SET session_replication_role = replica;

--
-- PostgreSQL database dump
--

-- \restrict ugJNs4FBHKuv2HO9Rd02eafPwS4329ZvUMLEbysvHcKZiYSy721t2XhkwzSpaYf

-- Dumped from database version 17.6
-- Dumped by pg_dump version 17.6

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET transaction_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Data for Name: audit_log_entries; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."audit_log_entries" ("instance_id", "id", "payload", "created_at", "ip_address") FROM stdin;
00000000-0000-0000-0000-000000000000	8d201e3c-d863-4cd8-b806-4c54d77a53c7	{"action":"login","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"account","traits":{"provider":"email"}}	2026-01-11 14:26:41.50747+00	
00000000-0000-0000-0000-000000000000	f52451f1-f2f9-49a9-910d-80ff2f893898	{"action":"login","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"account","traits":{"provider":"email"}}	2026-01-11 14:45:32.578556+00	
00000000-0000-0000-0000-000000000000	2db61ecf-7a19-44b1-a94d-7c4c7b2013cd	{"action":"token_refreshed","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"token"}	2026-01-11 15:44:23.234215+00	
00000000-0000-0000-0000-000000000000	96c4c0ce-7c68-48aa-9772-c6c9703686f1	{"action":"token_revoked","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"token"}	2026-01-11 15:44:23.236267+00	
00000000-0000-0000-0000-000000000000	375a1397-bf96-4654-801f-53001a475181	{"action":"user_signedup","actor_id":"00000000-0000-0000-0000-000000000000","actor_username":"service_role","actor_via_sso":false,"log_type":"team","traits":{"provider":"email","user_email":"andreyshokin1@gmail.com","user_id":"732eeef7-4c7d-474f-9eed-47123fa5c0ce","user_phone":""}}	2026-01-11 15:59:04.500004+00	
00000000-0000-0000-0000-000000000000	d49b3cb7-3581-4651-aae0-c73bb61c77f1	{"action":"user_modified","actor_id":"00000000-0000-0000-0000-000000000000","actor_username":"service_role","actor_via_sso":false,"log_type":"user","traits":{"user_email":"andreyshokin1@gmail.com","user_id":"732eeef7-4c7d-474f-9eed-47123fa5c0ce","user_phone":""}}	2026-01-11 16:36:27.046435+00	
00000000-0000-0000-0000-000000000000	f8ea8268-5429-4e4c-88a0-cd2463eec9d3	{"action":"user_signedup","actor_id":"00000000-0000-0000-0000-000000000000","actor_username":"service_role","actor_via_sso":false,"log_type":"team","traits":{"provider":"email","user_email":"andreyshokin123123@gmail.com","user_id":"493df201-0b31-43a5-834a-5f0e9ae2c67d","user_phone":""}}	2026-01-11 16:40:46.35625+00	
00000000-0000-0000-0000-000000000000	2d3d4e31-010e-4192-8513-fab162522a19	{"action":"token_refreshed","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"token"}	2026-01-11 16:42:23.352103+00	
00000000-0000-0000-0000-000000000000	492d2513-0a4f-43ed-953d-7f9f7a27cddb	{"action":"token_revoked","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"token"}	2026-01-11 16:42:23.353845+00	
00000000-0000-0000-0000-000000000000	a105d96c-c1b4-4f36-9eb7-e69131374ba0	{"action":"token_refreshed","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"token"}	2026-01-11 17:51:27.661355+00	
00000000-0000-0000-0000-000000000000	a86d5889-b381-472e-ab75-775cb5359149	{"action":"token_revoked","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"token"}	2026-01-11 17:51:27.66337+00	
00000000-0000-0000-0000-000000000000	2f37ecd7-dacc-45e4-a3bf-b997b599c2f9	{"action":"token_refreshed","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"token"}	2026-01-11 18:59:30.981852+00	
00000000-0000-0000-0000-000000000000	15d7b456-f3d3-4f7c-9222-71f4336d2879	{"action":"token_revoked","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"token"}	2026-01-11 18:59:30.983938+00	
00000000-0000-0000-0000-000000000000	4fb30f10-7b1d-402a-9f42-e5ac1e23b840	{"action":"token_refreshed","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"token"}	2026-01-12 03:12:33.849277+00	
00000000-0000-0000-0000-000000000000	ee240fef-db82-41e4-8a80-0bd70d091331	{"action":"token_revoked","actor_id":"1876594e-a7fe-4aa9-82f0-c85a35d14484","actor_name":"מנהל מערכת","actor_username":"manager@dietneta.com","actor_via_sso":false,"log_type":"token"}	2026-01-12 03:12:33.851011+00	
\.


--
-- Data for Name: flow_state; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."flow_state" ("id", "user_id", "auth_code", "code_challenge_method", "code_challenge", "provider_type", "provider_access_token", "provider_refresh_token", "created_at", "updated_at", "authentication_method", "auth_code_issued_at") FROM stdin;
\.


--
-- Data for Name: users; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."users" ("instance_id", "id", "aud", "role", "email", "encrypted_password", "email_confirmed_at", "invited_at", "confirmation_token", "confirmation_sent_at", "recovery_token", "recovery_sent_at", "email_change_token_new", "email_change", "email_change_sent_at", "last_sign_in_at", "raw_app_meta_data", "raw_user_meta_data", "is_super_admin", "created_at", "updated_at", "phone", "phone_confirmed_at", "phone_change", "phone_change_token", "phone_change_sent_at", "email_change_token_current", "email_change_confirm_status", "banned_until", "reauthentication_token", "reauthentication_sent_at", "is_sso_user", "deleted_at", "is_anonymous") FROM stdin;
00000000-0000-0000-0000-000000000000	f7c8a93d-36c2-4ed2-a878-ce01c486d026	authenticated	authenticated	client@dietneta.com	$2a$06$UI7PmaylMnSv4fGlwH4tzeNWKa31Eh5Q8XHEFpZfbKYlx2RAveo8G	2026-01-11 14:25:21.306084+00	\N		\N		2026-01-11 14:25:21.306084+00			\N	2026-01-11 14:25:21.306084+00	{"provider": "email", "providers": ["email"]}	{"role": "trainee", "full_name": "לקוח בדיקה"}	\N	2026-01-11 14:25:21.306084+00	2026-01-11 14:25:21.306084+00	\N	\N			\N		0	\N		\N	f	\N	f
00000000-0000-0000-0000-000000000000	732eeef7-4c7d-474f-9eed-47123fa5c0ce	authenticated	authenticated	andreyshokin1@gmail.com	$2a$10$3elUeHwKW1Z0JlztjLXbh.yvJoWNDfsCoemXf.JgKmBdkrkzCaSYC	2026-01-11 15:59:04.503004+00	\N		\N		\N			\N	\N	{"provider": "email", "providers": ["email"]}	{"role": "trainee", "email_verified": true}	\N	2026-01-11 15:59:04.493253+00	2026-01-11 16:36:27.041263+00	\N	\N			\N		0	\N		\N	f	\N	f
00000000-0000-0000-0000-000000000000	493df201-0b31-43a5-834a-5f0e9ae2c67d	authenticated	authenticated	andreyshokin123123@gmail.com	$2a$10$f/ZFyAuulWdR1Qbls9EGletjOM6NdIgt4bIU3Tt97lTT7P9U1eVkO	2026-01-11 16:40:46.359174+00	\N		\N		\N			\N	\N	{"provider": "email", "providers": ["email"]}	{"role": "trainee", "email_verified": true}	\N	2026-01-11 16:40:46.349186+00	2026-01-11 16:40:46.360294+00	\N	\N			\N		0	\N		\N	f	\N	f
00000000-0000-0000-0000-000000000000	1876594e-a7fe-4aa9-82f0-c85a35d14484	authenticated	authenticated	manager@dietneta.com	$2a$06$NOQx33aEle3V8Jqh20Du1eW99cl1C8jOyfJcP4VbBKOX4Sg/S8QTe	2026-01-11 14:25:21.306084+00	\N		\N		2026-01-11 14:25:21.306084+00			\N	2026-01-11 14:45:32.580862+00	{"provider": "email", "providers": ["email"]}	{"role": "admin", "full_name": "מנהל מערכת"}	\N	2026-01-11 14:25:21.306084+00	2026-01-12 03:12:33.855218+00	\N	\N			\N		0	\N		\N	f	\N	f
\.


--
-- Data for Name: identities; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."identities" ("provider_id", "user_id", "identity_data", "provider", "last_sign_in_at", "created_at", "updated_at", "id") FROM stdin;
732eeef7-4c7d-474f-9eed-47123fa5c0ce	732eeef7-4c7d-474f-9eed-47123fa5c0ce	{"sub": "732eeef7-4c7d-474f-9eed-47123fa5c0ce", "email": "andreyshokin1@gmail.com", "email_verified": false, "phone_verified": false}	email	2026-01-11 15:59:04.49819+00	2026-01-11 15:59:04.498233+00	2026-01-11 15:59:04.498233+00	d82e36e7-e602-4aa3-9dd3-488ce342f460
493df201-0b31-43a5-834a-5f0e9ae2c67d	493df201-0b31-43a5-834a-5f0e9ae2c67d	{"sub": "493df201-0b31-43a5-834a-5f0e9ae2c67d", "email": "andreyshokin123123@gmail.com", "email_verified": false, "phone_verified": false}	email	2026-01-11 16:40:46.354228+00	2026-01-11 16:40:46.354276+00	2026-01-11 16:40:46.354276+00	a5f7c987-6a32-4d6c-be9f-5e1bd38e475c
\.


--
-- Data for Name: instances; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."instances" ("id", "uuid", "raw_base_config", "created_at", "updated_at") FROM stdin;
\.


--
-- Data for Name: oauth_clients; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."oauth_clients" ("id", "client_secret_hash", "registration_type", "redirect_uris", "grant_types", "client_name", "client_uri", "logo_uri", "created_at", "updated_at", "deleted_at", "client_type") FROM stdin;
\.


--
-- Data for Name: sessions; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."sessions" ("id", "user_id", "created_at", "updated_at", "factor_id", "aal", "not_after", "refreshed_at", "user_agent", "ip", "tag", "oauth_client_id", "refresh_token_hmac_key", "refresh_token_counter", "scopes") FROM stdin;
811720a1-3e76-4830-a17d-250cf788b62b	1876594e-a7fe-4aa9-82f0-c85a35d14484	2026-01-11 14:26:41.51025+00	2026-01-11 14:26:41.51025+00	\N	aal1	\N	\N	Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36	172.18.0.1	\N	\N	\N	\N	\N
b51293c8-7380-4b01-9c1e-2c74d9f05d60	1876594e-a7fe-4aa9-82f0-c85a35d14484	2026-01-11 14:45:32.58094+00	2026-01-12 03:12:33.85793+00	\N	aal1	\N	2026-01-12 03:12:33.857854	Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36	192.168.65.1	\N	\N	\N	\N	\N
\.


--
-- Data for Name: mfa_amr_claims; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."mfa_amr_claims" ("session_id", "created_at", "updated_at", "authentication_method", "id") FROM stdin;
811720a1-3e76-4830-a17d-250cf788b62b	2026-01-11 14:26:41.515589+00	2026-01-11 14:26:41.515589+00	password	bfd4468c-bcc7-4af2-a61c-a04dba9ce777
b51293c8-7380-4b01-9c1e-2c74d9f05d60	2026-01-11 14:45:32.593088+00	2026-01-11 14:45:32.593088+00	password	85c61040-2bf5-48dd-a331-84a3f879f90b
\.


--
-- Data for Name: mfa_factors; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."mfa_factors" ("id", "user_id", "friendly_name", "factor_type", "status", "created_at", "updated_at", "secret", "phone", "last_challenged_at", "web_authn_credential", "web_authn_aaguid", "last_webauthn_challenge_data") FROM stdin;
\.


--
-- Data for Name: mfa_challenges; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."mfa_challenges" ("id", "factor_id", "created_at", "verified_at", "ip_address", "otp_code", "web_authn_session_data") FROM stdin;
\.


--
-- Data for Name: oauth_authorizations; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."oauth_authorizations" ("id", "authorization_id", "client_id", "user_id", "redirect_uri", "scope", "state", "resource", "code_challenge", "code_challenge_method", "response_type", "status", "authorization_code", "created_at", "expires_at", "approved_at", "nonce") FROM stdin;
\.


--
-- Data for Name: oauth_client_states; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."oauth_client_states" ("id", "provider_type", "code_verifier", "created_at") FROM stdin;
\.


--
-- Data for Name: oauth_consents; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."oauth_consents" ("id", "user_id", "client_id", "scopes", "granted_at", "revoked_at") FROM stdin;
\.


--
-- Data for Name: one_time_tokens; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."one_time_tokens" ("id", "user_id", "token_type", "token_hash", "relates_to", "created_at", "updated_at") FROM stdin;
\.


--
-- Data for Name: refresh_tokens; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."refresh_tokens" ("instance_id", "id", "token", "user_id", "revoked", "created_at", "updated_at", "parent", "session_id") FROM stdin;
00000000-0000-0000-0000-000000000000	1	amnq5soitqxn	1876594e-a7fe-4aa9-82f0-c85a35d14484	f	2026-01-11 14:26:41.512891+00	2026-01-11 14:26:41.512891+00	\N	811720a1-3e76-4830-a17d-250cf788b62b
00000000-0000-0000-0000-000000000000	2	gamv2yy4caht	1876594e-a7fe-4aa9-82f0-c85a35d14484	t	2026-01-11 14:45:32.586459+00	2026-01-11 15:44:23.237751+00	\N	b51293c8-7380-4b01-9c1e-2c74d9f05d60
00000000-0000-0000-0000-000000000000	3	vt64mx5yrsbx	1876594e-a7fe-4aa9-82f0-c85a35d14484	t	2026-01-11 15:44:23.239031+00	2026-01-11 16:42:23.35537+00	gamv2yy4caht	b51293c8-7380-4b01-9c1e-2c74d9f05d60
00000000-0000-0000-0000-000000000000	4	il4i5n74q5p5	1876594e-a7fe-4aa9-82f0-c85a35d14484	t	2026-01-11 16:42:23.356688+00	2026-01-11 17:51:27.664986+00	vt64mx5yrsbx	b51293c8-7380-4b01-9c1e-2c74d9f05d60
00000000-0000-0000-0000-000000000000	5	yfuohlb5lifv	1876594e-a7fe-4aa9-82f0-c85a35d14484	t	2026-01-11 17:51:27.666413+00	2026-01-11 18:59:30.987234+00	il4i5n74q5p5	b51293c8-7380-4b01-9c1e-2c74d9f05d60
00000000-0000-0000-0000-000000000000	6	5h6rvec6kkyf	1876594e-a7fe-4aa9-82f0-c85a35d14484	t	2026-01-11 18:59:30.989036+00	2026-01-12 03:12:33.852299+00	yfuohlb5lifv	b51293c8-7380-4b01-9c1e-2c74d9f05d60
00000000-0000-0000-0000-000000000000	7	jcpbcjfrbslk	1876594e-a7fe-4aa9-82f0-c85a35d14484	f	2026-01-12 03:12:33.853691+00	2026-01-12 03:12:33.853691+00	5h6rvec6kkyf	b51293c8-7380-4b01-9c1e-2c74d9f05d60
\.


--
-- Data for Name: sso_providers; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."sso_providers" ("id", "resource_id", "created_at", "updated_at", "disabled") FROM stdin;
\.


--
-- Data for Name: saml_providers; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."saml_providers" ("id", "sso_provider_id", "entity_id", "metadata_xml", "metadata_url", "attribute_mapping", "created_at", "updated_at", "name_id_format") FROM stdin;
\.


--
-- Data for Name: saml_relay_states; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."saml_relay_states" ("id", "sso_provider_id", "request_id", "for_email", "redirect_to", "created_at", "updated_at", "flow_state_id") FROM stdin;
\.


--
-- Data for Name: sso_domains; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."sso_domains" ("id", "sso_provider_id", "domain", "created_at", "updated_at") FROM stdin;
\.


--
-- Data for Name: nutrition_templates; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."nutrition_templates" ("id", "name", "description", "targets", "is_public", "created_at", "updated_at", "created_by") FROM stdin;
52388e0b-4abc-4e32-9029-7fa827aa861d	123	\N	{"fat": 70, "carbs": 140, "fiber": 32, "protein": 140, "calories": 1750}	f	2026-01-11 14:45:59.478891+00	2026-01-11 17:28:24.182483+00	1876594e-a7fe-4aa9-82f0-c85a35d14484
\.


--
-- Data for Name: workout_templates; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."workout_templates" ("id", "name", "description", "goal_tags", "routine_data", "is_public", "created_at", "updated_at", "created_by") FROM stdin;
caec3fc3-e663-40f6-a9b9-1db92ad06929	123	\N	{}	{"weeklyWorkout": {"days": {"friday": {"day": "friday", "isActive": true, "exercises": [{"id": "1768152488991-0.6429334550673733", "name": "דדליפט", "reps": 10, "sets": 3}]}, "monday": {"day": "monday", "isActive": true, "exercises": [{"id": "1768152482447-0.39519854619219075", "name": "משיכה עליונה", "reps": 10, "sets": 3}]}, "sunday": {"day": "sunday", "isActive": true, "exercises": [{"id": "1768142742324-0.484279618599742", "name": "דדליפט", "reps": 10, "sets": 3}]}, "tuesday": {"day": "tuesday", "isActive": true, "exercises": [{"id": "1768152485410-0.46970558008298724", "name": "פרפר", "reps": 10, "sets": 3}]}, "saturday": {"day": "saturday", "isActive": false, "exercises": []}, "thursday": {"day": "thursday", "isActive": false, "exercises": []}, "wednesday": {"day": "wednesday", "isActive": false, "exercises": []}}, "startDate": "2026-01-11", "stepsGoal": 0, "description": "123", "generalGoals": ""}}	f	2026-01-11 14:45:43.429023+00	2026-01-11 17:28:16.60399+00	1876594e-a7fe-4aa9-82f0-c85a35d14484
a69938ce-c3bf-414b-90c8-71de5ac1bac6	תבנית ללא שם	\N	{}	{"weeklyWorkout": {"days": {"friday": {"day": "friday", "isActive": false, "exercises": []}, "monday": {"day": "monday", "isActive": false, "exercises": []}, "sunday": {"day": "sunday", "isActive": true, "exercises": [{"id": "1768142582698-0.1717909625402646", "name": "משיכה אופקית", "reps": 10, "sets": 3, "image_url": "http://127.0.0.1:54321/storage/v1/object/sign/client-assets/workout-exercises/1768142582698-0.1717909625402646/images/1768142582698-0.1717909625402646-1768144284897.png?token=eyJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJjbGllbnQtYXNzZXRzL3dvcmtvdXQtZXhlcmNpc2VzLzE3NjgxNDI1ODI2OTgtMC4xNzE3OTA5NjI1NDAyNjQ2L2ltYWdlcy8xNzY4MTQyNTgyNjk4LTAuMTcxNzkwOTYyNTQwMjY0Ni0xNzY4MTQ0Mjg0ODk3LnBuZyIsImlhdCI6MTc2ODE0NDI4NSwiZXhwIjoxNzk5NjgwMjg1fQ.0gobac7ynlgZrRnhs1836H8sS-SOOuolePWUuZTU7T4", "video_url": "http://127.0.0.1:54321/storage/v1/object/sign/client-assets/workout-exercises/1768142582698-0.1717909625402646/videos/1768142582698-0.1717909625402646-1768144302225.mp4?token=eyJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJjbGllbnQtYXNzZXRzL3dvcmtvdXQtZXhlcmNpc2VzLzE3NjgxNDI1ODI2OTgtMC4xNzE3OTA5NjI1NDAyNjQ2L3ZpZGVvcy8xNzY4MTQyNTgyNjk4LTAuMTcxNzkwOTYyNTQwMjY0Ni0xNzY4MTQ0MzAyMjI1Lm1wNCIsImlhdCI6MTc2ODE0NDMwMiwiZXhwIjoxNzk5NjgwMzAyfQ.rIOq3Sy2tjNek8TIOvgkuG1PKAHl88cmdg8oabWZnf8"}]}, "tuesday": {"day": "tuesday", "isActive": false, "exercises": []}, "saturday": {"day": "saturday", "isActive": false, "exercises": []}, "thursday": {"day": "thursday", "isActive": false, "exercises": []}, "wednesday": {"day": "wednesday", "isActive": false, "exercises": []}}, "startDate": "2026-01-11", "stepsGoal": 0, "description": "תבנית ללא שם", "generalGoals": ""}}	f	2026-01-11 14:49:05.518452+00	2026-01-11 15:11:55.908316+00	1876594e-a7fe-4aa9-82f0-c85a35d14484
\.


--
-- Data for Name: budgets; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."budgets" ("id", "name", "description", "nutrition_template_id", "nutrition_targets", "steps_goal", "steps_instructions", "workout_template_id", "supplements", "eating_order", "eating_rules", "is_public", "created_at", "updated_at", "created_by") FROM stdin;
1c63d88e-d878-4314-b463-7135349a07ab	אנדרי	\N	52388e0b-4abc-4e32-9029-7fa827aa861d	{"fat": 70, "carbs": 140, "protein": 140, "calories": 1750, "fiber_min": 32, "water_min": 2.5}	0	\N	a69938ce-c3bf-414b-90c8-71de5ac1bac6	[{"name": "mg", "dosage": "1", "timing": "1"}]	\N	\N	f	2026-01-11 14:49:50.524182+00	2026-01-11 14:53:48.223513+00	1876594e-a7fe-4aa9-82f0-c85a35d14484
45416549-79ba-47d6-85a5-9828857618b4	אנדרי	תתיאור קצר	52388e0b-4abc-4e32-9029-7fa827aa861d	{"fat": 70, "carbs": 140, "protein": 140, "calories": 1750, "fiber_min": 32, "water_min": 2.5}	5000	הוראות צעדים	caec3fc3-e663-40f6-a9b9-1db92ad06929	[{"name": "MG", "dosage": "1", "timing": "1"}]	סדר אכילה	כללי לאכילה	f	2026-01-11 14:50:18.287294+00	2026-01-11 17:28:52.221372+00	1876594e-a7fe-4aa9-82f0-c85a35d14484
\.


--
-- Data for Name: customers; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."customers" ("id", "full_name", "phone", "email", "created_at", "updated_at", "daily_protocol", "workout_history", "steps_history", "avatar_url", "total_spent", "membership_tier", "user_id") FROM stdin;
2d827efb-4cde-4d3e-999b-9341dbc63c42	לקוח בדיקה	0501234567	client@dietneta.com	2026-01-11 14:25:21.306084+00	2026-01-11 14:25:21.306084+00	{}	[]	[]	\N	0.00	New	f7c8a93d-36c2-4ed2-a878-ce01c486d026
133f98f8-7eaa-414e-b55d-eb264afdfab5	אנדרי שצוקין	0526861485	\N	2026-01-11 14:37:35.960181+00	2026-01-11 15:59:04.515097+00	{}	[]	[]	\N	0.00	New	732eeef7-4c7d-474f-9eed-47123fa5c0ce
8f6401f5-7182-4dff-9789-796d6758966e	אנדרי שצוקין	0521234567	\N	2026-01-11 16:40:29.311554+00	2026-01-11 16:40:46.371496+00	{}	[]	[]	\N	0.00	New	493df201-0b31-43a5-834a-5f0e9ae2c67d
\.


--
-- Data for Name: profiles; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."profiles" ("id", "email", "full_name", "role", "created_at", "updated_at") FROM stdin;
f7c8a93d-36c2-4ed2-a878-ce01c486d026	client@dietneta.com	לקוח בדיקה	trainee	2026-01-11 14:25:21.306084+00	2026-01-11 14:25:21.306084+00
1876594e-a7fe-4aa9-82f0-c85a35d14484	manager@dietneta.com	מנהל מערכת	admin	2026-01-11 14:25:21.306084+00	2026-01-11 14:25:21.387393+00
732eeef7-4c7d-474f-9eed-47123fa5c0ce	andreyshokin1@gmail.com		trainee	2026-01-11 15:59:04.492903+00	2026-01-11 15:59:04.492903+00
493df201-0b31-43a5-834a-5f0e9ae2c67d	andreyshokin123123@gmail.com		trainee	2026-01-11 16:40:46.348759+00	2026-01-11 16:40:46.348759+00
\.


--
-- Data for Name: leads; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."leads" ("id", "created_at", "updated_at", "assigned_to", "city", "birth_date", "gender", "status_main", "status_sub", "height", "weight", "bmi", "join_date", "subscription_data", "daily_protocol", "workout_history", "steps_history", "source", "fitness_goal", "activity_level", "preferred_time", "notes", "customer_id", "nutrition_history", "supplements_history") FROM stdin;
0ef7190c-d57e-4c5b-bf72-664faa3eb4d5	2026-01-11 14:25:21.306084+00	2026-01-11 14:25:21.306084+00	\N	\N	\N	\N	בטיפול	\N	175.00	75.00	24.49	\N	{}	{}	[]	[]	\N	ירידה במשקל	בינוני	\N	\N	2d827efb-4cde-4d3e-999b-9341dbc63c42	[]	[]
60ac15ca-af26-41d8-970d-21b17cb5a10f	2026-01-11 14:37:35.975838+00	2026-01-11 14:37:35.975838+00	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	{}	{}	[]	[]	\N	\N	\N	\N	\N	133f98f8-7eaa-414e-b55d-eb264afdfab5	[]	[]
8ac7cf41-29d0-48e3-8bad-a6c141951a8d	2026-01-11 16:40:29.348281+00	2026-01-11 16:40:29.348281+00	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	{}	{}	[]	[]	\N	\N	\N	\N	\N	8f6401f5-7182-4dff-9789-796d6758966e	[]	[]
\.


--
-- Data for Name: budget_assignments; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."budget_assignments" ("id", "budget_id", "lead_id", "customer_id", "assigned_at", "assigned_by", "is_active", "notes", "created_at", "updated_at") FROM stdin;
cca08e23-3027-4282-a265-9d838cffa6a7	1c63d88e-d878-4314-b463-7135349a07ab	60ac15ca-af26-41d8-970d-21b17cb5a10f	\N	2026-01-11 14:49:50.719022+00	1876594e-a7fe-4aa9-82f0-c85a35d14484	f	\N	2026-01-11 14:49:50.719022+00	2026-01-11 14:53:48.646044+00
c07d3940-769d-4386-b000-441babdedafd	1c63d88e-d878-4314-b463-7135349a07ab	60ac15ca-af26-41d8-970d-21b17cb5a10f	\N	2026-01-11 14:53:48.661622+00	1876594e-a7fe-4aa9-82f0-c85a35d14484	t	\N	2026-01-11 14:53:48.661622+00	2026-01-11 14:53:48.661622+00
\.


--
-- Data for Name: check_in_field_configurations; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."check_in_field_configurations" ("id", "customer_id", "configuration", "created_at", "updated_at", "created_by") FROM stdin;
\.


--
-- Data for Name: customer_notes; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."customer_notes" ("id", "customer_id", "content", "created_at", "updated_at", "created_by", "lead_id", "attachment_url") FROM stdin;
9f96bce0-10d9-4743-a544-de5d700d7085	8f6401f5-7182-4dff-9789-796d6758966e	vgrv	2026-01-11 16:50:39.466657+00	2026-01-11 16:50:39.466657+00	\N	8ac7cf41-29d0-48e3-8bad-a6c141951a8d	8f6401f5-7182-4dff-9789-796d6758966e/notes/1768150239342.png
c0c4e1ae-cbc1-4852-b4b3-a5211fee505d	8f6401f5-7182-4dff-9789-796d6758966e	156	2026-01-11 16:49:30.982453+00	2026-01-11 18:08:35.042268+00	\N	8ac7cf41-29d0-48e3-8bad-a6c141951a8d	\N
\.


--
-- Data for Name: daily_check_ins; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."daily_check_ins" ("id", "customer_id", "lead_id", "check_in_date", "workout_completed", "steps_goal_met", "steps_actual", "nutrition_goal_met", "supplements_taken", "notes", "created_at", "updated_at", "created_by", "weight", "belly_circumference", "waist_circumference", "thigh_circumference", "arm_circumference", "neck_circumference", "exercises_count", "cardio_amount", "intervals_count", "calories_daily", "protein_daily", "fiber_daily", "water_amount", "stress_level", "hunger_level", "energy_level", "sleep_hours") FROM stdin;
\.


--
-- Data for Name: green_api_settings; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."green_api_settings" ("id", "id_instance", "api_token_instance", "created_at", "updated_at", "created_by", "updated_by") FROM stdin;
\.


--
-- Data for Name: user_invitations; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."user_invitations" ("id", "email", "user_id", "customer_id", "lead_id", "token_hash", "token_salt", "status", "invited_by", "invited_at", "expires_at", "accepted_at", "created_at", "updated_at") FROM stdin;
\.


--
-- Data for Name: invitation_audit_log; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."invitation_audit_log" ("id", "invitation_id", "action", "performed_by", "ip_address", "user_agent", "metadata", "created_at") FROM stdin;
\.


--
-- Data for Name: meetings; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."meetings" ("id", "lead_id", "customer_id", "fillout_submission_id", "meeting_data", "created_at", "updated_at", "created_by") FROM stdin;
\.


--
-- Data for Name: nutrition_plans; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."nutrition_plans" ("id", "user_id", "lead_id", "template_id", "start_date", "description", "targets", "created_at", "updated_at", "created_by", "customer_id", "budget_id") FROM stdin;
91a61221-aa79-4beb-b143-34e78e7ed7be	1876594e-a7fe-4aa9-82f0-c85a35d14484	60ac15ca-af26-41d8-970d-21b17cb5a10f	52388e0b-4abc-4e32-9029-7fa827aa861d	2026-01-11	תוכנית תזונה מתקציב: אנדרי	{"fat": 70, "carbs": 140, "protein": 140, "calories": 1750, "fiber_min": 32, "water_min": 2.5}	2026-01-11 14:53:48.739999+00	2026-01-11 14:53:48.739999+00	1876594e-a7fe-4aa9-82f0-c85a35d14484	133f98f8-7eaa-414e-b55d-eb264afdfab5	1c63d88e-d878-4314-b463-7135349a07ab
\.


--
-- Data for Name: payments; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."payments" ("id", "customer_id", "lead_id", "product_name", "amount", "currency", "status", "stripe_payment_id", "transaction_id", "receipt_url", "notes", "created_at", "updated_at", "created_by") FROM stdin;
\.


--
-- Data for Name: saved_views; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."saved_views" ("id", "resource_key", "view_name", "filter_config", "is_default", "created_by", "created_at", "updated_at", "icon_name") FROM stdin;
888b8c9b-5901-4813-b6f1-86063844f6dc	leads	כל הלידים	{"searchQuery": "", "selectedAge": null, "selectedDate": null, "selectedHeight": null, "selectedSource": null, "selectedStatus": null, "selectedWeight": null, "columnVisibility": {"id": true, "age": true, "name": true, "email": true, "notes": true, "phone": true, "height": true, "source": true, "status": true, "weight": true, "birthDate": true, "createdDate": true, "fitnessGoal": true, "activityLevel": true, "preferredTime": true}, "selectedFitnessGoal": null, "selectedActivityLevel": null, "selectedPreferredTime": null}	t	1876594e-a7fe-4aa9-82f0-c85a35d14484	2026-01-11 14:26:42.685525+00	2026-01-11 14:26:42.685525+00	\N
09f85c2e-7d97-4a7e-b4eb-fe2df897114c	nutrition_templates	כל תבניות התזונה	{"searchQuery": "", "selectedDate": null, "columnVisibility": {"name": true, "tags": false, "actions": true, "createdDate": true, "description": true, "connectedLeads": false}}	t	1876594e-a7fe-4aa9-82f0-c85a35d14484	2026-01-11 14:26:42.878308+00	2026-01-11 14:26:42.878308+00	\N
8b878b2c-5ccb-4c8a-8504-67974c217f2a	budgets	כל התקציבים	{"searchQuery": "", "selectedDate": null, "columnVisibility": {"name": true, "actions": true, "steps_goal": true, "createdDate": true, "description": true, "supplements": false, "eating_order": false, "eating_rules": false, "workout_template": true, "nutrition_targets": false, "nutrition_template": true, "steps_instructions": false}}	t	1876594e-a7fe-4aa9-82f0-c85a35d14484	2026-01-11 14:26:42.931529+00	2026-01-11 14:26:42.931529+00	\N
7d16c257-53c8-4cb7-8960-5d324355fc83	templates	כל התכניות	{"searchQuery": "", "selectedDate": null, "selectedTags": [], "columnVisibility": {"name": true, "tags": true, "actions": true, "createdDate": true, "description": true, "connectedLeads": true}, "selectedHasLeads": "all"}	t	1876594e-a7fe-4aa9-82f0-c85a35d14484	2026-01-11 14:42:47.25994+00	2026-01-11 14:42:47.25994+00	\N
a7092144-d0cb-4701-94fb-da18fc445060	customers	כל הלקוחות	{"searchQuery": "", "selectedDate": null}	t	1876594e-a7fe-4aa9-82f0-c85a35d14484	2026-01-11 16:57:21.788495+00	2026-01-11 16:57:21.788495+00	\N
f7d3dd2f-ad75-4dad-bd8a-09a2dadc684f	meetings	כל הפגישות	{"searchQuery": "", "selectedDate": null, "columnVisibility": {"phone": true, "status": true, "created_at": true, "meeting_date": true, "meeting_time": true, "customer_name": true}}	t	1876594e-a7fe-4aa9-82f0-c85a35d14484	2026-01-11 16:57:39.217326+00	2026-01-11 16:57:39.217326+00	\N
\.


--
-- Data for Name: steps_plans; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."steps_plans" ("id", "user_id", "lead_id", "customer_id", "budget_id", "template_id", "start_date", "end_date", "description", "steps_goal", "steps_instructions", "is_active", "created_at", "updated_at", "created_by") FROM stdin;
\.


--
-- Data for Name: supplement_plans; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."supplement_plans" ("id", "user_id", "lead_id", "customer_id", "budget_id", "template_id", "start_date", "end_date", "description", "supplements", "is_active", "created_at", "updated_at", "created_by") FROM stdin;
05acad70-cb13-47f4-8a0c-970e7e37afcb	1876594e-a7fe-4aa9-82f0-c85a35d14484	60ac15ca-af26-41d8-970d-21b17cb5a10f	133f98f8-7eaa-414e-b55d-eb264afdfab5	1c63d88e-d878-4314-b463-7135349a07ab	\N	2026-01-11	\N	תוכנית תוספים מתקציב: אנדרי	[{"name": "mg", "dosage": "1", "timing": "1"}]	t	2026-01-11 14:53:48.769473+00	2026-01-11 14:53:48.769473+00	1876594e-a7fe-4aa9-82f0-c85a35d14484
\.


--
-- Data for Name: user_interface_preferences; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."user_interface_preferences" ("id", "user_id", "interface_key", "icon_name", "created_at", "updated_at") FROM stdin;
0a134672-a893-487a-8c0f-1be0e18c3fc5	1876594e-a7fe-4aa9-82f0-c85a35d14484	budgets	Users	2026-01-11 17:03:32.749471+00	2026-01-11 17:03:32.702+00
\.


--
-- Data for Name: weekly_reviews; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."weekly_reviews" ("id", "lead_id", "customer_id", "week_start_date", "week_end_date", "target_calories", "target_protein", "target_carbs", "target_fat", "target_fiber", "target_steps", "actual_calories_avg", "actual_protein_avg", "actual_carbs_avg", "actual_fat_avg", "actual_fiber_avg", "actual_calories_weekly_avg", "weekly_avg_weight", "waist_measurement", "trainer_summary", "action_plan", "updated_steps_goal", "updated_calories_target", "created_at", "updated_at", "created_by") FROM stdin;
\.


--
-- Data for Name: whatsapp_flow_templates; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."whatsapp_flow_templates" ("id", "user_id", "flow_key", "template_content", "created_at", "updated_at", "buttons", "media") FROM stdin;
d231df36-bb3b-4b8a-a531-37f980c22bdd	1876594e-a7fe-4aa9-82f0-c85a35d14484	customer_journey_start	<p>123</p>	2026-01-11 14:37:09.551823+00	2026-01-11 17:55:24.781913+00	[]	{"url": "http://127.0.0.1:54321/storage/v1/object/sign/client-assets/templates/1876594e-a7fe-4aa9-82f0-c85a35d14484/customer_journey_start/1768150717577.png?token=eyJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJjbGllbnQtYXNzZXRzL3RlbXBsYXRlcy8xODc2NTk0ZS1hN2ZlLTRhYTktODJmMC1jODVhMzVkMTQ0ODQvY3VzdG9tZXJfam91cm5leV9zdGFydC8xNzY4MTUwNzE3NTc3LnBuZyIsImlhdCI6MTc2ODE1MDcxNywiZXhwIjoxNzk5Njg2NzE3fQ.Q86Eb4r6E75vOP-0U6WkIS0CiU7sqZepFn_q5x9VZ84", "type": "image"}
\.


--
-- Data for Name: workout_plans; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."workout_plans" ("id", "user_id", "lead_id", "start_date", "description", "strength", "cardio", "intervals", "custom_attributes", "created_at", "updated_at", "created_by", "template_id", "is_active", "deleted_at", "customer_id", "budget_id") FROM stdin;
f2dbc994-c035-4570-b240-f6ece13dbda8	1876594e-a7fe-4aa9-82f0-c85a35d14484	60ac15ca-af26-41d8-970d-21b17cb5a10f	2026-01-11	תוכנית אימונים מתקציב: אנדרי	0	0	0	{"weeklyWorkout": {"days": {"friday": {"day": "friday", "isActive": false, "exercises": []}, "monday": {"day": "monday", "isActive": false, "exercises": []}, "sunday": {"day": "sunday", "isActive": true, "exercises": [{"id": "1768142582698-0.1717909625402646", "name": "משיכה אופקית", "reps": 10, "sets": 3}]}, "tuesday": {"day": "tuesday", "isActive": false, "exercises": []}, "saturday": {"day": "saturday", "isActive": false, "exercises": []}, "thursday": {"day": "thursday", "isActive": false, "exercises": []}, "wednesday": {"day": "wednesday", "isActive": false, "exercises": []}}, "startDate": "2026-01-11", "stepsGoal": 0, "description": "תבנית ללא שם", "generalGoals": ""}}	2026-01-11 14:53:48.713519+00	2026-01-11 14:53:48.713519+00	1876594e-a7fe-4aa9-82f0-c85a35d14484	a69938ce-c3bf-414b-90c8-71de5ac1bac6	t	\N	133f98f8-7eaa-414e-b55d-eb264afdfab5	1c63d88e-d878-4314-b463-7135349a07ab
\.


--
-- Data for Name: schema_migrations; Type: TABLE DATA; Schema: supabase_migrations; Owner: postgres
--

COPY "supabase_migrations"."schema_migrations" ("version", "statements", "name") FROM stdin;
20240001	{"-- =====================================================\n-- Initial Schema Migration for Diet Neta CRM\n-- Created: 2024-01-01\n-- Description: Production-ready schema with RLS, JSONB flexibility, and auto-triggers\n-- =====================================================\n\n-- =====================================================\n-- 1. EXTENSIONS\n-- =====================================================\n\n-- Enable UUID generation\nCREATE EXTENSION IF NOT EXISTS \\"uuid-ossp\\"","-- =====================================================\n-- 2. UTILITY FUNCTIONS\n-- =====================================================\n\n-- Generic function to automatically update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- =====================================================\n-- 3. TABLE: profiles\n-- =====================================================\n\n-- Profiles table links to auth.users and manages user roles\nCREATE TABLE IF NOT EXISTS profiles (\n    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,\n    email TEXT NOT NULL,\n    full_name TEXT,\n    role TEXT NOT NULL DEFAULT 'user' CHECK (role IN ('admin', 'user')),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL\n)","-- Index for faster role lookups\nCREATE INDEX IF NOT EXISTS idx_profiles_role ON profiles(role)","CREATE INDEX IF NOT EXISTS idx_profiles_email ON profiles(email)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_profiles_updated_at\n    BEFORE UPDATE ON profiles\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- Function to automatically create profile when user signs up\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER AS $$\nBEGIN\n    INSERT INTO public.profiles (id, email, full_name, role)\n    VALUES (\n        NEW.id,\n        NEW.email,\n        COALESCE(NEW.raw_user_meta_data->>'full_name', ''),\n        COALESCE(NEW.raw_user_meta_data->>'role', 'user')\n    );\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Trigger to call handle_new_user when a new user is created in auth.users\nCREATE TRIGGER on_auth_user_created\n    AFTER INSERT ON auth.users\n    FOR EACH ROW\n    EXECUTE FUNCTION public.handle_new_user()","-- =====================================================\n-- 4. TABLE: leads (The Central Entity)\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS leads (\n    -- Meta Data\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    assigned_to UUID REFERENCES profiles(id) ON DELETE SET NULL,\n    \n    -- Personal Info\n    full_name TEXT NOT NULL,\n    phone TEXT UNIQUE NOT NULL,\n    email TEXT,\n    city TEXT,\n    birth_date DATE,\n    gender TEXT CHECK (gender IN ('male', 'female', 'other')) DEFAULT NULL,\n    \n    -- Status Management\n    status_main TEXT,\n    status_sub TEXT,\n    \n    -- Physical Metrics\n    height DECIMAL(5, 2), -- in cm\n    weight DECIMAL(5, 2), -- in kg\n    bmi DECIMAL(4, 2), -- calculated or stored\n    \n    -- Business/Subscription\n    join_date TIMESTAMP WITH TIME ZONE,\n    subscription_data JSONB DEFAULT '{}'::jsonb,\n    \n    -- Dynamic Data Columns (JSONB for flexibility)\n    daily_protocol JSONB DEFAULT '{}'::jsonb,\n    -- Structure: { \\"stepsGoal\\": 8000, \\"workoutGoal\\": 3, \\"supplements\\": [\\"Omega 3\\", \\"Magnesium\\"] }\n    \n    workout_history JSONB DEFAULT '[]'::jsonb,\n    -- Structure: [{ \\"name\\": \\"Plan A\\", \\"startDate\\": \\"2024-01-01\\", \\"validUntil\\": \\"2024-04-01\\", \n    --              \\"duration\\": \\"3 months\\", \\"description\\": \\"...\\", \n    --              \\"strengthCount\\": 3, \\"cardioCount\\": 1, \\"intervalsCount\\": 1 }]\n    \n    steps_history JSONB DEFAULT '[]'::jsonb,\n    -- Structure: [{ \\"weekNumber\\": 1, \\"startDate\\": \\"2024-01-01\\", \\"endDate\\": \\"2024-01-07\\", \\"target\\": 7000 }]\n    \n    -- Additional fields from the application\n    source TEXT,\n    fitness_goal TEXT,\n    activity_level TEXT,\n    preferred_time TEXT,\n    notes TEXT\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_leads_assigned_to ON leads(assigned_to)","CREATE INDEX IF NOT EXISTS idx_leads_status_main ON leads(status_main)","CREATE INDEX IF NOT EXISTS idx_leads_status_sub ON leads(status_sub)","CREATE INDEX IF NOT EXISTS idx_leads_phone ON leads(phone)","CREATE INDEX IF NOT EXISTS idx_leads_email ON leads(email)","CREATE INDEX IF NOT EXISTS idx_leads_created_at ON leads(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_leads_join_date ON leads(join_date)","-- GIN indexes for JSONB columns (enables fast queries on JSONB data)\nCREATE INDEX IF NOT EXISTS idx_leads_daily_protocol ON leads USING GIN (daily_protocol)","CREATE INDEX IF NOT EXISTS idx_leads_workout_history ON leads USING GIN (workout_history)","CREATE INDEX IF NOT EXISTS idx_leads_steps_history ON leads USING GIN (steps_history)","CREATE INDEX IF NOT EXISTS idx_leads_subscription_data ON leads USING GIN (subscription_data)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_leads_updated_at\n    BEFORE UPDATE ON leads\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- 5. ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on profiles table\nALTER TABLE profiles ENABLE ROW LEVEL SECURITY","-- Enable RLS on leads table\nALTER TABLE leads ENABLE ROW LEVEL SECURITY","-- =====================================================\n-- 6. RLS POLICIES: profiles\n-- =====================================================\n\n-- Policy: Users can read their own profile\nCREATE POLICY \\"Users can read own profile\\"\n    ON profiles FOR SELECT\n    USING (auth.uid() = id)","-- Policy: Users can update their own profile\nCREATE POLICY \\"Users can update own profile\\"\n    ON profiles FOR UPDATE\n    USING (auth.uid() = id)\n    WITH CHECK (auth.uid() = id)","-- Policy: Admins have full access to profiles\nCREATE POLICY \\"Admins have full access to profiles\\"\n    ON profiles FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- 7. RLS POLICIES: leads\n-- =====================================================\n\n-- Policy: Authenticated users can read all leads (adjust based on business logic)\nCREATE POLICY \\"Authenticated users can read leads\\"\n    ON leads FOR SELECT\n    USING (auth.role() = 'authenticated')","-- Policy: Authenticated users can insert leads\nCREATE POLICY \\"Authenticated users can insert leads\\"\n    ON leads FOR INSERT\n    WITH CHECK (auth.role() = 'authenticated')","-- Policy: Users can update leads assigned to them\nCREATE POLICY \\"Users can update assigned leads\\"\n    ON leads FOR UPDATE\n    USING (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Admins have full access to leads\nCREATE POLICY \\"Admins have full access to leads\\"\n    ON leads FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Users can delete leads (only admins or assigned users)\nCREATE POLICY \\"Users can delete assigned leads\\"\n    ON leads FOR DELETE\n    USING (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- 8. HELPER FUNCTIONS (Optional but useful)\n-- =====================================================\n\n-- Function to calculate BMI (can be used in triggers or application layer)\nCREATE OR REPLACE FUNCTION calculate_bmi(height_cm DECIMAL, weight_kg DECIMAL)\nRETURNS DECIMAL AS $$\nBEGIN\n    IF height_cm IS NULL OR weight_kg IS NULL OR height_cm <= 0 OR weight_kg <= 0 THEN\n        RETURN NULL;\n    END IF;\n    -- BMI = weight (kg) / (height (m))^2\n    RETURN ROUND((weight_kg / POWER(height_cm / 100.0, 2))::DECIMAL, 2);\nEND;\n$$ LANGUAGE plpgsql IMMUTABLE","-- Optional: Trigger to auto-calculate BMI when height or weight changes\nCREATE OR REPLACE FUNCTION update_lead_bmi()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF NEW.height IS NOT NULL AND NEW.weight IS NOT NULL THEN\n        NEW.bmi = calculate_bmi(NEW.height, NEW.weight);\n    END IF;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","CREATE TRIGGER calculate_bmi_trigger\n    BEFORE INSERT OR UPDATE OF height, weight ON leads\n    FOR EACH ROW\n    EXECUTE FUNCTION update_lead_bmi()","-- =====================================================\n-- 9. COMMENTS (Documentation)\n-- =====================================================\n\nCOMMENT ON TABLE profiles IS 'User profiles linked to auth.users, manages roles and user metadata'","COMMENT ON TABLE leads IS 'Central entity for CRM leads/trainees with flexible JSONB columns for dynamic data'","COMMENT ON COLUMN leads.daily_protocol IS 'JSONB: { \\"stepsGoal\\": number, \\"workoutGoal\\": number, \\"supplements\\": string[] }'","COMMENT ON COLUMN leads.workout_history IS 'JSONB: Array of workout program objects with dates, splits, and descriptions'","COMMENT ON COLUMN leads.steps_history IS 'JSONB: Array of step tracking objects with week numbers, dates, and targets'","COMMENT ON COLUMN leads.subscription_data IS 'JSONB: Flexible subscription information including pricing and package details'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	initial_schema
20240102000000	{"-- =====================================================\n-- Ensure Leads Table Exists\n-- Created: 2024-01-02\n-- Description: This migration ensures the leads table exists\n--              and is properly accessible in the public schema\n-- =====================================================\n\n-- Ensure we're working in the public schema\nSET search_path TO public","-- Drop table if it exists (only if you want to recreate it)\n-- Uncomment the next line if you need to recreate the table\n-- DROP TABLE IF EXISTS leads CASCADE;\n\n-- Create the leads table if it doesn't exist\nCREATE TABLE IF NOT EXISTS public.leads (\n    -- Meta Data\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    assigned_to UUID REFERENCES public.profiles(id) ON DELETE SET NULL,\n    \n    -- Personal Info\n    full_name TEXT NOT NULL,\n    phone TEXT UNIQUE NOT NULL,\n    email TEXT,\n    city TEXT,\n    birth_date DATE,\n    gender TEXT CHECK (gender IN ('male', 'female', 'other')) DEFAULT NULL,\n    \n    -- Status Management\n    status_main TEXT,\n    status_sub TEXT,\n    \n    -- Physical Metrics\n    height DECIMAL(5, 2), -- in cm\n    weight DECIMAL(5, 2), -- in kg\n    bmi DECIMAL(4, 2), -- calculated or stored\n    \n    -- Business/Subscription\n    join_date TIMESTAMP WITH TIME ZONE,\n    subscription_data JSONB DEFAULT '{}'::jsonb,\n    \n    -- Dynamic Data Columns (JSONB for flexibility)\n    daily_protocol JSONB DEFAULT '{}'::jsonb,\n    workout_history JSONB DEFAULT '[]'::jsonb,\n    steps_history JSONB DEFAULT '[]'::jsonb,\n    \n    -- Additional fields from the application\n    source TEXT,\n    fitness_goal TEXT,\n    activity_level TEXT,\n    preferred_time TEXT,\n    notes TEXT\n)","-- Ensure the table is in the public schema\nALTER TABLE IF EXISTS public.leads SET SCHEMA public","-- Grant necessary permissions\nGRANT ALL ON public.leads TO authenticated","GRANT ALL ON public.leads TO anon","GRANT ALL ON public.leads TO service_role","-- Create indexes if they don't exist\nCREATE INDEX IF NOT EXISTS idx_leads_assigned_to ON public.leads(assigned_to)","CREATE INDEX IF NOT EXISTS idx_leads_status_main ON public.leads(status_main)","CREATE INDEX IF NOT EXISTS idx_leads_status_sub ON public.leads(status_sub)","CREATE INDEX IF NOT EXISTS idx_leads_phone ON public.leads(phone)","CREATE INDEX IF NOT EXISTS idx_leads_email ON public.leads(email)","CREATE INDEX IF NOT EXISTS idx_leads_created_at ON public.leads(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_leads_join_date ON public.leads(join_date)","-- GIN indexes for JSONB columns\nCREATE INDEX IF NOT EXISTS idx_leads_daily_protocol ON public.leads USING GIN (daily_protocol)","CREATE INDEX IF NOT EXISTS idx_leads_workout_history ON public.leads USING GIN (workout_history)","CREATE INDEX IF NOT EXISTS idx_leads_steps_history ON public.leads USING GIN (steps_history)","CREATE INDEX IF NOT EXISTS idx_leads_subscription_data ON public.leads USING GIN (subscription_data)","-- Ensure the update_updated_at_column function exists\nCREATE OR REPLACE FUNCTION public.update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Create trigger for auto-updating updated_at\nDROP TRIGGER IF EXISTS update_leads_updated_at ON public.leads","CREATE TRIGGER update_leads_updated_at\n    BEFORE UPDATE ON public.leads\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- Ensure BMI calculation function exists\nCREATE OR REPLACE FUNCTION public.calculate_bmi(height_cm DECIMAL, weight_kg DECIMAL)\nRETURNS DECIMAL AS $$\nBEGIN\n    IF height_cm IS NULL OR weight_kg IS NULL OR height_cm <= 0 OR weight_kg <= 0 THEN\n        RETURN NULL;\n    END IF;\n    RETURN ROUND((weight_kg / POWER(height_cm / 100.0, 2))::DECIMAL, 2);\nEND;\n$$ LANGUAGE plpgsql IMMUTABLE","-- Create trigger for auto-calculating BMI\nDROP TRIGGER IF EXISTS calculate_bmi_trigger ON public.leads","CREATE OR REPLACE FUNCTION public.update_lead_bmi()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF NEW.height IS NOT NULL AND NEW.weight IS NOT NULL THEN\n        NEW.bmi = public.calculate_bmi(NEW.height, NEW.weight);\n    END IF;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","CREATE TRIGGER calculate_bmi_trigger\n    BEFORE INSERT OR UPDATE OF height, weight ON public.leads\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_lead_bmi()","-- Enable RLS\nALTER TABLE public.leads ENABLE ROW LEVEL SECURITY","-- Drop existing policies if they exist (to avoid conflicts)\nDROP POLICY IF EXISTS \\"Authenticated users can read leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Authenticated users can insert leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Users can update assigned leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Admins have full access to leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Users can delete assigned leads\\" ON public.leads","-- Recreate RLS policies\nCREATE POLICY \\"Authenticated users can read leads\\"\n    ON public.leads FOR SELECT\n    USING (auth.role() = 'authenticated')","CREATE POLICY \\"Authenticated users can insert leads\\"\n    ON public.leads FOR INSERT\n    WITH CHECK (auth.role() = 'authenticated')","CREATE POLICY \\"Users can update assigned leads\\"\n    ON public.leads FOR UPDATE\n    USING (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","CREATE POLICY \\"Admins have full access to leads\\"\n    ON public.leads FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","CREATE POLICY \\"Users can delete assigned leads\\"\n    ON public.leads FOR DELETE\n    USING (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Add comment for documentation\nCOMMENT ON TABLE public.leads IS 'Central entity for CRM leads/trainees with flexible JSONB columns for dynamic data'"}	ensure_leads_table
20240102000001	{"-- =====================================================\n-- Fix RLS Infinite Recursion Issue\n-- Created: 2024-01-02\n-- Description: Fixes the infinite recursion in profiles RLS policies\n-- =====================================================\n\n-- Drop the problematic admin policy on profiles that causes recursion\nDROP POLICY IF EXISTS \\"Admins have full access to profiles\\" ON public.profiles","-- Create a security definer function to check admin role (bypasses RLS)\nCREATE OR REPLACE FUNCTION public.is_admin(user_id UUID)\nRETURNS BOOLEAN AS $$\nBEGIN\n    RETURN EXISTS (\n        SELECT 1 FROM public.profiles\n        WHERE id = user_id AND role = 'admin'\n    );\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Recreate the admin policy using the function (avoids recursion)\nCREATE POLICY \\"Admins have full access to profiles\\"\n    ON public.profiles FOR ALL\n    USING (public.is_admin(auth.uid()))\n    WITH CHECK (public.is_admin(auth.uid()))","-- Also fix the leads policies to use the function\nDROP POLICY IF EXISTS \\"Users can update assigned leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Admins have full access to leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Users can delete assigned leads\\" ON public.leads","-- Recreate leads policies using the function\nCREATE POLICY \\"Users can update assigned leads\\"\n    ON public.leads FOR UPDATE\n    USING (\n        assigned_to = auth.uid() OR\n        public.is_admin(auth.uid())\n    )\n    WITH CHECK (\n        assigned_to = auth.uid() OR\n        public.is_admin(auth.uid())\n    )","CREATE POLICY \\"Admins have full access to leads\\"\n    ON public.leads FOR ALL\n    USING (public.is_admin(auth.uid()))\n    WITH CHECK (public.is_admin(auth.uid()))","CREATE POLICY \\"Users can delete assigned leads\\"\n    ON public.leads FOR DELETE\n    USING (\n        assigned_to = auth.uid() OR\n        public.is_admin(auth.uid())\n    )","-- For local development, also allow anonymous access to insert leads\n-- (Remove this in production or adjust based on your needs)\nDROP POLICY IF EXISTS \\"Allow anonymous insert leads\\" ON public.leads","CREATE POLICY \\"Allow anonymous insert leads\\"\n    ON public.leads FOR INSERT\n    TO anon\n    WITH CHECK (true)","DROP POLICY IF EXISTS \\"Allow anonymous read leads\\" ON public.leads","CREATE POLICY \\"Allow anonymous read leads\\"\n    ON public.leads FOR SELECT\n    TO anon\n    USING (true)"}	fix_rls_recursion
20240102000002	{"-- =====================================================\n-- Workout Plans Migration\n-- Created: 2024-01-02\n-- Description: User workout plans with dynamic custom attributes\n-- =====================================================\n\n-- =====================================================\n-- TABLE: workout_plans\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS workout_plans (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    \n    -- Standard fields\n    start_date DATE NOT NULL,\n    description TEXT,\n    \n    -- Metric columns\n    strength INTEGER DEFAULT 0,\n    cardio INTEGER DEFAULT 0,\n    intervals INTEGER DEFAULT 0,\n    \n    -- Dynamic custom attributes (JSONB)\n    -- Structure: { \\"schema\\": [{ \\"fieldName\\": \\"string\\", \\"fieldType\\": \\"text|number|date|boolean\\" }], \\"data\\": { \\"fieldName\\": \\"value\\" } }\n    custom_attributes JSONB DEFAULT '{\\"schema\\": [], \\"data\\": {}}'::jsonb,\n    \n    -- Metadata\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_workout_plans_user_id ON workout_plans(user_id)","CREATE INDEX IF NOT EXISTS idx_workout_plans_lead_id ON workout_plans(lead_id)","CREATE INDEX IF NOT EXISTS idx_workout_plans_start_date ON workout_plans(start_date DESC)","CREATE INDEX IF NOT EXISTS idx_workout_plans_created_at ON workout_plans(created_at DESC)","-- GIN index for JSONB column (enables fast queries on JSONB data)\nCREATE INDEX IF NOT EXISTS idx_workout_plans_custom_attributes ON workout_plans USING GIN (custom_attributes)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_workout_plans_updated_at\n    BEFORE UPDATE ON workout_plans\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on workout_plans table\nALTER TABLE workout_plans ENABLE ROW LEVEL SECURITY","-- Policy: Users can read their own workout plans\nCREATE POLICY \\"Users can read own workout plans\\"\n    ON workout_plans FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own workout plans\nCREATE POLICY \\"Users can insert own workout plans\\"\n    ON workout_plans FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own workout plans\nCREATE POLICY \\"Users can update own workout plans\\"\n    ON workout_plans FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own workout plans\nCREATE POLICY \\"Users can delete own workout plans\\"\n    ON workout_plans FOR DELETE\n    USING (auth.uid() = user_id)","-- Policy: Admins have full access to workout plans\nCREATE POLICY \\"Admins have full access to workout plans\\"\n    ON workout_plans FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )"}	workout_plans
20240102000003	{"-- =====================================================\n-- Remove Weight and RPE from Workout Plans\n-- Created: 2024-01-02\n-- Description: Clean up JSONB data to remove weight and rpe fields from exercises\n-- =====================================================\n\n-- Update existing workout plans to remove weight and rpe from exercises in JSONB\n-- This function processes each workout plan and removes weight/rpe from all exercises\nDO $$\nDECLARE\n    plan_record RECORD;\n    updated_days JSONB;\n    day_key TEXT;\n    day_data JSONB;\n    updated_exercises JSONB;\n    exercise JSONB;\nBEGIN\n    FOR plan_record IN \n        SELECT id, custom_attributes \n        FROM workout_plans \n        WHERE custom_attributes->'data'->'weeklyWorkout'->'days' IS NOT NULL\n    LOOP\n        updated_days := '{}'::JSONB;\n        \n        -- Process each day\n        FOR day_key, day_data IN \n            SELECT * FROM jsonb_each(plan_record.custom_attributes->'data'->'weeklyWorkout'->'days')\n        LOOP\n            -- Process exercises in this day - remove weight and rpe fields\n            updated_exercises := (\n                SELECT jsonb_agg(exercise - 'weight' - 'rpe')\n                FROM jsonb_array_elements(day_data->'exercises') AS exercise\n            );\n            \n            -- Update day with cleaned exercises\n            day_data := jsonb_set(day_data, '{exercises}', COALESCE(updated_exercises, '[]'::JSONB));\n            updated_days := updated_days || jsonb_build_object(day_key, day_data);\n        END LOOP;\n        \n        -- Update the workout plan\n        UPDATE workout_plans\n        SET custom_attributes = jsonb_set(\n            plan_record.custom_attributes,\n            '{data,weeklyWorkout,days}',\n            updated_days\n        )\n        WHERE id = plan_record.id;\n    END LOOP;\nEND $$","-- Note: Since weight and rpe are stored in JSONB (not as table columns),\n-- we only need to clean the JSONB data. No columns need to be dropped from the table."}	remove_weight_rpe_from_workout_plans
20240102000004	{"-- =====================================================\n-- Saved Views Migration\n-- Created: 2024-01-02\n-- Description: Table for storing user-defined saved views/filters for resources\n-- =====================================================\n\n-- =====================================================\n-- TABLE: saved_views\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS saved_views (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    resource_key TEXT NOT NULL CHECK (resource_key IN ('leads', 'workouts', 'customers')),\n    view_name TEXT NOT NULL,\n    filter_config JSONB NOT NULL DEFAULT '{}'::JSONB,\n    is_default BOOLEAN NOT NULL DEFAULT FALSE,\n    created_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    \n    -- Ensure unique view names per resource per user\n    CONSTRAINT unique_view_name_per_resource_user \n        UNIQUE (resource_key, created_by, view_name)\n)","-- Indexes for faster queries\nCREATE INDEX IF NOT EXISTS idx_saved_views_resource_key ON saved_views(resource_key)","CREATE INDEX IF NOT EXISTS idx_saved_views_created_by ON saved_views(created_by)","CREATE INDEX IF NOT EXISTS idx_saved_views_resource_user ON saved_views(resource_key, created_by)","CREATE INDEX IF NOT EXISTS idx_saved_views_default ON saved_views(resource_key, created_by, is_default) WHERE is_default = TRUE","-- Unique partial index to ensure only one default view per resource per user\nCREATE UNIQUE INDEX IF NOT EXISTS idx_saved_views_unique_default \n    ON saved_views(resource_key, created_by) \n    WHERE is_default = TRUE","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_saved_views_updated_at\n    BEFORE UPDATE ON saved_views\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS)\n-- =====================================================\n\n-- Enable RLS\nALTER TABLE saved_views ENABLE ROW LEVEL SECURITY","-- Policy: Users can view their own saved views\nCREATE POLICY \\"Users can view their own saved views\\"\n    ON saved_views\n    FOR SELECT\n    USING (auth.uid() = created_by)","-- Policy: Users can insert their own saved views\nCREATE POLICY \\"Users can insert their own saved views\\"\n    ON saved_views\n    FOR INSERT\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can update their own saved views\nCREATE POLICY \\"Users can update their own saved views\\"\n    ON saved_views\n    FOR UPDATE\n    USING (auth.uid() = created_by)\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can delete their own saved views\nCREATE POLICY \\"Users can delete their own saved views\\"\n    ON saved_views\n    FOR DELETE\n    USING (auth.uid() = created_by)","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE saved_views IS 'User-defined saved views/filters for different resources (leads, workouts, etc.)'","COMMENT ON COLUMN saved_views.resource_key IS 'The resource type this view applies to (e.g., \\"leads\\", \\"workouts\\")'","COMMENT ON COLUMN saved_views.view_name IS 'User-friendly name for the saved view'","COMMENT ON COLUMN saved_views.filter_config IS 'JSONB object storing the complete filter/sort state for this view'","COMMENT ON COLUMN saved_views.is_default IS 'Whether this is the default view for the resource (only one default per resource per user)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	saved_views
20240102000005	{"-- =====================================================\n-- Workout Templates Migration\n-- Created: 2024-01-02\n-- Description: Reusable workout templates that can be imported by users\n-- =====================================================\n\n-- =====================================================\n-- TABLE: workout_templates\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS workout_templates (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    name TEXT NOT NULL,\n    description TEXT,\n    goal_tags TEXT[] DEFAULT '{}',\n    routine_data JSONB NOT NULL DEFAULT '{}'::jsonb,\n    is_public BOOLEAN NOT NULL DEFAULT FALSE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_workout_templates_created_by ON workout_templates(created_by)","CREATE INDEX IF NOT EXISTS idx_workout_templates_is_public ON workout_templates(is_public)","CREATE INDEX IF NOT EXISTS idx_workout_templates_goal_tags ON workout_templates USING GIN (goal_tags)","CREATE INDEX IF NOT EXISTS idx_workout_templates_routine_data ON workout_templates USING GIN (routine_data)","CREATE INDEX IF NOT EXISTS idx_workout_templates_created_at ON workout_templates(created_at DESC)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_workout_templates_updated_at\n    BEFORE UPDATE ON workout_templates\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on workout_templates table\nALTER TABLE workout_templates ENABLE ROW LEVEL SECURITY","-- Policy: Users can view public templates or their own templates\nCREATE POLICY \\"Users can view public or own templates\\"\n    ON workout_templates FOR SELECT\n    USING (\n        is_public = TRUE OR \n        created_by = auth.uid()\n    )","-- Policy: Users can insert their own templates\nCREATE POLICY \\"Users can insert own templates\\"\n    ON workout_templates FOR INSERT\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can update their own templates\nCREATE POLICY \\"Users can update own templates\\"\n    ON workout_templates FOR UPDATE\n    USING (auth.uid() = created_by)\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can delete their own templates\nCREATE POLICY \\"Users can delete own templates\\"\n    ON workout_templates FOR DELETE\n    USING (auth.uid() = created_by)","-- Policy: Admins have full access to templates\nCREATE POLICY \\"Admins have full access to templates\\"\n    ON workout_templates FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE workout_templates IS 'Reusable workout templates that can be imported by users to create workout plans'","COMMENT ON COLUMN workout_templates.name IS 'Template name'","COMMENT ON COLUMN workout_templates.description IS 'Template description'","COMMENT ON COLUMN workout_templates.goal_tags IS 'Array of goal tags (e.g., [\\"חיטוב\\", \\"כוח\\", \\"סיבולת\\"])'","COMMENT ON COLUMN workout_templates.routine_data IS 'JSONB containing the workout routine data (matches workout_plans.custom_attributes.data.weeklyWorkout schema)'","COMMENT ON COLUMN workout_templates.is_public IS 'Whether the template is publicly visible to all users'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	workout_templates
20240102000006	{"-- =====================================================\n-- Add 'templates' to saved_views resource_key constraint\n-- Created: 2024-01-02\n-- Description: Allow saved views for workout templates\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'templates'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_templates_to_saved_views
20240102000007	{"-- =====================================================\n-- Add template_id to workout_plans\n-- Created: 2024-01-02\n-- Description: Track which template a workout plan was created from (reference only, snapshot pattern maintained)\n-- =====================================================\n\n-- Add template_id column (nullable, just for reference)\nALTER TABLE workout_plans\nADD COLUMN IF NOT EXISTS template_id UUID REFERENCES workout_templates(id) ON DELETE SET NULL","-- Create index for performance\nCREATE INDEX IF NOT EXISTS idx_workout_plans_template_id ON workout_plans(template_id)","-- Note: This is a reference only. The actual routine_data is stored in workout_plans.custom_attributes\n-- When a template is changed, existing workout_plans remain independent (snapshot pattern)"}	add_template_id_to_workout_plans
20240102000008	{"-- =====================================================\n-- Nutrition Templates Migration\n-- Created: 2024-01-02\n-- Description: Reusable nutrition templates for macro-nutrient planning and calculation\n-- =====================================================\n\n-- =====================================================\n-- TABLE: nutrition_templates\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS nutrition_templates (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    name TEXT NOT NULL,\n    description TEXT,\n    targets JSONB NOT NULL DEFAULT '{}'::jsonb,\n    -- Structure: { calories: number, protein: number, carbs: number, fat: number, fiber: number }\n    is_public BOOLEAN NOT NULL DEFAULT FALSE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_nutrition_templates_created_by ON nutrition_templates(created_by)","CREATE INDEX IF NOT EXISTS idx_nutrition_templates_is_public ON nutrition_templates(is_public)","CREATE INDEX IF NOT EXISTS idx_nutrition_templates_targets ON nutrition_templates USING GIN (targets)","CREATE INDEX IF NOT EXISTS idx_nutrition_templates_created_at ON nutrition_templates(created_at DESC)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_nutrition_templates_updated_at\n    BEFORE UPDATE ON nutrition_templates\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on nutrition_templates table\nALTER TABLE nutrition_templates ENABLE ROW LEVEL SECURITY","-- Policy: Users can view public templates or their own templates\nCREATE POLICY \\"Users can view public or own nutrition templates\\"\n    ON nutrition_templates FOR SELECT\n    USING (\n        is_public = TRUE OR \n        created_by = auth.uid()\n    )","-- Policy: Users can insert their own templates\nCREATE POLICY \\"Users can insert own nutrition templates\\"\n    ON nutrition_templates FOR INSERT\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can update their own templates\nCREATE POLICY \\"Users can update own nutrition templates\\"\n    ON nutrition_templates FOR UPDATE\n    USING (auth.uid() = created_by)\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can delete their own templates\nCREATE POLICY \\"Users can delete own nutrition templates\\"\n    ON nutrition_templates FOR DELETE\n    USING (auth.uid() = created_by)","-- Policy: Admins have full access to templates\nCREATE POLICY \\"Admins have full access to nutrition templates\\"\n    ON nutrition_templates FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE nutrition_templates IS 'Reusable nutrition templates for macro-nutrient planning and calculation'","COMMENT ON COLUMN nutrition_templates.name IS 'Template name'","COMMENT ON COLUMN nutrition_templates.description IS 'Template description'","COMMENT ON COLUMN nutrition_templates.targets IS 'JSONB containing macro targets: { calories: number, protein: number, carbs: number, fat: number, fiber: number }'","COMMENT ON COLUMN nutrition_templates.is_public IS 'Whether the template is publicly visible to all users'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	nutrition_templates
20240102000009	{"-- =====================================================\n-- Nutrition Plans Migration\n-- Created: 2024-01-02\n-- Description: User nutrition plans linked to leads (snapshot pattern - independent from templates)\n-- =====================================================\n\n-- =====================================================\n-- TABLE: nutrition_plans\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS nutrition_plans (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    template_id UUID REFERENCES nutrition_templates(id) ON DELETE SET NULL,\n    \n    -- Standard fields\n    start_date DATE NOT NULL,\n    description TEXT,\n    \n    -- Nutrition targets (snapshot - independent from template)\n    -- Structure: { calories: number, protein: number, carbs: number, fat: number, fiber: number }\n    targets JSONB NOT NULL DEFAULT '{}'::jsonb,\n    \n    -- Metadata\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_nutrition_plans_user_id ON nutrition_plans(user_id)","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_lead_id ON nutrition_plans(lead_id)","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_template_id ON nutrition_plans(template_id)","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_start_date ON nutrition_plans(start_date DESC)","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_created_at ON nutrition_plans(created_at DESC)","-- GIN index for JSONB column (enables fast queries on JSONB data)\nCREATE INDEX IF NOT EXISTS idx_nutrition_plans_targets ON nutrition_plans USING GIN (targets)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_nutrition_plans_updated_at\n    BEFORE UPDATE ON nutrition_plans\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on nutrition_plans table\nALTER TABLE nutrition_plans ENABLE ROW LEVEL SECURITY","-- Policy: Users can read their own nutrition plans\nCREATE POLICY \\"Users can read own nutrition plans\\"\n    ON nutrition_plans FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own nutrition plans\nCREATE POLICY \\"Users can insert own nutrition plans\\"\n    ON nutrition_plans FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own nutrition plans\nCREATE POLICY \\"Users can update own nutrition plans\\"\n    ON nutrition_plans FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own nutrition plans\nCREATE POLICY \\"Users can delete own nutrition plans\\"\n    ON nutrition_plans FOR DELETE\n    USING (auth.uid() = user_id)","-- Policy: Admins have full access to nutrition plans\nCREATE POLICY \\"Admins have full access to nutrition plans\\"\n    ON nutrition_plans FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE nutrition_plans IS 'User nutrition plans linked to leads (snapshot pattern - independent from templates)'","COMMENT ON COLUMN nutrition_plans.lead_id IS 'Reference to the lead this plan is assigned to'","COMMENT ON COLUMN nutrition_plans.template_id IS 'Reference to the template this plan was created from (for tracking only, changes to template do not affect this plan)'","COMMENT ON COLUMN nutrition_plans.targets IS 'JSONB containing macro targets: { calories: number, protein: number, carbs: number, fat: number, fiber: number } - This is a snapshot, independent from the template'","COMMENT ON COLUMN nutrition_plans.start_date IS 'Date when the nutrition plan starts'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	nutrition_plans
20240102000010	{"-- =====================================================\n-- Add 'nutrition_templates' to saved_views resource_key constraint\n-- Created: 2024-01-02\n-- Description: Allow saved views for nutrition templates\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'nutrition_templates'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_nutrition_templates_to_saved_views
20240102000011	{"-- =====================================================\n-- Add history tracking to workout_plans\n-- Created: 2024-01-02\n-- Description: Add is_active and deleted_at fields to track workout plan history\n-- =====================================================\n\n-- Add is_active and deleted_at columns\nALTER TABLE workout_plans\n  ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true NOT NULL,\n  ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMP WITH TIME ZONE","-- Create index for active plans\nCREATE INDEX IF NOT EXISTS idx_workout_plans_is_active ON workout_plans(is_active) WHERE is_active = true","CREATE INDEX IF NOT EXISTS idx_workout_plans_deleted_at ON workout_plans(deleted_at) WHERE deleted_at IS NOT NULL","-- Update existing plans to be active\nUPDATE workout_plans SET is_active = true WHERE is_active IS NULL","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_workout_plan_history
20240102000012	{"-- =====================================================\n-- Normalize Database: Separate Customers from Leads\n-- Created: 2024-01-02\n-- Description: Create customers table and normalize leads table\n--              Decouple Identity (Customer) from Opportunity (Lead)\n--              Unique identifier: phone number\n-- =====================================================\n\n-- =====================================================\n-- STEP A: Create customers table\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS public.customers (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    full_name TEXT NOT NULL,\n    phone TEXT NOT NULL UNIQUE,\n    email TEXT,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL\n)","-- Create indexes for customers\nCREATE INDEX IF NOT EXISTS idx_customers_phone ON public.customers(phone)","CREATE INDEX IF NOT EXISTS idx_customers_email ON public.customers(email)","CREATE INDEX IF NOT EXISTS idx_customers_created_at ON public.customers(created_at DESC)","-- Create trigger for auto-updating updated_at\nCREATE TRIGGER update_customers_updated_at\n    BEFORE UPDATE ON public.customers\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- Enable RLS on customers table\nALTER TABLE public.customers ENABLE ROW LEVEL SECURITY","-- RLS Policies for customers\nDROP POLICY IF EXISTS \\"Authenticated users can read customers\\" ON public.customers","DROP POLICY IF EXISTS \\"Authenticated users can insert customers\\" ON public.customers","DROP POLICY IF EXISTS \\"Authenticated users can update customers\\" ON public.customers","DROP POLICY IF EXISTS \\"Admins have full access to customers\\" ON public.customers","CREATE POLICY \\"Authenticated users can read customers\\"\n    ON public.customers FOR SELECT\n    USING (auth.role() = 'authenticated')","CREATE POLICY \\"Authenticated users can insert customers\\"\n    ON public.customers FOR INSERT\n    WITH CHECK (auth.role() = 'authenticated')","CREATE POLICY \\"Authenticated users can update customers\\"\n    ON public.customers FOR UPDATE\n    USING (auth.role() = 'authenticated')\n    WITH CHECK (auth.role() = 'authenticated')","CREATE POLICY \\"Admins have full access to customers\\"\n    ON public.customers FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- STEP B: Data Migration (Backfill Script)\n-- =====================================================\n-- Since we're resetting the DB, this step is not needed\n-- But we'll include it for completeness in case of future migrations\n\n-- This would migrate existing data if needed:\n-- INSERT INTO public.customers (full_name, phone, email, created_at, updated_at)\n-- SELECT DISTINCT ON (phone)\n--     full_name,\n--     phone,\n--     email,\n--     MIN(created_at) as created_at,\n--     NOW() as updated_at\n-- FROM public.leads\n-- WHERE phone IS NOT NULL\n-- GROUP BY phone, full_name, email\n-- ON CONFLICT (phone) DO NOTHING;\n\n-- =====================================================\n-- STEP C: Update leads table\n-- =====================================================\n\n-- Add customer_id column\nALTER TABLE public.leads\n    ADD COLUMN IF NOT EXISTS customer_id UUID REFERENCES public.customers(id) ON DELETE CASCADE","-- Create index for customer_id\nCREATE INDEX IF NOT EXISTS idx_leads_customer_id ON public.leads(customer_id)","-- Link existing data (if any exists)\n-- UPDATE public.leads l\n-- SET customer_id = c.id\n-- FROM public.customers c\n-- WHERE l.phone = c.phone;\n\n-- Make customer_id NOT NULL (since we're resetting, we can set it immediately)\nALTER TABLE public.leads ALTER COLUMN customer_id SET NOT NULL","-- Remove old columns (since we're resetting, we can drop them immediately)\nALTER TABLE public.leads\n    DROP COLUMN IF EXISTS full_name,\n    DROP COLUMN IF EXISTS phone,\n    DROP COLUMN IF EXISTS email","-- Drop old indexes that are no longer needed\nDROP INDEX IF EXISTS public.idx_leads_phone","DROP INDEX IF EXISTS public.idx_leads_email","-- Add comment for documentation\nCOMMENT ON TABLE public.customers IS 'Customer identity table - unique by phone number'","COMMENT ON COLUMN public.customers.phone IS 'Unique identifier for customer identity'","COMMENT ON TABLE public.leads IS 'Lead/Opportunity table - linked to customers via customer_id'","COMMENT ON COLUMN public.leads.customer_id IS 'Foreign key to customers table - one customer can have many leads'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	normalize_customers_leads
20240102000013	{"-- =====================================================\n-- Add 'customers' to saved_views resource_key constraint\n-- Created: 2024-01-02\n-- Description: Allow saved views for customers\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'customers'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_customers_to_saved_views
20240102000014	{"-- =====================================================\n-- Service Data Relocation: Move Coaching Data from Leads to Customers\n-- Created: 2024-01-02\n-- Description: Relocate ownership of coaching data (Workouts, Nutrition, Steps, Measurements)\n--              from Lead entity to Customer entity\n-- Philosophy: Lead = Sales/CRM, Customer = Service/Coaching\n-- =====================================================\n\n-- =====================================================\n-- STEP A: Add customer_id to service tables\n-- =====================================================\n\n-- Add customer_id to workout_plans\nALTER TABLE workout_plans\n    ADD COLUMN IF NOT EXISTS customer_id UUID REFERENCES customers(id) ON DELETE CASCADE","-- Add customer_id to nutrition_plans\nALTER TABLE nutrition_plans\n    ADD COLUMN IF NOT EXISTS customer_id UUID REFERENCES customers(id) ON DELETE CASCADE","-- Create indexes for customer_id\nCREATE INDEX IF NOT EXISTS idx_workout_plans_customer_id ON workout_plans(customer_id)","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_customer_id ON nutrition_plans(customer_id)","-- =====================================================\n-- STEP B: Migrate existing data (populate customer_id from lead_id)\n-- =====================================================\n\n-- Migrate workout_plans: Set customer_id based on lead_id -> customer_id relationship\nUPDATE workout_plans wp\nSET customer_id = l.customer_id\nFROM leads l\nWHERE wp.lead_id = l.id\n  AND wp.customer_id IS NULL\n  AND l.customer_id IS NOT NULL","-- Migrate nutrition_plans: Set customer_id based on lead_id -> customer_id relationship\nUPDATE nutrition_plans np\nSET customer_id = l.customer_id\nFROM leads l\nWHERE np.lead_id = l.id\n  AND np.customer_id IS NULL\n  AND l.customer_id IS NOT NULL","-- Handle orphaned records: Delete workout_plans that can't be linked to a customer\n-- (These are orphaned records with invalid lead_id references or NULL lead_id)\n-- First, try to find customer_id through any remaining valid lead relationships\nUPDATE workout_plans wp\nSET customer_id = l.customer_id\nFROM leads l\nWHERE wp.lead_id = l.id\n  AND wp.customer_id IS NULL\n  AND l.customer_id IS NOT NULL","-- Now delete any remaining orphaned records that still have NULL customer_id\nDELETE FROM workout_plans\nWHERE customer_id IS NULL","-- Handle orphaned records: Delete nutrition_plans that can't be linked to a customer\n-- First, try to find customer_id through any remaining valid lead relationships\nUPDATE nutrition_plans np\nSET customer_id = l.customer_id\nFROM leads l\nWHERE np.lead_id = l.id\n  AND np.customer_id IS NULL\n  AND l.customer_id IS NOT NULL","-- Now delete any remaining orphaned records that still have NULL customer_id\nDELETE FROM nutrition_plans\nWHERE customer_id IS NULL","-- =====================================================\n-- STEP C: Add coaching data columns to customers table\n-- =====================================================\n\n-- Add coaching data JSONB columns to customers\nALTER TABLE customers\n    ADD COLUMN IF NOT EXISTS daily_protocol JSONB DEFAULT '{}'::jsonb,\n    ADD COLUMN IF NOT EXISTS workout_history JSONB DEFAULT '[]'::jsonb,\n    ADD COLUMN IF NOT EXISTS steps_history JSONB DEFAULT '[]'::jsonb","-- Create GIN indexes for JSONB columns\nCREATE INDEX IF NOT EXISTS idx_customers_daily_protocol ON customers USING GIN (daily_protocol)","CREATE INDEX IF NOT EXISTS idx_customers_workout_history ON customers USING GIN (workout_history)","CREATE INDEX IF NOT EXISTS idx_customers_steps_history ON customers USING GIN (steps_history)","-- =====================================================\n-- STEP D: Migrate coaching data from leads to customers\n-- =====================================================\n\n-- Migrate daily_protocol, workout_history, steps_history from leads to customers\n-- Aggregate data per customer (in case of multiple leads per customer)\n-- Note: Since we're resetting the DB, this migration step is mainly for documentation\n-- In a production migration, you would aggregate data from all leads per customer\nUPDATE customers c\nSET \n    daily_protocol = COALESCE(\n        (SELECT daily_protocol FROM leads WHERE customer_id = c.id AND daily_protocol IS NOT NULL AND daily_protocol != '{}'::jsonb ORDER BY created_at DESC LIMIT 1),\n        '{}'::jsonb\n    ),\n    workout_history = COALESCE(\n        (\n            SELECT jsonb_agg(DISTINCT elem)\n            FROM leads l, jsonb_array_elements(l.workout_history) elem\n            WHERE l.customer_id = c.id \n              AND l.workout_history IS NOT NULL \n              AND l.workout_history != '[]'::jsonb\n        ),\n        '[]'::jsonb\n    ),\n    steps_history = COALESCE(\n        (\n            SELECT jsonb_agg(DISTINCT elem)\n            FROM leads l, jsonb_array_elements(l.steps_history) elem\n            WHERE l.customer_id = c.id \n              AND l.steps_history IS NOT NULL \n              AND l.steps_history != '[]'::jsonb\n        ),\n        '[]'::jsonb\n    )\nWHERE EXISTS (SELECT 1 FROM leads WHERE customer_id = c.id)","-- =====================================================\n-- STEP E: Make customer_id NOT NULL and deprecate lead_id\n-- =====================================================\n\n-- Verify all records have customer_id before setting NOT NULL\n-- (This should pass after orphaned records are deleted in Step B)\nDO $$\nBEGIN\n    -- Check for any remaining NULL customer_id values\n    IF EXISTS (SELECT 1 FROM workout_plans WHERE customer_id IS NULL) THEN\n        RAISE EXCEPTION 'Cannot set NOT NULL: workout_plans still contains NULL customer_id values. Please check orphaned records.';\n    END IF;\n    \n    IF EXISTS (SELECT 1 FROM nutrition_plans WHERE customer_id IS NULL) THEN\n        RAISE EXCEPTION 'Cannot set NOT NULL: nutrition_plans still contains NULL customer_id values. Please check orphaned records.';\n    END IF;\nEND $$","-- For workout_plans: Make customer_id required for new records (keep lead_id nullable for backward compatibility)\n-- Note: We keep lead_id for now but it's deprecated - new records should use customer_id\nALTER TABLE workout_plans\n    ALTER COLUMN customer_id SET NOT NULL","-- For nutrition_plans: Make customer_id required for new records\nALTER TABLE nutrition_plans\n    ALTER COLUMN customer_id SET NOT NULL","-- Drop the foreign key constraint on lead_id (we'll keep the column but remove the constraint)\n-- This allows us to keep historical data but prevents new relationships\nALTER TABLE workout_plans\n    DROP CONSTRAINT IF EXISTS workout_plans_lead_id_fkey","ALTER TABLE nutrition_plans\n    DROP CONSTRAINT IF EXISTS nutrition_plans_lead_id_fkey","-- Add comments to mark lead_id as deprecated\nCOMMENT ON COLUMN workout_plans.lead_id IS 'DEPRECATED: Use customer_id instead. This column is kept for historical data only.'","COMMENT ON COLUMN nutrition_plans.lead_id IS 'DEPRECATED: Use customer_id instead. This column is kept for historical data only.'","-- =====================================================\n-- STEP F: Update RLS policies to use customer_id\n-- =====================================================\n\n-- Note: RLS policies will need to be updated in application logic\n-- The policies currently check user_id, which is still valid\n-- We add customer-based policies for admin access\n\n-- Policy: Admins can read all workout plans by customer\nDROP POLICY IF EXISTS \\"Admins can read workout plans by customer\\" ON workout_plans","CREATE POLICY \\"Admins can read workout plans by customer\\"\n    ON workout_plans FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Admins can read all nutrition plans by customer\nDROP POLICY IF EXISTS \\"Admins can read nutrition plans by customer\\" ON nutrition_plans","CREATE POLICY \\"Admins can read nutrition plans by customer\\"\n    ON nutrition_plans FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- STEP G: Add comments for documentation\n-- =====================================================\n\nCOMMENT ON COLUMN customers.daily_protocol IS 'JSONB: { \\"stepsGoal\\": number, \\"workoutGoal\\": number, \\"supplements\\": string[] } - Coaching protocol data'","COMMENT ON COLUMN customers.workout_history IS 'JSONB: Array of workout program objects with dates, splits, and descriptions - Historical coaching data'","COMMENT ON COLUMN customers.steps_history IS 'JSONB: Array of step tracking objects with week numbers, dates, and targets - Historical coaching data'","COMMENT ON COLUMN workout_plans.customer_id IS 'Reference to the customer this workout plan belongs to (coaching data)'","COMMENT ON COLUMN nutrition_plans.customer_id IS 'Reference to the customer this nutrition plan belongs to (coaching data)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	relocate_service_data_to_customers
20240102000015	{"-- =====================================================\n-- Performance Optimization: Shift Left Strategy\n-- Created: 2024-01-02\n-- Description: Move filtering, calculations, and aggregations to PostgreSQL\n--              Replace client-side JS logic with database functions\n-- Philosophy: Database does the heavy lifting, frontend stays light\n-- =====================================================\n\n-- =====================================================\n-- STEP 1: Create Optimized Indexes (Strategic, not over-indexing)\n-- =====================================================\n\n-- Indexes for filtering columns (most common filters)\nCREATE INDEX IF NOT EXISTS idx_leads_status_main ON public.leads(status_main) WHERE status_main IS NOT NULL","CREATE INDEX IF NOT EXISTS idx_leads_status_sub ON public.leads(status_sub) WHERE status_sub IS NOT NULL","CREATE INDEX IF NOT EXISTS idx_leads_source ON public.leads(source) WHERE source IS NOT NULL","CREATE INDEX IF NOT EXISTS idx_leads_fitness_goal ON public.leads(fitness_goal) WHERE fitness_goal IS NOT NULL","CREATE INDEX IF NOT EXISTS idx_leads_activity_level ON public.leads(activity_level) WHERE activity_level IS NOT NULL","CREATE INDEX IF NOT EXISTS idx_leads_preferred_time ON public.leads(preferred_time) WHERE preferred_time IS NOT NULL","-- Note: Removed idx_leads_created_at_date - DATE() is not IMMUTABLE\n-- Use existing idx_leads_created_at index for date filtering instead\n\n-- Composite index for common filter combinations\nCREATE INDEX IF NOT EXISTS idx_leads_status_source ON public.leads(status_main, source) WHERE status_main IS NOT NULL AND source IS NOT NULL","-- Index for customer_id (already exists, but ensure it's there)\nCREATE INDEX IF NOT EXISTS idx_leads_customer_id ON public.leads(customer_id)","-- Index for birth_date (for age calculations)\nCREATE INDEX IF NOT EXISTS idx_leads_birth_date ON public.leads(birth_date) WHERE birth_date IS NOT NULL","-- Note: Removed idx_leads_created_at_date index\n-- DATE() function is not IMMUTABLE, so it can't be used in index expressions\n-- The existing idx_leads_created_at index on created_at (DESC) is sufficient for date filtering\n\n-- =====================================================\n-- STEP 2: Create View for Leads with Customer Data (Pre-joined)\n-- =====================================================\n\nCREATE OR REPLACE VIEW public.v_leads_with_customer AS\nSELECT \n    l.id,\n    l.created_at,\n    l.updated_at,\n    l.assigned_to,\n    l.customer_id,\n    l.city,\n    l.birth_date,\n    l.gender,\n    l.status_main,\n    l.status_sub,\n    l.height,\n    l.weight,\n    l.bmi,\n    l.join_date,\n    l.subscription_data,\n    l.daily_protocol,\n    l.workout_history,\n    l.steps_history,\n    l.source,\n    l.fitness_goal,\n    l.activity_level,\n    l.preferred_time,\n    l.notes,\n    -- Customer data (joined)\n    c.full_name as customer_name,\n    c.phone as customer_phone,\n    c.email as customer_email,\n    -- Calculated fields (PostgreSQL does the math)\n    EXTRACT(YEAR FROM AGE(l.birth_date))::INTEGER as age,\n    TO_CHAR(l.created_at, 'YYYY-MM-DD') as created_date_formatted,\n    TO_CHAR(l.birth_date, 'YYYY-MM-DD') as birth_date_formatted,\n    -- Extract JSONB fields (PostgreSQL parses JSON)\n    (l.daily_protocol->>'stepsGoal')::INTEGER as daily_steps_goal,\n    (l.daily_protocol->>'workoutGoal')::INTEGER as weekly_workouts,\n    -- Extract supplements array from JSONB (handle both array and null)\n    CASE \n        WHEN l.daily_protocol->'supplements' IS NULL THEN ARRAY[]::TEXT[]\n        WHEN jsonb_typeof(l.daily_protocol->'supplements') = 'array' \n        THEN ARRAY(SELECT jsonb_array_elements_text(l.daily_protocol->'supplements'))\n        ELSE ARRAY[]::TEXT[]\n    END as daily_supplements,\n    -- Extract subscription data\n    (l.subscription_data->>'months')::INTEGER as subscription_months,\n    (l.subscription_data->>'initialPrice')::DECIMAL as subscription_initial_price,\n    (l.subscription_data->>'renewalPrice')::DECIMAL as subscription_renewal_price\nFROM public.leads l\nINNER JOIN public.customers c ON l.customer_id = c.id","-- Grant access to authenticated users\nGRANT SELECT ON public.v_leads_with_customer TO authenticated","-- =====================================================\n-- STEP 3: Create RPC Function for Filtered Leads (Complex Filtering)\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.get_filtered_leads(\n    p_search_query TEXT DEFAULT NULL,\n    p_created_date DATE DEFAULT NULL,\n    p_status_main TEXT DEFAULT NULL,\n    p_status_sub TEXT DEFAULT NULL,\n    p_age TEXT DEFAULT NULL,\n    p_height TEXT DEFAULT NULL,\n    p_weight TEXT DEFAULT NULL,\n    p_fitness_goal TEXT DEFAULT NULL,\n    p_activity_level TEXT DEFAULT NULL,\n    p_preferred_time TEXT DEFAULT NULL,\n    p_source TEXT DEFAULT NULL,\n    p_limit_count INTEGER DEFAULT 1000,\n    p_offset_count INTEGER DEFAULT 0\n)\nRETURNS TABLE (\n    id UUID,\n    created_at TIMESTAMP WITH TIME ZONE,\n    updated_at TIMESTAMP WITH TIME ZONE,\n    customer_id UUID,\n    customer_name TEXT,\n    customer_phone TEXT,\n    customer_email TEXT,\n    status_main TEXT,\n    status_sub TEXT,\n    source TEXT,\n    fitness_goal TEXT,\n    activity_level TEXT,\n    preferred_time TEXT,\n    notes TEXT,\n    age INTEGER,\n    birth_date DATE,\n    birth_date_formatted TEXT,\n    created_date_formatted TEXT,\n    height DECIMAL,\n    weight DECIMAL,\n    daily_steps_goal INTEGER,\n    weekly_workouts INTEGER,\n    daily_supplements TEXT[],\n    subscription_months INTEGER,\n    subscription_initial_price DECIMAL,\n    subscription_renewal_price DECIMAL\n) \nLANGUAGE plpgsql\nSECURITY DEFINER\nSTABLE\nAS $$\nBEGIN\n    RETURN QUERY\n    SELECT \n        v.id,\n        v.created_at,\n        v.updated_at,\n        v.customer_id,\n        v.customer_name,\n        v.customer_phone,\n        v.customer_email,\n        v.status_main,\n        v.status_sub,\n        v.source,\n        v.fitness_goal,\n        v.activity_level,\n        v.preferred_time,\n        v.notes,\n        v.age,\n        v.birth_date,\n        v.birth_date_formatted,\n        v.created_date_formatted,\n        v.height,\n        v.weight,\n        v.daily_steps_goal,\n        v.weekly_workouts,\n        v.daily_supplements,\n        v.subscription_months,\n        v.subscription_initial_price,\n        v.subscription_renewal_price\n    FROM public.v_leads_with_customer v\n    WHERE \n        -- Search query (PostgreSQL text search - fast with indexes)\n        (p_search_query IS NULL OR \n         v.customer_name ILIKE '%' || p_search_query || '%' OR\n         v.customer_email ILIKE '%' || p_search_query || '%' OR\n         v.customer_phone LIKE '%' || p_search_query || '%' OR\n         v.fitness_goal ILIKE '%' || p_search_query || '%' OR\n         v.notes ILIKE '%' || p_search_query || '%')\n        -- Date filter (PostgreSQL date comparison)\n        AND (p_created_date IS NULL OR DATE(v.created_at) = p_created_date)\n        -- Status filters (uses indexes)\n        AND (p_status_main IS NULL OR v.status_main = p_status_main)\n        AND (p_status_sub IS NULL OR v.status_sub = p_status_sub)\n        -- Age filter (calculated in PostgreSQL)\n        AND (p_age IS NULL OR v.age::TEXT = p_age)\n        -- Height filter\n        AND (p_height IS NULL OR v.height::TEXT = p_height)\n        -- Weight filter\n        AND (p_weight IS NULL OR v.weight::TEXT = p_weight)\n        -- Fitness goal filter (uses index)\n        AND (p_fitness_goal IS NULL OR v.fitness_goal = p_fitness_goal)\n        -- Activity level filter (uses index)\n        AND (p_activity_level IS NULL OR v.activity_level = p_activity_level)\n        -- Preferred time filter (uses index)\n        AND (p_preferred_time IS NULL OR v.preferred_time = p_preferred_time)\n        -- Source filter (uses index)\n        AND (p_source IS NULL OR v.source = p_source)\n    ORDER BY v.created_at DESC\n    LIMIT p_limit_count\n    OFFSET p_offset_count;\nEND;\n$$","-- Grant execute permission to authenticated users\nGRANT EXECUTE ON FUNCTION public.get_filtered_leads TO authenticated","-- =====================================================\n-- STEP 4: Create Helper Function for Age Calculation (Reusable)\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.calculate_age_from_birth_date(birth_date DATE)\nRETURNS INTEGER\nLANGUAGE plpgsql\nIMMUTABLE\nAS $$\nBEGIN\n    IF birth_date IS NULL THEN\n        RETURN 0;\n    END IF;\n    RETURN EXTRACT(YEAR FROM AGE(birth_date))::INTEGER;\nEND;\n$$","-- =====================================================\n-- STEP 5: Create Function to Get Unique Filter Values (For Dropdowns)\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.get_lead_filter_options()\nRETURNS JSONB\nLANGUAGE plpgsql\nSECURITY DEFINER\nSTABLE\nAS $$\nDECLARE\n    result JSONB;\nBEGIN\n    SELECT jsonb_build_object(\n        'statuses', ARRAY(SELECT DISTINCT status_main FROM public.leads WHERE status_main IS NOT NULL ORDER BY status_main)::TEXT[],\n        'sources', ARRAY(SELECT DISTINCT source FROM public.leads WHERE source IS NOT NULL ORDER BY source)::TEXT[],\n        'fitness_goals', ARRAY(SELECT DISTINCT fitness_goal FROM public.leads WHERE fitness_goal IS NOT NULL ORDER BY fitness_goal)::TEXT[],\n        'activity_levels', ARRAY(SELECT DISTINCT activity_level FROM public.leads WHERE activity_level IS NOT NULL ORDER BY activity_level)::TEXT[],\n        'preferred_times', ARRAY(SELECT DISTINCT preferred_time FROM public.leads WHERE preferred_time IS NOT NULL ORDER BY preferred_time)::TEXT[],\n        'ages', ARRAY(SELECT DISTINCT EXTRACT(YEAR FROM AGE(birth_date))::TEXT \n                      FROM public.leads \n                      WHERE birth_date IS NOT NULL \n                      ORDER BY EXTRACT(YEAR FROM AGE(birth_date)))::TEXT[],\n        'heights', ARRAY(SELECT DISTINCT height::TEXT \n                         FROM public.leads \n                         WHERE height IS NOT NULL \n                         ORDER BY height)::TEXT[],\n        'weights', ARRAY(SELECT DISTINCT weight::TEXT \n                         FROM public.leads \n                         WHERE weight IS NOT NULL \n                         ORDER BY weight)::TEXT[]\n    ) INTO result;\n    \n    RETURN result;\nEND;\n$$","-- Grant execute permission\nGRANT EXECUTE ON FUNCTION public.get_lead_filter_options TO authenticated","-- =====================================================\n-- STEP 6: Comments for Documentation\n-- =====================================================\n\nCOMMENT ON VIEW public.v_leads_with_customer IS 'Pre-joined view of leads with customer data and calculated fields. Use this for read operations to avoid client-side joins.'","COMMENT ON FUNCTION public.get_filtered_leads IS 'RPC function for complex lead filtering. All filtering happens in PostgreSQL. Returns pre-calculated fields (age, formatted dates, JSONB extracts).'","COMMENT ON FUNCTION public.calculate_age_from_birth_date IS 'Immutable function to calculate age from birth date. Can be used in queries and views.'","COMMENT ON FUNCTION public.get_lead_filter_options IS 'Returns distinct filter values for dropdowns. Calculated once in PostgreSQL instead of client-side.'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	optimize_leads_queries
20240102000016	{"-- =====================================================\n-- Add Profile Fields to Customers Table\n-- Created: 2024-01-02\n-- Description: Add fields for Rich Profile Hero view\n--              - total_spent: Calculated from leads subscription_data\n--              - membership_tier: Derived from total_spent\n--              - avatar_url: URL for customer avatar image\n-- =====================================================\n\n-- Add new columns to customers table\nALTER TABLE public.customers\n  ADD COLUMN IF NOT EXISTS avatar_url TEXT,\n  ADD COLUMN IF NOT EXISTS total_spent NUMERIC(10, 2) DEFAULT 0,\n  ADD COLUMN IF NOT EXISTS membership_tier TEXT DEFAULT 'New' CHECK (membership_tier IN ('New', 'Standard', 'Premium', 'VIP'))","-- Create index for membership_tier for faster filtering\nCREATE INDEX IF NOT EXISTS idx_customers_membership_tier ON public.customers(membership_tier)","-- Add comments for documentation\nCOMMENT ON COLUMN public.customers.avatar_url IS 'URL to customer avatar/profile image'","COMMENT ON COLUMN public.customers.total_spent IS 'Total amount spent across all leads (calculated field)'","COMMENT ON COLUMN public.customers.membership_tier IS 'Customer membership tier based on total_spent: New (<500), Standard (500-1999), Premium (2000-4999), VIP (5000+)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_profile_fields_to_customers
20240102000017	{"-- =====================================================\n-- Add Nutrition and Supplements History to Leads Table\n-- Created: 2024-01-02\n-- Description: Add nutrition_history and supplements_history JSONB columns\n--              to store historical nutrition plans and supplements plans\n-- =====================================================\n\n-- Add nutrition_history column to leads table\nALTER TABLE public.leads\n  ADD COLUMN IF NOT EXISTS nutrition_history JSONB DEFAULT '[]'::jsonb","-- Add supplements_history column to leads table\nALTER TABLE public.leads\n  ADD COLUMN IF NOT EXISTS supplements_history JSONB DEFAULT '[]'::jsonb","-- Create GIN indexes for efficient JSONB queries\nCREATE INDEX IF NOT EXISTS idx_leads_nutrition_history ON public.leads USING GIN (nutrition_history)","CREATE INDEX IF NOT EXISTS idx_leads_supplements_history ON public.leads USING GIN (supplements_history)","-- Add comments for documentation\nCOMMENT ON COLUMN public.leads.nutrition_history IS 'Array of historical nutrition plans for this lead'","COMMENT ON COLUMN public.leads.supplements_history IS 'Array of historical supplements plans for this lead'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_nutrition_supplements_history_to_leads
20240102000018	{"-- Migration: Add customer_notes table for unified customer notes system\n-- Created: 2024-01-02\n-- Description: Customer-centric notes that are unified across all leads belonging to the same customer\n\nCREATE TABLE IF NOT EXISTS customer_notes (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,\n  content TEXT NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id)\n)","-- Create indexes for performance\nCREATE INDEX IF NOT EXISTS idx_customer_notes_customer_id ON customer_notes(customer_id)","CREATE INDEX IF NOT EXISTS idx_customer_notes_created_at ON customer_notes(created_at DESC)","-- Enable RLS\nALTER TABLE customer_notes ENABLE ROW LEVEL SECURITY","-- RLS Policies: Allow authenticated users to manage notes\n-- Adjust these policies based on your specific requirements\n\nCREATE POLICY \\"Users can view customer notes\\" ON customer_notes\n  FOR SELECT\n  USING (auth.role() = 'authenticated')","CREATE POLICY \\"Users can insert customer notes\\" ON customer_notes\n  FOR INSERT\n  WITH CHECK (auth.role() = 'authenticated')","CREATE POLICY \\"Users can update customer notes\\" ON customer_notes\n  FOR UPDATE\n  USING (auth.role() = 'authenticated')","CREATE POLICY \\"Users can delete customer notes\\" ON customer_notes\n  FOR DELETE\n  USING (auth.role() = 'authenticated')","-- Function to automatically update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_customer_notes_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Trigger to automatically update updated_at\nCREATE TRIGGER customer_notes_updated_at\n  BEFORE UPDATE ON customer_notes\n  FOR EACH ROW\n  EXECUTE FUNCTION update_customer_notes_updated_at()"}	add_customer_notes
20240102000019	{"-- Migration: Add icon_name column to saved_views table\n-- This allows users to customize the icon for each saved view\n\n-- Add icon_name column (nullable, defaults to NULL for existing rows)\nALTER TABLE saved_views \nADD COLUMN IF NOT EXISTS icon_name TEXT","-- Add comment to explain the column\nCOMMENT ON COLUMN saved_views.icon_name IS 'Name of the Lucide icon component to use for this view (e.g., \\"Users\\", \\"Dumbbell\\", \\"Flame\\"). If NULL, uses default icon for the resource_key.'"}	add_icon_name_to_saved_views
20240102000020	{"-- Migration: Add user_interface_preferences table for storing custom interface icons\n-- This allows users to customize icons for main interface items (e.g., \\"ניהול לידים\\", \\"ניהול לקוחות\\")\n\nCREATE TABLE IF NOT EXISTS user_interface_preferences (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    interface_key TEXT NOT NULL, -- e.g., 'leads', 'customers', 'templates', etc.\n    icon_name TEXT NOT NULL, -- e.g., 'Users', 'Dumbbell', 'LayoutDashboard', etc.\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    \n    -- Ensure one preference per interface per user\n    CONSTRAINT unique_user_interface_preference \n        UNIQUE (user_id, interface_key)\n)","-- Index for faster queries\nCREATE INDEX IF NOT EXISTS idx_user_interface_preferences_user_id \n    ON user_interface_preferences(user_id)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_user_interface_preferences_updated_at\n    BEFORE UPDATE ON user_interface_preferences\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- Enable RLS\nALTER TABLE user_interface_preferences ENABLE ROW LEVEL SECURITY","-- Policy: Users can view their own preferences\nCREATE POLICY \\"Users can view their own interface preferences\\"\n    ON user_interface_preferences\n    FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own preferences\nCREATE POLICY \\"Users can insert their own interface preferences\\"\n    ON user_interface_preferences\n    FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own preferences\nCREATE POLICY \\"Users can update their own interface preferences\\"\n    ON user_interface_preferences\n    FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own preferences\nCREATE POLICY \\"Users can delete their own interface preferences\\"\n    ON user_interface_preferences\n    FOR DELETE\n    USING (auth.uid() = user_id)","-- Comments\nCOMMENT ON TABLE user_interface_preferences IS 'User preferences for customizing interface icons'","COMMENT ON COLUMN user_interface_preferences.interface_key IS 'The interface identifier (e.g., \\"leads\\", \\"customers\\", \\"templates\\")'","COMMENT ON COLUMN user_interface_preferences.icon_name IS 'The Lucide icon name (e.g., \\"Users\\", \\"Dumbbell\\", \\"LayoutDashboard\\")'"}	add_user_interface_preferences
20240102000021	{"-- Migration: Allow authenticated users to update leads\n-- This ensures that any authenticated user can update leads they can read\n-- Required for the inline editing functionality to work properly\n\n-- Note: We keep the existing admin policy which uses is_admin() function\n-- This new policy allows any authenticated user to update leads\n\n-- Create new policy that allows authenticated users to update leads\n-- Since we already have a SELECT policy allowing authenticated users to read leads,\n-- we should allow them to update leads as well for the CRM functionality\n-- The admin policy (created in 20240102000001) will still apply for admins\nCREATE POLICY \\"Authenticated users can update leads\\"\n    ON public.leads FOR UPDATE\n    USING (auth.role() = 'authenticated')\n    WITH CHECK (auth.role() = 'authenticated')","COMMENT ON POLICY \\"Authenticated users can update leads\\" ON public.leads IS \n    'Allows all authenticated users to update leads for CRM functionality'"}	allow_authenticated_users_update_leads
20240102000022	{"-- Migration: Add lead_id column to customer_notes table\n-- Created: 2024-01-02\n-- Description: Allow notes to be associated with specific leads/inquiries\n\nALTER TABLE customer_notes \nADD COLUMN IF NOT EXISTS lead_id UUID REFERENCES leads(id) ON DELETE SET NULL","-- Create index for performance\nCREATE INDEX IF NOT EXISTS idx_customer_notes_lead_id ON customer_notes(lead_id)","-- Add comment\nCOMMENT ON COLUMN customer_notes.lead_id IS 'Optional reference to a specific lead/inquiry. NULL means the note applies to all inquiries for the customer.'"}	add_lead_id_to_customer_notes
20240102000023	{"-- Migration: Add Client Portal Support\n-- Created: 2024-01-02\n-- Description: Enable client/trainee role, link customers to auth users, and create daily check-ins\n\n-- =====================================================\n-- 1. UPDATE profiles.role to include 'trainee'\n-- =====================================================\n\n-- Drop the existing CHECK constraint\nALTER TABLE profiles DROP CONSTRAINT IF EXISTS profiles_role_check","-- Add new CHECK constraint with 'trainee' role\nALTER TABLE profiles \nADD CONSTRAINT profiles_role_check \nCHECK (role IN ('admin', 'user', 'trainee'))","-- Update comment\nCOMMENT ON COLUMN profiles.role IS 'User role: admin (coach/admin), user (coach), trainee (client/trainee)'","-- =====================================================\n-- 2. ADD user_id to customers table\n-- =====================================================\n\n-- Add user_id column to customers (nullable, as existing customers may not have user accounts yet)\nALTER TABLE customers \nADD COLUMN IF NOT EXISTS user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL","-- Create index for faster lookups\nCREATE INDEX IF NOT EXISTS idx_customers_user_id ON customers(user_id)","-- Add unique constraint to ensure one user can only be linked to one customer\nCREATE UNIQUE INDEX IF NOT EXISTS idx_customers_user_id_unique ON customers(user_id) \nWHERE user_id IS NOT NULL","-- Add comment\nCOMMENT ON COLUMN customers.user_id IS 'Link to auth.users - allows clients to log in and access their portal'","-- =====================================================\n-- 3. CREATE daily_check_ins table\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS daily_check_ins (\n  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,\n  lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n  check_in_date DATE NOT NULL DEFAULT CURRENT_DATE,\n  \n  -- Check-in statuses\n  workout_completed BOOLEAN DEFAULT false,\n  steps_goal_met BOOLEAN DEFAULT false,\n  steps_actual INTEGER, -- Actual steps taken (optional)\n  nutrition_goal_met BOOLEAN DEFAULT false,\n  supplements_taken JSONB DEFAULT '[]'::jsonb, -- Array of supplement names taken\n  \n  -- Additional notes\n  notes TEXT,\n  \n  -- Metadata\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n  \n  -- Ensure one check-in per customer per day\n  UNIQUE(customer_id, check_in_date)\n)","-- Create indexes for performance\nCREATE INDEX IF NOT EXISTS idx_daily_check_ins_customer_id ON daily_check_ins(customer_id)","CREATE INDEX IF NOT EXISTS idx_daily_check_ins_lead_id ON daily_check_ins(lead_id)","CREATE INDEX IF NOT EXISTS idx_daily_check_ins_date ON daily_check_ins(check_in_date DESC)","CREATE INDEX IF NOT EXISTS idx_daily_check_ins_customer_date ON daily_check_ins(customer_id, check_in_date DESC)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_daily_check_ins_updated_at\n  BEFORE UPDATE ON daily_check_ins\n  FOR EACH ROW\n  EXECUTE FUNCTION update_updated_at_column()","-- Add comments\nCOMMENT ON TABLE daily_check_ins IS 'Daily check-in records for client compliance tracking'","COMMENT ON COLUMN daily_check_ins.workout_completed IS 'Whether the client completed their workout for the day'","COMMENT ON COLUMN daily_check_ins.steps_goal_met IS 'Whether the client met their daily steps goal'","COMMENT ON COLUMN daily_check_ins.steps_actual IS 'Actual number of steps taken (optional, for detailed tracking)'","COMMENT ON COLUMN daily_check_ins.nutrition_goal_met IS 'Whether the client met their nutrition/macro goals'","COMMENT ON COLUMN daily_check_ins.supplements_taken IS 'JSONB array of supplement names that were taken'","-- =====================================================\n-- 4. ENABLE RLS ON daily_check_ins\n-- =====================================================\n\nALTER TABLE daily_check_ins ENABLE ROW LEVEL SECURITY","-- Policy: Trainees can view their own check-ins\nCREATE POLICY \\"Trainees can view own check-ins\\"\n  ON daily_check_ins FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = daily_check_ins.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- Policy: Trainees can insert their own check-ins\nCREATE POLICY \\"Trainees can insert own check-ins\\"\n  ON daily_check_ins FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = daily_check_ins.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- Policy: Trainees can update their own check-ins\nCREATE POLICY \\"Trainees can update own check-ins\\"\n  ON daily_check_ins FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = daily_check_ins.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = daily_check_ins.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- Policy: Coaches/admins can view all check-ins\nCREATE POLICY \\"Coaches can view all check-ins\\"\n  ON daily_check_ins FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE id = auth.uid() \n      AND role IN ('admin', 'user')\n    )\n  )","-- Policy: Coaches/admins can insert check-ins for any customer\nCREATE POLICY \\"Coaches can insert check-ins\\"\n  ON daily_check_ins FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE id = auth.uid() \n      AND role IN ('admin', 'user')\n    )\n  )","-- Policy: Coaches/admins can update check-ins for any customer\nCREATE POLICY \\"Coaches can update check-ins\\"\n  ON daily_check_ins FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE id = auth.uid() \n      AND role IN ('admin', 'user')\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE id = auth.uid() \n      AND role IN ('admin', 'user')\n    )\n  )","-- =====================================================\n-- 5. UPDATE RLS POLICIES FOR customers\n-- =====================================================\n\n-- Policy: Trainees can view their own customer record\nCREATE POLICY \\"Trainees can view own customer\\"\n  ON customers FOR SELECT\n  USING (user_id = auth.uid())","-- Policy: Trainees can update their own customer record (for profile editing)\nCREATE POLICY \\"Trainees can update own customer\\"\n  ON customers FOR UPDATE\n  USING (user_id = auth.uid())\n  WITH CHECK (user_id = auth.uid())","-- =====================================================\n-- 6. UPDATE RLS POLICIES FOR leads (for trainee access)\n-- =====================================================\n\n-- Policy: Trainees can view leads associated with their customer_id\nCREATE POLICY \\"Trainees can view own leads\\"\n  ON leads FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = leads.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- Policy: Trainees can update their own leads (for weight, height, etc.)\nCREATE POLICY \\"Trainees can update own leads\\"\n  ON leads FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = leads.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = leads.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_client_portal_support
20240102000024	{"-- Migration: Fix Trainee User Role\n-- Created: 2024-01-02\n-- Description: \n--   1. Update existing trainee user's role from 'user' to 'trainee' in the profiles table\n--   2. Create profile with correct role if user exists in auth.users but not in profiles\n--   3. Update handle_new_user function to automatically set role='trainee' for trainee@test.com\n\n-- =====================================================\n-- 1. UPDATE handle_new_user to auto-set trainee role\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Auto-set role to 'trainee' for trainee@test.com\n    INSERT INTO public.profiles (id, email, full_name, role)\n    VALUES (\n        NEW.id,\n        NEW.email,\n        COALESCE(NEW.raw_user_meta_data->>'full_name', ''),\n        CASE \n            WHEN NEW.email = 'trainee@test.com' THEN 'trainee'\n            ELSE COALESCE(NEW.raw_user_meta_data->>'role', 'user')\n        END\n    );\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- =====================================================\n-- 2. UPDATE/CREATE trainee@test.com role to 'trainee'\n-- =====================================================\n\nDO $$\nDECLARE\n  v_user_id UUID;\n  v_role TEXT;\n  v_updated_count INTEGER;\nBEGIN\n  -- Find the user in auth.users\n  SELECT id INTO v_user_id\n  FROM auth.users\n  WHERE email = 'trainee@test.com';\n  \n  IF v_user_id IS NULL THEN\n    RAISE NOTICE '⚠️ User trainee@test.com not found in auth.users - will be set to trainee when user is created';\n    RETURN;\n  END IF;\n  \n  -- Check if profile exists\n  SELECT role INTO v_role\n  FROM profiles\n  WHERE id = v_user_id;\n  \n  IF v_role IS NULL THEN\n    -- Profile doesn't exist, create it with 'trainee' role\n    INSERT INTO profiles (id, email, role, full_name)\n    VALUES (v_user_id, 'trainee@test.com', 'trainee', 'Test Trainee')\n    ON CONFLICT (id) DO UPDATE\n      SET role = 'trainee',\n          email = EXCLUDED.email;\n    \n    RAISE NOTICE '✅ Created profile for trainee@test.com with role: trainee';\n  ELSIF v_role != 'trainee' THEN\n    -- Profile exists but has wrong role, update it\n    UPDATE profiles \n    SET role = 'trainee' \n    WHERE id = v_user_id;\n    \n    GET DIAGNOSTICS v_updated_count = ROW_COUNT;\n    \n    IF v_updated_count > 0 THEN\n      RAISE NOTICE '✅ Updated trainee@test.com role from % to: trainee', v_role;\n    END IF;\n  ELSE\n    -- Profile already has correct role\n    RAISE NOTICE '✅ User trainee@test.com already has role: trainee';\n  END IF;\nEND $$"}	fix_trainee_user_role
20240102000025	{"-- Migration: Create Test Users (Manager & Client)\n-- Created: 2024-01-02\n-- Description: Creates two test users:\n--   1. Manager user (coach/admin) - sees full dashboard\n--   2. Client user (trainee) - sees only their client portal\n-- IMPORTANT: This must be the LAST migration to run\n\n-- =====================================================\n-- CREATE TEST USERS\n-- =====================================================\n\nDO $$\nDECLARE\n  v_manager_user_id UUID;\n  v_client_user_id UUID;\n  v_client_customer_id UUID;\n  v_client_lead_id UUID;\nBEGIN\n  -- =====================================================\n  -- 1. CREATE MANAGER USER (coach/admin)\n  -- =====================================================\n  \n  -- Check if manager user already exists\n  SELECT id INTO v_manager_user_id\n  FROM auth.users\n  WHERE email = 'manager@dietneta.com';\n  \n  -- Create auth user for manager (only if doesn't exist)\n  IF v_manager_user_id IS NULL THEN\n    INSERT INTO auth.users (\n      instance_id,\n      id,\n      aud,\n      role,\n      email,\n      encrypted_password,\n      email_confirmed_at,\n      recovery_sent_at,\n      last_sign_in_at,\n      raw_app_meta_data,\n      raw_user_meta_data,\n      created_at,\n      updated_at,\n      confirmation_token,\n      email_change,\n      email_change_token_new,\n      recovery_token\n    ) VALUES (\n      '00000000-0000-0000-0000-000000000000',\n      gen_random_uuid(),\n      'authenticated',\n      'authenticated',\n      'manager@dietneta.com',\n      crypt('Manager123!', gen_salt('bf')),\n      NOW(),\n      NOW(),\n      NOW(),\n      '{\\"provider\\": \\"email\\", \\"providers\\": [\\"email\\"]}',\n      '{\\"full_name\\": \\"מנהל מערכת\\", \\"role\\": \\"admin\\"}',\n      NOW(),\n      NOW(),\n      '',\n      '',\n      '',\n      ''\n    )\n    RETURNING id INTO v_manager_user_id;\n  END IF;\n  \n  -- Create profile for manager (if user exists)\n  IF v_manager_user_id IS NOT NULL THEN\n    INSERT INTO public.profiles (id, email, full_name, role)\n    VALUES (v_manager_user_id, 'manager@dietneta.com', 'מנהל מערכת', 'admin')\n    ON CONFLICT (id) DO UPDATE\n      SET role = 'admin',\n          email = 'manager@dietneta.com',\n          full_name = 'מנהל מערכת';\n    \n    RAISE NOTICE '✅ Manager user created/updated: manager@dietneta.com (ID: %)', v_manager_user_id;\n  ELSE\n    -- User already exists, get the ID\n    SELECT id INTO v_manager_user_id\n    FROM auth.users\n    WHERE email = 'manager@dietneta.com';\n    \n    -- Update profile to ensure correct role\n    UPDATE public.profiles\n    SET role = 'admin',\n        email = 'manager@dietneta.com',\n        full_name = 'מנהל מערכת'\n    WHERE id = v_manager_user_id;\n    \n    RAISE NOTICE '✅ Manager user already exists, profile updated: manager@dietneta.com (ID: %)', v_manager_user_id;\n  END IF;\n  \n  -- =====================================================\n  -- 2. CREATE CLIENT USER (trainee)\n  -- =====================================================\n  \n  -- Check if client user already exists\n  SELECT id INTO v_client_user_id\n  FROM auth.users\n  WHERE email = 'client@dietneta.com';\n  \n  -- Create auth user for client (only if doesn't exist)\n  IF v_client_user_id IS NULL THEN\n    INSERT INTO auth.users (\n      instance_id,\n      id,\n      aud,\n      role,\n      email,\n      encrypted_password,\n      email_confirmed_at,\n      recovery_sent_at,\n      last_sign_in_at,\n      raw_app_meta_data,\n      raw_user_meta_data,\n      created_at,\n      updated_at,\n      confirmation_token,\n      email_change,\n      email_change_token_new,\n      recovery_token\n    ) VALUES (\n      '00000000-0000-0000-0000-000000000000',\n      gen_random_uuid(),\n      'authenticated',\n      'authenticated',\n      'client@dietneta.com',\n      crypt('Client123!', gen_salt('bf')),\n      NOW(),\n      NOW(),\n      NOW(),\n      '{\\"provider\\": \\"email\\", \\"providers\\": [\\"email\\"]}',\n      '{\\"full_name\\": \\"לקוח בדיקה\\", \\"role\\": \\"trainee\\"}',\n      NOW(),\n      NOW(),\n      '',\n      '',\n      '',\n      ''\n    )\n    RETURNING id INTO v_client_user_id;\n  END IF;\n  \n  -- Create profile for client (if user exists)\n  IF v_client_user_id IS NOT NULL THEN\n    INSERT INTO public.profiles (id, email, full_name, role)\n    VALUES (v_client_user_id, 'client@dietneta.com', 'לקוח בדיקה', 'trainee')\n    ON CONFLICT (id) DO UPDATE\n      SET role = 'trainee',\n          email = 'client@dietneta.com',\n          full_name = 'לקוח בדיקה';\n    \n    RAISE NOTICE '✅ Client user created/updated: client@dietneta.com (ID: %)', v_client_user_id;\n  ELSE\n    -- User already exists, get the ID\n    SELECT id INTO v_client_user_id\n    FROM auth.users\n    WHERE email = 'client@dietneta.com';\n    \n    -- Update profile to ensure correct role\n    UPDATE public.profiles\n    SET role = 'trainee',\n        email = 'client@dietneta.com',\n        full_name = 'לקוח בדיקה'\n    WHERE id = v_client_user_id;\n    \n    RAISE NOTICE '✅ Client user already exists, profile updated: client@dietneta.com (ID: %)', v_client_user_id;\n  END IF;\n  \n  -- =====================================================\n  -- 3. CREATE CUSTOMER RECORD FOR CLIENT\n  -- =====================================================\n  \n  IF v_client_user_id IS NOT NULL THEN\n    -- Create customer record linked to client user\n    -- Use upsert approach since we can't rely on ON CONFLICT with partial unique index\n    INSERT INTO customers (full_name, phone, email, user_id)\n    VALUES (\n      'לקוח בדיקה',\n      '0501234567',\n      'client@dietneta.com',\n      v_client_user_id\n    )\n    ON CONFLICT (phone) DO UPDATE\n      SET user_id = EXCLUDED.user_id,\n          full_name = EXCLUDED.full_name,\n          email = EXCLUDED.email\n    RETURNING id INTO v_client_customer_id;\n    \n    -- If customer already existed with different user_id, update it\n    IF v_client_customer_id IS NULL THEN\n      UPDATE customers\n      SET user_id = v_client_user_id,\n          full_name = 'לקוח בדיקה',\n          email = 'client@dietneta.com'\n      WHERE phone = '0501234567'\n      RETURNING id INTO v_client_customer_id;\n    END IF;\n    \n    RAISE NOTICE '✅ Customer record created/updated for client (ID: %)', v_client_customer_id;\n    \n    -- =====================================================\n    -- 4. CREATE LEAD RECORD FOR CLIENT\n    -- =====================================================\n    \n    -- Create a lead record for the client (only if doesn't exist)\n    -- Note: After normalization, leads table no longer has full_name, phone, email columns\n    -- Those are in the customers table, linked via customer_id\n    INSERT INTO leads (\n      customer_id,\n      status_main,\n      fitness_goal,\n      height,\n      weight,\n      activity_level\n    )\n    SELECT \n      v_client_customer_id,\n      'בטיפול',\n      'ירידה במשקל',\n      175.0,\n      75.0,\n      'בינוני'\n    WHERE NOT EXISTS (\n      SELECT 1 FROM leads \n      WHERE customer_id = v_client_customer_id \n    )\n    RETURNING id INTO v_client_lead_id;\n    \n    RAISE NOTICE '✅ Lead record created/updated for client (ID: %)', v_client_lead_id;\n  END IF;\n  \n  RAISE NOTICE '';\n  RAISE NOTICE '========================================';\n  RAISE NOTICE '✅ TEST USERS CREATED SUCCESSFULLY';\n  RAISE NOTICE '========================================';\n  RAISE NOTICE '';\n  RAISE NOTICE '📧 MANAGER USER:';\n  RAISE NOTICE '   Email: manager@dietneta.com';\n  RAISE NOTICE '   Password: Manager123!';\n  RAISE NOTICE '   Role: admin (sees full dashboard)';\n  RAISE NOTICE '';\n  RAISE NOTICE '📧 CLIENT USER:';\n  RAISE NOTICE '   Email: client@dietneta.com';\n  RAISE NOTICE '   Password: Client123!';\n  RAISE NOTICE '   Role: trainee (sees only client portal)';\n  RAISE NOTICE '';\n  RAISE NOTICE '========================================';\n  \nEXCEPTION\n  WHEN OTHERS THEN\n    RAISE WARNING 'Error creating test users: %', SQLERRM;\n    -- Don't fail the migration if users already exist\nEND $$"}	create_test_users
20240102000026	{"-- Migration: Add Trainee Access to Workout and Nutrition Plans\n-- Created: 2024-01-02\n-- Description: Allow trainees to access their workout and nutrition plans via customer_id\n\n-- =====================================================\n-- 1. UPDATE RLS POLICIES FOR workout_plans (for trainee access)\n-- =====================================================\n\n-- Policy: Trainees can view workout plans associated with their customer_id\nCREATE POLICY \\"Trainees can view own workout plans\\"\n  ON workout_plans FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = workout_plans.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- =====================================================\n-- 2. UPDATE RLS POLICIES FOR nutrition_plans (for trainee access)\n-- =====================================================\n\n-- Policy: Trainees can view nutrition plans associated with their customer_id\nCREATE POLICY \\"Trainees can view own nutrition plans\\"\n  ON nutrition_plans FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = nutrition_plans.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_trainee_access_to_plans
20240102000027	{"-- Migration: Secure User Invitations System\n-- Created: 2024-01-02\n-- Description: Implements secure invitation system for trainee user creation without passwords\n\n-- =====================================================\n-- 1. CREATE user_invitations TABLE\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS public.user_invitations (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    \n    -- User identification\n    email TEXT NOT NULL,\n    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,\n    customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    \n    -- Secure token (hashed at rest)\n    token_hash TEXT NOT NULL UNIQUE, -- SHA-256 hash of the invitation token\n    token_salt TEXT NOT NULL, -- Random salt for token hashing\n    \n    -- Invitation metadata\n    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'sent', 'accepted', 'expired', 'revoked')),\n    invited_by UUID REFERENCES auth.users(id) ON DELETE SET NULL, -- Admin/manager who created the invitation\n    invited_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    expires_at TIMESTAMP WITH TIME ZONE NOT NULL, -- Configurable expiration (default 7 days)\n    accepted_at TIMESTAMP WITH TIME ZONE,\n    \n    -- Audit fields\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    \n    -- Constraints\n    CONSTRAINT user_invitations_email_user_id_check CHECK (\n        (email IS NOT NULL) OR (user_id IS NOT NULL)\n    )\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_user_invitations_email ON public.user_invitations(email)","CREATE INDEX IF NOT EXISTS idx_user_invitations_user_id ON public.user_invitations(user_id)","CREATE INDEX IF NOT EXISTS idx_user_invitations_customer_id ON public.user_invitations(customer_id)","CREATE INDEX IF NOT EXISTS idx_user_invitations_token_hash ON public.user_invitations(token_hash)","CREATE INDEX IF NOT EXISTS idx_user_invitations_status ON public.user_invitations(status)","CREATE INDEX IF NOT EXISTS idx_user_invitations_expires_at ON public.user_invitations(expires_at)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_user_invitations_updated_at\n    BEFORE UPDATE ON public.user_invitations\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- 2. CREATE invitation_audit_log TABLE (for security audit)\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS public.invitation_audit_log (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    invitation_id UUID REFERENCES user_invitations(id) ON DELETE CASCADE,\n    action TEXT NOT NULL CHECK (action IN ('created', 'sent', 'resent', 'accepted', 'expired', 'revoked', 'viewed')),\n    performed_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n    ip_address INET,\n    user_agent TEXT,\n    metadata JSONB DEFAULT '{}'::jsonb,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL\n)","CREATE INDEX IF NOT EXISTS idx_invitation_audit_log_invitation_id ON public.invitation_audit_log(invitation_id)","CREATE INDEX IF NOT EXISTS idx_invitation_audit_log_performed_by ON public.invitation_audit_log(performed_by)","CREATE INDEX IF NOT EXISTS idx_invitation_audit_log_created_at ON public.invitation_audit_log(created_at DESC)","-- =====================================================\n-- 3. ENABLE RLS\n-- =====================================================\n\nALTER TABLE public.user_invitations ENABLE ROW LEVEL SECURITY","ALTER TABLE public.invitation_audit_log ENABLE ROW LEVEL SECURITY","-- =====================================================\n-- 4. RLS POLICIES FOR user_invitations\n-- =====================================================\n\n-- Policy: Admins/managers can view all invitations\nCREATE POLICY \\"Admins can view all invitations\\"\n    ON public.user_invitations FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Admins/managers can create invitations\nCREATE POLICY \\"Admins can create invitations\\"\n    ON public.user_invitations FOR INSERT\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Admins/managers can update invitations (for resend, revoke)\nCREATE POLICY \\"Admins can update invitations\\"\n    ON public.user_invitations FOR UPDATE\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Users can view their own invitation (by email match)\n-- Use profiles table instead of auth.users to avoid permission issues\nCREATE POLICY \\"Users can view own invitation\\"\n    ON public.user_invitations FOR SELECT\n    USING (\n        email = (SELECT email FROM profiles WHERE id = auth.uid())\n        OR user_id = auth.uid()\n    )","-- =====================================================\n-- 5. RLS POLICIES FOR invitation_audit_log\n-- =====================================================\n\n-- Policy: Admins can view all audit logs\nCREATE POLICY \\"Admins can view audit logs\\"\n    ON public.invitation_audit_log FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: System can insert audit logs (via service role or admin)\nCREATE POLICY \\"System can insert audit logs\\"\n    ON public.invitation_audit_log FOR INSERT\n    WITH CHECK (true)","-- Will be restricted by RLS on user_invitations\n\n-- =====================================================\n-- 6. HELPER FUNCTION: Generate secure invitation token\n-- =====================================================\n\n-- This function generates a cryptographically secure token\n-- The actual token is generated client-side and hashed before storage\nCREATE OR REPLACE FUNCTION public.generate_invitation_token()\nRETURNS TEXT AS $$\nDECLARE\n    token TEXT;\nBEGIN\n    -- Generate a secure random token (32 bytes = 64 hex characters)\n    -- This is just a placeholder - actual token generation happens in application code\n    -- using crypto.randomBytes or similar\n    token := encode(gen_random_bytes(32), 'hex');\n    RETURN token;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- =====================================================\n-- 7. HELPER FUNCTION: Hash token for storage\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.hash_invitation_token(token TEXT, salt TEXT)\nRETURNS TEXT AS $$\nBEGIN\n    -- Use SHA-256 for token hashing\n    -- In production, consider using bcrypt or argon2\n    RETURN encode(digest(salt || token, 'sha256'), 'hex');\nEND;\n$$ LANGUAGE plpgsql IMMUTABLE","-- =====================================================\n-- 8. HELPER FUNCTION: Verify invitation token\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.verify_invitation_token(\n    p_token_hash TEXT,\n    p_token TEXT,\n    p_salt TEXT\n)\nRETURNS BOOLEAN AS $$\nBEGIN\n    -- Verify token by hashing and comparing\n    RETURN p_token_hash = public.hash_invitation_token(p_token, p_salt);\nEND;\n$$ LANGUAGE plpgsql IMMUTABLE","-- =====================================================\n-- 9. HELPER FUNCTION: Check if invitation is valid\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.is_invitation_valid(p_invitation_id UUID)\nRETURNS BOOLEAN AS $$\nDECLARE\n    v_status TEXT;\n    v_expires_at TIMESTAMP WITH TIME ZONE;\nBEGIN\n    SELECT status, expires_at INTO v_status, v_expires_at\n    FROM public.user_invitations\n    WHERE id = p_invitation_id;\n    \n    IF NOT FOUND THEN\n        RETURN FALSE;\n    END IF;\n    \n    -- Check if expired or revoked\n    IF v_status IN ('expired', 'revoked', 'accepted') THEN\n        RETURN FALSE;\n    END IF;\n    \n    -- Check expiration\n    IF v_expires_at < NOW() THEN\n        -- Auto-update status to expired\n        UPDATE public.user_invitations\n        SET status = 'expired', updated_at = NOW()\n        WHERE id = p_invitation_id;\n        RETURN FALSE;\n    END IF;\n    \n    RETURN TRUE;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- =====================================================\n-- 10. COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE public.user_invitations IS 'Secure invitation system for trainee user creation without passwords'","COMMENT ON COLUMN public.user_invitations.token_hash IS 'SHA-256 hash of the invitation token (never store plaintext)'","COMMENT ON COLUMN public.user_invitations.token_salt IS 'Random salt used for token hashing'","COMMENT ON COLUMN public.user_invitations.status IS 'Invitation status: pending, sent, accepted, expired, revoked'","COMMENT ON COLUMN public.user_invitations.expires_at IS 'Token expiration timestamp (default 7 days from creation)'","COMMENT ON TABLE public.invitation_audit_log IS 'Audit log for all invitation-related actions for security compliance'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	secure_user_invitations
20240102000028	{"-- Migration: Fix RLS Policies for user_invitations\n-- Created: 2024-01-02\n-- Description: Fixes RLS policies that were trying to access auth.users directly\n\n-- Drop all existing policies to recreate them properly\nDROP POLICY IF EXISTS \\"Users can view own invitation\\" ON public.user_invitations","DROP POLICY IF EXISTS \\"Admins can view all invitations\\" ON public.user_invitations","DROP POLICY IF EXISTS \\"Admins can create invitations\\" ON public.user_invitations","DROP POLICY IF EXISTS \\"Admins can update invitations\\" ON public.user_invitations","-- Create a helper function to check if user is admin/manager\n-- This avoids repeated subqueries in policies\nCREATE OR REPLACE FUNCTION public.is_admin_or_manager()\nRETURNS BOOLEAN AS $$\nBEGIN\n    RETURN EXISTS (\n        SELECT 1 FROM profiles\n        WHERE id = auth.uid() \n        AND role IN ('admin', 'user')\n    );\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER STABLE","-- Policy: Admins/managers can view all invitations\nCREATE POLICY \\"Admins can view all invitations\\"\n    ON public.user_invitations FOR SELECT\n    USING (public.is_admin_or_manager())","-- Policy: Users can view their own invitation (by user_id or email from profile)\nCREATE POLICY \\"Users can view own invitation\\"\n    ON public.user_invitations FOR SELECT\n    USING (\n        user_id = auth.uid()\n        OR (\n            email = (SELECT email FROM profiles WHERE id = auth.uid())\n        )\n    )","-- Policy: Admins/managers can create invitations\nCREATE POLICY \\"Admins can create invitations\\"\n    ON public.user_invitations FOR INSERT\n    WITH CHECK (public.is_admin_or_manager())","-- Policy: Admins/managers can update invitations (for resend, revoke)\nCREATE POLICY \\"Admins can update invitations\\"\n    ON public.user_invitations FOR UPDATE\n    USING (public.is_admin_or_manager())\n    WITH CHECK (public.is_admin_or_manager())"}	fix_invitation_rls
20240102000029	{"-- Migration: Fix Manager User Password\n-- Created: 2024-01-02\n-- Description: Properly creates/resets manager user password using Supabase Auth\n\n-- This migration uses a function to properly set the password\n-- Note: Direct password updates in auth.users don't work with Supabase Auth\n-- This migration will be handled by a script instead\n\n-- For now, we'll just ensure the profile is correct\n-- The password should be reset using the admin API or script\n\nDO $$\nDECLARE\n  v_manager_user_id UUID;\nBEGIN\n  -- Find manager user\n  SELECT id INTO v_manager_user_id\n  FROM auth.users\n  WHERE email = 'manager@dietneta.com'\n  LIMIT 1;\n  \n  -- Ensure profile exists and is correct\n  IF v_manager_user_id IS NOT NULL THEN\n    INSERT INTO public.profiles (id, email, full_name, role)\n    VALUES (v_manager_user_id, 'manager@dietneta.com', 'מנהל מערכת', 'admin')\n    ON CONFLICT (id) DO UPDATE\n      SET role = 'admin',\n          email = 'manager@dietneta.com',\n          full_name = 'מנהל מערכת';\n    \n    RAISE NOTICE '✅ Manager profile updated: manager@dietneta.com (ID: %)', v_manager_user_id;\n    RAISE NOTICE '⚠️  Password reset required. Run: node scripts/reset_manager_password.js';\n  ELSE\n    RAISE NOTICE '⚠️  Manager user not found. Please create using Supabase Auth signUp or admin API.';\n  END IF;\nEND $$"}	fix_manager_user_password
20240102000030	{"-- Migration: Add WhatsApp Flow Templates Table\n-- Description: Stores message templates for WhatsApp automation flows\n-- Created: 2024-01-02\n\n-- Create whatsapp_flow_templates table\nCREATE TABLE IF NOT EXISTS public.whatsapp_flow_templates (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n  flow_key TEXT NOT NULL, -- e.g., 'customer_journey_start', 'intro_questionnaire'\n  template_content TEXT NOT NULL DEFAULT '', -- The message template with placeholders\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  \n  -- Ensure one template per flow per user\n  UNIQUE(user_id, flow_key)\n)","-- Add RLS policies\nALTER TABLE public.whatsapp_flow_templates ENABLE ROW LEVEL SECURITY","-- Policy: Users can view their own templates\nCREATE POLICY \\"Users can view own templates\\"\n  ON public.whatsapp_flow_templates\n  FOR SELECT\n  USING (auth.uid() = user_id)","-- Policy: Users can insert their own templates\nCREATE POLICY \\"Users can insert own templates\\"\n  ON public.whatsapp_flow_templates\n  FOR INSERT\n  WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own templates\nCREATE POLICY \\"Users can update own templates\\"\n  ON public.whatsapp_flow_templates\n  FOR UPDATE\n  USING (auth.uid() = user_id)\n  WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own templates\nCREATE POLICY \\"Users can delete own templates\\"\n  ON public.whatsapp_flow_templates\n  FOR DELETE\n  USING (auth.uid() = user_id)","-- Create index for faster lookups\nCREATE INDEX IF NOT EXISTS idx_whatsapp_flow_templates_user_flow \n  ON public.whatsapp_flow_templates(user_id, flow_key)","-- Create function to update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_whatsapp_flow_templates_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Create trigger to automatically update updated_at\nCREATE TRIGGER update_whatsapp_flow_templates_updated_at\n  BEFORE UPDATE ON public.whatsapp_flow_templates\n  FOR EACH ROW\n  EXECUTE FUNCTION update_whatsapp_flow_templates_updated_at()","-- Add comments\nCOMMENT ON TABLE public.whatsapp_flow_templates IS 'Stores WhatsApp message templates for automation flows'","COMMENT ON COLUMN public.whatsapp_flow_templates.flow_key IS 'Unique identifier for the flow (e.g., customer_journey_start, intro_questionnaire)'","COMMENT ON COLUMN public.whatsapp_flow_templates.template_content IS 'Message template with placeholders like {{name}}, {{phone}}, etc.'"}	add_whatsapp_flow_templates
20240102000031	{"-- Migration: Add buttons support to WhatsApp Flow Templates\n-- Description: Adds JSONB column to store interactive buttons for WhatsApp messages\n-- Created: 2024-01-02\n-- Migration number: 20240102000031 (must be last in sequence)\n\n-- Add buttons column to store interactive buttons array\nALTER TABLE public.whatsapp_flow_templates\nADD COLUMN IF NOT EXISTS buttons JSONB DEFAULT '[]'::jsonb","-- Add comment\nCOMMENT ON COLUMN public.whatsapp_flow_templates.buttons IS 'Array of interactive buttons: [{\\"id\\": \\"1\\", \\"text\\": \\"Button Text\\"}]'","-- Ensure any existing data complies with max 3 buttons rule before adding constraint\n-- This is safe because the column was just added, so there should be no existing data\n-- But we do this defensively in case the migration is run multiple times\nUPDATE public.whatsapp_flow_templates\nSET buttons = '[]'::jsonb\nWHERE buttons IS NULL \n   OR (jsonb_typeof(buttons) = 'array' AND jsonb_array_length(COALESCE(buttons, '[]'::jsonb)) > 3)","-- Add constraint to ensure buttons array has max 3 items (idempotent)\n-- Use DO block to safely handle constraint creation/dropping\nDO $$\nBEGIN\n    -- Drop constraint if it exists (in case of re-running migration)\n    IF EXISTS (\n        SELECT 1 FROM pg_constraint \n        WHERE conname = 'check_buttons_max_count' \n        AND conrelid = 'public.whatsapp_flow_templates'::regclass\n    ) THEN\n        ALTER TABLE public.whatsapp_flow_templates DROP CONSTRAINT check_buttons_max_count;\n    END IF;\n    \n    -- Add the constraint\n    ALTER TABLE public.whatsapp_flow_templates\n    ADD CONSTRAINT check_buttons_max_count \n    CHECK (jsonb_array_length(COALESCE(buttons, '[]'::jsonb)) <= 3);\nEXCEPTION\n    WHEN others THEN\n        -- If constraint creation fails, log but don't fail the migration\n        RAISE NOTICE 'Could not add check_buttons_max_count constraint: %', SQLERRM;\nEND $$"}	add_buttons_to_whatsapp_templates
20251228093611	{"-- Migration: Add Green API Settings Table\n-- Description: Stores Green API credentials in PostgreSQL instead of using Edge Functions\n-- Created: 2025-12-28\n-- Migration number: 20251228093611 (must be last in sequence)\n\n-- Create settings table for Green API credentials\nCREATE TABLE IF NOT EXISTS public.green_api_settings (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    id_instance TEXT NOT NULL,\n    api_token_instance TEXT NOT NULL,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n    updated_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Enable RLS\nALTER TABLE public.green_api_settings ENABLE ROW LEVEL SECURITY","-- Policy: Authenticated users can read Green API settings (needed to send messages)\nCREATE POLICY \\"Authenticated users can read Green API settings\\"\n    ON public.green_api_settings FOR SELECT\n    USING (auth.uid() IS NOT NULL)","-- Policy: Only admins can insert Green API settings\nCREATE POLICY \\"Admins can insert Green API settings\\"\n    ON public.green_api_settings FOR INSERT\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Only admins can update Green API settings\nCREATE POLICY \\"Admins can update Green API settings\\"\n    ON public.green_api_settings FOR UPDATE\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Only admins can delete Green API settings\nCREATE POLICY \\"Admins can delete Green API settings\\"\n    ON public.green_api_settings FOR DELETE\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Trigger to auto-update updated_at and updated_by\nCREATE TRIGGER update_green_api_settings_updated_at\n    BEFORE UPDATE ON public.green_api_settings\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- Function to set created_by and updated_by on insert\nCREATE OR REPLACE FUNCTION set_green_api_settings_user()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.created_by = COALESCE(NEW.created_by, auth.uid());\n    NEW.updated_by = auth.uid();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Trigger to set user fields\nCREATE TRIGGER set_green_api_settings_user_trigger\n    BEFORE INSERT OR UPDATE ON public.green_api_settings\n    FOR EACH ROW\n    EXECUTE FUNCTION set_green_api_settings_user()","-- Add comments\nCOMMENT ON TABLE public.green_api_settings IS 'Stores Green API credentials for WhatsApp messaging'","COMMENT ON COLUMN public.green_api_settings.id_instance IS 'Green API instance ID'","COMMENT ON COLUMN public.green_api_settings.api_token_instance IS 'Green API token instance'"}	add_green_api_settings
20251228120000	{"-- Migration: Expand daily_check_ins table with comprehensive metrics\n-- This adds 19 new fields for luxury daily check-in tracking\n\n-- Physical measurements (6 fields)\nALTER TABLE daily_check_ins\n  ADD COLUMN IF NOT EXISTS weight NUMERIC(5,2), -- Weight in kg\n  ADD COLUMN IF NOT EXISTS belly_circumference INTEGER, -- היקף בטן in cm\n  ADD COLUMN IF NOT EXISTS waist_circumference INTEGER, -- היקף מותן in cm\n  ADD COLUMN IF NOT EXISTS thigh_circumference INTEGER, -- היקף ירכיים in cm\n  ADD COLUMN IF NOT EXISTS arm_circumference INTEGER, -- היקף יד in cm\n  ADD COLUMN IF NOT EXISTS neck_circumference INTEGER, -- היקף צוואר in cm\n  -- Activity metrics (3 new fields, steps_actual already exists)\n  ADD COLUMN IF NOT EXISTS exercises_count INTEGER, -- כמה תרגילים עשית\n  ADD COLUMN IF NOT EXISTS cardio_amount INTEGER, -- כמה אירובי עשית (minutes)\n  ADD COLUMN IF NOT EXISTS intervals_count INTEGER, -- כמה אינטרוולים\n  -- Nutrition and Hydration (4 fields)\n  ADD COLUMN IF NOT EXISTS calories_daily INTEGER, -- קלוריות יומי\n  ADD COLUMN IF NOT EXISTS protein_daily INTEGER, -- חלבון יומי in grams\n  ADD COLUMN IF NOT EXISTS fiber_daily INTEGER, -- סיבים יומי in grams\n  ADD COLUMN IF NOT EXISTS water_amount NUMERIC(5,2), -- כמה מים שתית in liters\n  -- Well-being scales 1-10 (3 fields)\n  ADD COLUMN IF NOT EXISTS stress_level INTEGER, -- רמת הלחץ היומי\n  ADD COLUMN IF NOT EXISTS hunger_level INTEGER, -- רמת הרעב שלך\n  ADD COLUMN IF NOT EXISTS energy_level INTEGER, -- רמת האנרגיה שלך\n  -- Rest (1 field)\n  ADD COLUMN IF NOT EXISTS sleep_hours NUMERIC(4,2)","-- כמה שעות ישנת\n\n-- Add CHECK constraints for well-being scales (must be done separately after columns exist)\nDO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_constraint WHERE conname = 'daily_check_ins_stress_level_check'\n  ) THEN\n    ALTER TABLE daily_check_ins\n      ADD CONSTRAINT daily_check_ins_stress_level_check \n        CHECK (stress_level IS NULL OR (stress_level >= 1 AND stress_level <= 10));\n  END IF;\n\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_constraint WHERE conname = 'daily_check_ins_hunger_level_check'\n  ) THEN\n    ALTER TABLE daily_check_ins\n      ADD CONSTRAINT daily_check_ins_hunger_level_check \n        CHECK (hunger_level IS NULL OR (hunger_level >= 1 AND hunger_level <= 10));\n  END IF;\n\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_constraint WHERE conname = 'daily_check_ins_energy_level_check'\n  ) THEN\n    ALTER TABLE daily_check_ins\n      ADD CONSTRAINT daily_check_ins_energy_level_check \n        CHECK (energy_level IS NULL OR (energy_level >= 1 AND energy_level <= 10));\n  END IF;\nEND $$","-- Add comments for documentation\nCOMMENT ON COLUMN daily_check_ins.weight IS 'Weight measurement in kg (משקל)'","COMMENT ON COLUMN daily_check_ins.belly_circumference IS 'Belly circumference in cm (היקף בטן)'","COMMENT ON COLUMN daily_check_ins.waist_circumference IS 'Waist circumference in cm (היקף מותן)'","COMMENT ON COLUMN daily_check_ins.thigh_circumference IS 'Thigh circumference in cm (היקף ירכיים)'","COMMENT ON COLUMN daily_check_ins.arm_circumference IS 'Arm circumference in cm (היקף יד)'","COMMENT ON COLUMN daily_check_ins.neck_circumference IS 'Neck circumference in cm (היקף צוואר)'","COMMENT ON COLUMN daily_check_ins.exercises_count IS 'Number of exercises completed (כמה תרגילים עשית)'","COMMENT ON COLUMN daily_check_ins.cardio_amount IS 'Cardio duration in minutes (כמה אירובי עשית)'","COMMENT ON COLUMN daily_check_ins.intervals_count IS 'Number of interval training sessions (כמה אינטרוולים)'","COMMENT ON COLUMN daily_check_ins.calories_daily IS 'Daily calorie intake (קלוריות יומי)'","COMMENT ON COLUMN daily_check_ins.protein_daily IS 'Daily protein intake in grams (חלבון יומי)'","COMMENT ON COLUMN daily_check_ins.fiber_daily IS 'Daily fiber intake in grams (סיבים יומי)'","COMMENT ON COLUMN daily_check_ins.water_amount IS 'Water consumed in liters (כמה מים שתית)'","COMMENT ON COLUMN daily_check_ins.stress_level IS 'Daily stress level 1-10 (רמת הלחץ היומי)'","COMMENT ON COLUMN daily_check_ins.hunger_level IS 'Hunger level 1-10 (רמת הרעב שלך)'","COMMENT ON COLUMN daily_check_ins.energy_level IS 'Energy level 1-10 (רמת האנרגיה שלך)'","COMMENT ON COLUMN daily_check_ins.sleep_hours IS 'Hours of sleep (כמה שעות ישנת)'"}	expand_daily_check_ins
20251229000000	{"-- =====================================================\n-- Budgets (Taktziv) Migration\n-- Created: 2024-12-29\n-- Description: Master budget templates that aggregate nutrition, workout, steps, and supplements\n-- =====================================================\n\n-- =====================================================\n-- TABLE: budgets (Budget Templates)\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS budgets (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name TEXT NOT NULL,\n    description TEXT,\n    \n    -- Nutrition Master (can link to nutrition_template or have custom values)\n    nutrition_template_id UUID REFERENCES nutrition_templates(id) ON DELETE SET NULL,\n    nutrition_targets JSONB DEFAULT '{}'::jsonb,\n    -- Structure: { calories: number, protein: number, carbs: number, fat: number, fiber_min: number, water_min: number }\n    \n    -- Steps Module\n    steps_goal INTEGER DEFAULT 0,\n    steps_instructions TEXT,\n    \n    -- Workout Link\n    workout_template_id UUID REFERENCES workout_templates(id) ON DELETE SET NULL,\n    \n    -- Supplements Module (JSONB array)\n    supplements JSONB DEFAULT '[]'::jsonb,\n    -- Structure: [{ name: string, dosage: string, timing: string }]\n    \n    -- Guidelines\n    eating_order TEXT, -- e.g., \\"Vegetables -> Protein -> Carbs\\"\n    eating_rules TEXT, -- e.g., \\"Don't eat carbs alone\\"\n    \n    -- Metadata\n    is_public BOOLEAN NOT NULL DEFAULT FALSE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_budgets_created_by ON budgets(created_by)","CREATE INDEX IF NOT EXISTS idx_budgets_is_public ON budgets(is_public)","CREATE INDEX IF NOT EXISTS idx_budgets_nutrition_template_id ON budgets(nutrition_template_id)","CREATE INDEX IF NOT EXISTS idx_budgets_workout_template_id ON budgets(workout_template_id)","CREATE INDEX IF NOT EXISTS idx_budgets_nutrition_targets ON budgets USING GIN (nutrition_targets)","CREATE INDEX IF NOT EXISTS idx_budgets_supplements ON budgets USING GIN (supplements)","CREATE INDEX IF NOT EXISTS idx_budgets_created_at ON budgets(created_at DESC)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_budgets_updated_at\n    BEFORE UPDATE ON budgets\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- TABLE: budget_assignments (Active Client Budgets)\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS budget_assignments (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    budget_id UUID NOT NULL REFERENCES budgets(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE CASCADE,\n    customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,\n    \n    -- Assignment metadata\n    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    assigned_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    \n    -- Notes specific to this assignment\n    notes TEXT,\n    \n    -- Metadata\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_budget_assignments_budget_id ON budget_assignments(budget_id)","CREATE INDEX IF NOT EXISTS idx_budget_assignments_lead_id ON budget_assignments(lead_id)","CREATE INDEX IF NOT EXISTS idx_budget_assignments_customer_id ON budget_assignments(customer_id)","CREATE INDEX IF NOT EXISTS idx_budget_assignments_is_active ON budget_assignments(is_active)","CREATE INDEX IF NOT EXISTS idx_budget_assignments_assigned_at ON budget_assignments(assigned_at DESC)","-- Unique constraint: One active budget per lead/customer\nCREATE UNIQUE INDEX IF NOT EXISTS idx_budget_assignments_unique_active_lead \n    ON budget_assignments(lead_id) \n    WHERE is_active = TRUE AND lead_id IS NOT NULL","CREATE UNIQUE INDEX IF NOT EXISTS idx_budget_assignments_unique_active_customer \n    ON budget_assignments(customer_id) \n    WHERE is_active = TRUE AND customer_id IS NOT NULL","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_budget_assignments_updated_at\n    BEFORE UPDATE ON budget_assignments\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on budgets table\nALTER TABLE budgets ENABLE ROW LEVEL SECURITY","-- Policy: Users can view public budgets or their own budgets\nCREATE POLICY \\"Users can view public or own budgets\\"\n    ON budgets FOR SELECT\n    USING (\n        is_public = TRUE OR \n        created_by = auth.uid()\n    )","-- Policy: Users can insert their own budgets\nCREATE POLICY \\"Users can insert own budgets\\"\n    ON budgets FOR INSERT\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can update their own budgets\nCREATE POLICY \\"Users can update own budgets\\"\n    ON budgets FOR UPDATE\n    USING (auth.uid() = created_by)\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can delete their own budgets\nCREATE POLICY \\"Users can delete own budgets\\"\n    ON budgets FOR DELETE\n    USING (auth.uid() = created_by)","-- Policy: Admins have full access to budgets\nCREATE POLICY \\"Admins have full access to budgets\\"\n    ON budgets FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Enable RLS on budget_assignments table\nALTER TABLE budget_assignments ENABLE ROW LEVEL SECURITY","-- Policy: Users can view assignments for their own leads/customers or if they created the budget\nCREATE POLICY \\"Users can view relevant budget assignments\\"\n    ON budget_assignments FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM budgets\n            WHERE budgets.id = budget_assignments.budget_id\n            AND (budgets.created_by = auth.uid() OR budgets.is_public = TRUE)\n        )\n        OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Users can insert assignments if they own the budget\nCREATE POLICY \\"Users can insert budget assignments for own budgets\\"\n    ON budget_assignments FOR INSERT\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM budgets\n            WHERE budgets.id = budget_assignments.budget_id\n            AND budgets.created_by = auth.uid()\n        )\n        OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Users can update assignments if they own the budget\nCREATE POLICY \\"Users can update budget assignments for own budgets\\"\n    ON budget_assignments FOR UPDATE\n    USING (\n        EXISTS (\n            SELECT 1 FROM budgets\n            WHERE budgets.id = budget_assignments.budget_id\n            AND budgets.created_by = auth.uid()\n        )\n        OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM budgets\n            WHERE budgets.id = budget_assignments.budget_id\n            AND budgets.created_by = auth.uid()\n        )\n        OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Users can delete assignments if they own the budget\nCREATE POLICY \\"Users can delete budget assignments for own budgets\\"\n    ON budget_assignments FOR DELETE\n    USING (\n        EXISTS (\n            SELECT 1 FROM budgets\n            WHERE budgets.id = budget_assignments.budget_id\n            AND budgets.created_by = auth.uid()\n        )\n        OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE budgets IS 'Master budget templates that aggregate nutrition, workout, steps, and supplements'","COMMENT ON COLUMN budgets.nutrition_targets IS 'JSONB containing macro targets: { calories: number, protein: number, carbs: number, fat: number, fiber_min: number, water_min: number }'","COMMENT ON COLUMN budgets.supplements IS 'JSONB array of supplements: [{ name: string, dosage: string, timing: string }]'","COMMENT ON TABLE budget_assignments IS 'Active budget assignments to leads/customers'","COMMENT ON COLUMN budget_assignments.is_active IS 'Only one active budget per lead/customer at a time'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_budgets
20251229000001	{"-- =====================================================\n-- Add 'budgets' to saved_views resource_key constraint\n-- Created: 2025-12-29\n-- Description: Allow saved views for budgets (Taktziv)\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'budgets'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates', 'budgets'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_budgets_to_saved_views
20251230000000	{"-- Migration: Add check-in field configurations table\n-- Allows admins to customize which fields and sections are visible in client check-in forms\n\n-- Create check_in_field_configurations table\nCREATE TABLE IF NOT EXISTS check_in_field_configurations (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,\n  -- If customer_id is NULL, this is a global/default configuration\n  configuration JSONB NOT NULL DEFAULT '{}'::jsonb,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id),\n  \n  -- Ensure only one configuration per customer (or one global)\n  CONSTRAINT check_in_field_configurations_customer_unique UNIQUE (customer_id)\n)","-- Add index for faster lookups\nCREATE INDEX IF NOT EXISTS idx_check_in_field_configurations_customer_id \n  ON check_in_field_configurations(customer_id)","-- Add index for global configurations\nCREATE INDEX IF NOT EXISTS idx_check_in_field_configurations_global \n  ON check_in_field_configurations((customer_id IS NULL))","-- Enable RLS\nALTER TABLE check_in_field_configurations ENABLE ROW LEVEL SECURITY","-- RLS Policies\n-- Admins can read/write all configurations\nCREATE POLICY \\"Admins can manage all check-in field configurations\\"\n  ON check_in_field_configurations\n  FOR ALL\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'manager')\n    )\n  )","-- Clients can read their own configuration\nCREATE POLICY \\"Clients can read their check-in field configuration\\"\n  ON check_in_field_configurations\n  FOR SELECT\n  USING (\n    customer_id IN (\n      SELECT id FROM customers\n      WHERE user_id = auth.uid()\n    )\n    OR customer_id IS NULL -- Also allow reading global/default config\n  )","-- Function to update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_check_in_field_configurations_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Trigger to automatically update updated_at\nCREATE TRIGGER update_check_in_field_configurations_updated_at\n  BEFORE UPDATE ON check_in_field_configurations\n  FOR EACH ROW\n  EXECUTE FUNCTION update_check_in_field_configurations_updated_at()","-- Add comments\nCOMMENT ON TABLE check_in_field_configurations IS 'Stores configuration for check-in field visibility and labels per customer or globally'","COMMENT ON COLUMN check_in_field_configurations.customer_id IS 'Customer ID for customer-specific config, NULL for global/default config'","COMMENT ON COLUMN check_in_field_configurations.configuration IS 'JSONB object containing field visibility, labels, and section visibility settings'","-- Example configuration structure:\n-- {\n--   \\"sections\\": {\n--     \\"body\\": { \\"visible\\": true, \\"label\\": \\"מדדי גוף\\" },\n--     \\"activity\\": { \\"visible\\": true, \\"label\\": \\"פעילות\\" },\n--     \\"nutrition\\": { \\"visible\\": true, \\"label\\": \\"תזונה\\" },\n--     \\"wellness\\": { \\"visible\\": true, \\"label\\": \\"בריאות\\" }\n--   },\n--   \\"fields\\": {\n--     \\"weight\\": { \\"visible\\": true, \\"label\\": \\"משקל\\", \\"section\\": \\"body\\" },\n--     \\"bellyCircumference\\": { \\"visible\\": true, \\"label\\": \\"היקף בטן\\", \\"section\\": \\"body\\" },\n--     \\"waistCircumference\\": { \\"visible\\": true, \\"label\\": \\"היקף מותן\\", \\"section\\": \\"body\\" },\n--     \\"thighCircumference\\": { \\"visible\\": true, \\"label\\": \\"היקף ירכיים\\", \\"section\\": \\"body\\" },\n--     \\"armCircumference\\": { \\"visible\\": true, \\"label\\": \\"היקף יד\\", \\"section\\": \\"body\\" },\n--     \\"neckCircumference\\": { \\"visible\\": true, \\"label\\": \\"היקף צוואר\\", \\"section\\": \\"body\\" },\n--     \\"stepsActual\\": { \\"visible\\": true, \\"label\\": \\"מס' צעדים יומי\\", \\"section\\": \\"activity\\" },\n--     \\"exercisesCount\\": { \\"visible\\": true, \\"label\\": \\"כמה תרגילים עשית\\", \\"section\\": \\"activity\\" },\n--     \\"cardioAmount\\": { \\"visible\\": true, \\"label\\": \\"כמה אירובי עשית\\", \\"section\\": \\"activity\\" },\n--     \\"intervalsCount\\": { \\"visible\\": true, \\"label\\": \\"כמה אינטרוולים\\", \\"section\\": \\"activity\\" },\n--     \\"caloriesDaily\\": { \\"visible\\": true, \\"label\\": \\"קלוריות יומי\\", \\"section\\": \\"nutrition\\" },\n--     \\"proteinDaily\\": { \\"visible\\": true, \\"label\\": \\"חלבון יומי\\", \\"section\\": \\"nutrition\\" },\n--     \\"fiberDaily\\": { \\"visible\\": true, \\"label\\": \\"סיבים יומי\\", \\"section\\": \\"nutrition\\" },\n--     \\"waterAmount\\": { \\"visible\\": true, \\"label\\": \\"כמה מים שתית\\", \\"section\\": \\"nutrition\\" },\n--     \\"stressLevel\\": { \\"visible\\": true, \\"label\\": \\"רמת הלחץ היומי\\", \\"section\\": \\"wellness\\" },\n--     \\"hungerLevel\\": { \\"visible\\": true, \\"label\\": \\"רמת הרעב שלך\\", \\"section\\": \\"wellness\\" },\n--     \\"energyLevel\\": { \\"visible\\": true, \\"label\\": \\"רמת האנרגיה שלך\\", \\"section\\": \\"wellness\\" },\n--     \\"sleepHours\\": { \\"visible\\": true, \\"label\\": \\"כמה שעות ישנת\\", \\"section\\": \\"wellness\\" }\n--   }\n-- }"}	add_check_in_field_configurations
20251231000000	{"-- =====================================================\n-- Add Budget Links to Plans Migration\n-- Created: 2024-12-31\n-- Description: Links workout_plans, nutrition_plans, and supplement_plans to budgets\n-- =====================================================\n\n-- =====================================================\n-- Add budget_id to workout_plans\n-- =====================================================\n\nALTER TABLE workout_plans \nADD COLUMN IF NOT EXISTS budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL","CREATE INDEX IF NOT EXISTS idx_workout_plans_budget_id ON workout_plans(budget_id)","-- =====================================================\n-- Add budget_id to nutrition_plans\n-- =====================================================\n\nALTER TABLE nutrition_plans \nADD COLUMN IF NOT EXISTS budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_budget_id ON nutrition_plans(budget_id)","-- =====================================================\n-- Create supplement_plans table\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS supplement_plans (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    customer_id UUID REFERENCES customers(id) ON DELETE SET NULL,\n    budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL,\n    template_id UUID, -- For future use if supplement templates are created\n    \n    -- Standard fields\n    start_date DATE NOT NULL,\n    end_date DATE,\n    description TEXT,\n    \n    -- Supplements (JSONB array)\n    supplements JSONB DEFAULT '[]'::jsonb,\n    -- Structure: [{ name: string, dosage: string, timing: string }]\n    \n    -- Metadata\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_supplement_plans_user_id ON supplement_plans(user_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_lead_id ON supplement_plans(lead_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_customer_id ON supplement_plans(customer_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_budget_id ON supplement_plans(budget_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_start_date ON supplement_plans(start_date DESC)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_created_at ON supplement_plans(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_supplements ON supplement_plans USING GIN (supplements)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_supplement_plans_updated_at\n    BEFORE UPDATE ON supplement_plans\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES for supplement_plans\n-- =====================================================\n\n-- Enable RLS on supplement_plans table\nALTER TABLE supplement_plans ENABLE ROW LEVEL SECURITY","-- Policy: Users can read their own supplement plans\nCREATE POLICY \\"Users can read own supplement plans\\"\n    ON supplement_plans FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own supplement plans\nCREATE POLICY \\"Users can insert own supplement plans\\"\n    ON supplement_plans FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own supplement plans\nCREATE POLICY \\"Users can update own supplement plans\\"\n    ON supplement_plans FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own supplement plans\nCREATE POLICY \\"Users can delete own supplement plans\\"\n    ON supplement_plans FOR DELETE\n    USING (auth.uid() = user_id)","-- Policy: Admins have full access to supplement plans\nCREATE POLICY \\"Admins have full access to supplement plans\\"\n    ON supplement_plans FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON COLUMN workout_plans.budget_id IS 'Reference to the budget this workout plan was created from'","COMMENT ON COLUMN nutrition_plans.budget_id IS 'Reference to the budget this nutrition plan was created from'","COMMENT ON TABLE supplement_plans IS 'Supplement plans linked to leads/customers and budgets'","COMMENT ON COLUMN supplement_plans.budget_id IS 'Reference to the budget this supplement plan was created from'","COMMENT ON COLUMN supplement_plans.supplements IS 'JSONB array of supplements: [{ name: string, dosage: string, timing: string }]'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_budget_links_to_plans
20260101000000	{"-- =====================================================\n-- Fix Budget Links to Plans and Create Supplement Plans\n-- Created: 2026-01-01\n-- Description: Ensures budget_id columns exist in workout_plans and nutrition_plans,\n--              and creates supplement_plans table if it doesn't exist\n-- =====================================================\n\n-- =====================================================\n-- Add budget_id to workout_plans (if not exists)\n-- =====================================================\n\nDO $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.columns \n        WHERE table_name = 'workout_plans' \n        AND column_name = 'budget_id'\n    ) THEN\n        ALTER TABLE workout_plans \n        ADD COLUMN budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL;\n        \n        CREATE INDEX IF NOT EXISTS idx_workout_plans_budget_id ON workout_plans(budget_id);\n        \n        COMMENT ON COLUMN workout_plans.budget_id IS 'Reference to the budget this workout plan was created from';\n    END IF;\nEND $$","-- =====================================================\n-- Add budget_id to nutrition_plans (if not exists)\n-- =====================================================\n\nDO $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.columns \n        WHERE table_name = 'nutrition_plans' \n        AND column_name = 'budget_id'\n    ) THEN\n        ALTER TABLE nutrition_plans \n        ADD COLUMN budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL;\n        \n        CREATE INDEX IF NOT EXISTS idx_nutrition_plans_budget_id ON nutrition_plans(budget_id);\n        \n        COMMENT ON COLUMN nutrition_plans.budget_id IS 'Reference to the budget this nutrition plan was created from';\n    END IF;\nEND $$","-- =====================================================\n-- Create supplement_plans table (if not exists)\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS supplement_plans (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    customer_id UUID REFERENCES customers(id) ON DELETE SET NULL,\n    budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL,\n    template_id UUID, -- For future use if supplement templates are created\n    \n    -- Standard fields\n    start_date DATE NOT NULL,\n    end_date DATE,\n    description TEXT,\n    \n    -- Supplements (JSONB array)\n    supplements JSONB DEFAULT '[]'::jsonb,\n    -- Structure: [{ name: string, dosage: string, timing: string }]\n    \n    -- Metadata\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_supplement_plans_user_id ON supplement_plans(user_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_lead_id ON supplement_plans(lead_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_customer_id ON supplement_plans(customer_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_budget_id ON supplement_plans(budget_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_start_date ON supplement_plans(start_date DESC)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_created_at ON supplement_plans(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_supplements ON supplement_plans USING GIN (supplements)","-- Trigger to auto-update updated_at (only if it doesn't exist)\nDO $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM pg_trigger \n        WHERE tgname = 'update_supplement_plans_updated_at'\n    ) THEN\n        CREATE TRIGGER update_supplement_plans_updated_at\n            BEFORE UPDATE ON supplement_plans\n            FOR EACH ROW\n            EXECUTE FUNCTION update_updated_at_column();\n    END IF;\nEND $$","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES for supplement_plans\n-- =====================================================\n\n-- Enable RLS on supplement_plans table\nALTER TABLE supplement_plans ENABLE ROW LEVEL SECURITY","-- Drop existing policies if they exist (to avoid conflicts)\nDROP POLICY IF EXISTS \\"Users can read own supplement plans\\" ON supplement_plans","DROP POLICY IF EXISTS \\"Users can insert own supplement plans\\" ON supplement_plans","DROP POLICY IF EXISTS \\"Users can update own supplement plans\\" ON supplement_plans","DROP POLICY IF EXISTS \\"Users can delete own supplement plans\\" ON supplement_plans","DROP POLICY IF EXISTS \\"Admins have full access to supplement plans\\" ON supplement_plans","-- Policy: Users can read their own supplement plans\nCREATE POLICY \\"Users can read own supplement plans\\"\n    ON supplement_plans FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own supplement plans\nCREATE POLICY \\"Users can insert own supplement plans\\"\n    ON supplement_plans FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own supplement plans\nCREATE POLICY \\"Users can update own supplement plans\\"\n    ON supplement_plans FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own supplement plans\nCREATE POLICY \\"Users can delete own supplement plans\\"\n    ON supplement_plans FOR DELETE\n    USING (auth.uid() = user_id)","-- Policy: Admins have full access to supplement plans\nCREATE POLICY \\"Admins have full access to supplement plans\\"\n    ON supplement_plans FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE supplement_plans IS 'Supplement plans linked to leads/customers and budgets'","COMMENT ON COLUMN supplement_plans.budget_id IS 'Reference to the budget this supplement plan was created from'","COMMENT ON COLUMN supplement_plans.supplements IS 'JSONB array of supplements: [{ name: string, dosage: string, timing: string }]'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_budget_links_and_supplement_plans
20260103000000	{"-- =====================================================\n-- Weekly Reviews Migration\n-- Created: 2026-01-03\n-- Description: Weekly strategy review module for trainer-client communication\n-- =====================================================\n\n-- =====================================================\n-- TABLE: weekly_reviews\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS weekly_reviews (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    \n    -- Links\n    lead_id UUID REFERENCES leads(id) ON DELETE CASCADE,\n    customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,\n    \n    -- Week identification\n    week_start_date DATE NOT NULL, -- First day of the week (typically Sunday or Monday)\n    week_end_date DATE NOT NULL,   -- Last day of the week\n    \n    -- Current Goals (from active budget/protocol at time of review)\n    target_calories INTEGER,\n    target_protein INTEGER, -- grams\n    target_carbs INTEGER,  -- grams\n    target_fat INTEGER,     -- grams\n    target_fiber INTEGER,   -- grams\n    target_steps INTEGER,\n    \n    -- Actual Averages (calculated from daily_check_ins for the week)\n    actual_calories_avg NUMERIC(10,2),\n    actual_protein_avg NUMERIC(10,2),\n    actual_carbs_avg NUMERIC(10,2),\n    actual_fat_avg NUMERIC(10,2),\n    actual_fiber_avg NUMERIC(10,2),\n    actual_calories_weekly_avg NUMERIC(10,2), -- Weekly average of daily calories\n    \n    -- Body Metrics\n    weekly_avg_weight NUMERIC(5,2), -- Average weight for the week\n    waist_measurement INTEGER,        -- Latest waist measurement from body metrics (cm)\n    \n    -- Trainer Inputs\n    trainer_summary TEXT,             -- סיכום ומסקנות (Summary & Insights)\n    action_plan TEXT,                 -- דגשים לשבוע הקרוב (Focus for next week)\n    \n    -- Protocol Updates (for next week)\n    updated_steps_goal INTEGER,       -- Updated step goal for following week\n    updated_calories_target INTEGER, -- Updated calorie target for following week\n    \n    -- Metadata\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n    \n    -- Ensure one review per lead/customer per week\n    UNIQUE(lead_id, week_start_date),\n    UNIQUE(customer_id, week_start_date)\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_weekly_reviews_lead_id ON weekly_reviews(lead_id)","CREATE INDEX IF NOT EXISTS idx_weekly_reviews_customer_id ON weekly_reviews(customer_id)","CREATE INDEX IF NOT EXISTS idx_weekly_reviews_week_start ON weekly_reviews(week_start_date DESC)","CREATE INDEX IF NOT EXISTS idx_weekly_reviews_created_at ON weekly_reviews(created_at DESC)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_weekly_reviews_updated_at\n    BEFORE UPDATE ON weekly_reviews\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\nALTER TABLE weekly_reviews ENABLE ROW LEVEL SECURITY","-- Policy: Trainees can view their own weekly reviews\nCREATE POLICY \\"Trainees can view own weekly reviews\\"\n    ON weekly_reviews FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM customers\n            WHERE customers.id = weekly_reviews.customer_id\n            AND customers.user_id = auth.uid()\n        )\n    )","-- Policy: Coaches/admins can view all weekly reviews\nCREATE POLICY \\"Coaches can view all weekly reviews\\"\n    ON weekly_reviews FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Coaches/admins can insert weekly reviews\nCREATE POLICY \\"Coaches can insert weekly reviews\\"\n    ON weekly_reviews FOR INSERT\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Coaches/admins can update weekly reviews\nCREATE POLICY \\"Coaches can update weekly reviews\\"\n    ON weekly_reviews FOR UPDATE\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Coaches/admins can delete weekly reviews\nCREATE POLICY \\"Coaches can delete weekly reviews\\"\n    ON weekly_reviews FOR DELETE\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE weekly_reviews IS 'Weekly strategy reviews linking trainer insights with client check-in data'","COMMENT ON COLUMN weekly_reviews.week_start_date IS 'First day of the week being reviewed'","COMMENT ON COLUMN weekly_reviews.week_end_date IS 'Last day of the week being reviewed'","COMMENT ON COLUMN weekly_reviews.target_calories IS 'Target calories from active budget/protocol at time of review'","COMMENT ON COLUMN weekly_reviews.actual_calories_avg IS 'Average daily calories from check-ins during the week'","COMMENT ON COLUMN weekly_reviews.weekly_avg_weight IS 'Average weight for the week from daily check-ins'","COMMENT ON COLUMN weekly_reviews.waist_measurement IS 'Latest waist measurement from body metrics section'","COMMENT ON COLUMN weekly_reviews.trainer_summary IS 'Trainer summary and insights (סיכום ומסקנות)'","COMMENT ON COLUMN weekly_reviews.action_plan IS 'Action plan for next week (דגשים לשבוע הקרוב)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_weekly_reviews
20260104000000	{"-- Migration: Create Meetings Table\n-- Description: Stores meeting data from Fillout form submissions\n-- Created: 2026-01-04\n\n-- Create meetings table\nCREATE TABLE IF NOT EXISTS public.meetings (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  lead_id UUID REFERENCES public.leads(id) ON DELETE SET NULL,\n  customer_id UUID REFERENCES public.customers(id) ON DELETE SET NULL,\n  fillout_submission_id TEXT, -- ID from Fillout submission\n  meeting_data JSONB NOT NULL DEFAULT '{}'::jsonb, -- Flexible JSONB to store all form data\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Add indexes\nCREATE INDEX IF NOT EXISTS idx_meetings_lead_id ON public.meetings(lead_id)","CREATE INDEX IF NOT EXISTS idx_meetings_customer_id ON public.meetings(customer_id)","CREATE INDEX IF NOT EXISTS idx_meetings_created_at ON public.meetings(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_meetings_fillout_submission_id ON public.meetings(fillout_submission_id)","-- Add RLS policies\nALTER TABLE public.meetings ENABLE ROW LEVEL SECURITY","-- Policy: Managers can view all meetings\nCREATE POLICY \\"Managers can view all meetings\\"\n  ON public.meetings\n  FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Policy: Managers can insert meetings\nCREATE POLICY \\"Managers can insert meetings\\"\n  ON public.meetings\n  FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Policy: Managers can update meetings\nCREATE POLICY \\"Managers can update meetings\\"\n  ON public.meetings\n  FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Policy: Managers can delete meetings\nCREATE POLICY \\"Managers can delete meetings\\"\n  ON public.meetings\n  FOR DELETE\n  USING (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Create function to update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_meetings_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Create trigger to automatically update updated_at\nCREATE TRIGGER update_meetings_updated_at\n  BEFORE UPDATE ON public.meetings\n  FOR EACH ROW\n  EXECUTE FUNCTION update_meetings_updated_at()","-- Add comments\nCOMMENT ON TABLE public.meetings IS 'Stores meeting data from Fillout form submissions'","COMMENT ON COLUMN public.meetings.lead_id IS 'Link to the lead that the meeting is associated with'","COMMENT ON COLUMN public.meetings.customer_id IS 'Link to the customer that the meeting is associated with'","COMMENT ON COLUMN public.meetings.fillout_submission_id IS 'Unique identifier from Fillout submission'","COMMENT ON COLUMN public.meetings.meeting_data IS 'Flexible JSONB containing all meeting data from Fillout form'"}	create_meetings
20260104000001	{"-- =====================================================\n-- Add 'meetings' to saved_views resource_key constraint\n-- Created: 2026-01-04\n-- Description: Allow saved views for meetings (Pegishot)\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'meetings'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates', 'budgets', 'meetings'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_meetings_to_saved_views
20260104000002	{"-- =====================================================\n-- Fix Meetings RLS Policies\n-- Created: 2026-01-04\n-- Description: Update RLS policies to use 'admin' and 'user' roles instead of 'manager'\n-- =====================================================\n\n-- Drop existing policies\nDROP POLICY IF EXISTS \\"Managers can view all meetings\\" ON public.meetings","DROP POLICY IF EXISTS \\"Managers can insert meetings\\" ON public.meetings","DROP POLICY IF EXISTS \\"Managers can update meetings\\" ON public.meetings","DROP POLICY IF EXISTS \\"Managers can delete meetings\\" ON public.meetings","-- Policy: Admins and users (managers) can view all meetings\nCREATE POLICY \\"Admins and users can view all meetings\\"\n  ON public.meetings\n  FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user')\n    )\n  )","-- Policy: Admins and users can insert meetings\nCREATE POLICY \\"Admins and users can insert meetings\\"\n  ON public.meetings\n  FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user')\n    )\n  )","-- Policy: Admins and users can update meetings\nCREATE POLICY \\"Admins and users can update meetings\\"\n  ON public.meetings\n  FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user')\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user')\n    )\n  )","-- Policy: Admins and users can delete meetings\nCREATE POLICY \\"Admins and users can delete meetings\\"\n  ON public.meetings\n  FOR DELETE\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user')\n    )\n  )","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_meetings_rls_policies
20260104000003	{"-- Migration: Backfill Meeting Data from Fillout\n-- Description: This migration provides a function to re-sync meeting_data from Fillout API\n--              for existing meetings that only have metadata. Run this manually via Supabase SQL editor\n--              or create an Edge Function to trigger it.\n-- Created: 2026-01-04\n\n-- Note: This migration doesn't automatically backfill data.\n-- To backfill existing meetings, you need to:\n-- 1. Call the sync-fillout-meetings Edge Function which will update existing meetings\n-- 2. Or manually update meetings via the Supabase dashboard\n-- 3. Or create a one-time script to fetch from Fillout API and update meeting_data\n\n-- The sync-fillout-meetings function has been updated to properly extract all question data\n-- including the Schedule field. When you run the sync, it will update existing meetings\n-- with the full meeting_data including all form fields.\n\n-- This migration file serves as documentation that the extraction logic has been improved.\n-- No database schema changes are needed as meeting_data is already JSONB and can store any structure.\n\nCOMMENT ON COLUMN public.meetings.meeting_data IS 'Flexible JSONB containing all meeting data from Fillout form, including Schedule field for actual meeting date/time'"}	backfill_meeting_data_from_fillout
20260104000004	{"-- =====================================================\n-- Add 'check_in_settings' to saved_views resource_key constraint\n-- Created: 2026-01-04\n-- Description: Allow saved views for check-in settings\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'check_in_settings'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates', 'budgets', 'meetings', 'check_in_settings'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_check_in_settings_to_saved_views
20260104000005	{"-- =====================================================\n-- Add attachment_url column to customer_notes table\n-- Created: 2026-01-04\n-- Description: Allow notes to have file attachments stored in Supabase Storage\n-- =====================================================\n\n-- Add attachment_url column to store the file path in Supabase Storage\nALTER TABLE customer_notes \n  ADD COLUMN IF NOT EXISTS attachment_url TEXT","-- Create index for faster queries on notes with attachments\nCREATE INDEX IF NOT EXISTS idx_customer_notes_attachment_url \n  ON customer_notes(attachment_url) \n  WHERE attachment_url IS NOT NULL","-- Add comment for documentation\nCOMMENT ON COLUMN customer_notes.attachment_url IS 'URL/path to file attachment in Supabase Storage (client-assets bucket)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_attachment_url_to_customer_notes
20260104000006	{"-- =====================================================\n-- Create client-assets storage bucket with RLS policies\n-- Created: 2026-01-04\n-- Description: Storage bucket for progress photos and note attachments\n-- Path structure: [client_id]/progress/[file_name] and [client_id]/notes/[file_name]\n-- \n-- NOTE: Storage buckets must be created via Supabase Dashboard or CLI.\n-- This migration only sets up RLS policies for the 'client-assets' bucket.\n-- \n-- To create the bucket:\n-- 1. Via Supabase Dashboard: Go to Storage > Create Bucket > Name: \\"client-assets\\" > Public: false\n-- 2. Via CLI: Use Supabase Management API or create manually in dashboard\n-- \n-- The bucket should have:\n-- - Name: client-assets\n-- - Public: false (private, uses signed URLs)\n-- - File size limit: 10MB\n-- - Allowed MIME types: image/*, application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document\n-- \n-- IMPORTANT: Storage must be enabled in supabase/config.toml ([storage] enabled = true)\n-- and the bucket must be created before these policies will work.\n-- \n-- For local development:\n-- 1. Enable storage in supabase/config.toml: [storage] enabled = true\n-- 2. Restart Supabase: npx supabase stop && npx supabase start\n-- 3. Create the bucket via Supabase Studio (http://localhost:54323) > Storage > Create Bucket\n-- \n-- If storage is not enabled locally, this migration will fail. That's expected.\n-- The migration will work correctly in production/remote Supabase where storage is enabled.\n-- =====================================================\n\n-- Only create policies if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- RLS Policy: Allow trainees to upload files to their own client_id folder\n    DROP POLICY IF EXISTS \\"Trainees can upload to own client folder\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Trainees can upload to own client folder\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = ''client-assets'' AND\n      (\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''progress''\n        OR\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''notes''\n      )\n    )';\n\n    -- RLS Policy: Allow trainees to view files in their own client_id folder\n    DROP POLICY IF EXISTS \\"Trainees can view own client files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Trainees can view own client files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      (\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''progress''\n        OR\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''notes''\n      )\n    )';\n\n    -- RLS Policy: Allow trainees to delete files from their own client_id folder\n    DROP POLICY IF EXISTS \\"Trainees can delete own client files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Trainees can delete own client files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      (\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''progress''\n        OR\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''notes''\n      )\n    )';\n\n    -- RLS Policy: Allow managers/admins to upload files for any client\n    DROP POLICY IF EXISTS \\"Managers can upload client files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can upload client files\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (\n        (storage.foldername(name))[2] = ''progress'' OR\n        (storage.foldername(name))[2] = ''notes''\n      )\n    )';\n\n    -- RLS Policy: Allow managers/admins to view all client files\n    DROP POLICY IF EXISTS \\"Managers can view all client files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can view all client files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      )\n    )';\n\n    -- RLS Policy: Allow managers/admins to delete all client files\n    DROP POLICY IF EXISTS \\"Managers can delete all client files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can delete all client files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      )\n    )';\n\n    RAISE NOTICE 'Storage RLS policies created successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy creation. Enable storage in config.toml and restart Supabase to create policies.';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_client_assets_storage_bucket
20260104000007	{"-- =====================================================\n-- Create Steps Plans Table Migration\n-- Created: 2026-01-04\n-- Description: Create steps_plans table similar to supplement_plans\n-- =====================================================\n\n-- =====================================================\n-- Create steps_plans table\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS steps_plans (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    customer_id UUID REFERENCES customers(id) ON DELETE SET NULL,\n    budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL,\n    template_id UUID, -- For future use if steps templates are created\n    \n    -- Standard fields\n    start_date DATE NOT NULL,\n    end_date DATE,\n    description TEXT,\n    \n    -- Steps data\n    steps_goal INTEGER NOT NULL DEFAULT 0,\n    steps_instructions TEXT,\n    \n    -- Metadata\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_steps_plans_user_id ON steps_plans(user_id)","CREATE INDEX IF NOT EXISTS idx_steps_plans_lead_id ON steps_plans(lead_id)","CREATE INDEX IF NOT EXISTS idx_steps_plans_customer_id ON steps_plans(customer_id)","CREATE INDEX IF NOT EXISTS idx_steps_plans_budget_id ON steps_plans(budget_id)","CREATE INDEX IF NOT EXISTS idx_steps_plans_start_date ON steps_plans(start_date DESC)","CREATE INDEX IF NOT EXISTS idx_steps_plans_created_at ON steps_plans(created_at DESC)","-- Trigger to auto-update updated_at\n-- Ensure the function exists first\nCREATE OR REPLACE FUNCTION public.update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","CREATE TRIGGER update_steps_plans_updated_at\n    BEFORE UPDATE ON steps_plans\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES for steps_plans\n-- =====================================================\n\n-- Enable RLS on steps_plans table\nALTER TABLE steps_plans ENABLE ROW LEVEL SECURITY","-- Policy: Users can read their own steps plans\nCREATE POLICY \\"Users can read own steps plans\\"\n    ON steps_plans FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own steps plans\nCREATE POLICY \\"Users can insert own steps plans\\"\n    ON steps_plans FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own steps plans\nCREATE POLICY \\"Users can update own steps plans\\"\n    ON steps_plans FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own steps plans\nCREATE POLICY \\"Users can delete own steps plans\\"\n    ON steps_plans FOR DELETE\n    USING (auth.uid() = user_id)","-- Policy: Admins have full access to steps plans\nCREATE POLICY \\"Admins have full access to steps plans\\"\n    ON steps_plans FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE steps_plans IS 'Steps plans linked to leads/customers and budgets'","COMMENT ON COLUMN steps_plans.budget_id IS 'Reference to the budget this steps plan was created from'","COMMENT ON COLUMN steps_plans.steps_goal IS 'Daily steps goal for this plan'","COMMENT ON COLUMN steps_plans.steps_instructions IS 'Instructions and guidelines for daily steps'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_steps_plans
20260104000008	{"-- =====================================================\n-- Prevent Duplicate Plans Per Budget Migration\n-- Created: 2026-01-04\n-- Description: Prevents duplicate plans (workout, nutrition, steps, supplement) \n--              for the same budget + customer/lead combination\n-- =====================================================\n\n-- =====================================================\n-- STEP 1: Clean up existing duplicates\n-- Keep only the most recent plan per budget_id + customer_id/lead_id combination\n-- =====================================================\n\n-- Clean up duplicate workout_plans\nWITH ranked_plans AS (\n  SELECT \n    id,\n    ROW_NUMBER() OVER (\n      PARTITION BY budget_id, COALESCE(customer_id::text, ''), COALESCE(lead_id::text, '')\n      ORDER BY created_at DESC\n    ) as rn\n  FROM workout_plans\n  WHERE budget_id IS NOT NULL\n)\nDELETE FROM workout_plans\nWHERE id IN (\n  SELECT id FROM ranked_plans WHERE rn > 1\n)","-- Clean up duplicate nutrition_plans\nWITH ranked_plans AS (\n  SELECT \n    id,\n    ROW_NUMBER() OVER (\n      PARTITION BY budget_id, COALESCE(customer_id::text, ''), COALESCE(lead_id::text, '')\n      ORDER BY created_at DESC\n    ) as rn\n  FROM nutrition_plans\n  WHERE budget_id IS NOT NULL\n)\nDELETE FROM nutrition_plans\nWHERE id IN (\n  SELECT id FROM ranked_plans WHERE rn > 1\n)","-- Clean up duplicate steps_plans\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'steps_plans') THEN\n    EXECUTE '\n    WITH ranked_plans AS (\n      SELECT \n        id,\n        ROW_NUMBER() OVER (\n          PARTITION BY budget_id, COALESCE(customer_id::text, ''''), COALESCE(lead_id::text, '''')\n          ORDER BY created_at DESC\n        ) as rn\n      FROM steps_plans\n      WHERE budget_id IS NOT NULL\n    )\n    DELETE FROM steps_plans\n    WHERE id IN (\n      SELECT id FROM ranked_plans WHERE rn > 1\n    )';\n  END IF;\nEND $$","-- Clean up duplicate supplement_plans\nWITH ranked_plans AS (\n  SELECT \n    id,\n    ROW_NUMBER() OVER (\n      PARTITION BY budget_id, COALESCE(customer_id::text, ''), COALESCE(lead_id::text, '')\n      ORDER BY created_at DESC\n    ) as rn\n  FROM supplement_plans\n  WHERE budget_id IS NOT NULL\n)\nDELETE FROM supplement_plans\nWHERE id IN (\n  SELECT id FROM ranked_plans WHERE rn > 1\n)","-- =====================================================\n-- STEP 2: Create unique partial indexes to prevent future duplicates\n-- These indexes ensure only one plan per budget + customer/lead combination\n-- =====================================================\n\n-- Unique index for workout_plans (when budget_id is set)\nCREATE UNIQUE INDEX IF NOT EXISTS idx_workout_plans_unique_budget_customer\nON workout_plans (budget_id, customer_id)\nWHERE budget_id IS NOT NULL AND customer_id IS NOT NULL","CREATE UNIQUE INDEX IF NOT EXISTS idx_workout_plans_unique_budget_lead\nON workout_plans (budget_id, lead_id)\nWHERE budget_id IS NOT NULL AND lead_id IS NOT NULL","-- Unique index for nutrition_plans (when budget_id is set)\nCREATE UNIQUE INDEX IF NOT EXISTS idx_nutrition_plans_unique_budget_customer\nON nutrition_plans (budget_id, customer_id)\nWHERE budget_id IS NOT NULL AND customer_id IS NOT NULL","CREATE UNIQUE INDEX IF NOT EXISTS idx_nutrition_plans_unique_budget_lead\nON nutrition_plans (budget_id, lead_id)\nWHERE budget_id IS NOT NULL AND lead_id IS NOT NULL","-- Unique index for steps_plans (when budget_id is set)\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'steps_plans') THEN\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_steps_plans_unique_budget_customer\n    ON steps_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_steps_plans_unique_budget_lead\n    ON steps_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- Unique index for supplement_plans (when budget_id is set)\nCREATE UNIQUE INDEX IF NOT EXISTS idx_supplement_plans_unique_budget_customer\nON supplement_plans (budget_id, customer_id)\nWHERE budget_id IS NOT NULL AND customer_id IS NOT NULL","CREATE UNIQUE INDEX IF NOT EXISTS idx_supplement_plans_unique_budget_lead\nON supplement_plans (budget_id, lead_id)\nWHERE budget_id IS NOT NULL AND lead_id IS NOT NULL","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON INDEX idx_workout_plans_unique_budget_customer IS 'Ensures only one workout plan per budget + customer combination'","COMMENT ON INDEX idx_workout_plans_unique_budget_lead IS 'Ensures only one workout plan per budget + lead combination'","COMMENT ON INDEX idx_nutrition_plans_unique_budget_customer IS 'Ensures only one nutrition plan per budget + customer combination'","COMMENT ON INDEX idx_nutrition_plans_unique_budget_lead IS 'Ensures only one nutrition plan per budget + lead combination'","COMMENT ON INDEX idx_supplement_plans_unique_budget_customer IS 'Ensures only one supplement plan per budget + customer combination'","COMMENT ON INDEX idx_supplement_plans_unique_budget_lead IS 'Ensures only one supplement plan per budget + lead combination'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	prevent_duplicate_plans_per_budget
20260104000009	{"-- =====================================================\n-- Create Payments Table\n-- Created: 2026-01-04\n-- Description: Secure payments table for tracking customer/lead payments\n--              NO sensitive data (card numbers, CVV, passwords) stored\n--              Links to both customers and leads\n-- =====================================================\n\n-- Create payments table\nCREATE TABLE IF NOT EXISTS public.payments (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    customer_id UUID NOT NULL REFERENCES public.customers(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES public.leads(id) ON DELETE SET NULL,\n    product_name TEXT NOT NULL,\n    amount NUMERIC(10, 2) NOT NULL CHECK (amount >= 0),\n    currency TEXT NOT NULL DEFAULT 'ILS',\n    status TEXT NOT NULL CHECK (status IN ('שולם', 'ממתין', 'הוחזר', 'נכשל')),\n    stripe_payment_id TEXT,\n    transaction_id TEXT,\n    receipt_url TEXT,\n    notes TEXT,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Create indexes for efficient queries\nCREATE INDEX IF NOT EXISTS idx_payments_customer_id ON public.payments(customer_id)","CREATE INDEX IF NOT EXISTS idx_payments_lead_id ON public.payments(lead_id)","CREATE INDEX IF NOT EXISTS idx_payments_created_at ON public.payments(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_payments_status ON public.payments(status)","CREATE INDEX IF NOT EXISTS idx_payments_stripe_payment_id ON public.payments(stripe_payment_id) WHERE stripe_payment_id IS NOT NULL","-- Create trigger for auto-updating updated_at\nCREATE TRIGGER update_payments_updated_at\n    BEFORE UPDATE ON public.payments\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- Enable RLS on payments table\nALTER TABLE public.payments ENABLE ROW LEVEL SECURITY","-- RLS Policies for payments\n-- Authenticated users can read payments for customers/leads they have access to\nDROP POLICY IF EXISTS \\"Authenticated users can read payments\\" ON public.payments","CREATE POLICY \\"Authenticated users can read payments\\"\n    ON public.payments FOR SELECT\n    USING (\n        auth.role() = 'authenticated' AND (\n            -- Users can see payments for customers they have access to\n            EXISTS (\n                SELECT 1 FROM public.customers\n                WHERE customers.id = payments.customer_id\n            )\n            OR\n            -- Admins can see all payments\n            EXISTS (\n                SELECT 1 FROM public.profiles\n                WHERE profiles.id = auth.uid() AND profiles.role = 'admin'\n            )\n        )\n    )","-- Authenticated users can insert payments\nDROP POLICY IF EXISTS \\"Authenticated users can insert payments\\" ON public.payments","CREATE POLICY \\"Authenticated users can insert payments\\"\n    ON public.payments FOR INSERT\n    WITH CHECK (auth.role() = 'authenticated')","-- Authenticated users can update payments\nDROP POLICY IF EXISTS \\"Authenticated users can update payments\\" ON public.payments","CREATE POLICY \\"Authenticated users can update payments\\"\n    ON public.payments FOR UPDATE\n    USING (auth.role() = 'authenticated')\n    WITH CHECK (auth.role() = 'authenticated')","-- Admins have full access to payments\nDROP POLICY IF EXISTS \\"Admins have full access to payments\\" ON public.payments","CREATE POLICY \\"Admins have full access to payments\\"\n    ON public.payments FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid() AND profiles.role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid() AND profiles.role = 'admin'\n        )\n    )","-- Add comment to table\nCOMMENT ON TABLE public.payments IS 'Customer/lead payment records. NO sensitive payment data (card numbers, CVV, passwords) stored.'","COMMENT ON COLUMN public.payments.stripe_payment_id IS 'Stripe payment intent ID - external reference only'","COMMENT ON COLUMN public.payments.transaction_id IS 'Transaction ID for tracking purposes'","COMMENT ON COLUMN public.payments.receipt_url IS 'URL to receipt document (stored in secure storage)'","COMMENT ON COLUMN public.payments.status IS 'Payment status in Hebrew: שולם (paid), ממתין (pending), הוחזר (refunded), נכשל (failed)'"}	create_payments
20260111161628	{"-- Migration: Add Media Support to WhatsApp Flow Templates\n-- Description: Adds media column to store image, video, or GIF URLs\n-- Created: 2026-01-11\n\n-- Add media column to whatsapp_flow_templates table\n-- Media is stored as JSONB with structure: { type: 'image'|'video'|'gif', url: string }\nALTER TABLE public.whatsapp_flow_templates\nADD COLUMN IF NOT EXISTS media JSONB DEFAULT NULL","-- Add comment\nCOMMENT ON COLUMN public.whatsapp_flow_templates.media IS 'Media attachment for template (image, video, or GIF) stored as JSONB: { type: \\"image\\"|\\"video\\"|\\"gif\\", url: string }'","-- Add index for faster queries if needed\nCREATE INDEX IF NOT EXISTS idx_whatsapp_flow_templates_media \nON public.whatsapp_flow_templates USING gin(media)"}	add_media_to_whatsapp_templates
20260111162708	{"-- =====================================================\n-- Ensure client-assets storage bucket exists with templates folder policies\n-- Created: 2026-01-11\n-- Description: Ensures the client-assets bucket exists and has RLS policies for templates folder\n-- This migration must be the LAST one in the list for migration up to work correctly\n-- =====================================================\n\n-- Ensure storage bucket exists (idempotent)\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'buckets'\n  ) THEN\n    -- Insert bucket if it doesn't exist (idempotent)\n    INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)\n    VALUES (\n      'client-assets',\n      'client-assets',\n      false, -- private bucket (uses signed URLs)\n      52428800, -- 50MB file size limit (in bytes) - matches config.toml\n      ARRAY[\n        'image/jpeg',\n        'image/jpg', \n        'image/png',\n        'image/gif',\n        'image/webp',\n        'video/mp4',\n        'video/mpeg',\n        'video/quicktime',\n        'application/pdf',\n        'application/msword',\n        'application/vnd.openxmlformats-officedocument.wordprocessingml.document'\n      ]::text[]\n    )\n    ON CONFLICT (id) DO UPDATE SET\n      file_size_limit = EXCLUDED.file_size_limit,\n      allowed_mime_types = EXCLUDED.allowed_mime_types;\n    \n    RAISE NOTICE 'Storage bucket \\"client-assets\\" ensured successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping bucket creation. Enable storage in config.toml and restart Supabase.';\n  END IF;\nEND $$","-- Add RLS policies for templates folder if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- RLS Policy: Allow authenticated users (managers/admins) to upload template files\n    -- Path structure: templates/{user_id}/{flow_key}/{filename}\n    DROP POLICY IF EXISTS \\"Managers can upload template files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can upload template files\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''templates''\n    )';\n\n    -- RLS Policy: Allow authenticated users (managers/admins) to view template files\n    DROP POLICY IF EXISTS \\"Managers can view template files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can view template files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''templates''\n    )';\n\n    -- RLS Policy: Allow authenticated users (managers/admins) to delete template files\n    DROP POLICY IF EXISTS \\"Managers can delete template files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can delete template files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''templates''\n    )';\n\n    RAISE NOTICE 'Storage RLS policies for templates folder created successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy creation. Enable storage in config.toml and restart Supabase to create policies.';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	ensure_client_assets_storage_bucket
20260112000000	{"-- =====================================================\n-- Add Storage Policies for Workout Exercises Media\n-- Created: 2026-01-12\n-- Description: Adds RLS policies to allow managers/admins to upload and manage\n--              images and videos for workout exercises in the client-assets bucket\n-- Path structure: workout-exercises/[exercise_id]/[images|videos]/[file_name]\n-- =====================================================\n\n-- Only create policies if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- RLS Policy: Allow managers/admins to upload workout exercise media\n    DROP POLICY IF EXISTS \\"Managers can upload workout exercise media\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can upload workout exercise media\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''workout-exercises''\n    )';\n\n    -- RLS Policy: Allow managers/admins to view workout exercise media\n    DROP POLICY IF EXISTS \\"Managers can view workout exercise media\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can view workout exercise media\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      (\n        EXISTS (\n          SELECT 1 FROM profiles\n          WHERE profiles.id = auth.uid()\n          AND profiles.role IN (''admin'', ''user'')\n        ) AND\n        (storage.foldername(name))[1] = ''workout-exercises''\n      )\n    )';\n\n    -- RLS Policy: Allow managers/admins to delete workout exercise media\n    DROP POLICY IF EXISTS \\"Managers can delete workout exercise media\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can delete workout exercise media\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''workout-exercises''\n    )';\n\n    RAISE NOTICE 'Workout exercises storage RLS policies created successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy creation. Enable storage in config.toml and restart Supabase to create policies.';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_workout_exercises_storage_policies
\.


--
-- Name: refresh_tokens_id_seq; Type: SEQUENCE SET; Schema: auth; Owner: supabase_auth_admin
--

SELECT pg_catalog.setval('"auth"."refresh_tokens_id_seq"', 7, true);


--
-- PostgreSQL database dump complete
--

-- \unrestrict ugJNs4FBHKuv2HO9Rd02eafPwS4329ZvUMLEbysvHcKZiYSy721t2XhkwzSpaYf

RESET ALL;
