SET session_replication_role = replica;

--
-- PostgreSQL database dump
--

-- \restrict X2iLRBMBTzpTHJl5m8vWiv2uo2kCYrZGg87bvBbcUo0mjfuaKddS1Wr0NrEWDIj

-- Dumped from database version 17.6
-- Dumped by pg_dump version 17.6

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET transaction_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Data for Name: audit_log_entries; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."audit_log_entries" ("instance_id", "id", "payload", "created_at", "ip_address") FROM stdin;
\.


--
-- Data for Name: flow_state; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."flow_state" ("id", "user_id", "auth_code", "code_challenge_method", "code_challenge", "provider_type", "provider_access_token", "provider_refresh_token", "created_at", "updated_at", "authentication_method", "auth_code_issued_at") FROM stdin;
\.


--
-- Data for Name: users; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."users" ("instance_id", "id", "aud", "role", "email", "encrypted_password", "email_confirmed_at", "invited_at", "confirmation_token", "confirmation_sent_at", "recovery_token", "recovery_sent_at", "email_change_token_new", "email_change", "email_change_sent_at", "last_sign_in_at", "raw_app_meta_data", "raw_user_meta_data", "is_super_admin", "created_at", "updated_at", "phone", "phone_confirmed_at", "phone_change", "phone_change_token", "phone_change_sent_at", "email_change_token_current", "email_change_confirm_status", "banned_until", "reauthentication_token", "reauthentication_sent_at", "is_sso_user", "deleted_at", "is_anonymous") FROM stdin;
00000000-0000-0000-0000-000000000000	600a932a-370e-4ed7-9078-5612a0167468	authenticated	authenticated	andreyshokin1@gmail.com	$2a$10$S3stiguewN6FayFwvHRCFOnv0aTm.xrS0pUS5zrSHy6xmKWWeddzG	2026-01-28 15:33:27.197526+00	\N		\N		\N			\N	\N	{"provider": "email", "providers": ["email"]}	{"role": "trainee", "email_verified": true}	\N	2026-01-28 15:33:27.176556+00	2026-01-28 15:33:27.198671+00	\N	\N			\N		0	\N		\N	f	\N	f
00000000-0000-0000-0000-000000000000	6a718dbd-0fa3-4e93-bc64-f2ad3116bc63	authenticated	authenticated	nadav@dietneta.com	$2a$10$MLGmWb.GCYni6ljou37b3.L64fpnNrHL2R74XT8yqsOvmGiepBujG	2026-01-14 02:24:37.290667+00	\N		\N		\N			\N	2026-01-14 02:24:57.900176+00	{"provider": "email", "providers": ["email"]}	{"role": "trainee", "email_verified": true}	\N	2026-01-14 02:24:37.284441+00	2026-01-15 15:55:40.038514+00	\N	\N			\N		0	\N		\N	f	\N	f
00000000-0000-0000-0000-000000000000	fe090720-f100-4977-ba2e-3702fa207e1e	authenticated	authenticated	info@easyflow.co.il	$2a$10$cPv0LB4SBSsKDu24EqnghetmNC1/abg0Pu4KO6nFh6Oalf6AGFfjG	2026-01-14 02:18:28.739353+00	\N		\N		\N			\N	\N	{"provider": "email", "providers": ["email"]}	{"role": "trainee", "email_verified": true}	\N	2026-01-14 02:18:28.734362+00	2026-01-14 02:23:45.870895+00	\N	\N			\N		0	\N		\N	f	\N	f
00000000-0000-0000-0000-000000000000	50668840-6376-4411-9dc4-b7606ead34ef	authenticated	authenticated	manager@dietneta.com	$2a$10$O3Q2KKot5B/PAy/GndjfhOdEm4JhkxVu77zDKbjnMMkP0b9LQGcPG	2026-01-14 01:43:34.364123+00	\N		\N		\N			\N	2026-01-26 16:01:52.155767+00	{"provider": "email", "providers": ["email"]}	{"role": "admin", "full_name": "מנהל מערכת", "email_verified": true}	\N	2026-01-14 01:43:34.347792+00	2026-01-29 13:48:16.910027+00	\N	\N			\N		0	\N		\N	f	\N	f
\.


--
-- Data for Name: identities; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."identities" ("provider_id", "user_id", "identity_data", "provider", "last_sign_in_at", "created_at", "updated_at", "id") FROM stdin;
50668840-6376-4411-9dc4-b7606ead34ef	50668840-6376-4411-9dc4-b7606ead34ef	{"sub": "50668840-6376-4411-9dc4-b7606ead34ef", "email": "manager@dietneta.com", "email_verified": false, "phone_verified": false}	email	2026-01-14 01:43:34.361633+00	2026-01-14 01:43:34.361693+00	2026-01-14 01:43:34.361693+00	d537aa14-5352-49a2-9518-0c4739d1f563
fe090720-f100-4977-ba2e-3702fa207e1e	fe090720-f100-4977-ba2e-3702fa207e1e	{"sub": "fe090720-f100-4977-ba2e-3702fa207e1e", "email": "info@easyflow.co.il", "email_verified": false, "phone_verified": false}	email	2026-01-14 02:18:28.737384+00	2026-01-14 02:18:28.737448+00	2026-01-14 02:18:28.737448+00	48ca58c0-7923-41cb-9013-00cef6b2a103
6a718dbd-0fa3-4e93-bc64-f2ad3116bc63	6a718dbd-0fa3-4e93-bc64-f2ad3116bc63	{"sub": "6a718dbd-0fa3-4e93-bc64-f2ad3116bc63", "email": "nadav@dietneta.com", "email_verified": false, "phone_verified": false}	email	2026-01-14 02:24:37.288363+00	2026-01-14 02:24:37.288427+00	2026-01-14 02:24:37.288427+00	db57d209-579e-4d58-906e-b23f271bfaa8
600a932a-370e-4ed7-9078-5612a0167468	600a932a-370e-4ed7-9078-5612a0167468	{"sub": "600a932a-370e-4ed7-9078-5612a0167468", "email": "andreyshokin1@gmail.com", "email_verified": false, "phone_verified": false}	email	2026-01-28 15:33:27.192671+00	2026-01-28 15:33:27.192737+00	2026-01-28 15:33:27.192737+00	0e8b8711-c87c-4e23-b292-b9628a54f84b
\.


--
-- Data for Name: instances; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."instances" ("id", "uuid", "raw_base_config", "created_at", "updated_at") FROM stdin;
\.


--
-- Data for Name: oauth_clients; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."oauth_clients" ("id", "client_secret_hash", "registration_type", "redirect_uris", "grant_types", "client_name", "client_uri", "logo_uri", "created_at", "updated_at", "deleted_at", "client_type") FROM stdin;
\.


--
-- Data for Name: sessions; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."sessions" ("id", "user_id", "created_at", "updated_at", "factor_id", "aal", "not_after", "refreshed_at", "user_agent", "ip", "tag", "oauth_client_id", "refresh_token_hmac_key", "refresh_token_counter", "scopes") FROM stdin;
18e1a72c-8e7d-4b59-a5ce-06feeb566a06	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-26 16:01:52.155866+00	2026-01-29 13:48:16.911878+00	\N	aal1	\N	2026-01-29 13:48:16.911766	Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36	147.235.208.138	\N	\N	\N	\N	\N
10251bbb-44de-459d-bcf9-2ee130235bb6	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-22 16:27:40.795114+00	2026-01-27 01:24:14.243682+00	\N	aal1	\N	2026-01-27 01:24:14.24359	Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36	87.68.203.20	\N	\N	\N	\N	\N
\.


--
-- Data for Name: mfa_amr_claims; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."mfa_amr_claims" ("session_id", "created_at", "updated_at", "authentication_method", "id") FROM stdin;
10251bbb-44de-459d-bcf9-2ee130235bb6	2026-01-22 16:27:40.797825+00	2026-01-22 16:27:40.797825+00	password	38c42ede-3cbe-4308-bc9c-540b7e095119
18e1a72c-8e7d-4b59-a5ce-06feeb566a06	2026-01-26 16:01:52.181037+00	2026-01-26 16:01:52.181037+00	password	11644ae3-d21e-4b83-92d2-7b6fc1704f30
\.


--
-- Data for Name: mfa_factors; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."mfa_factors" ("id", "user_id", "friendly_name", "factor_type", "status", "created_at", "updated_at", "secret", "phone", "last_challenged_at", "web_authn_credential", "web_authn_aaguid", "last_webauthn_challenge_data") FROM stdin;
\.


--
-- Data for Name: mfa_challenges; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."mfa_challenges" ("id", "factor_id", "created_at", "verified_at", "ip_address", "otp_code", "web_authn_session_data") FROM stdin;
\.


--
-- Data for Name: oauth_authorizations; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."oauth_authorizations" ("id", "authorization_id", "client_id", "user_id", "redirect_uri", "scope", "state", "resource", "code_challenge", "code_challenge_method", "response_type", "status", "authorization_code", "created_at", "expires_at", "approved_at", "nonce") FROM stdin;
\.


--
-- Data for Name: oauth_client_states; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."oauth_client_states" ("id", "provider_type", "code_verifier", "created_at") FROM stdin;
\.


--
-- Data for Name: oauth_consents; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."oauth_consents" ("id", "user_id", "client_id", "scopes", "granted_at", "revoked_at") FROM stdin;
\.


--
-- Data for Name: one_time_tokens; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."one_time_tokens" ("id", "user_id", "token_type", "token_hash", "relates_to", "created_at", "updated_at") FROM stdin;
\.


--
-- Data for Name: refresh_tokens; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."refresh_tokens" ("instance_id", "id", "token", "user_id", "revoked", "created_at", "updated_at", "parent", "session_id") FROM stdin;
00000000-0000-0000-0000-000000000000	123	lqqeuaaenbpn	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 10:46:04.530812+00	2026-01-27 11:44:42.903907+00	fgflofkxwoba	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	98	ca3by2xosazm	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-22 22:42:46.502275+00	2026-01-24 14:34:38.631076+00	zn4khc3vumxi	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	125	ovfcpn2lv7ns	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 12:54:37.222163+00	2026-01-27 13:56:35.480511+00	ksumomc36lmi	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	100	atkblrii2zo7	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-26 16:01:52.169705+00	2026-01-26 17:03:35.752098+00	\N	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	102	oeoup6722qe3	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-26 18:02:25.887376+00	2026-01-26 19:03:21.945601+00	2vjg6sjcwjsp	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	127	lvaslh3i3gaj	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 15:00:07.414155+00	2026-01-27 15:58:56.179499+00	ytgkqfdw6iwt	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	104	boafjml2lqok	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-26 20:06:55.850792+00	2026-01-26 21:09:09.114234+00	7cezimcyrxon	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	106	kwhdonm2rmsi	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-26 21:28:39.015538+00	2026-01-26 22:27:32.365765+00	o5dtdfu42v6j	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	129	c6fvc6pgwdq6	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 16:58:28.816407+00	2026-01-27 17:57:15.428941+00	g36y5eopnoah	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	115	hsjgunsufqno	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 02:13:33.5181+00	2026-01-27 03:39:21.323181+00	y2s7a4gje3x4	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	117	y2n4w7gwzinx	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 04:40:15.042035+00	2026-01-27 05:41:23.691357+00	x5xao7ndm3he	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	131	bns32pcb5ape	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 18:56:03.42001+00	2026-01-27 19:56:42.954699+00	kzjzbn3yy3mu	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	119	r4i4ue2c2jxw	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 06:42:36.170619+00	2026-01-27 07:45:40.346208+00	uknibwb2puw4	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	121	bw5vak5oliks	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 08:45:35.108249+00	2026-01-27 09:45:53.065069+00	g46wke3qikiy	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	133	hmn3uh6kyvzn	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 21:00:40.773138+00	2026-01-27 22:03:03.912413+00	q7uibfqp6seu	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	135	sa66c6lgsxp7	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 23:01:55.31302+00	2026-01-28 00:01:06.015096+00	2uuijpxbultn	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	137	jcswxeqq34fo	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 00:59:52.726692+00	2026-01-28 01:59:51.173042+00	o6egeglwn6mk	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	139	olb3ay3xuqut	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 03:03:37.659127+00	2026-01-28 04:04:08.015106+00	q5ywecqrmgyg	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	141	wo3gaewxcnza	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 05:02:45.454135+00	2026-01-28 06:04:40.529543+00	dnqp6p5qjl7w	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	143	qdrmvb5jqjcg	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 07:03:23.308722+00	2026-01-28 08:03:29.594795+00	hmadano2eb2m	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	145	aofhvn3ezvtm	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 09:05:08.830936+00	2026-01-28 10:06:45.56773+00	qz6rorjfleen	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	147	vgs35jarohzz	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 11:05:44.003223+00	2026-01-28 12:09:23.13638+00	rmr72w6vtpso	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	149	jixfjhgpe3dg	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 13:08:13.055572+00	2026-01-28 14:10:48.760788+00	svnhcsxwpc56	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	151	xcpk77yoh23g	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 15:09:01.269847+00	2026-01-28 16:07:55.694626+00	2sxadqdolubm	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	152	bl64qu3fsiss	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 16:07:55.695562+00	2026-01-28 17:06:45.040917+00	xcpk77yoh23g	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	153	e4dfn653goef	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 17:06:45.04314+00	2026-01-28 18:05:31.696532+00	bl64qu3fsiss	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	154	diej3fxd5sj4	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 18:05:31.696999+00	2026-01-28 19:04:07.080238+00	e4dfn653goef	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	156	2ugy2iygn5oz	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 20:12:09.005281+00	2026-01-28 21:11:02.533725+00	ak5wwwphqmog	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	158	sognvjfss4rt	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 22:09:41.512829+00	2026-01-28 23:10:44.116415+00	cteuuy67nd3f	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	160	uov2v5tgoucw	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-29 00:09:32.956135+00	2026-01-29 01:08:27.737269+00	zjj47bfz7cjq	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	162	opigwfn7tjno	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-29 02:07:34.94063+00	2026-01-29 03:06:16.92279+00	pcofl46knlqu	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	164	33sftclqtkl2	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-29 07:05:40.731949+00	2026-01-29 08:45:45.40545+00	hmqtszd5xa2q	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	166	lzz7uujrxpra	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-29 09:44:42.973958+00	2026-01-29 10:48:10.594091+00	xfhy462txlu7	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	168	2csalj7bekri	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-29 11:48:42.889861+00	2026-01-29 12:49:43.623445+00	dg7njh45hoek	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	170	heogr3q3j2w4	50668840-6376-4411-9dc4-b7606ead34ef	f	2026-01-29 13:48:16.908621+00	2026-01-29 13:48:16.908621+00	3gfuwmkwemmu	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	122	fgflofkxwoba	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 09:45:53.066162+00	2026-01-27 10:46:04.529901+00	bw5vak5oliks	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	124	ksumomc36lmi	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 11:44:42.904967+00	2026-01-27 12:54:37.22114+00	lqqeuaaenbpn	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	126	ytgkqfdw6iwt	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 13:56:35.481689+00	2026-01-27 15:00:07.4133+00	ovfcpn2lv7ns	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	128	g36y5eopnoah	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 15:58:56.180839+00	2026-01-27 16:58:28.815498+00	lvaslh3i3gaj	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	130	kzjzbn3yy3mu	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 17:57:15.429859+00	2026-01-27 18:56:03.418611+00	c6fvc6pgwdq6	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	132	q7uibfqp6seu	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 19:56:42.955839+00	2026-01-27 21:00:40.772153+00	bns32pcb5ape	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	134	2uuijpxbultn	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 22:03:03.913453+00	2026-01-27 23:01:55.312134+00	hmn3uh6kyvzn	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	136	o6egeglwn6mk	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 00:01:06.01624+00	2026-01-28 00:59:52.725735+00	sa66c6lgsxp7	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	138	q5ywecqrmgyg	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 01:59:51.174194+00	2026-01-28 03:03:37.657943+00	jcswxeqq34fo	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	140	dnqp6p5qjl7w	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 04:04:08.015937+00	2026-01-28 05:02:45.453063+00	olb3ay3xuqut	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	142	hmadano2eb2m	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 06:04:40.530417+00	2026-01-28 07:03:23.307199+00	wo3gaewxcnza	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	93	bojbd5mwtpoa	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-22 16:27:40.796469+00	2026-01-22 17:26:36.010832+00	\N	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	144	qz6rorjfleen	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 08:03:29.595673+00	2026-01-28 09:05:08.830034+00	qdrmvb5jqjcg	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	94	7kljzhijpaeo	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-22 17:26:36.011657+00	2026-01-22 18:25:29.971859+00	bojbd5mwtpoa	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	146	rmr72w6vtpso	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 10:06:45.568505+00	2026-01-28 11:05:44.001751+00	aofhvn3ezvtm	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	95	tqp6ivtjykz7	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-22 18:25:29.972174+00	2026-01-22 19:24:24.051096+00	7kljzhijpaeo	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	96	g4y3mrk4btiy	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-22 19:24:24.051454+00	2026-01-22 20:23:21.136252+00	tqp6ivtjykz7	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	148	svnhcsxwpc56	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 12:09:23.13759+00	2026-01-28 13:08:13.054464+00	vgs35jarohzz	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	97	zn4khc3vumxi	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-22 20:23:21.136629+00	2026-01-22 22:42:46.501383+00	g4y3mrk4btiy	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	150	2sxadqdolubm	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 14:10:48.761742+00	2026-01-28 15:09:01.268497+00	jixfjhgpe3dg	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	101	2vjg6sjcwjsp	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-26 17:03:35.75313+00	2026-01-26 18:02:25.886425+00	atkblrii2zo7	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	103	7cezimcyrxon	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-26 19:03:21.946755+00	2026-01-26 20:06:55.849918+00	oeoup6722qe3	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	155	ak5wwwphqmog	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 19:04:07.081518+00	2026-01-28 20:12:09.0033+00	diej3fxd5sj4	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	99	o5dtdfu42v6j	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-24 14:34:38.632012+00	2026-01-26 21:28:39.014261+00	ca3by2xosazm	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	105	io5ovfk4dt5s	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-26 21:09:09.115387+00	2026-01-26 22:08:26.238845+00	boafjml2lqok	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	157	cteuuy67nd3f	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 21:11:02.534868+00	2026-01-28 22:09:41.510815+00	2ugy2iygn5oz	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	107	4npsfxizl3es	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-26 22:08:26.239745+00	2026-01-26 23:10:09.407342+00	io5ovfk4dt5s	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	108	y7dxsdka4whk	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-26 22:27:32.36618+00	2026-01-26 23:26:26.347366+00	kwhdonm2rmsi	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	159	zjj47bfz7cjq	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-28 23:10:44.117867+00	2026-01-29 00:09:32.954953+00	sognvjfss4rt	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	109	d2xcln6caksn	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-26 23:10:09.407762+00	2026-01-27 00:10:51.142211+00	4npsfxizl3es	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	110	t7tsj6zej7qo	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-26 23:26:26.347742+00	2026-01-27 00:25:20.32493+00	y7dxsdka4whk	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	161	pcofl46knlqu	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-29 01:08:27.738119+00	2026-01-29 02:07:34.93945+00	uov2v5tgoucw	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	111	4wf2g5jjk774	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 00:10:51.142661+00	2026-01-27 01:11:07.277167+00	d2xcln6caksn	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	112	6ch25y62s6cl	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 00:25:20.32575+00	2026-01-27 01:24:14.240696+00	t7tsj6zej7qo	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	114	lugzy672xgq5	50668840-6376-4411-9dc4-b7606ead34ef	f	2026-01-27 01:24:14.241544+00	2026-01-27 01:24:14.241544+00	6ch25y62s6cl	10251bbb-44de-459d-bcf9-2ee130235bb6
00000000-0000-0000-0000-000000000000	113	y2s7a4gje3x4	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 01:11:07.277586+00	2026-01-27 02:13:33.517133+00	4wf2g5jjk774	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	163	hmqtszd5xa2q	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-29 03:06:16.923932+00	2026-01-29 07:05:40.731069+00	opigwfn7tjno	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	116	x5xao7ndm3he	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 03:39:21.324195+00	2026-01-27 04:40:15.040723+00	hsjgunsufqno	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	118	uknibwb2puw4	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 05:41:23.692269+00	2026-01-27 06:42:36.169426+00	y2n4w7gwzinx	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	165	xfhy462txlu7	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-29 08:45:45.406415+00	2026-01-29 09:44:42.972476+00	33sftclqtkl2	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	120	g46wke3qikiy	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-27 07:45:40.347517+00	2026-01-27 08:45:35.107332+00	r4i4ue2c2jxw	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	167	dg7njh45hoek	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-29 10:48:10.595109+00	2026-01-29 11:48:42.88876+00	lzz7uujrxpra	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
00000000-0000-0000-0000-000000000000	169	3gfuwmkwemmu	50668840-6376-4411-9dc4-b7606ead34ef	t	2026-01-29 12:49:43.624567+00	2026-01-29 13:48:16.907387+00	2csalj7bekri	18e1a72c-8e7d-4b59-a5ce-06feeb566a06
\.


--
-- Data for Name: sso_providers; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."sso_providers" ("id", "resource_id", "created_at", "updated_at", "disabled") FROM stdin;
\.


--
-- Data for Name: saml_providers; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."saml_providers" ("id", "sso_provider_id", "entity_id", "metadata_xml", "metadata_url", "attribute_mapping", "created_at", "updated_at", "name_id_format") FROM stdin;
\.


--
-- Data for Name: saml_relay_states; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."saml_relay_states" ("id", "sso_provider_id", "request_id", "for_email", "redirect_to", "created_at", "updated_at", "flow_state_id") FROM stdin;
\.


--
-- Data for Name: sso_domains; Type: TABLE DATA; Schema: auth; Owner: supabase_auth_admin
--

COPY "auth"."sso_domains" ("id", "sso_provider_id", "domain", "created_at", "updated_at") FROM stdin;
\.


--
-- Data for Name: customers; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."customers" ("id", "full_name", "phone", "email", "created_at", "updated_at", "daily_protocol", "workout_history", "steps_history", "avatar_url", "total_spent", "membership_tier", "user_id") FROM stdin;
d6f1839c-69ba-485c-a2c8-94ab813608b8	נטע -בדיקה	972545496861	netasway@gmail.com	2026-01-14 20:12:33.415829+00	2026-01-14 20:12:33.415829+00	{}	[]	[]	\N	0.00	New	\N
1bb66d54-a424-493c-98ee-068a879afcb6	ליטל אסיף	972504233707	litalaseef@gmail.com	2026-01-15 15:50:11.975544+00	2026-01-15 15:50:11.975544+00	{}	[]	[]	\N	0.00	New	\N
af7bdb9d-65aa-45b0-be2b-007ea60ae134	נדב	972528393372	\N	2026-01-19 14:14:01.305835+00	2026-01-20 21:55:01.868255+00	{}	[]	[]	\N	0.00	New	fe090720-f100-4977-ba2e-3702fa207e1e
f379a13d-19c9-4338-a0fd-df07cb597f5e	נטע הירש	13058077747	\N	2026-01-21 18:42:34.542653+00	2026-01-21 18:45:20.532737+00	{}	[]	[]	\N	0.00	New	\N
731fd819-64e9-47a7-bafe-409b7103e895	אנדרי שצוקין	972526861485	\N	2026-01-28 14:56:37.891755+00	2026-01-28 15:33:27.321538+00	{}	[]	[]	\N	0.00	New	600a932a-370e-4ed7-9078-5612a0167468
\.


--
-- Data for Name: profiles; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."profiles" ("id", "email", "full_name", "role", "created_at", "updated_at", "is_active", "customer_id", "avatar_url") FROM stdin;
50668840-6376-4411-9dc4-b7606ead34ef	manager@dietneta.com	מנהל מערכת	admin	2026-01-14 01:43:34.347427+00	2026-01-14 01:43:34.528323+00	t	\N	\N
fe090720-f100-4977-ba2e-3702fa207e1e	info@easyflow.co.il		trainee	2026-01-14 02:18:28.734001+00	2026-01-14 02:24:10.792503+00	t	\N	\N
6a718dbd-0fa3-4e93-bc64-f2ad3116bc63	nadav@dietneta.com		trainee	2026-01-14 02:24:37.284111+00	2026-01-14 02:24:37.284111+00	t	\N	\N
600a932a-370e-4ed7-9078-5612a0167468	andreyshokin1@gmail.com		trainee	2026-01-28 15:33:27.176219+00	2026-01-28 15:33:27.176219+00	t	\N	\N
\.


--
-- Data for Name: leads; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."leads" ("id", "created_at", "updated_at", "assigned_to", "city", "birth_date", "gender", "status_main", "status_sub", "height", "weight", "bmi", "join_date", "subscription_data", "daily_protocol", "workout_history", "steps_history", "source", "fitness_goal", "activity_level", "preferred_time", "notes", "customer_id", "nutrition_history", "supplements_history", "age", "period") FROM stdin;
b5fcbb81-6ecb-4268-b5f1-7f0532bc5194	2026-01-14 20:12:33.639764+00	2026-01-14 20:15:43.735911+00	\N	tulsa	\N	female	פעיל	\N	165.00	61.00	22.41	2026-01-14 00:00:00+00	{"months": 1, "status": "פעיל", "initialPrice": 900, "expirationDate": "2026-02-14"}	{}	[]	[]	אינסטגרם	חיטוב	מתקדם	ערב	בודקת	d6f1839c-69ba-485c-a2c8-94ab813608b8	[]	[]	\N	\N
014c0a33-d0c8-4af7-a0d7-806f6169a153	2026-01-15 15:50:12.199708+00	2026-01-15 15:50:12.199708+00	\N	חיפה	\N	female	פעיל	\N	165.00	61.90	22.74	\N	{}	{}	[]	[]	אינסטגרם	חיטוב	בינוני	בוקר	\N	1bb66d54-a424-493c-98ee-068a879afcb6	[]	[]	\N	\N
a6fa7f71-2314-4db8-88fa-d4f76c4b7562	2026-01-21 18:45:20.65218+00	2026-01-21 18:45:20.65218+00	\N	\N	\N	female	פעיל	\N	\N	\N	\N	\N	{}	{}	[]	[]	\N	\N	\N	\N	\N	f379a13d-19c9-4338-a0fd-df07cb597f5e	[]	[]	\N	\N
10827900-0971-4a59-9611-9f8fb929182e	2026-01-21 18:42:34.806097+00	2026-01-21 18:49:13.679562+00	\N	\N	\N	female	\N	\N	180.00	99.00	30.56	2026-01-21 00:00:00+00	{"months": 1, "initialPrice": 1250, "renewalPrice": 0, "subscription_status": "active", "subscription_type_id": "f583c9f6-04d4-4e62-9c41-d552ef8efb2a", "subscription_type_name": "חופשי חודשי"}	{}	[]	[]	\N	\N	\N	\N	\N	f379a13d-19c9-4338-a0fd-df07cb597f5e	[]	[]	45	f
53d28a1c-321f-40d9-8375-a527456a27d5	2026-01-20 21:55:01.987406+00	2026-01-26 21:30:16.017442+00	\N	\N	\N	male	לא פעיל	\N	\N	\N	\N	2026-01-21 00:00:00+00	{"months": 1, "status": "פעיל", "currency": "ILS", "initialPrice": 900, "duration_unit": "months", "expirationDate": "2026-02-21", "currentWeekInProgram": 2}	{}	[]	[]	\N	\N	\N	\N	\N	af7bdb9d-65aa-45b0-be2b-007ea60ae134	[]	[]	\N	\N
80fe6444-d80d-4b5b-8f1c-2fcd8258b36e	2026-01-28 14:56:38.1058+00	2026-01-28 14:58:07.073701+00	\N	\N	\N	female	\N	\N	\N	\N	\N	\N	{}	{}	[]	[]	\N	\N	\N	\N	\N	731fd819-64e9-47a7-bafe-409b7103e895	[]	[]	29	\N
\.


--
-- Data for Name: blood_tests; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."blood_tests" ("id", "lead_id", "file_url", "file_name", "upload_date", "created_at", "updated_at", "uploaded_by") FROM stdin;
\.


--
-- Data for Name: nutrition_templates; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."nutrition_templates" ("id", "name", "description", "targets", "is_public", "created_at", "updated_at", "created_by", "manual_override", "manual_fields", "activity_entries") FROM stdin;
f0500c82-3d6c-4eaa-9134-ead0f4bda4e9	ההה	\N	{"fat": 70, "carbs": 140, "fiber": 32, "protein": 140, "calories": 1750}	f	2026-01-20 22:01:33.317924+00	2026-01-20 22:01:33.317924+00	50668840-6376-4411-9dc4-b7606ead34ef	{"fat": false, "carbs": false, "fiber": false, "protein": false, "calories": false}	{"steps": null, "workouts": null, "supplements": null}	[{"id": "1", "mets": 3.5, "activityType": "הליכה איטית/יוגה/פילאטיס", "minutesPerWeek": 0}, {"id": "2", "mets": 5.5, "activityType": "אימון משקולות כבד", "minutesPerWeek": 0}, {"id": "3", "mets": 6, "activityType": "סטודיו/פונקציונלי/איר", "minutesPerWeek": 0}, {"id": "4", "mets": 7.5, "activityType": "ריצה קלה/ג'וגינג", "minutesPerWeek": 0}, {"id": "5", "mets": 10, "activityType": "ריצה מהירה/שחייה מהירה/ספינינג", "minutesPerWeek": 0}]
60dc71c8-3626-4327-ab2a-01a46b2c3ace	תוכנית נדירה	\N	{"fat": 0, "carbs": 0, "fiber": 30, "protein": 140, "calories": 2000}	f	2026-01-21 18:59:42.639137+00	2026-01-21 18:59:42.639137+00	50668840-6376-4411-9dc4-b7606ead34ef	{"fat": true, "carbs": true, "fiber": true, "protein": true, "calories": true}	{"steps": null, "workouts": null, "supplements": null}	[{"id": "1", "mets": 3.5, "activityType": "הליכה איטית/יוגה/פילאטיס", "minutesPerWeek": 0}, {"id": "2", "mets": 5.5, "activityType": "אימון משקולות כבד", "minutesPerWeek": 0}, {"id": "3", "mets": 6, "activityType": "סטודיו/פונקציונלי/איר", "minutesPerWeek": 0}, {"id": "4", "mets": 7.5, "activityType": "ריצה קלה/ג'וגינג", "minutesPerWeek": 0}, {"id": "5", "mets": 10, "activityType": "ריצה מהירה/שחייה מהירה/ספינינג", "minutesPerWeek": 0}]
\.


--
-- Data for Name: supplement_templates; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."supplement_templates" ("id", "name", "description", "supplements", "is_public", "created_at", "updated_at", "created_by") FROM stdin;
2a9c9f79-14af-47dd-a938-4f1c2de29d2d	מע	\N	[{"name": "מע", "dosage": "", "timing": ""}]	f	2026-01-28 15:00:12.004751+00	2026-01-28 15:00:12.004751+00	50668840-6376-4411-9dc4-b7606ead34ef
\.


--
-- Data for Name: workout_templates; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."workout_templates" ("id", "name", "description", "goal_tags", "routine_data", "is_public", "created_at", "updated_at", "created_by") FROM stdin;
6e717bed-c709-47d3-9688-fdd3f137f0e7	תבנית ללא שם	\N	{}	{"weeklyWorkout": {"days": {"friday": {"day": "friday", "isActive": false, "exercises": []}, "monday": {"day": "monday", "isActive": false, "exercises": []}, "sunday": {"day": "sunday", "isActive": true, "exercises": [{"id": "1768946436759-0.28402187621147057", "name": "גדכדג", "reps": 10, "sets": 3}, {"id": "1768946454713-0.4004387696292534", "name": "ספסל לחיצה", "reps": 8, "sets": 4}, {"id": "1768946454713-0.9199210131944925", "name": "לחיצת כתפיים", "reps": 10, "sets": 3}, {"id": "1768946454713-0.6136195738413109", "name": "דיפים", "reps": 12, "sets": 3}, {"id": "1768946454713-0.1684890227843283", "name": "טריצפס", "reps": 12, "sets": 3}, {"id": "1768946458321-0.6911141340853347", "name": "ספסל לחיצה", "reps": 8, "sets": 4}, {"id": "1768946458321-0.5306429205092226", "name": "לחיצת כתפיים", "reps": 10, "sets": 3}, {"id": "1768946458321-0.6038593862366576", "name": "דיפים", "reps": 12, "sets": 3}, {"id": "1768946458321-0.480898070299403", "name": "טריצפס", "reps": 12, "sets": 3}]}, "tuesday": {"day": "tuesday", "isActive": false, "exercises": []}, "saturday": {"day": "saturday", "isActive": false, "exercises": []}, "thursday": {"day": "thursday", "isActive": false, "exercises": []}, "wednesday": {"day": "wednesday", "isActive": false, "exercises": []}}, "startDate": "2026-01-21", "stepsGoal": 0, "description": "", "generalGoals": ""}}	f	2026-01-20 22:01:17.71368+00	2026-01-20 22:01:17.71368+00	50668840-6376-4411-9dc4-b7606ead34ef
97a36f1e-a527-45d9-81d3-5206af40b56a	תוכנית לנשים רזות כבר 	\N	{}	{"weeklyWorkout": {"days": {"friday": {"day": "friday", "isActive": false, "exercises": []}, "monday": {"day": "monday", "isActive": true, "exercises": [{"id": "1769021592471-0.016841179009880247", "name": "סקווטים", "reps": 10, "sets": 3, "image_url": "https://www.youtube.com/watch?v=sBJppqCeFGI"}, {"id": "1769021648081-0.94583902367398", "name": "עעעעע", "reps": 9, "sets": 3}, {"id": "1769021654703-0.02306508014809061", "name": "כעיכע", "reps": 10, "sets": 3}]}, "sunday": {"day": "sunday", "isActive": false, "exercises": []}, "tuesday": {"day": "tuesday", "isActive": false, "exercises": []}, "saturday": {"day": "saturday", "isActive": false, "exercises": []}, "thursday": {"day": "thursday", "isActive": false, "exercises": []}, "wednesday": {"day": "wednesday", "isActive": false, "exercises": []}}, "startDate": "2026-01-28", "stepsGoal": 0, "description": "תוכנית לנשים רזות כבר ", "generalGoals": ""}}	f	2026-01-21 18:54:25.264947+00	2026-01-28 15:01:21.616873+00	50668840-6376-4411-9dc4-b7606ead34ef
\.


--
-- Data for Name: budgets; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."budgets" ("id", "name", "description", "nutrition_template_id", "nutrition_targets", "steps_goal", "steps_instructions", "workout_template_id", "supplements", "eating_order", "eating_rules", "is_public", "created_at", "updated_at", "created_by", "supplement_template_id", "cardio_training", "interval_training") FROM stdin;
8993ff19-90da-4796-bf14-27629e45e544	כככ	\N	f0500c82-3d6c-4eaa-9134-ead0f4bda4e9	{"fat": 70, "carbs": 140, "protein": 140, "calories": 1750, "fiber_min": 32, "water_min": 2.5}	0	\N	6e717bed-c709-47d3-9688-fdd3f137f0e7	[{"name": "גהכ", "dosage": "33", "timing": "ככ"}, {"name": "22", "dosage": "44", "timing": "ככ"}]	\N	\N	f	2026-01-20 22:01:51.937534+00	2026-01-20 22:01:51.937534+00	50668840-6376-4411-9dc4-b7606ead34ef	\N	\N	\N
fb9e1667-42c2-4a7f-b68a-36edb6639176	כככ	\N	\N	{"fat": 70, "carbs": 140, "protein": 140, "calories": 1750, "fiber_min": 32, "water_min": 2.5}	800	\N	\N	[{"name": "גהכ", "dosage": "33", "timing": "ככ"}, {"name": "22", "dosage": "44", "timing": "ככ"}]	\N	\N	f	2026-01-20 22:05:09.190324+00	2026-01-20 22:05:15.251171+00	50668840-6376-4411-9dc4-b7606ead34ef	\N	\N	\N
8e853ecf-5a46-46e0-9617-4e8fa8204d73	כככ	\N	60dc71c8-3626-4327-ab2a-01a46b2c3ace	{"fat": 0, "carbs": 0, "protein": 140, "calories": 2000, "fiber_min": 30}	800	\N	97a36f1e-a527-45d9-81d3-5206af40b56a	[{"name": "גהכ", "dosage": "33", "timing": "ככ"}, {"name": "22", "dosage": "44", "timing": "ככ"}, {"name": "מע", "dosage": "", "timing": ""}]	\N	\N	f	2026-01-28 14:59:44.015672+00	2026-01-28 15:01:23.08104+00	50668840-6376-4411-9dc4-b7606ead34ef	\N	[{"id": "workout-1769612413766-0.26381308824753547", "name": "ריצה", "type": "erobi", "notes": "", "period_type": "לשבוע", "duration_minutes": 60, "workouts_per_week": 1}]	\N
e29f6377-3741-491e-ad6e-b90573aac300	תקציב לנטע	\N	60dc71c8-3626-4327-ab2a-01a46b2c3ace	{"fat": 0, "carbs": 0, "protein": 140, "calories": 2000, "fiber_min": 30, "water_min": 2.5}	7000	\N	97a36f1e-a527-45d9-81d3-5206af40b56a	[{"name": "ויטמין די", "dosage": "22", "timing": "בערב"}, {"name": "קריאטין", "dosage": "19", "timing": "בבוקר"}]	\N	\N	f	2026-01-28 15:31:57.542787+00	2026-01-28 15:32:01.009185+00	50668840-6376-4411-9dc4-b7606ead34ef	\N	\N	\N
c990c184-430f-4adb-8516-a2762a00682f	תקציב לנטע	\N	60dc71c8-3626-4327-ab2a-01a46b2c3ace	{"fat": 0, "carbs": 0, "protein": 140, "calories": 2000, "fiber_min": 30, "water_min": 2.5}	7000	\N	97a36f1e-a527-45d9-81d3-5206af40b56a	[{"name": "ויטמין די", "dosage": "22", "timing": "בערב"}, {"name": "קריאטין", "dosage": "19", "timing": "בבוקר"}]	\N	\N	f	2026-01-21 19:00:08.809822+00	2026-01-28 15:32:14.331203+00	50668840-6376-4411-9dc4-b7606ead34ef	\N	\N	\N
\.


--
-- Data for Name: budget_assignments; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."budget_assignments" ("id", "budget_id", "lead_id", "customer_id", "assigned_at", "assigned_by", "is_active", "notes", "created_at", "updated_at") FROM stdin;
6adc866c-ff6e-4dd5-974b-8df60e233d72	8993ff19-90da-4796-bf14-27629e45e544	53d28a1c-321f-40d9-8375-a527456a27d5	\N	2026-01-20 22:01:56.009842+00	50668840-6376-4411-9dc4-b7606ead34ef	f	\N	2026-01-20 22:01:56.009842+00	2026-01-20 22:04:49.678563+00
1c04b939-e3ae-4330-966f-7de64705f23a	fb9e1667-42c2-4a7f-b68a-36edb6639176	53d28a1c-321f-40d9-8375-a527456a27d5	\N	2026-01-20 22:04:49.798591+00	50668840-6376-4411-9dc4-b7606ead34ef	f	גגג	2026-01-20 22:04:49.798591+00	2026-01-20 22:05:16.104875+00
2c441d62-3941-4009-b076-f91d14b4f0ce	fb9e1667-42c2-4a7f-b68a-36edb6639176	53d28a1c-321f-40d9-8375-a527456a27d5	\N	2026-01-20 22:05:16.213396+00	50668840-6376-4411-9dc4-b7606ead34ef	t	\N	2026-01-20 22:05:16.213396+00	2026-01-20 22:05:16.213396+00
bdacc43b-8b38-453c-b114-ecef7e008569	c990c184-430f-4adb-8516-a2762a00682f	10827900-0971-4a59-9611-9f8fb929182e	\N	2026-01-21 19:00:13.359528+00	50668840-6376-4411-9dc4-b7606ead34ef	t	\N	2026-01-21 19:00:13.359528+00	2026-01-21 19:00:13.359528+00
46abad09-312c-42e4-b67e-bd981c55a4a8	e29f6377-3741-491e-ad6e-b90573aac300	80fe6444-d80d-4b5b-8f1c-2fcd8258b36e	\N	2026-01-28 15:31:47.722664+00	50668840-6376-4411-9dc4-b7606ead34ef	t	\N	2026-01-28 15:31:47.722664+00	2026-01-28 15:31:57.750329+00
\.


--
-- Data for Name: budget_history; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."budget_history" ("id", "budget_id", "changed_at", "changed_by", "change_type", "changes", "snapshot", "lead_id") FROM stdin;
b02137d2-aa02-44cf-ad6c-6885de28691d	8e853ecf-5a46-46e0-9617-4e8fa8204d73	2026-01-28 14:59:44.015672+00	50668840-6376-4411-9dc4-b7606ead34ef	create	{}	{"id": "8e853ecf-5a46-46e0-9617-4e8fa8204d73", "name": "כככ", "is_public": false, "created_at": "2026-01-28T14:59:44.015672+00:00", "created_by": "50668840-6376-4411-9dc4-b7606ead34ef", "steps_goal": 800, "updated_at": "2026-01-28T14:59:44.015672+00:00", "description": null, "supplements": [{"name": "גהכ", "dosage": "33", "timing": "ככ"}, {"name": "22", "dosage": "44", "timing": "ככ"}], "eating_order": null, "eating_rules": null, "cardio_training": null, "interval_training": null, "nutrition_targets": {"fat": 70, "carbs": 140, "protein": 140, "calories": 1750, "fiber_min": 32, "water_min": 2.5}, "steps_instructions": null, "workout_template_id": null, "nutrition_template_id": null, "supplement_template_id": null}	\N
d0bf0afe-2ed1-47d9-b604-578b190448b6	8e853ecf-5a46-46e0-9617-4e8fa8204d73	2026-01-28 15:00:24.221019+00	50668840-6376-4411-9dc4-b7606ead34ef	update	{"new": {"id": "8e853ecf-5a46-46e0-9617-4e8fa8204d73", "name": "כככ", "is_public": false, "created_at": "2026-01-28T14:59:44.015672+00:00", "created_by": "50668840-6376-4411-9dc4-b7606ead34ef", "steps_goal": 800, "updated_at": "2026-01-28T15:00:24.221019+00:00", "description": null, "supplements": [{"name": "גהכ", "dosage": "33", "timing": "ככ"}, {"name": "22", "dosage": "44", "timing": "ככ"}, {"name": "מע", "dosage": "", "timing": ""}], "eating_order": null, "eating_rules": null, "cardio_training": [{"id": "workout-1769612413766-0.26381308824753547", "name": "ריצה", "type": "erobi", "notes": "", "period_type": "לשבוע", "duration_minutes": 60, "workouts_per_week": 1}], "interval_training": null, "nutrition_targets": {"fat": 0, "carbs": 0, "protein": 140, "calories": 2000, "fiber_min": 30}, "steps_instructions": null, "workout_template_id": "97a36f1e-a527-45d9-81d3-5206af40b56a", "nutrition_template_id": "60dc71c8-3626-4327-ab2a-01a46b2c3ace", "supplement_template_id": null}, "old": {"id": "8e853ecf-5a46-46e0-9617-4e8fa8204d73", "name": "כככ", "is_public": false, "created_at": "2026-01-28T14:59:44.015672+00:00", "created_by": "50668840-6376-4411-9dc4-b7606ead34ef", "steps_goal": 800, "updated_at": "2026-01-28T14:59:44.015672+00:00", "description": null, "supplements": [{"name": "גהכ", "dosage": "33", "timing": "ככ"}, {"name": "22", "dosage": "44", "timing": "ככ"}], "eating_order": null, "eating_rules": null, "cardio_training": null, "interval_training": null, "nutrition_targets": {"fat": 70, "carbs": 140, "protein": 140, "calories": 1750, "fiber_min": 32, "water_min": 2.5}, "steps_instructions": null, "workout_template_id": null, "nutrition_template_id": null, "supplement_template_id": null}}	{"id": "8e853ecf-5a46-46e0-9617-4e8fa8204d73", "name": "כככ", "is_public": false, "created_at": "2026-01-28T14:59:44.015672+00:00", "created_by": "50668840-6376-4411-9dc4-b7606ead34ef", "steps_goal": 800, "updated_at": "2026-01-28T15:00:24.221019+00:00", "description": null, "supplements": [{"name": "גהכ", "dosage": "33", "timing": "ככ"}, {"name": "22", "dosage": "44", "timing": "ככ"}, {"name": "מע", "dosage": "", "timing": ""}], "eating_order": null, "eating_rules": null, "cardio_training": [{"id": "workout-1769612413766-0.26381308824753547", "name": "ריצה", "type": "erobi", "notes": "", "period_type": "לשבוע", "duration_minutes": 60, "workouts_per_week": 1}], "interval_training": null, "nutrition_targets": {"fat": 0, "carbs": 0, "protein": 140, "calories": 2000, "fiber_min": 30}, "steps_instructions": null, "workout_template_id": "97a36f1e-a527-45d9-81d3-5206af40b56a", "nutrition_template_id": "60dc71c8-3626-4327-ab2a-01a46b2c3ace", "supplement_template_id": null}	80fe6444-d80d-4b5b-8f1c-2fcd8258b36e
9a342ec3-c21d-4c90-8790-2f3112415e84	8e853ecf-5a46-46e0-9617-4e8fa8204d73	2026-01-28 15:01:24.033577+00	50668840-6376-4411-9dc4-b7606ead34ef	workout_create	{"entity": "workout_plan"}	{"id": "d95e8dcc-6425-45bd-98ea-3583cc7bd32e", "name": null, "cardio": 0, "lead_id": "80fe6444-d80d-4b5b-8f1c-2fcd8258b36e", "user_id": "50668840-6376-4411-9dc4-b7606ead34ef", "strength": 0, "budget_id": "8e853ecf-5a46-46e0-9617-4e8fa8204d73", "intervals": 0, "is_active": true, "created_at": "2026-01-28T15:01:24.033577+00:00", "created_by": "50668840-6376-4411-9dc4-b7606ead34ef", "deleted_at": null, "start_date": "2026-01-28", "updated_at": "2026-01-28T15:01:24.033577+00:00", "customer_id": "731fd819-64e9-47a7-bafe-409b7103e895", "description": "תוכנית אימונים מתכנית פעולה: כככ", "template_id": "97a36f1e-a527-45d9-81d3-5206af40b56a", "custom_attributes": {"data": {"weeklyWorkout": {"days": {"friday": {"day": "friday", "isActive": false, "exercises": []}, "monday": {"day": "monday", "isActive": true, "exercises": [{"id": "1769021592471-0.016841179009880247", "name": "סקווטים", "reps": 10, "sets": 3, "image_url": "https://www.youtube.com/watch?v=sBJppqCeFGI"}, {"id": "1769021648081-0.94583902367398", "name": "עעעעע", "reps": 9, "sets": 3}, {"id": "1769021654703-0.02306508014809061", "name": "כעיכע", "reps": 10, "sets": 3}]}, "sunday": {"day": "sunday", "isActive": false, "exercises": []}, "tuesday": {"day": "tuesday", "isActive": false, "exercises": []}, "saturday": {"day": "saturday", "isActive": false, "exercises": []}, "thursday": {"day": "thursday", "isActive": false, "exercises": []}, "wednesday": {"day": "wednesday", "isActive": false, "exercises": []}}, "startDate": "2026-01-28", "stepsGoal": 0, "description": "תוכנית לנשים רזות כבר ", "generalGoals": ""}}, "schema": []}}	80fe6444-d80d-4b5b-8f1c-2fcd8258b36e
201f1109-ce66-4522-bc27-80be60b0987f	8e853ecf-5a46-46e0-9617-4e8fa8204d73	2026-01-28 15:01:24.299942+00	50668840-6376-4411-9dc4-b7606ead34ef	nutrition_create	{"entity": "nutrition_plan"}	{"id": "0e20895b-8000-422b-93d9-767323161e06", "name": null, "lead_id": "80fe6444-d80d-4b5b-8f1c-2fcd8258b36e", "targets": {"fat": 0, "carbs": 0, "protein": 140, "calories": 2000, "fiber_min": 30}, "user_id": "50668840-6376-4411-9dc4-b7606ead34ef", "budget_id": "8e853ecf-5a46-46e0-9617-4e8fa8204d73", "is_active": true, "created_at": "2026-01-28T15:01:24.299942+00:00", "created_by": "50668840-6376-4411-9dc4-b7606ead34ef", "deleted_at": null, "start_date": "2026-01-28", "updated_at": "2026-01-28T15:01:24.299942+00:00", "customer_id": "731fd819-64e9-47a7-bafe-409b7103e895", "description": "תוכנית תזונה מתכנית פעולה: כככ", "template_id": "60dc71c8-3626-4327-ab2a-01a46b2c3ace"}	80fe6444-d80d-4b5b-8f1c-2fcd8258b36e
879b1064-0f01-4065-a960-b3223459ce60	e29f6377-3741-491e-ad6e-b90573aac300	2026-01-28 15:31:57.542787+00	50668840-6376-4411-9dc4-b7606ead34ef	create	{}	{"id": "e29f6377-3741-491e-ad6e-b90573aac300", "name": "תקציב לנטע", "is_public": false, "created_at": "2026-01-28T15:31:57.542787+00:00", "created_by": "50668840-6376-4411-9dc4-b7606ead34ef", "steps_goal": 7000, "updated_at": "2026-01-28T15:31:57.542787+00:00", "description": null, "supplements": [{"name": "ויטמין די", "dosage": "22", "timing": "בערב"}, {"name": "קריאטין", "dosage": "19", "timing": "בבוקר"}], "eating_order": null, "eating_rules": null, "cardio_training": null, "interval_training": null, "nutrition_targets": {"fat": 0, "carbs": 0, "protein": 140, "calories": 2000, "fiber_min": 30, "water_min": 2.5}, "steps_instructions": null, "workout_template_id": "97a36f1e-a527-45d9-81d3-5206af40b56a", "nutrition_template_id": "60dc71c8-3626-4327-ab2a-01a46b2c3ace", "supplement_template_id": null}	\N
\.


--
-- Data for Name: check_in_field_configurations; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."check_in_field_configurations" ("id", "customer_id", "configuration", "created_at", "updated_at", "created_by") FROM stdin;
5c68344d-c4c8-4d00-8498-ed4a20eda3a5	\N	{"fields": {"weight": {"unit": "ק״ג", "label": "משקל", "section": "body", "visible": true}, "fiberDaily": {"unit": "גרם", "label": "סיבים יומי", "section": "nutrition", "visible": true}, "sleepHours": {"unit": "שעות", "label": "כמה שעות ישנת", "section": "wellness", "visible": true}, "energyLevel": {"unit": "1-10", "label": "רמת האנרגיה שלך", "section": "wellness", "visible": true}, "hungerLevel": {"unit": "1-10", "label": "רמת הרעב שלך", "section": "wellness", "visible": true}, "stepsActual": {"unit": "צעדים", "label": "מס' צעדים יומי", "section": "activity", "visible": true}, "stressLevel": {"unit": "1-10", "label": "רמת הלחץ היומי", "section": "wellness", "visible": true}, "waterAmount": {"unit": "ליטר", "label": "כמה מים שתית", "section": "nutrition", "visible": true}, "cardioAmount": {"unit": "דקות", "label": "כמה אירובי עשית", "section": "activity", "visible": true}, "proteinDaily": {"unit": "גרם", "label": "חלבון יומי", "section": "nutrition", "visible": true}, "caloriesDaily": {"unit": "קק״ל", "label": "קלוריות יומי", "section": "nutrition", "visible": true}, "exercisesCount": {"unit": "תרגילים", "label": "כמה תרגילים עשית", "section": "activity", "visible": true}, "intervalsCount": {"unit": "אינטרוולים", "label": "כמה אינטרוולים", "section": "activity", "visible": true}, "armCircumference": {"unit": "ס״מ", "label": "היקף יד", "section": "body", "visible": true}, "neckCircumference": {"unit": "ס״מ", "label": "היקף צוואר", "section": "body", "visible": true}, "bellyCircumference": {"unit": "ס״מ", "label": "היקף בטן (הכי רחב)", "section": "body", "visible": true}, "thighCircumference": {"unit": "ס״מ", "label": "היקף ירכיים", "section": "body", "visible": true}, "waistCircumference": {"unit": "ס״מ", "label": "היקף מותן (הכי צר)", "section": "body", "visible": true}, "custom_1768485465873_4xp6v7g5j": {"id": "custom_1768485465873_4xp6v7g5j", "unit": "ק״ג", "label": "היקף ישבן ", "section": "body", "visible": true}}, "sections": {"body": {"label": "מדדי גוף", "visible": true}, "activity": {"label": "פעילות", "visible": true}, "wellness": {"label": "בריאות", "visible": true}, "nutrition": {"label": "תזונה", "visible": true}}}	2026-01-15 13:58:03.252625+00	2026-01-15 13:58:02.408+00	50668840-6376-4411-9dc4-b7606ead34ef
\.


--
-- Data for Name: collections; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."collections" ("id", "lead_id", "customer_id", "total_amount", "due_date", "status", "description", "notes", "created_at", "updated_at", "created_by") FROM stdin;
dffcc90d-a08c-45a4-b53a-29c1844ff1e5	53d28a1c-321f-40d9-8375-a527456a27d5	af7bdb9d-65aa-45b0-be2b-007ea60ae134	400.00	\N	ממתין	\N	\N	2026-01-20 21:55:46.136699+00	2026-01-20 21:55:46.136699+00	50668840-6376-4411-9dc4-b7606ead34ef
1014ae22-76c5-4d7d-8eef-33dcae16897c	a6fa7f71-2314-4db8-88fa-d4f76c4b7562	\N	900.00	2026-01-30	ממתין	\N	\N	2026-01-21 19:13:59.12493+00	2026-01-21 19:13:59.12493+00	50668840-6376-4411-9dc4-b7606ead34ef
\.


--
-- Data for Name: customer_notes; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."customer_notes" ("id", "customer_id", "content", "created_at", "updated_at", "created_by", "lead_id", "attachment_url") FROM stdin;
1f71496e-b290-4f47-8636-802889ba0dc7	f379a13d-19c9-4338-a0fd-df07cb597f5e	שגדכגשדכ\nדגכ	2026-01-21 18:47:49.713546+00	2026-01-21 18:47:49.713546+00	\N	10827900-0971-4a59-9611-9f8fb929182e	\N
\.


--
-- Data for Name: daily_check_ins; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."daily_check_ins" ("id", "customer_id", "lead_id", "check_in_date", "workout_completed", "steps_goal_met", "steps_actual", "nutrition_goal_met", "supplements_taken", "notes", "created_at", "updated_at", "created_by", "weight", "belly_circumference", "waist_circumference", "thigh_circumference", "arm_circumference", "neck_circumference", "exercises_count", "cardio_amount", "intervals_count", "calories_daily", "protein_daily", "fiber_daily", "water_amount", "stress_level", "hunger_level", "energy_level", "sleep_hours") FROM stdin;
3d8770a6-16f4-4079-9b9c-edb51b08fe9e	af7bdb9d-65aa-45b0-be2b-007ea60ae134	\N	2026-01-19	f	f	\N	f	[]	\N	2026-01-19 15:16:56.729137+00	2026-01-20 21:54:28.972687+00	\N	60.00	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N
e9a79e68-e565-4909-ba32-e63e1dea91e5	af7bdb9d-65aa-45b0-be2b-007ea60ae134	\N	2026-01-21	f	f	\N	f	[]	\N	2026-01-19 15:17:02.14401+00	2026-01-20 21:54:28.972687+00	\N	\N	\N	\N	50	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N	\N
\.


--
-- Data for Name: exercises; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."exercises" ("id", "name", "repetitions", "weight", "image", "video_link", "created_at", "updated_at", "created_by") FROM stdin;
\.


--
-- Data for Name: external_knowledge_base; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."external_knowledge_base" ("id", "title", "content", "images", "videos", "status", "created_at", "updated_at", "created_by", "cover_image") FROM stdin;
593bc099-8995-4b07-99df-8dfd3638fce5	כותרת	{"blocks": [{"type": "text", "content": "<p>זה מרמק נדיר ביותר</p><p><br></p><p><br></p><p><br></p><p><img src=\\"https://uklxejsaenqoxujcjkba.supabase.co/storage/v1/object/sign/client-assets/knowledge-base/images/inline-1769022705937-ki4rxe.jpeg?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9jMGRhYTJhMC03YmRlLTQxMTMtYWJlYy1lYzA4ZTZiMDliNjEiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJjbGllbnQtYXNzZXRzL2tub3dsZWRnZS1iYXNlL2ltYWdlcy9pbmxpbmUtMTc2OTAyMjcwNTkzNy1raTRyeGUuanBlZyIsImlhdCI6MTc2OTAyMjcwNiwiZXhwIjoxODAwNTU4NzA2fQ.qGxu978f1ZaFQT2qsod54V7H2HmEbecIpRSXBJ67ltw\\"></p><p><br></p><p><br></p><h1>להזהר מפחמימות</h1>"}]}	{}	{}	draft	2026-01-21 19:10:53.32143+00	2026-01-21 19:12:12.256875+00	50668840-6376-4411-9dc4-b7606ead34ef	\N
\.


--
-- Data for Name: fillout_submissions; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."fillout_submissions" ("id", "fillout_submission_id", "fillout_form_id", "submission_type", "submission_data", "lead_id", "customer_id", "created_at", "updated_at", "created_by") FROM stdin;
67fb7fa5-11c7-4239-91b9-3b7d7ff5d002	fba124eb-d6a0-47de-987b-d1b58788f9c3	שאלון התאמה	שאלון התאמה	{"_formId": "שאלון התאמה", "Form_name": "שאלון התאמה", "_formName": "שאלון התאמה", "form_name": "שאלון התאמה", "meeting_type": "שאלון התאמה", "_submissionTime": "2026-01-22T15:07:37.807Z", "סוג פגישה": "שאלון התאמה", "_rawWebhookPayload": {"form_name": "שאלון התאמה", "submission_id": "fba124eb-d6a0-47de-987b-d1b58788f9c3"}}	\N	\N	2026-01-22 15:07:39.185602+00	2026-01-22 15:07:39.185602+00	\N
9af41a6b-868b-4473-98f1-c830f71a0515	f741380f-0417-4f20-a9dc-2f47208d4bf0	שאלון התאמה	שאלון התאמה	{"_formId": "שאלון התאמה", "Form_name": "שאלון התאמה", "_formName": "שאלון התאמה", "form_name": "שאלון התאמה", "meeting_type": "שאלון התאמה", "_submissionTime": "2026-01-25T06:17:34.705Z", "סוג פגישה": "שאלון התאמה", "_rawWebhookPayload": {"form_name": "שאלון התאמה", "submission_id": "f741380f-0417-4f20-a9dc-2f47208d4bf0"}}	\N	\N	2026-01-25 06:17:35.805903+00	2026-01-25 06:17:35.805903+00	\N
23770134-fdca-4ce7-9e96-b6c64a917470	afa93c09-fc89-4a92-81a4-b65baa2961c9	שאלון התאמה	שאלון התאמה	{"_formId": "שאלון התאמה", "Form_name": "שאלון התאמה", "_formName": "שאלון התאמה", "form_name": "שאלון התאמה", "meeting_type": "שאלון התאמה", "_submissionTime": "2026-01-25T19:40:06.859Z", "סוג פגישה": "שאלון התאמה", "_rawWebhookPayload": {"form_name": "שאלון התאמה", "submission_id": "afa93c09-fc89-4a92-81a4-b65baa2961c9"}}	\N	\N	2026-01-25 19:40:07.863678+00	2026-01-25 19:40:07.863678+00	\N
67a05101-6aed-4b39-a6b0-bf424a218aef	f8189b57-014e-4475-84ee-512c19c5e079		other	{"lead_id": "80fe6444-d80d-4b5b-8f1c-2fcd8258b36e", "Form_name": "פגישת התאמה", "_formName": "פגישת התאמה", "eventEndTime": "2026-02-02T16:30:00.000Z", "meeting_type": "פגישת התאמה", "eventStartTime": "2026-02-02T16:00:00.000Z", "event_end_time": "2026-02-02T16:30:00.000Z", "_submissionTime": "2026-01-28T16:09:00.386Z", "event_start_time": "2026-02-02T16:00:00.000Z", "סוג פגישה": "פגישת התאמה", "_rawWebhookPayload": {"lead_id": "80fe6444-d80d-4b5b-8f1c-2fcd8258b36e", "Form_name": "פגישת התאמה", "submission_id": "f8189b57-014e-4475-84ee-512c19c5e079", "event_end_time": "2026-02-02T16:30:00.000Z", "event_start_time": "2026-02-02T16:00:00.000Z"}}	80fe6444-d80d-4b5b-8f1c-2fcd8258b36e	731fd819-64e9-47a7-bafe-409b7103e895	2026-01-28 16:09:00.702958+00	2026-01-28 16:09:00.702958+00	\N
77164244-c19b-4540-8b83-f9e6dc6c7c76	817f9c3a-4853-42db-95f5-438bfbc297b4	n5VwsjFk5ous	meeting	{"_formId": "n5VwsjFk5ous", "lead_id": "80fe6444-d80d-4b5b-8f1c-2fcd8258b36e", "Form_name": "פגישת התאמה", "_formName": "פגישת התאמה", "eventEndTime": "2026-02-02T18:30:00.000Z", "meeting_type": "פגישת התאמה", "eventStartTime": "2026-02-02T18:00:00.000Z", "event_end_time": "2026-02-02T18:30:00.000Z", "_submissionTime": "2026-01-28T16:15:21.155Z", "event_start_time": "2026-02-02T18:00:00.000Z", "סוג פגישה": "פגישת התאמה", "_rawWebhookPayload": {"form_id": "n5VwsjFk5ous", "lead_id": "80fe6444-d80d-4b5b-8f1c-2fcd8258b36e", "Form_name": "פגישת התאמה", "submission_id": "817f9c3a-4853-42db-95f5-438bfbc297b4", "event_end_time": "2026-02-02T18:30:00.000Z", "event_start_time": "2026-02-02T18:00:00.000Z"}}	80fe6444-d80d-4b5b-8f1c-2fcd8258b36e	731fd819-64e9-47a7-bafe-409b7103e895	2026-01-28 16:15:21.706056+00	2026-01-28 16:15:21.706056+00	\N
48cf5549-0f78-4c61-81e4-006df66a32b5	8b3b5e40-ef50-41d1-8dd1-cae1ba930481	jHNYYKDSGpus	שאלון התאמה	{"_formId": "jHNYYKDSGpus", "lead_id": "80fe6444-d80d-4b5b-8f1c-2fcd8258b36e", "Form_name": "שאלון התאמה", "_formName": "שאלון התאמה", "form_name": "שאלון התאמה", "meeting_type": "שאלון התאמה", "_submissionTime": "2026-01-28T16:24:28.105Z", "סוג פגישה": "שאלון התאמה", "_rawWebhookPayload": {"formId": "jHNYYKDSGpus", "lead_id": "80fe6444-d80d-4b5b-8f1c-2fcd8258b36e", "form_name": "שאלון התאמה", "submission_id": "8b3b5e40-ef50-41d1-8dd1-cae1ba930481"}}	80fe6444-d80d-4b5b-8f1c-2fcd8258b36e	731fd819-64e9-47a7-bafe-409b7103e895	2026-01-28 16:24:29.010604+00	2026-01-28 16:24:29.010604+00	\N
\.


--
-- Data for Name: green_api_settings; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."green_api_settings" ("id", "id_instance", "api_token_instance", "created_at", "updated_at", "created_by", "updated_by") FROM stdin;
\.


--
-- Data for Name: interface_folders; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."interface_folders" ("id", "name", "interface_key", "user_id", "display_order", "created_at", "updated_at") FROM stdin;
\.


--
-- Data for Name: internal_knowledge_base; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."internal_knowledge_base" ("id", "title", "description", "video_url", "tags", "duration", "additional_info", "created_at", "updated_at", "created_by") FROM stdin;
71b7d435-3e69-4492-aef4-42c0921f574c	הדרכת מערכת כללי 1	בסרטון אנחנו רואים הדרכה ראשונית של המערכת, והסברים עליה	https://www.loom.com/share/f37f189e0fa44e97a433cf181de051a8	{CRM,"הדרכה כללית"}	600	{}	2026-01-14 01:45:42.554024+00	2026-01-14 01:45:42.554024+00	50668840-6376-4411-9dc4-b7606ead34ef
\.


--
-- Data for Name: user_invitations; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."user_invitations" ("id", "email", "user_id", "customer_id", "lead_id", "token_hash", "token_salt", "status", "invited_by", "invited_at", "expires_at", "accepted_at", "created_at", "updated_at") FROM stdin;
\.


--
-- Data for Name: invitation_audit_log; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."invitation_audit_log" ("id", "invitation_id", "action", "performed_by", "ip_address", "user_agent", "metadata", "created_at") FROM stdin;
\.


--
-- Data for Name: meetings; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."meetings" ("id", "lead_id", "customer_id", "fillout_submission_id", "meeting_data", "created_at", "updated_at", "created_by") FROM stdin;
11795066-1914-4b0e-adac-609511c4710b	80fe6444-d80d-4b5b-8f1c-2fcd8258b36e	731fd819-64e9-47a7-bafe-409b7103e895	817f9c3a-4853-42db-95f5-438bfbc297b4	{"_formId": "n5VwsjFk5ous", "lead_id": "80fe6444-d80d-4b5b-8f1c-2fcd8258b36e", "Form_name": "פגישת התאמה", "_formName": "פגישת התאמה", "eventEndTime": "2026-02-02T18:30:00.000Z", "meeting_type": "פגישת התאמה", "eventStartTime": "2026-02-02T18:00:00.000Z", "event_end_time": "2026-02-02T18:30:00.000Z", "_submissionTime": "2026-01-28T16:15:21.155Z", "event_start_time": "2026-02-02T18:00:00.000Z", "סוג פגישה": "פגישת התאמה", "_rawWebhookPayload": {"form_id": "n5VwsjFk5ous", "lead_id": "80fe6444-d80d-4b5b-8f1c-2fcd8258b36e", "Form_name": "פגישת התאמה", "submission_id": "817f9c3a-4853-42db-95f5-438bfbc297b4", "event_end_time": "2026-02-02T18:30:00.000Z", "event_start_time": "2026-02-02T18:00:00.000Z"}}	2026-01-28 16:15:21.94254+00	2026-01-28 16:15:21.94254+00	\N
\.


--
-- Data for Name: notifications; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."notifications" ("id", "user_id", "customer_id", "lead_id", "type", "title", "message", "action_url", "is_read", "created_at", "read_at", "metadata") FROM stdin;
\.


--
-- Data for Name: nutrition_plans; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."nutrition_plans" ("id", "user_id", "lead_id", "template_id", "start_date", "description", "targets", "created_at", "updated_at", "created_by", "customer_id", "budget_id", "is_active", "deleted_at", "name") FROM stdin;
57f17359-6eaa-42d7-9efe-d6fe1fb57b54	50668840-6376-4411-9dc4-b7606ead34ef	53d28a1c-321f-40d9-8375-a527456a27d5	f0500c82-3d6c-4eaa-9134-ead0f4bda4e9	2026-01-20	תוכנית תזונה מתקציב: כככ	{"fat": 70, "carbs": 140, "protein": 140, "calories": 1750, "fiber_min": 32, "water_min": 2.5}	2026-01-20 22:04:50.795522+00	2026-01-20 22:04:50.795522+00	50668840-6376-4411-9dc4-b7606ead34ef	af7bdb9d-65aa-45b0-be2b-007ea60ae134	8993ff19-90da-4796-bf14-27629e45e544	t	\N	\N
6757fce9-ea11-45e7-bedc-cf87cb897993	50668840-6376-4411-9dc4-b7606ead34ef	53d28a1c-321f-40d9-8375-a527456a27d5	\N	2026-01-20	תוכנית תזונה מתקציב: כככ	{"fat": 70, "carbs": 140, "protein": 140, "calories": 1750, "fiber_min": 32, "water_min": 2.5}	2026-01-20 22:05:16.709322+00	2026-01-20 22:05:16.709322+00	50668840-6376-4411-9dc4-b7606ead34ef	af7bdb9d-65aa-45b0-be2b-007ea60ae134	fb9e1667-42c2-4a7f-b68a-36edb6639176	t	\N	\N
91eff7d4-c827-4dc2-8084-ffd3d4276a40	50668840-6376-4411-9dc4-b7606ead34ef	10827900-0971-4a59-9611-9f8fb929182e	60dc71c8-3626-4327-ab2a-01a46b2c3ace	2026-01-21	תוכנית תזונה מתקציב: תקציב לנטע	{"fat": 0, "carbs": 0, "protein": 140, "calories": 2000, "fiber_min": 30, "water_min": 2.5}	2026-01-21 19:00:14.294276+00	2026-01-21 19:00:14.294276+00	50668840-6376-4411-9dc4-b7606ead34ef	f379a13d-19c9-4338-a0fd-df07cb597f5e	c990c184-430f-4adb-8516-a2762a00682f	t	\N	\N
5db66463-829b-46ef-a874-c2daa282c645	50668840-6376-4411-9dc4-b7606ead34ef	80fe6444-d80d-4b5b-8f1c-2fcd8258b36e	\N	2026-01-28		{"fat": 70, "carbs": 140, "fiber": 32, "protein": 140, "calories": 1751}	2026-01-28 14:59:24.42295+00	2026-01-28 14:59:24.42295+00	50668840-6376-4411-9dc4-b7606ead34ef	731fd819-64e9-47a7-bafe-409b7103e895	\N	t	\N	\N
\.


--
-- Data for Name: payments; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."payments" ("id", "customer_id", "lead_id", "product_name", "amount", "currency", "status", "stripe_payment_id", "transaction_id", "receipt_url", "notes", "created_at", "updated_at", "created_by", "collection_id") FROM stdin;
95952250-fbda-4782-b9d6-b410c31b6c53	af7bdb9d-65aa-45b0-be2b-007ea60ae134	53d28a1c-321f-40d9-8375-a527456a27d5	50	50.00	ILS	שולם	\N	\N	\N	\N	2026-01-20 21:56:55.823868+00	2026-01-20 21:56:55.823868+00	50668840-6376-4411-9dc4-b7606ead34ef	dffcc90d-a08c-45a4-b53a-29c1844ff1e5
0ac0212f-68de-4bf8-abce-8a3730160f3d	f379a13d-19c9-4338-a0fd-df07cb597f5e	a6fa7f71-2314-4db8-88fa-d4f76c4b7562	גכעגכע	444.00	ILS	שולם	\N	\N	\N	\N	2026-01-21 19:13:33.074534+00	2026-01-21 19:13:33.074534+00	50668840-6376-4411-9dc4-b7606ead34ef	\N
\.


--
-- Data for Name: proposals; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."proposals" ("id", "created_at", "updated_at", "lead_id", "customer_id", "title", "description", "proposal_link", "external_proposal_id", "status", "amount", "currency", "sent_at", "viewed_at", "signed_at", "expires_at", "metadata", "created_by") FROM stdin;
\.


--
-- Data for Name: saved_action_plans; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."saved_action_plans" ("id", "user_id", "budget_id", "name", "description", "saved_at", "snapshot", "notes", "lead_id") FROM stdin;
d434fed7-4f9c-4086-8b88-59a6c54aaab3	50668840-6376-4411-9dc4-b7606ead34ef	c990c184-430f-4adb-8516-a2762a00682f	תקציב לנטע	\N	2026-01-28 15:35:10.951951+00	{"id": "c990c184-430f-4adb-8516-a2762a00682f", "name": "תקציב לנטע", "created_at": "2026-01-21T19:00:08.809822+00:00", "steps_goal": 7000, "updated_at": "2026-01-28T15:32:14.331203+00:00", "description": null, "supplements": [{"name": "ויטמין די", "dosage": "22", "timing": "בערב"}, {"name": "קריאטין", "dosage": "19", "timing": "בבוקר"}], "eating_order": null, "eating_rules": null, "cardio_training": null, "workout_template": {"id": "97a36f1e-a527-45d9-81d3-5206af40b56a", "name": "תוכנית לנשים רזות כבר ", "goal_tags": [], "description": null, "routine_data": {"weeklyWorkout": {"days": {"friday": {"day": "friday", "isActive": false, "exercises": []}, "monday": {"day": "monday", "isActive": true, "exercises": [{"id": "1769021592471-0.016841179009880247", "name": "סקווטים", "reps": 10, "sets": 3, "image_url": "https://www.youtube.com/watch?v=sBJppqCeFGI"}, {"id": "1769021648081-0.94583902367398", "name": "עעעעע", "reps": 9, "sets": 3}, {"id": "1769021654703-0.02306508014809061", "name": "כעיכע", "reps": 10, "sets": 3}]}, "sunday": {"day": "sunday", "isActive": false, "exercises": []}, "tuesday": {"day": "tuesday", "isActive": false, "exercises": []}, "saturday": {"day": "saturday", "isActive": false, "exercises": []}, "thursday": {"day": "thursday", "isActive": false, "exercises": []}, "wednesday": {"day": "wednesday", "isActive": false, "exercises": []}}, "startDate": "2026-01-28", "stepsGoal": 0, "description": "תוכנית לנשים רזות כבר ", "generalGoals": ""}}}, "interval_training": null, "nutrition_targets": {"fat": 0, "carbs": 0, "protein": 140, "calories": 2000, "fiber_min": 30, "water_min": 2.5}, "nutrition_template": {"id": "60dc71c8-3626-4327-ab2a-01a46b2c3ace", "name": "תוכנית נדירה", "targets": {"fat": 0, "carbs": 0, "fiber": 30, "protein": 140, "calories": 2000}, "description": null, "manual_fields": {"steps": null, "workouts": null, "supplements": null}, "manual_override": {"fat": true, "carbs": true, "fiber": true, "protein": true, "calories": true}, "activity_entries": [{"id": "1", "mets": 3.5, "activityType": "הליכה איטית/יוגה/פילאטיס", "minutesPerWeek": 0}, {"id": "2", "mets": 5.5, "activityType": "אימון משקולות כבד", "minutesPerWeek": 0}, {"id": "3", "mets": 6, "activityType": "סטודיו/פונקציונלי/איר", "minutesPerWeek": 0}, {"id": "4", "mets": 7.5, "activityType": "ריצה קלה/ג'וגינג", "minutesPerWeek": 0}, {"id": "5", "mets": 10, "activityType": "ריצה מהירה/שחייה מהירה/ספינינג", "minutesPerWeek": 0}]}, "steps_instructions": null, "workout_template_id": "97a36f1e-a527-45d9-81d3-5206af40b56a", "nutrition_template_id": "60dc71c8-3626-4327-ab2a-01a46b2c3ace"}	\N	80fe6444-d80d-4b5b-8f1c-2fcd8258b36e
\.


--
-- Data for Name: saved_views; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."saved_views" ("id", "resource_key", "view_name", "filter_config", "is_default", "created_by", "created_at", "updated_at", "icon_name", "display_order", "folder_id") FROM stdin;
8abdbb68-7b80-46d1-a734-7c8ffa408cc4	customers	כל הלקוחות	{"searchQuery": "", "selectedDate": null}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-14 01:44:13.270167+00	2026-01-20 17:13:15.908572+00	\N	0	\N
4f3a4cf7-64db-4b34-9236-a201b6f3f548	leads	כל הלידים	{"searchQuery": "", "selectedAge": null, "selectedDate": null, "selectedHeight": null, "selectedSource": null, "selectedStatus": null, "selectedWeight": null, "columnVisibility": {"id": true, "age": true, "name": true, "email": true, "notes": true, "phone": true, "height": true, "source": true, "status": true, "weight": true, "birthDate": true, "createdDate": true, "fitnessGoal": true, "activityLevel": true, "preferredTime": true}, "selectedFitnessGoal": null, "selectedActivityLevel": null, "selectedPreferredTime": null}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-14 01:44:13.435541+00	2026-01-20 17:13:15.908572+00	\N	0	\N
441cfd4b-ddaf-4f22-9f1c-4d4caedb92d0	meetings	כל הפגישות	{"searchQuery": "", "selectedDate": null, "columnVisibility": {"phone": true, "status": true, "created_at": true, "meeting_date": true, "meeting_time": true, "customer_name": true}}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-14 01:44:13.452512+00	2026-01-20 17:13:15.908572+00	\N	0	\N
0e778fe4-e952-451a-853a-d82926eff214	nutrition_templates	כל תבניות התזונה	{"searchQuery": "", "selectedDate": null, "columnVisibility": {"name": true, "tags": false, "actions": true, "createdDate": true, "description": true, "connectedLeads": false}}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-14 01:57:26.643961+00	2026-01-20 17:13:15.908572+00	\N	0	\N
9a05bde4-ecad-44b1-bb9b-ea5980b93fdc	payments	כל התשלומים	{"searchQuery": "", "selectedDate": null}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-19 12:59:07.406123+00	2026-01-20 17:13:15.908572+00	\N	0	\N
d9637896-3677-4ba1-aa2f-8f2107684a42	templates	כל התכניות	{"searchQuery": "", "selectedDate": null, "selectedTags": [], "columnVisibility": {"name": true, "tags": true, "actions": true, "createdDate": true, "description": true, "connectedLeads": true}, "selectedHasLeads": "all"}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-14 01:57:26.69227+00	2026-01-20 17:13:15.908572+00	\N	0	\N
eb9a3c08-c619-4397-9fd9-6681c29824fc	collections	כל הגבייות	{}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-20 17:14:22.424377+00	2026-01-20 17:14:22.424377+00	\N	1	\N
d199d8e4-4017-4baf-bd94-2a7f50ee4c4b	collections	כל הגבייות	{}	t	6a718dbd-0fa3-4e93-bc64-f2ad3116bc63	2026-01-20 17:14:22.424377+00	2026-01-20 17:14:22.424377+00	\N	1	\N
e8994e39-4e8a-4002-9710-fb8a8a6fb6df	collections	כל הגבייות	{}	t	fe090720-f100-4977-ba2e-3702fa207e1e	2026-01-20 17:14:22.424377+00	2026-01-20 17:14:22.424377+00	\N	1	\N
b538d696-0430-4abf-9eaf-16624427df3a	leads	לא פעיל	{"filterGroup": {"id": "group-1769020743851", "children": [{"id": "status-1769020759082", "type": "multiselect", "values": ["פעיל"], "fieldId": "status", "operator": "isNot", "fieldLabel": "סטטוס"}], "operator": "and"}, "searchQuery": "", "selectedAge": null, "selectedDate": null, "selectedHeight": null, "selectedSource": null, "selectedStatus": null, "selectedWeight": null, "advancedFilters": [{"id": "status-1769020759082", "type": "multiselect", "values": ["פעיל"], "fieldId": "status", "operator": "isNot", "fieldLabel": "סטטוס"}], "columnVisibility": {"id": true, "age": true, "name": true, "email": true, "notes": true, "phone": true, "height": true, "source": true, "status": true, "weight": true, "createdDate": true, "fitnessGoal": true, "activityLevel": true, "preferredTime": true}, "selectedFitnessGoal": null, "selectedActivityLevel": null, "selectedPreferredTime": null}	f	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-21 18:39:12.210967+00	2026-01-21 18:39:20.399901+00	\N	2	\N
98a60fe5-6d55-494f-8aa0-75dfca65f559	leads	לא פעיל (עותק)	{"filterGroup": {"id": "group-1769020743851", "children": [{"id": "status-1769020759082", "type": "multiselect", "values": ["פעיל"], "fieldId": "status", "operator": "isNot", "fieldLabel": "סטטוס"}], "operator": "and"}, "searchQuery": "", "selectedAge": null, "selectedDate": null, "selectedHeight": null, "selectedSource": null, "selectedStatus": null, "selectedWeight": null, "advancedFilters": [{"id": "status-1769020759082", "type": "multiselect", "values": ["פעיל"], "fieldId": "status", "operator": "isNot", "fieldLabel": "סטטוס"}], "columnVisibility": {"id": true, "age": true, "name": true, "email": true, "notes": true, "phone": true, "height": true, "source": true, "status": true, "weight": true, "createdDate": true, "fitnessGoal": true, "activityLevel": true, "preferredTime": true}, "selectedFitnessGoal": null, "selectedActivityLevel": null, "selectedPreferredTime": null}	f	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-21 18:46:05.367135+00	2026-01-21 18:46:05.367135+00	\N	3	\N
9227f87c-444f-4674-b0a4-9d1f633a6e73	subscription_types	כל סוגי המנויים	{}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-27 19:09:13.804469+00	2026-01-27 19:09:13.804469+00	\N	1	\N
dcc95e31-448d-4be8-88f4-92f2a9b2348d	subscription_types	כל סוגי המנויים	{}	t	6a718dbd-0fa3-4e93-bc64-f2ad3116bc63	2026-01-27 19:09:13.804469+00	2026-01-27 19:09:13.804469+00	\N	1	\N
5667dbc7-7ec4-4fdd-a650-aeb45cff6609	subscription_types	כל סוגי המנויים	{}	t	fe090720-f100-4977-ba2e-3702fa207e1e	2026-01-27 19:09:13.804469+00	2026-01-27 19:09:13.804469+00	\N	1	\N
b39e376a-ae0c-45bd-9871-6bce7fbf1492	whatsapp_automations	כל האוטומציות	{}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-27 19:09:13.804469+00	2026-01-27 19:09:13.804469+00	\N	1	\N
b1f0b3c1-62f8-4fb3-b0fb-cc8adc855287	whatsapp_automations	כל האוטומציות	{}	t	6a718dbd-0fa3-4e93-bc64-f2ad3116bc63	2026-01-27 19:09:13.804469+00	2026-01-27 19:09:13.804469+00	\N	1	\N
843b17a8-0f21-4342-9334-39b9160b3510	whatsapp_automations	כל האוטומציות	{}	t	fe090720-f100-4977-ba2e-3702fa207e1e	2026-01-27 19:09:13.804469+00	2026-01-27 19:09:13.804469+00	\N	1	\N
fc5a34b5-8f85-4b45-9bf5-6934a26dcc6e	exercises	כל התרגילים	{}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-27 19:09:14.296494+00	2026-01-27 19:09:14.296494+00	\N	1	\N
e21960b8-b775-4073-9739-f0b6c54027fa	exercises	כל התרגילים	{}	t	6a718dbd-0fa3-4e93-bc64-f2ad3116bc63	2026-01-27 19:09:14.296494+00	2026-01-27 19:09:14.296494+00	\N	1	\N
93b4ce1a-872d-454c-8652-06eb33fcb5d0	exercises	כל התרגילים	{}	t	fe090720-f100-4977-ba2e-3702fa207e1e	2026-01-27 19:09:14.296494+00	2026-01-27 19:09:14.296494+00	\N	1	\N
97058c56-a4f1-4033-a757-a8b469aa6312	supplement_templates	כל התבניות	{}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-27 19:09:16.177471+00	2026-01-27 19:09:16.177471+00	\N	1	\N
99a938e3-1d34-4470-a338-11bfe94ed392	supplement_templates	כל התבניות	{}	t	6a718dbd-0fa3-4e93-bc64-f2ad3116bc63	2026-01-27 19:09:16.177471+00	2026-01-27 19:09:16.177471+00	\N	1	\N
0618da0b-9d7f-47fc-a2cf-d720b14dda75	supplement_templates	כל התבניות	{}	t	fe090720-f100-4977-ba2e-3702fa207e1e	2026-01-27 19:09:16.177471+00	2026-01-27 19:09:16.177471+00	\N	1	\N
bd34eebd-701a-4f25-a569-4b08ff677212	budgets	כל תכניות הפעולה	{"searchQuery": "", "selectedDate": null, "columnVisibility": {"name": true, "actions": true, "steps_goal": true, "createdDate": true, "description": true, "supplements": false, "eating_order": false, "eating_rules": false, "workout_template": true, "nutrition_targets": false, "nutrition_template": true, "steps_instructions": false}}	t	50668840-6376-4411-9dc4-b7606ead34ef	2026-01-14 01:44:13.415944+00	2026-01-27 19:09:17.578434+00	\N	0	\N
\.


--
-- Data for Name: steps_plans; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."steps_plans" ("id", "user_id", "lead_id", "customer_id", "budget_id", "template_id", "start_date", "end_date", "description", "steps_goal", "steps_instructions", "is_active", "created_at", "updated_at", "created_by") FROM stdin;
9ea95891-204b-44ab-b3f1-56820e1bc6d6	50668840-6376-4411-9dc4-b7606ead34ef	53d28a1c-321f-40d9-8375-a527456a27d5	af7bdb9d-65aa-45b0-be2b-007ea60ae134	fb9e1667-42c2-4a7f-b68a-36edb6639176	\N	2026-01-20	\N	תוכנית צעדים מתקציב: כככ	800	\N	t	2026-01-20 22:05:17.212786+00	2026-01-20 22:05:17.212786+00	50668840-6376-4411-9dc4-b7606ead34ef
322af2dc-caa2-440b-8119-c2e9698eb9db	50668840-6376-4411-9dc4-b7606ead34ef	10827900-0971-4a59-9611-9f8fb929182e	f379a13d-19c9-4338-a0fd-df07cb597f5e	c990c184-430f-4adb-8516-a2762a00682f	\N	2026-01-21	\N	תוכנית צעדים מתכנית פעולה: תקציב לנטע	7000	\N	t	2026-01-21 19:00:14.669672+00	2026-01-28 15:32:15.039674+00	50668840-6376-4411-9dc4-b7606ead34ef
\.


--
-- Data for Name: subscription_types; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."subscription_types" ("id", "name", "duration", "price", "created_at", "updated_at", "created_by", "currency", "duration_unit", "second_period") FROM stdin;
a7a30b4d-c0dd-4cd3-935e-265761a61b7e	665	1	100.00	2026-01-14 02:14:16.152316+00	2026-01-14 02:14:16.152316+00	50668840-6376-4411-9dc4-b7606ead34ef	ILS	months	\N
74cf37d9-b658-470c-871c-09d1d3b7f9ae	4 חודשים	1	1700.00	2026-01-14 20:13:56.567416+00	2026-01-14 20:14:35.784248+00	50668840-6376-4411-9dc4-b7606ead34ef	ILS	months	\N
f583c9f6-04d4-4e62-9c41-d552ef8efb2a	חופשי חודשי	1	1250.00	2026-01-14 20:14:48.203725+00	2026-01-14 20:14:48.203725+00	50668840-6376-4411-9dc4-b7606ead34ef	ILS	months	\N
8382c4a9-77cb-4890-ae1c-c46f9f4c67f7	חופשי חודשי (ישן)	1	900.00	2026-01-14 20:15:25.954902+00	2026-01-14 20:15:25.954902+00	50668840-6376-4411-9dc4-b7606ead34ef	ILS	months	\N
\.


--
-- Data for Name: supplement_plans; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."supplement_plans" ("id", "user_id", "lead_id", "customer_id", "budget_id", "template_id", "start_date", "end_date", "description", "supplements", "is_active", "created_at", "updated_at", "created_by") FROM stdin;
64595acb-c34f-4589-88fc-2c32a09907e9	50668840-6376-4411-9dc4-b7606ead34ef	53d28a1c-321f-40d9-8375-a527456a27d5	af7bdb9d-65aa-45b0-be2b-007ea60ae134	8993ff19-90da-4796-bf14-27629e45e544	\N	2026-01-20	\N	תוכנית תוספים מתקציב: כככ	[{"name": "גהכ", "dosage": "33", "timing": "ככ"}, {"name": "22", "dosage": "44", "timing": "ככ"}]	f	2026-01-20 22:04:51.22869+00	2026-01-20 22:05:17.31782+00	50668840-6376-4411-9dc4-b7606ead34ef
eefa3a69-64bc-4626-9eed-8d21f493ba6c	50668840-6376-4411-9dc4-b7606ead34ef	53d28a1c-321f-40d9-8375-a527456a27d5	af7bdb9d-65aa-45b0-be2b-007ea60ae134	fb9e1667-42c2-4a7f-b68a-36edb6639176	\N	2026-01-20	\N	תוכנית תוספים מתקציב: כככ	[{"name": "גהכ", "dosage": "33", "timing": "ככ"}, {"name": "22", "dosage": "44", "timing": "ככ"}]	t	2026-01-20 22:05:17.687261+00	2026-01-20 22:05:17.687261+00	50668840-6376-4411-9dc4-b7606ead34ef
0588a904-144d-4cb5-84c8-18c21067edb0	50668840-6376-4411-9dc4-b7606ead34ef	10827900-0971-4a59-9611-9f8fb929182e	f379a13d-19c9-4338-a0fd-df07cb597f5e	c990c184-430f-4adb-8516-a2762a00682f	\N	2026-01-21	\N	תוכנית תוספים מתקציב: תקציב לנטע	[{"name": "ויטמין די", "dosage": "22", "timing": "בערב"}, {"name": "קריאטין", "dosage": "19", "timing": "בבוקר"}]	t	2026-01-21 19:00:15.100093+00	2026-01-21 19:00:15.100093+00	50668840-6376-4411-9dc4-b7606ead34ef
cae30854-19a1-4ebe-9553-1d6663574da6	50668840-6376-4411-9dc4-b7606ead34ef	80fe6444-d80d-4b5b-8f1c-2fcd8258b36e	\N	e29f6377-3741-491e-ad6e-b90573aac300	\N	2026-01-28	\N	תוכנית תוספים מתכנית פעולה: תקציב לנטע	[{"name": "ויטמין די", "dosage": "22", "timing": "בערב"}, {"name": "קריאטין", "dosage": "19", "timing": "בבוקר"}, {"name": "מע", "dosage": "", "timing": ""}]	t	2026-01-28 15:32:01.62117+00	2026-01-28 15:34:59.821994+00	50668840-6376-4411-9dc4-b7606ead34ef
\.


--
-- Data for Name: user_interface_preferences; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."user_interface_preferences" ("id", "user_id", "interface_key", "icon_name", "created_at", "updated_at", "display_order", "numeric_value") FROM stdin;
\.


--
-- Data for Name: weekly_reviews; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."weekly_reviews" ("id", "lead_id", "customer_id", "week_start_date", "week_end_date", "target_calories", "target_protein", "target_carbs", "target_fat", "target_fiber", "target_steps", "actual_calories_avg", "actual_protein_avg", "actual_carbs_avg", "actual_fat_avg", "actual_fiber_avg", "actual_calories_weekly_avg", "weekly_avg_weight", "waist_measurement", "trainer_summary", "action_plan", "updated_steps_goal", "updated_calories_target", "created_at", "updated_at", "created_by", "target_weight", "target_waist") FROM stdin;
64382cfd-135f-4e00-b050-ebf7e58e83e0	53d28a1c-321f-40d9-8375-a527456a27d5	af7bdb9d-65aa-45b0-be2b-007ea60ae134	2026-01-18	2026-01-24	50	40	\N	\N	80	\N	50.00	60.00	\N	\N	900.00	50.00	60.00	\N	להזהר מקורנפלקס		\N	\N	2026-01-20 21:59:15.540449+00	2026-01-20 21:59:21.973505+00	50668840-6376-4411-9dc4-b7606ead34ef	\N	\N
\.


--
-- Data for Name: whatsapp_flow_templates; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."whatsapp_flow_templates" ("id", "user_id", "flow_key", "template_content", "created_at", "updated_at", "buttons", "media", "name", "status", "description") FROM stdin;
e3e4a263-1a0f-4d6d-87ea-478f5aa46822	50668840-6376-4411-9dc4-b7606ead34ef	weekly_review	📊 סיכום שבועי - שבוע {{week_start}} - {{week_end}}\n\n🎯 יעדים:\nקלוריות: {{target_calories}} קק"ל\nחלבון: {{target_protein}} גרם\nסיבים: {{target_fiber}} גרם\nצעדים: {{target_steps}}\n\n📈 בפועל (ממוצע):\nקלוריות: {{actual_calories}} קק"ל\nמשקל ממוצע: {{actual_weight}} ק"ג	2026-01-19 12:55:54.964395+00	2026-01-27 19:09:17.733398+00	[]	\N	סיכום שבועי ויעדים	מוגדר	\N
662cf0f2-53cb-4a27-8753-709f7777f08d	fe090720-f100-4977-ba2e-3702fa207e1e	weekly_review	📊 סיכום שבועי - שבוע {{week_start}} - {{week_end}}\n\n🎯 יעדים:\nקלוריות: {{target_calories}} קק"ל\nחלבון: {{target_protein}} גרם\nסיבים: {{target_fiber}} גרם\nצעדים: {{target_steps}}\n\n📈 בפועל (ממוצע):\nקלוריות: {{actual_calories}} קק"ל\nמשקל ממוצע: {{actual_weight}} ק"ג	2026-01-19 12:55:54.964395+00	2026-01-27 19:09:17.733398+00	[]	\N	סיכום שבועי ויעדים	מוגדר	\N
31ae53d0-fbc2-4b5a-89e3-2eaa1f9c20c0	50668840-6376-4411-9dc4-b7606ead34ef	intro_questionnaire	<p><span style="color: rgba(255,255,255,var(--O42jJQ,1));">איזה כיף שקבענו שיחה! 🙌</span></p><p><span style="color: rgba(255,255,255,var(--O42jJQ,1));">מחכה כבר להכיר אותך ולשמוע ממך באופן אישי.</span></p><p><span style="color: rgba(255,255,255,var(--O42jJQ,1));">כדי שנוכל לנצל את הזמן בצורה הכי מדויקת </span></p><p><span style="color: rgba(255,255,255,var(--O42jJQ,1));">אשמח שתמלאי את השאלון הזה מראש.</span></p><p><span style="color: rgba(255,255,255,var(--O42jJQ,1));">זה יעזור לי להבין מי את, איפה את נמצאת, ומה את באמת צריכה </span></p><p><span style="color: rgba(255,255,255,var(--O42jJQ,1));">כדי שאוכל להקשיב, לשאול את השאלות הנכונות ולוודא שהליווי האישי אכן מתאים עבורך</span></p><p><span style="color: rgba(255,255,255,var(--O42jJQ,1));">📄 הנה הקישור לשאלון:</span></p><p>https://dietneta.fillout.com/1on1premiumform </p>	2026-01-14 01:46:52.203463+00	2026-01-27 19:09:17.733398+00	[]	\N	אוטומטי שליחת שאלון הכרות לאחר קביעת שיחה	מוגדר	\N
3abb8856-f9e7-4013-9608-7a68b54c0eca	6a718dbd-0fa3-4e93-bc64-f2ad3116bc63	weekly_review	📊 סיכום שבועי - שבוע {{week_start}} - {{week_end}}\n\n🎯 יעדים:\nקלוריות: {{target_calories}} קק"ל\nחלבון: {{target_protein}} גרם\nסיבים: {{target_fiber}} גרם\nצעדים: {{target_steps}}\n\n📈 בפועל (ממוצע):\nקלוריות: {{actual_calories}} קק"ל\nמשקל ממוצע: {{actual_weight}} ק"ג	2026-01-19 12:55:54.964395+00	2026-01-27 19:09:17.733398+00	[]	\N	סיכום שבועי ויעדים	מוגדר	\N
0fb34729-2153-44d1-b862-d4b624b74f7d	50668840-6376-4411-9dc4-b7606ead34ef	payment_request	שלום {{name}},\n\nאנא לחץ על הקישור הבא כדי להשלים את התשלום:\n\n{{payment_link}}\n\nתודה!	2026-01-19 15:12:37.17409+00	2026-01-27 19:09:17.733398+00	[]	\N	בקשת תשלום	מוגדר	\N
f29db1e9-caa0-44ca-b929-946f58e60802	50668840-6376-4411-9dc4-b7606ead34ef	trainee_user_credentials	שלום {{name}},\n\nחשבון המשתמש שלך נוצר בהצלחה!\n\nפרטי הכניסה:\n📧 אימייל: {{email}}\n🔑 סיסמה: {{password}}\n\nניתן להתחבר בכתובת:\n{{login_url}}\n\nבברכה,\nצוות DietNeta	2026-01-19 15:12:37.383632+00	2026-01-27 19:09:17.733398+00	[]	\N	שליחת פרטי משתמש	מוגדר	\N
368983ae-91f5-4e42-a850-0208f9b63169	50668840-6376-4411-9dc4-b7606ead34ef	customer_journey_start	<p>היי, תודה שפנית והתעניינת בתהליך הליווי האישי 🙏</p><p><br></p><p>&nbsp;אני מלווה נשים שמוכנות לקחת צעד משמעותי בדרך שלהן.</p><p>תהליך עמוק, אישי, שמותאם בדיוק למי שאת ולמה שאת צריכה עכשיו.</p><p><br></p><p>כדי להבין אם זה אכן הדבר המדויק עבורך, אני מזמינה אותך לתאם איתי שיחת היכרות.</p><p><br></p><p>בשיחה נדבר בגובה העיניים, אכיר אותך לעומק, אספר איך הליווי מתנהל, ונוכל לבדוק יחד אם זה באמת תפור למידות שלך.</p><p><br></p><p>חשוב לי לציין שהתהליך פתוח רק למספר מוגבל של נשים בכל שלב, אז אם את מרגישה שזה מדבר אלייך, כדאי לתפוס מקום לשיחה כשהיומן עדיין פתוח.</p><p><br></p><p><br></p><p>💬 לתיאום השיחה, לחצי כאן ובחרי זמן שנוח לך:</p><p><br></p><p>https://dietneta.fillout.com/-open-meeting?lead_id={{lead_id}}</p><p><br></p><p>למילוי פרטים:</p><p>https://dietneta.fillout.com/priorcall?lead_id={{lead_id}}</p>	2026-01-14 01:48:27.045165+00	2026-01-28 16:22:58.044126+00	[]	\N	תחילת מסע לקוח ותיאום פגישה	מוגדר	\N
\.


--
-- Data for Name: workout_plans; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY "public"."workout_plans" ("id", "user_id", "lead_id", "start_date", "description", "strength", "cardio", "intervals", "custom_attributes", "created_at", "updated_at", "created_by", "template_id", "is_active", "deleted_at", "customer_id", "budget_id", "name") FROM stdin;
80ec9e9b-db12-4f3a-be92-84ae6983d07e	50668840-6376-4411-9dc4-b7606ead34ef	53d28a1c-321f-40d9-8375-a527456a27d5	2026-01-20	תוכנית אימונים מתקציב: כככ	0	0	0	{"data": {"weeklyWorkout": {"days": {"friday": {"day": "friday", "isActive": false, "exercises": []}, "monday": {"day": "monday", "isActive": false, "exercises": []}, "sunday": {"day": "sunday", "isActive": true, "exercises": [{"id": "1768946436759-0.28402187621147057", "name": "גדכדג", "reps": 10, "sets": 3}, {"id": "1768946454713-0.4004387696292534", "name": "ספסל לחיצה", "reps": 8, "sets": 4}, {"id": "1768946454713-0.9199210131944925", "name": "לחיצת כתפיים", "reps": 10, "sets": 3}, {"id": "1768946454713-0.6136195738413109", "name": "דיפים", "reps": 12, "sets": 3}, {"id": "1768946454713-0.1684890227843283", "name": "טריצפס", "reps": 12, "sets": 3}, {"id": "1768946458321-0.6911141340853347", "name": "ספסל לחיצה", "reps": 8, "sets": 4}, {"id": "1768946458321-0.5306429205092226", "name": "לחיצת כתפיים", "reps": 10, "sets": 3}, {"id": "1768946458321-0.6038593862366576", "name": "דיפים", "reps": 12, "sets": 3}, {"id": "1768946458321-0.480898070299403", "name": "טריצפס", "reps": 12, "sets": 3}]}, "tuesday": {"day": "tuesday", "isActive": false, "exercises": []}, "saturday": {"day": "saturday", "isActive": false, "exercises": []}, "thursday": {"day": "thursday", "isActive": false, "exercises": []}, "wednesday": {"day": "wednesday", "isActive": false, "exercises": []}}, "startDate": "2026-01-21", "stepsGoal": 0, "description": "", "generalGoals": ""}}, "schema": []}	2026-01-20 22:04:50.461347+00	2026-01-20 22:04:50.461347+00	50668840-6376-4411-9dc4-b7606ead34ef	6e717bed-c709-47d3-9688-fdd3f137f0e7	t	\N	af7bdb9d-65aa-45b0-be2b-007ea60ae134	8993ff19-90da-4796-bf14-27629e45e544	\N
18a19af9-a540-477d-a3d5-65ade6b623c4	50668840-6376-4411-9dc4-b7606ead34ef	10827900-0971-4a59-9611-9f8fb929182e	2026-01-21	תוכנית אימונים מתקציב: תקציב לנטע	0	0	0	{"data": {"weeklyWorkout": {"days": {"friday": {"day": "friday", "isActive": false, "exercises": []}, "monday": {"day": "monday", "isActive": true, "exercises": [{"id": "1769021592471-0.016841179009880247", "name": "סקווטים", "reps": 10, "sets": 3, "image_url": "https://www.youtube.com/watch?v=sBJppqCeFGI"}, {"id": "1769021648081-0.94583902367398", "name": "עעעעע", "reps": 9, "sets": 3}, {"id": "1769021654703-0.02306508014809061", "name": "כעיכע", "reps": 10, "sets": 3}]}, "sunday": {"day": "sunday", "isActive": false, "exercises": []}, "tuesday": {"day": "tuesday", "isActive": false, "exercises": []}, "saturday": {"day": "saturday", "isActive": false, "exercises": []}, "thursday": {"day": "thursday", "isActive": false, "exercises": []}, "wednesday": {"day": "wednesday", "isActive": false, "exercises": []}}, "startDate": "2026-01-21", "stepsGoal": 0, "description": "תוכנית לנשים רזות כבר ", "generalGoals": ""}}, "schema": []}	2026-01-21 19:00:14.010115+00	2026-01-21 19:00:14.010115+00	50668840-6376-4411-9dc4-b7606ead34ef	97a36f1e-a527-45d9-81d3-5206af40b56a	t	\N	f379a13d-19c9-4338-a0fd-df07cb597f5e	c990c184-430f-4adb-8516-a2762a00682f	\N
\.


--
-- Data for Name: schema_migrations; Type: TABLE DATA; Schema: supabase_migrations; Owner: postgres
--

COPY "supabase_migrations"."schema_migrations" ("version", "statements", "name") FROM stdin;
20240001	{"-- =====================================================\n-- Initial Schema Migration for Diet Neta CRM\n-- Created: 2024-01-01\n-- Description: Production-ready schema with RLS, JSONB flexibility, and auto-triggers\n-- =====================================================\n\n-- =====================================================\n-- 1. EXTENSIONS\n-- =====================================================\n\n-- Note: gen_random_uuid() is built into PostgreSQL 13+ and doesn't require an extension\n\n-- =====================================================\n-- 2. UTILITY FUNCTIONS\n-- =====================================================\n\n-- Generic function to automatically update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- =====================================================\n-- 3. TABLE: profiles\n-- =====================================================\n\n-- Profiles table links to auth.users and manages user roles\nCREATE TABLE IF NOT EXISTS profiles (\n    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,\n    email TEXT NOT NULL,\n    full_name TEXT,\n    role TEXT NOT NULL DEFAULT 'user' CHECK (role IN ('admin', 'user')),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL\n)","-- Index for faster role lookups\nCREATE INDEX IF NOT EXISTS idx_profiles_role ON profiles(role)","CREATE INDEX IF NOT EXISTS idx_profiles_email ON profiles(email)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_profiles_updated_at\n    BEFORE UPDATE ON profiles\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- Function to automatically create profile when user signs up\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER AS $$\nBEGIN\n    INSERT INTO public.profiles (id, email, full_name, role)\n    VALUES (\n        NEW.id,\n        NEW.email,\n        COALESCE(NEW.raw_user_meta_data->>'full_name', ''),\n        COALESCE(NEW.raw_user_meta_data->>'role', 'user')\n    );\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Trigger to call handle_new_user when a new user is created in auth.users\nCREATE TRIGGER on_auth_user_created\n    AFTER INSERT ON auth.users\n    FOR EACH ROW\n    EXECUTE FUNCTION public.handle_new_user()","-- =====================================================\n-- 4. TABLE: leads (The Central Entity)\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS leads (\n    -- Meta Data\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    assigned_to UUID REFERENCES profiles(id) ON DELETE SET NULL,\n    \n    -- Personal Info\n    full_name TEXT NOT NULL,\n    phone TEXT UNIQUE NOT NULL,\n    email TEXT,\n    city TEXT,\n    birth_date DATE,\n    gender TEXT CHECK (gender IN ('male', 'female', 'other')) DEFAULT NULL,\n    \n    -- Status Management\n    status_main TEXT,\n    status_sub TEXT,\n    \n    -- Physical Metrics\n    height DECIMAL(5, 2), -- in cm\n    weight DECIMAL(5, 2), -- in kg\n    bmi DECIMAL(4, 2), -- calculated or stored\n    \n    -- Business/Subscription\n    join_date TIMESTAMP WITH TIME ZONE,\n    subscription_data JSONB DEFAULT '{}'::jsonb,\n    \n    -- Dynamic Data Columns (JSONB for flexibility)\n    daily_protocol JSONB DEFAULT '{}'::jsonb,\n    -- Structure: { \\"stepsGoal\\": 8000, \\"workoutGoal\\": 3, \\"supplements\\": [\\"Omega 3\\", \\"Magnesium\\"] }\n    \n    workout_history JSONB DEFAULT '[]'::jsonb,\n    -- Structure: [{ \\"name\\": \\"Plan A\\", \\"startDate\\": \\"2024-01-01\\", \\"validUntil\\": \\"2024-04-01\\", \n    --              \\"duration\\": \\"3 months\\", \\"description\\": \\"...\\", \n    --              \\"strengthCount\\": 3, \\"cardioCount\\": 1, \\"intervalsCount\\": 1 }]\n    \n    steps_history JSONB DEFAULT '[]'::jsonb,\n    -- Structure: [{ \\"weekNumber\\": 1, \\"startDate\\": \\"2024-01-01\\", \\"endDate\\": \\"2024-01-07\\", \\"target\\": 7000 }]\n    \n    -- Additional fields from the application\n    source TEXT,\n    fitness_goal TEXT,\n    activity_level TEXT,\n    preferred_time TEXT,\n    notes TEXT\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_leads_assigned_to ON leads(assigned_to)","CREATE INDEX IF NOT EXISTS idx_leads_status_main ON leads(status_main)","CREATE INDEX IF NOT EXISTS idx_leads_status_sub ON leads(status_sub)","CREATE INDEX IF NOT EXISTS idx_leads_phone ON leads(phone)","CREATE INDEX IF NOT EXISTS idx_leads_email ON leads(email)","CREATE INDEX IF NOT EXISTS idx_leads_created_at ON leads(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_leads_join_date ON leads(join_date)","-- GIN indexes for JSONB columns (enables fast queries on JSONB data)\nCREATE INDEX IF NOT EXISTS idx_leads_daily_protocol ON leads USING GIN (daily_protocol)","CREATE INDEX IF NOT EXISTS idx_leads_workout_history ON leads USING GIN (workout_history)","CREATE INDEX IF NOT EXISTS idx_leads_steps_history ON leads USING GIN (steps_history)","CREATE INDEX IF NOT EXISTS idx_leads_subscription_data ON leads USING GIN (subscription_data)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_leads_updated_at\n    BEFORE UPDATE ON leads\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- 5. ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on profiles table\nALTER TABLE profiles ENABLE ROW LEVEL SECURITY","-- Enable RLS on leads table\nALTER TABLE leads ENABLE ROW LEVEL SECURITY","-- =====================================================\n-- 6. RLS POLICIES: profiles\n-- =====================================================\n\n-- Policy: Users can read their own profile\nCREATE POLICY \\"Users can read own profile\\"\n    ON profiles FOR SELECT\n    USING (auth.uid() = id)","-- Policy: Users can update their own profile\nCREATE POLICY \\"Users can update own profile\\"\n    ON profiles FOR UPDATE\n    USING (auth.uid() = id)\n    WITH CHECK (auth.uid() = id)","-- Policy: Admins have full access to profiles\nCREATE POLICY \\"Admins have full access to profiles\\"\n    ON profiles FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- 7. RLS POLICIES: leads\n-- =====================================================\n\n-- Policy: Authenticated users can read all leads (adjust based on business logic)\nCREATE POLICY \\"Authenticated users can read leads\\"\n    ON leads FOR SELECT\n    USING (auth.role() = 'authenticated')","-- Policy: Authenticated users can insert leads\nCREATE POLICY \\"Authenticated users can insert leads\\"\n    ON leads FOR INSERT\n    WITH CHECK (auth.role() = 'authenticated')","-- Policy: Users can update leads assigned to them\nCREATE POLICY \\"Users can update assigned leads\\"\n    ON leads FOR UPDATE\n    USING (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Admins have full access to leads\nCREATE POLICY \\"Admins have full access to leads\\"\n    ON leads FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Users can delete leads (only admins or assigned users)\nCREATE POLICY \\"Users can delete assigned leads\\"\n    ON leads FOR DELETE\n    USING (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- 8. HELPER FUNCTIONS (Optional but useful)\n-- =====================================================\n\n-- Function to calculate BMI (can be used in triggers or application layer)\nCREATE OR REPLACE FUNCTION calculate_bmi(height_cm DECIMAL, weight_kg DECIMAL)\nRETURNS DECIMAL AS $$\nBEGIN\n    IF height_cm IS NULL OR weight_kg IS NULL OR height_cm <= 0 OR weight_kg <= 0 THEN\n        RETURN NULL;\n    END IF;\n    -- BMI = weight (kg) / (height (m))^2\n    RETURN ROUND((weight_kg / POWER(height_cm / 100.0, 2))::DECIMAL, 2);\nEND;\n$$ LANGUAGE plpgsql IMMUTABLE","-- Optional: Trigger to auto-calculate BMI when height or weight changes\nCREATE OR REPLACE FUNCTION update_lead_bmi()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF NEW.height IS NOT NULL AND NEW.weight IS NOT NULL THEN\n        NEW.bmi = calculate_bmi(NEW.height, NEW.weight);\n    END IF;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","CREATE TRIGGER calculate_bmi_trigger\n    BEFORE INSERT OR UPDATE OF height, weight ON leads\n    FOR EACH ROW\n    EXECUTE FUNCTION update_lead_bmi()","-- =====================================================\n-- 9. COMMENTS (Documentation)\n-- =====================================================\n\nCOMMENT ON TABLE profiles IS 'User profiles linked to auth.users, manages roles and user metadata'","COMMENT ON TABLE leads IS 'Central entity for CRM leads/trainees with flexible JSONB columns for dynamic data'","COMMENT ON COLUMN leads.daily_protocol IS 'JSONB: { \\"stepsGoal\\": number, \\"workoutGoal\\": number, \\"supplements\\": string[] }'","COMMENT ON COLUMN leads.workout_history IS 'JSONB: Array of workout program objects with dates, splits, and descriptions'","COMMENT ON COLUMN leads.steps_history IS 'JSONB: Array of step tracking objects with week numbers, dates, and targets'","COMMENT ON COLUMN leads.subscription_data IS 'JSONB: Flexible subscription information including pricing and package details'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	initial_schema
20240102000000	{"-- =====================================================\n-- Ensure Leads Table Exists\n-- Created: 2024-01-02\n-- Description: This migration ensures the leads table exists\n--              and is properly accessible in the public schema\n-- =====================================================\n\n-- Ensure we're working in the public schema\nSET search_path TO public","-- Drop table if it exists (only if you want to recreate it)\n-- Uncomment the next line if you need to recreate the table\n-- DROP TABLE IF EXISTS leads CASCADE;\n\n-- Create the leads table if it doesn't exist\nCREATE TABLE IF NOT EXISTS public.leads (\n    -- Meta Data\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    assigned_to UUID REFERENCES public.profiles(id) ON DELETE SET NULL,\n    \n    -- Personal Info\n    full_name TEXT NOT NULL,\n    phone TEXT UNIQUE NOT NULL,\n    email TEXT,\n    city TEXT,\n    birth_date DATE,\n    gender TEXT CHECK (gender IN ('male', 'female', 'other')) DEFAULT NULL,\n    \n    -- Status Management\n    status_main TEXT,\n    status_sub TEXT,\n    \n    -- Physical Metrics\n    height DECIMAL(5, 2), -- in cm\n    weight DECIMAL(5, 2), -- in kg\n    bmi DECIMAL(4, 2), -- calculated or stored\n    \n    -- Business/Subscription\n    join_date TIMESTAMP WITH TIME ZONE,\n    subscription_data JSONB DEFAULT '{}'::jsonb,\n    \n    -- Dynamic Data Columns (JSONB for flexibility)\n    daily_protocol JSONB DEFAULT '{}'::jsonb,\n    workout_history JSONB DEFAULT '[]'::jsonb,\n    steps_history JSONB DEFAULT '[]'::jsonb,\n    \n    -- Additional fields from the application\n    source TEXT,\n    fitness_goal TEXT,\n    activity_level TEXT,\n    preferred_time TEXT,\n    notes TEXT\n)","-- Ensure the table is in the public schema\nALTER TABLE IF EXISTS public.leads SET SCHEMA public","-- Grant necessary permissions\nGRANT ALL ON public.leads TO authenticated","GRANT ALL ON public.leads TO anon","GRANT ALL ON public.leads TO service_role","-- Create indexes if they don't exist\nCREATE INDEX IF NOT EXISTS idx_leads_assigned_to ON public.leads(assigned_to)","CREATE INDEX IF NOT EXISTS idx_leads_status_main ON public.leads(status_main)","CREATE INDEX IF NOT EXISTS idx_leads_status_sub ON public.leads(status_sub)","CREATE INDEX IF NOT EXISTS idx_leads_phone ON public.leads(phone)","CREATE INDEX IF NOT EXISTS idx_leads_email ON public.leads(email)","CREATE INDEX IF NOT EXISTS idx_leads_created_at ON public.leads(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_leads_join_date ON public.leads(join_date)","-- GIN indexes for JSONB columns\nCREATE INDEX IF NOT EXISTS idx_leads_daily_protocol ON public.leads USING GIN (daily_protocol)","CREATE INDEX IF NOT EXISTS idx_leads_workout_history ON public.leads USING GIN (workout_history)","CREATE INDEX IF NOT EXISTS idx_leads_steps_history ON public.leads USING GIN (steps_history)","CREATE INDEX IF NOT EXISTS idx_leads_subscription_data ON public.leads USING GIN (subscription_data)","-- Ensure the update_updated_at_column function exists\nCREATE OR REPLACE FUNCTION public.update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Create trigger for auto-updating updated_at\nDROP TRIGGER IF EXISTS update_leads_updated_at ON public.leads","CREATE TRIGGER update_leads_updated_at\n    BEFORE UPDATE ON public.leads\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- Ensure BMI calculation function exists\nCREATE OR REPLACE FUNCTION public.calculate_bmi(height_cm DECIMAL, weight_kg DECIMAL)\nRETURNS DECIMAL AS $$\nBEGIN\n    IF height_cm IS NULL OR weight_kg IS NULL OR height_cm <= 0 OR weight_kg <= 0 THEN\n        RETURN NULL;\n    END IF;\n    RETURN ROUND((weight_kg / POWER(height_cm / 100.0, 2))::DECIMAL, 2);\nEND;\n$$ LANGUAGE plpgsql IMMUTABLE","-- Create trigger for auto-calculating BMI\nDROP TRIGGER IF EXISTS calculate_bmi_trigger ON public.leads","CREATE OR REPLACE FUNCTION public.update_lead_bmi()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF NEW.height IS NOT NULL AND NEW.weight IS NOT NULL THEN\n        NEW.bmi = public.calculate_bmi(NEW.height, NEW.weight);\n    END IF;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","CREATE TRIGGER calculate_bmi_trigger\n    BEFORE INSERT OR UPDATE OF height, weight ON public.leads\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_lead_bmi()","-- Enable RLS\nALTER TABLE public.leads ENABLE ROW LEVEL SECURITY","-- Drop existing policies if they exist (to avoid conflicts)\nDROP POLICY IF EXISTS \\"Authenticated users can read leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Authenticated users can insert leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Users can update assigned leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Admins have full access to leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Users can delete assigned leads\\" ON public.leads","-- Recreate RLS policies\nCREATE POLICY \\"Authenticated users can read leads\\"\n    ON public.leads FOR SELECT\n    USING (auth.role() = 'authenticated')","CREATE POLICY \\"Authenticated users can insert leads\\"\n    ON public.leads FOR INSERT\n    WITH CHECK (auth.role() = 'authenticated')","CREATE POLICY \\"Users can update assigned leads\\"\n    ON public.leads FOR UPDATE\n    USING (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","CREATE POLICY \\"Admins have full access to leads\\"\n    ON public.leads FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","CREATE POLICY \\"Users can delete assigned leads\\"\n    ON public.leads FOR DELETE\n    USING (\n        assigned_to = auth.uid() OR\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Add comment for documentation\nCOMMENT ON TABLE public.leads IS 'Central entity for CRM leads/trainees with flexible JSONB columns for dynamic data'"}	ensure_leads_table
20240102000001	{"-- =====================================================\n-- Fix RLS Infinite Recursion Issue\n-- Created: 2024-01-02\n-- Description: Fixes the infinite recursion in profiles RLS policies\n-- =====================================================\n\n-- Drop the problematic admin policy on profiles that causes recursion\nDROP POLICY IF EXISTS \\"Admins have full access to profiles\\" ON public.profiles","-- Create a security definer function to check admin role (bypasses RLS)\nCREATE OR REPLACE FUNCTION public.is_admin(user_id UUID)\nRETURNS BOOLEAN AS $$\nBEGIN\n    RETURN EXISTS (\n        SELECT 1 FROM public.profiles\n        WHERE id = user_id AND role = 'admin'\n    );\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Recreate the admin policy using the function (avoids recursion)\nCREATE POLICY \\"Admins have full access to profiles\\"\n    ON public.profiles FOR ALL\n    USING (public.is_admin(auth.uid()))\n    WITH CHECK (public.is_admin(auth.uid()))","-- Also fix the leads policies to use the function\nDROP POLICY IF EXISTS \\"Users can update assigned leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Admins have full access to leads\\" ON public.leads","DROP POLICY IF EXISTS \\"Users can delete assigned leads\\" ON public.leads","-- Recreate leads policies using the function\nCREATE POLICY \\"Users can update assigned leads\\"\n    ON public.leads FOR UPDATE\n    USING (\n        assigned_to = auth.uid() OR\n        public.is_admin(auth.uid())\n    )\n    WITH CHECK (\n        assigned_to = auth.uid() OR\n        public.is_admin(auth.uid())\n    )","CREATE POLICY \\"Admins have full access to leads\\"\n    ON public.leads FOR ALL\n    USING (public.is_admin(auth.uid()))\n    WITH CHECK (public.is_admin(auth.uid()))","CREATE POLICY \\"Users can delete assigned leads\\"\n    ON public.leads FOR DELETE\n    USING (\n        assigned_to = auth.uid() OR\n        public.is_admin(auth.uid())\n    )","-- For local development, also allow anonymous access to insert leads\n-- (Remove this in production or adjust based on your needs)\nDROP POLICY IF EXISTS \\"Allow anonymous insert leads\\" ON public.leads","CREATE POLICY \\"Allow anonymous insert leads\\"\n    ON public.leads FOR INSERT\n    TO anon\n    WITH CHECK (true)","DROP POLICY IF EXISTS \\"Allow anonymous read leads\\" ON public.leads","CREATE POLICY \\"Allow anonymous read leads\\"\n    ON public.leads FOR SELECT\n    TO anon\n    USING (true)"}	fix_rls_recursion
20240102000002	{"-- =====================================================\n-- Workout Plans Migration\n-- Created: 2024-01-02\n-- Description: User workout plans with dynamic custom attributes\n-- =====================================================\n\n-- =====================================================\n-- TABLE: workout_plans\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS workout_plans (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    \n    -- Standard fields\n    start_date DATE NOT NULL,\n    description TEXT,\n    \n    -- Metric columns\n    strength INTEGER DEFAULT 0,\n    cardio INTEGER DEFAULT 0,\n    intervals INTEGER DEFAULT 0,\n    \n    -- Dynamic custom attributes (JSONB)\n    -- Structure: { \\"schema\\": [{ \\"fieldName\\": \\"string\\", \\"fieldType\\": \\"text|number|date|boolean\\" }], \\"data\\": { \\"fieldName\\": \\"value\\" } }\n    custom_attributes JSONB DEFAULT '{\\"schema\\": [], \\"data\\": {}}'::jsonb,\n    \n    -- Metadata\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_workout_plans_user_id ON workout_plans(user_id)","CREATE INDEX IF NOT EXISTS idx_workout_plans_lead_id ON workout_plans(lead_id)","CREATE INDEX IF NOT EXISTS idx_workout_plans_start_date ON workout_plans(start_date DESC)","CREATE INDEX IF NOT EXISTS idx_workout_plans_created_at ON workout_plans(created_at DESC)","-- GIN index for JSONB column (enables fast queries on JSONB data)\nCREATE INDEX IF NOT EXISTS idx_workout_plans_custom_attributes ON workout_plans USING GIN (custom_attributes)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_workout_plans_updated_at\n    BEFORE UPDATE ON workout_plans\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on workout_plans table\nALTER TABLE workout_plans ENABLE ROW LEVEL SECURITY","-- Policy: Users can read their own workout plans\nCREATE POLICY \\"Users can read own workout plans\\"\n    ON workout_plans FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own workout plans\nCREATE POLICY \\"Users can insert own workout plans\\"\n    ON workout_plans FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own workout plans\nCREATE POLICY \\"Users can update own workout plans\\"\n    ON workout_plans FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own workout plans\nCREATE POLICY \\"Users can delete own workout plans\\"\n    ON workout_plans FOR DELETE\n    USING (auth.uid() = user_id)","-- Policy: Admins have full access to workout plans\nCREATE POLICY \\"Admins have full access to workout plans\\"\n    ON workout_plans FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )"}	workout_plans
20240102000003	{"-- =====================================================\n-- Remove Weight and RPE from Workout Plans\n-- Created: 2024-01-02\n-- Description: Clean up JSONB data to remove weight and rpe fields from exercises\n-- =====================================================\n\n-- Update existing workout plans to remove weight and rpe from exercises in JSONB\n-- This function processes each workout plan and removes weight/rpe from all exercises\nDO $$\nDECLARE\n    plan_record RECORD;\n    updated_days JSONB;\n    day_key TEXT;\n    day_data JSONB;\n    updated_exercises JSONB;\n    exercise JSONB;\nBEGIN\n    FOR plan_record IN \n        SELECT id, custom_attributes \n        FROM workout_plans \n        WHERE custom_attributes->'data'->'weeklyWorkout'->'days' IS NOT NULL\n    LOOP\n        updated_days := '{}'::JSONB;\n        \n        -- Process each day\n        FOR day_key, day_data IN \n            SELECT * FROM jsonb_each(plan_record.custom_attributes->'data'->'weeklyWorkout'->'days')\n        LOOP\n            -- Process exercises in this day - remove weight and rpe fields\n            updated_exercises := (\n                SELECT jsonb_agg(exercise - 'weight' - 'rpe')\n                FROM jsonb_array_elements(day_data->'exercises') AS exercise\n            );\n            \n            -- Update day with cleaned exercises\n            day_data := jsonb_set(day_data, '{exercises}', COALESCE(updated_exercises, '[]'::JSONB));\n            updated_days := updated_days || jsonb_build_object(day_key, day_data);\n        END LOOP;\n        \n        -- Update the workout plan\n        UPDATE workout_plans\n        SET custom_attributes = jsonb_set(\n            plan_record.custom_attributes,\n            '{data,weeklyWorkout,days}',\n            updated_days\n        )\n        WHERE id = plan_record.id;\n    END LOOP;\nEND $$","-- Note: Since weight and rpe are stored in JSONB (not as table columns),\n-- we only need to clean the JSONB data. No columns need to be dropped from the table."}	remove_weight_rpe_from_workout_plans
20240102000004	{"-- =====================================================\n-- Saved Views Migration\n-- Created: 2024-01-02\n-- Description: Table for storing user-defined saved views/filters for resources\n-- =====================================================\n\n-- =====================================================\n-- TABLE: saved_views\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS saved_views (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    resource_key TEXT NOT NULL CHECK (resource_key IN ('leads', 'workouts', 'customers')),\n    view_name TEXT NOT NULL,\n    filter_config JSONB NOT NULL DEFAULT '{}'::JSONB,\n    is_default BOOLEAN NOT NULL DEFAULT FALSE,\n    created_by UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    \n    -- Ensure unique view names per resource per user\n    CONSTRAINT unique_view_name_per_resource_user \n        UNIQUE (resource_key, created_by, view_name)\n)","-- Indexes for faster queries\nCREATE INDEX IF NOT EXISTS idx_saved_views_resource_key ON saved_views(resource_key)","CREATE INDEX IF NOT EXISTS idx_saved_views_created_by ON saved_views(created_by)","CREATE INDEX IF NOT EXISTS idx_saved_views_resource_user ON saved_views(resource_key, created_by)","CREATE INDEX IF NOT EXISTS idx_saved_views_default ON saved_views(resource_key, created_by, is_default) WHERE is_default = TRUE","-- Unique partial index to ensure only one default view per resource per user\nCREATE UNIQUE INDEX IF NOT EXISTS idx_saved_views_unique_default \n    ON saved_views(resource_key, created_by) \n    WHERE is_default = TRUE","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_saved_views_updated_at\n    BEFORE UPDATE ON saved_views\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS)\n-- =====================================================\n\n-- Enable RLS\nALTER TABLE saved_views ENABLE ROW LEVEL SECURITY","-- Policy: Users can view their own saved views\nCREATE POLICY \\"Users can view their own saved views\\"\n    ON saved_views\n    FOR SELECT\n    USING (auth.uid() = created_by)","-- Policy: Users can insert their own saved views\nCREATE POLICY \\"Users can insert their own saved views\\"\n    ON saved_views\n    FOR INSERT\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can update their own saved views\nCREATE POLICY \\"Users can update their own saved views\\"\n    ON saved_views\n    FOR UPDATE\n    USING (auth.uid() = created_by)\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can delete their own saved views\nCREATE POLICY \\"Users can delete their own saved views\\"\n    ON saved_views\n    FOR DELETE\n    USING (auth.uid() = created_by)","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE saved_views IS 'User-defined saved views/filters for different resources (leads, workouts, etc.)'","COMMENT ON COLUMN saved_views.resource_key IS 'The resource type this view applies to (e.g., \\"leads\\", \\"workouts\\")'","COMMENT ON COLUMN saved_views.view_name IS 'User-friendly name for the saved view'","COMMENT ON COLUMN saved_views.filter_config IS 'JSONB object storing the complete filter/sort state for this view'","COMMENT ON COLUMN saved_views.is_default IS 'Whether this is the default view for the resource (only one default per resource per user)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	saved_views
20240102000005	{"-- =====================================================\n-- Workout Templates Migration\n-- Created: 2024-01-02\n-- Description: Reusable workout templates that can be imported by users\n-- =====================================================\n\n-- =====================================================\n-- TABLE: workout_templates\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS workout_templates (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name TEXT NOT NULL,\n    description TEXT,\n    goal_tags TEXT[] DEFAULT '{}',\n    routine_data JSONB NOT NULL DEFAULT '{}'::jsonb,\n    is_public BOOLEAN NOT NULL DEFAULT FALSE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_workout_templates_created_by ON workout_templates(created_by)","CREATE INDEX IF NOT EXISTS idx_workout_templates_is_public ON workout_templates(is_public)","CREATE INDEX IF NOT EXISTS idx_workout_templates_goal_tags ON workout_templates USING GIN (goal_tags)","CREATE INDEX IF NOT EXISTS idx_workout_templates_routine_data ON workout_templates USING GIN (routine_data)","CREATE INDEX IF NOT EXISTS idx_workout_templates_created_at ON workout_templates(created_at DESC)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_workout_templates_updated_at\n    BEFORE UPDATE ON workout_templates\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on workout_templates table\nALTER TABLE workout_templates ENABLE ROW LEVEL SECURITY","-- Policy: Users can view public templates or their own templates\nCREATE POLICY \\"Users can view public or own templates\\"\n    ON workout_templates FOR SELECT\n    USING (\n        is_public = TRUE OR \n        created_by = auth.uid()\n    )","-- Policy: Users can insert their own templates\nCREATE POLICY \\"Users can insert own templates\\"\n    ON workout_templates FOR INSERT\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can update their own templates\nCREATE POLICY \\"Users can update own templates\\"\n    ON workout_templates FOR UPDATE\n    USING (auth.uid() = created_by)\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can delete their own templates\nCREATE POLICY \\"Users can delete own templates\\"\n    ON workout_templates FOR DELETE\n    USING (auth.uid() = created_by)","-- Policy: Admins have full access to templates\nCREATE POLICY \\"Admins have full access to templates\\"\n    ON workout_templates FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE workout_templates IS 'Reusable workout templates that can be imported by users to create workout plans'","COMMENT ON COLUMN workout_templates.name IS 'Template name'","COMMENT ON COLUMN workout_templates.description IS 'Template description'","COMMENT ON COLUMN workout_templates.goal_tags IS 'Array of goal tags (e.g., [\\"חיטוב\\", \\"כוח\\", \\"סיבולת\\"])'","COMMENT ON COLUMN workout_templates.routine_data IS 'JSONB containing the workout routine data (matches workout_plans.custom_attributes.data.weeklyWorkout schema)'","COMMENT ON COLUMN workout_templates.is_public IS 'Whether the template is publicly visible to all users'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	workout_templates
20240102000006	{"-- =====================================================\n-- Add 'templates' to saved_views resource_key constraint\n-- Created: 2024-01-02\n-- Description: Allow saved views for workout templates\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'templates'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_templates_to_saved_views
20240102000007	{"-- =====================================================\n-- Add template_id to workout_plans\n-- Created: 2024-01-02\n-- Description: Track which template a workout plan was created from (reference only, snapshot pattern maintained)\n-- =====================================================\n\n-- Add template_id column (nullable, just for reference)\nALTER TABLE workout_plans\nADD COLUMN IF NOT EXISTS template_id UUID REFERENCES workout_templates(id) ON DELETE SET NULL","-- Create index for performance\nCREATE INDEX IF NOT EXISTS idx_workout_plans_template_id ON workout_plans(template_id)","-- Note: This is a reference only. The actual routine_data is stored in workout_plans.custom_attributes\n-- When a template is changed, existing workout_plans remain independent (snapshot pattern)"}	add_template_id_to_workout_plans
20240102000008	{"-- =====================================================\n-- Nutrition Templates Migration\n-- Created: 2024-01-02\n-- Description: Reusable nutrition templates for macro-nutrient planning and calculation\n-- =====================================================\n\n-- =====================================================\n-- TABLE: nutrition_templates\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS nutrition_templates (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name TEXT NOT NULL,\n    description TEXT,\n    targets JSONB NOT NULL DEFAULT '{}'::jsonb,\n    -- Structure: { calories: number, protein: number, carbs: number, fat: number, fiber: number }\n    is_public BOOLEAN NOT NULL DEFAULT FALSE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_nutrition_templates_created_by ON nutrition_templates(created_by)","CREATE INDEX IF NOT EXISTS idx_nutrition_templates_is_public ON nutrition_templates(is_public)","CREATE INDEX IF NOT EXISTS idx_nutrition_templates_targets ON nutrition_templates USING GIN (targets)","CREATE INDEX IF NOT EXISTS idx_nutrition_templates_created_at ON nutrition_templates(created_at DESC)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_nutrition_templates_updated_at\n    BEFORE UPDATE ON nutrition_templates\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on nutrition_templates table\nALTER TABLE nutrition_templates ENABLE ROW LEVEL SECURITY","-- Policy: Users can view public templates or their own templates\nCREATE POLICY \\"Users can view public or own nutrition templates\\"\n    ON nutrition_templates FOR SELECT\n    USING (\n        is_public = TRUE OR \n        created_by = auth.uid()\n    )","-- Policy: Users can insert their own templates\nCREATE POLICY \\"Users can insert own nutrition templates\\"\n    ON nutrition_templates FOR INSERT\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can update their own templates\nCREATE POLICY \\"Users can update own nutrition templates\\"\n    ON nutrition_templates FOR UPDATE\n    USING (auth.uid() = created_by)\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can delete their own templates\nCREATE POLICY \\"Users can delete own nutrition templates\\"\n    ON nutrition_templates FOR DELETE\n    USING (auth.uid() = created_by)","-- Policy: Admins have full access to templates\nCREATE POLICY \\"Admins have full access to nutrition templates\\"\n    ON nutrition_templates FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE nutrition_templates IS 'Reusable nutrition templates for macro-nutrient planning and calculation'","COMMENT ON COLUMN nutrition_templates.name IS 'Template name'","COMMENT ON COLUMN nutrition_templates.description IS 'Template description'","COMMENT ON COLUMN nutrition_templates.targets IS 'JSONB containing macro targets: { calories: number, protein: number, carbs: number, fat: number, fiber: number }'","COMMENT ON COLUMN nutrition_templates.is_public IS 'Whether the template is publicly visible to all users'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	nutrition_templates
20240102000009	{"-- =====================================================\n-- Nutrition Plans Migration\n-- Created: 2024-01-02\n-- Description: User nutrition plans linked to leads (snapshot pattern - independent from templates)\n-- =====================================================\n\n-- =====================================================\n-- TABLE: nutrition_plans\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS nutrition_plans (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    template_id UUID REFERENCES nutrition_templates(id) ON DELETE SET NULL,\n    \n    -- Standard fields\n    start_date DATE NOT NULL,\n    description TEXT,\n    \n    -- Nutrition targets (snapshot - independent from template)\n    -- Structure: { calories: number, protein: number, carbs: number, fat: number, fiber: number }\n    targets JSONB NOT NULL DEFAULT '{}'::jsonb,\n    \n    -- Metadata\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_nutrition_plans_user_id ON nutrition_plans(user_id)","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_lead_id ON nutrition_plans(lead_id)","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_template_id ON nutrition_plans(template_id)","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_start_date ON nutrition_plans(start_date DESC)","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_created_at ON nutrition_plans(created_at DESC)","-- GIN index for JSONB column (enables fast queries on JSONB data)\nCREATE INDEX IF NOT EXISTS idx_nutrition_plans_targets ON nutrition_plans USING GIN (targets)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_nutrition_plans_updated_at\n    BEFORE UPDATE ON nutrition_plans\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on nutrition_plans table\nALTER TABLE nutrition_plans ENABLE ROW LEVEL SECURITY","-- Policy: Users can read their own nutrition plans\nCREATE POLICY \\"Users can read own nutrition plans\\"\n    ON nutrition_plans FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own nutrition plans\nCREATE POLICY \\"Users can insert own nutrition plans\\"\n    ON nutrition_plans FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own nutrition plans\nCREATE POLICY \\"Users can update own nutrition plans\\"\n    ON nutrition_plans FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own nutrition plans\nCREATE POLICY \\"Users can delete own nutrition plans\\"\n    ON nutrition_plans FOR DELETE\n    USING (auth.uid() = user_id)","-- Policy: Admins have full access to nutrition plans\nCREATE POLICY \\"Admins have full access to nutrition plans\\"\n    ON nutrition_plans FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE nutrition_plans IS 'User nutrition plans linked to leads (snapshot pattern - independent from templates)'","COMMENT ON COLUMN nutrition_plans.lead_id IS 'Reference to the lead this plan is assigned to'","COMMENT ON COLUMN nutrition_plans.template_id IS 'Reference to the template this plan was created from (for tracking only, changes to template do not affect this plan)'","COMMENT ON COLUMN nutrition_plans.targets IS 'JSONB containing macro targets: { calories: number, protein: number, carbs: number, fat: number, fiber: number } - This is a snapshot, independent from the template'","COMMENT ON COLUMN nutrition_plans.start_date IS 'Date when the nutrition plan starts'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	nutrition_plans
20240102000010	{"-- =====================================================\n-- Add 'nutrition_templates' to saved_views resource_key constraint\n-- Created: 2024-01-02\n-- Description: Allow saved views for nutrition templates\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'nutrition_templates'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_nutrition_templates_to_saved_views
20240102000011	{"-- =====================================================\n-- Add history tracking to workout_plans\n-- Created: 2024-01-02\n-- Description: Add is_active and deleted_at fields to track workout plan history\n-- =====================================================\n\n-- Add is_active and deleted_at columns\nALTER TABLE workout_plans\n  ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true NOT NULL,\n  ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMP WITH TIME ZONE","-- Create index for active plans\nCREATE INDEX IF NOT EXISTS idx_workout_plans_is_active ON workout_plans(is_active) WHERE is_active = true","CREATE INDEX IF NOT EXISTS idx_workout_plans_deleted_at ON workout_plans(deleted_at) WHERE deleted_at IS NOT NULL","-- Update existing plans to be active\nUPDATE workout_plans SET is_active = true WHERE is_active IS NULL","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_workout_plan_history
20240102000012	{"-- =====================================================\n-- Normalize Database: Separate Customers from Leads\n-- Created: 2024-01-02\n-- Description: Create customers table and normalize leads table\n--              Decouple Identity (Customer) from Opportunity (Lead)\n--              Unique identifier: phone number\n-- =====================================================\n\n-- =====================================================\n-- STEP A: Create customers table\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS public.customers (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    full_name TEXT NOT NULL,\n    phone TEXT NOT NULL UNIQUE,\n    email TEXT,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL\n)","-- Create indexes for customers\nCREATE INDEX IF NOT EXISTS idx_customers_phone ON public.customers(phone)","CREATE INDEX IF NOT EXISTS idx_customers_email ON public.customers(email)","CREATE INDEX IF NOT EXISTS idx_customers_created_at ON public.customers(created_at DESC)","-- Create trigger for auto-updating updated_at\nCREATE TRIGGER update_customers_updated_at\n    BEFORE UPDATE ON public.customers\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- Enable RLS on customers table\nALTER TABLE public.customers ENABLE ROW LEVEL SECURITY","-- RLS Policies for customers\nDROP POLICY IF EXISTS \\"Authenticated users can read customers\\" ON public.customers","DROP POLICY IF EXISTS \\"Authenticated users can insert customers\\" ON public.customers","DROP POLICY IF EXISTS \\"Authenticated users can update customers\\" ON public.customers","DROP POLICY IF EXISTS \\"Admins have full access to customers\\" ON public.customers","CREATE POLICY \\"Authenticated users can read customers\\"\n    ON public.customers FOR SELECT\n    USING (auth.role() = 'authenticated')","CREATE POLICY \\"Authenticated users can insert customers\\"\n    ON public.customers FOR INSERT\n    WITH CHECK (auth.role() = 'authenticated')","CREATE POLICY \\"Authenticated users can update customers\\"\n    ON public.customers FOR UPDATE\n    USING (auth.role() = 'authenticated')\n    WITH CHECK (auth.role() = 'authenticated')","CREATE POLICY \\"Admins have full access to customers\\"\n    ON public.customers FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- STEP B: Data Migration (Backfill Script)\n-- =====================================================\n-- Since we're resetting the DB, this step is not needed\n-- But we'll include it for completeness in case of future migrations\n\n-- This would migrate existing data if needed:\n-- INSERT INTO public.customers (full_name, phone, email, created_at, updated_at)\n-- SELECT DISTINCT ON (phone)\n--     full_name,\n--     phone,\n--     email,\n--     MIN(created_at) as created_at,\n--     NOW() as updated_at\n-- FROM public.leads\n-- WHERE phone IS NOT NULL\n-- GROUP BY phone, full_name, email\n-- ON CONFLICT (phone) DO NOTHING;\n\n-- =====================================================\n-- STEP C: Update leads table\n-- =====================================================\n\n-- Add customer_id column\nALTER TABLE public.leads\n    ADD COLUMN IF NOT EXISTS customer_id UUID REFERENCES public.customers(id) ON DELETE CASCADE","-- Create index for customer_id\nCREATE INDEX IF NOT EXISTS idx_leads_customer_id ON public.leads(customer_id)","-- Link existing data (if any exists)\n-- UPDATE public.leads l\n-- SET customer_id = c.id\n-- FROM public.customers c\n-- WHERE l.phone = c.phone;\n\n-- Make customer_id NOT NULL (since we're resetting, we can set it immediately)\nALTER TABLE public.leads ALTER COLUMN customer_id SET NOT NULL","-- Remove old columns (since we're resetting, we can drop them immediately)\nALTER TABLE public.leads\n    DROP COLUMN IF EXISTS full_name,\n    DROP COLUMN IF EXISTS phone,\n    DROP COLUMN IF EXISTS email","-- Drop old indexes that are no longer needed\nDROP INDEX IF EXISTS public.idx_leads_phone","DROP INDEX IF EXISTS public.idx_leads_email","-- Add comment for documentation\nCOMMENT ON TABLE public.customers IS 'Customer identity table - unique by phone number'","COMMENT ON COLUMN public.customers.phone IS 'Unique identifier for customer identity'","COMMENT ON TABLE public.leads IS 'Lead/Opportunity table - linked to customers via customer_id'","COMMENT ON COLUMN public.leads.customer_id IS 'Foreign key to customers table - one customer can have many leads'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	normalize_customers_leads
20240102000013	{"-- =====================================================\n-- Add 'customers' to saved_views resource_key constraint\n-- Created: 2024-01-02\n-- Description: Allow saved views for customers\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'customers'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_customers_to_saved_views
20240102000014	{"-- =====================================================\n-- Service Data Relocation: Move Coaching Data from Leads to Customers\n-- Created: 2024-01-02\n-- Description: Relocate ownership of coaching data (Workouts, Nutrition, Steps, Measurements)\n--              from Lead entity to Customer entity\n-- Philosophy: Lead = Sales/CRM, Customer = Service/Coaching\n-- =====================================================\n\n-- =====================================================\n-- STEP A: Add customer_id to service tables\n-- =====================================================\n\n-- Add customer_id to workout_plans\nALTER TABLE workout_plans\n    ADD COLUMN IF NOT EXISTS customer_id UUID REFERENCES customers(id) ON DELETE CASCADE","-- Add customer_id to nutrition_plans\nALTER TABLE nutrition_plans\n    ADD COLUMN IF NOT EXISTS customer_id UUID REFERENCES customers(id) ON DELETE CASCADE","-- Create indexes for customer_id\nCREATE INDEX IF NOT EXISTS idx_workout_plans_customer_id ON workout_plans(customer_id)","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_customer_id ON nutrition_plans(customer_id)","-- =====================================================\n-- STEP B: Migrate existing data (populate customer_id from lead_id)\n-- =====================================================\n\n-- Migrate workout_plans: Set customer_id based on lead_id -> customer_id relationship\nUPDATE workout_plans wp\nSET customer_id = l.customer_id\nFROM leads l\nWHERE wp.lead_id = l.id\n  AND wp.customer_id IS NULL\n  AND l.customer_id IS NOT NULL","-- Migrate nutrition_plans: Set customer_id based on lead_id -> customer_id relationship\nUPDATE nutrition_plans np\nSET customer_id = l.customer_id\nFROM leads l\nWHERE np.lead_id = l.id\n  AND np.customer_id IS NULL\n  AND l.customer_id IS NOT NULL","-- Handle orphaned records: Delete workout_plans that can't be linked to a customer\n-- (These are orphaned records with invalid lead_id references or NULL lead_id)\n-- First, try to find customer_id through any remaining valid lead relationships\nUPDATE workout_plans wp\nSET customer_id = l.customer_id\nFROM leads l\nWHERE wp.lead_id = l.id\n  AND wp.customer_id IS NULL\n  AND l.customer_id IS NOT NULL","-- Now delete any remaining orphaned records that still have NULL customer_id\nDELETE FROM workout_plans\nWHERE customer_id IS NULL","-- Handle orphaned records: Delete nutrition_plans that can't be linked to a customer\n-- First, try to find customer_id through any remaining valid lead relationships\nUPDATE nutrition_plans np\nSET customer_id = l.customer_id\nFROM leads l\nWHERE np.lead_id = l.id\n  AND np.customer_id IS NULL\n  AND l.customer_id IS NOT NULL","-- Now delete any remaining orphaned records that still have NULL customer_id\nDELETE FROM nutrition_plans\nWHERE customer_id IS NULL","-- =====================================================\n-- STEP C: Add coaching data columns to customers table\n-- =====================================================\n\n-- Add coaching data JSONB columns to customers\nALTER TABLE customers\n    ADD COLUMN IF NOT EXISTS daily_protocol JSONB DEFAULT '{}'::jsonb,\n    ADD COLUMN IF NOT EXISTS workout_history JSONB DEFAULT '[]'::jsonb,\n    ADD COLUMN IF NOT EXISTS steps_history JSONB DEFAULT '[]'::jsonb","-- Create GIN indexes for JSONB columns\nCREATE INDEX IF NOT EXISTS idx_customers_daily_protocol ON customers USING GIN (daily_protocol)","CREATE INDEX IF NOT EXISTS idx_customers_workout_history ON customers USING GIN (workout_history)","CREATE INDEX IF NOT EXISTS idx_customers_steps_history ON customers USING GIN (steps_history)","-- =====================================================\n-- STEP D: Migrate coaching data from leads to customers\n-- =====================================================\n\n-- Migrate daily_protocol, workout_history, steps_history from leads to customers\n-- Aggregate data per customer (in case of multiple leads per customer)\n-- Note: Since we're resetting the DB, this migration step is mainly for documentation\n-- In a production migration, you would aggregate data from all leads per customer\nUPDATE customers c\nSET \n    daily_protocol = COALESCE(\n        (SELECT daily_protocol FROM leads WHERE customer_id = c.id AND daily_protocol IS NOT NULL AND daily_protocol != '{}'::jsonb ORDER BY created_at DESC LIMIT 1),\n        '{}'::jsonb\n    ),\n    workout_history = COALESCE(\n        (\n            SELECT jsonb_agg(DISTINCT elem)\n            FROM leads l, jsonb_array_elements(l.workout_history) elem\n            WHERE l.customer_id = c.id \n              AND l.workout_history IS NOT NULL \n              AND l.workout_history != '[]'::jsonb\n        ),\n        '[]'::jsonb\n    ),\n    steps_history = COALESCE(\n        (\n            SELECT jsonb_agg(DISTINCT elem)\n            FROM leads l, jsonb_array_elements(l.steps_history) elem\n            WHERE l.customer_id = c.id \n              AND l.steps_history IS NOT NULL \n              AND l.steps_history != '[]'::jsonb\n        ),\n        '[]'::jsonb\n    )\nWHERE EXISTS (SELECT 1 FROM leads WHERE customer_id = c.id)","-- =====================================================\n-- STEP E: Make customer_id NOT NULL and deprecate lead_id\n-- =====================================================\n\n-- Verify all records have customer_id before setting NOT NULL\n-- (This should pass after orphaned records are deleted in Step B)\nDO $$\nBEGIN\n    -- Check for any remaining NULL customer_id values\n    IF EXISTS (SELECT 1 FROM workout_plans WHERE customer_id IS NULL) THEN\n        RAISE EXCEPTION 'Cannot set NOT NULL: workout_plans still contains NULL customer_id values. Please check orphaned records.';\n    END IF;\n    \n    IF EXISTS (SELECT 1 FROM nutrition_plans WHERE customer_id IS NULL) THEN\n        RAISE EXCEPTION 'Cannot set NOT NULL: nutrition_plans still contains NULL customer_id values. Please check orphaned records.';\n    END IF;\nEND $$","-- For workout_plans: Make customer_id required for new records (keep lead_id nullable for backward compatibility)\n-- Note: We keep lead_id for now but it's deprecated - new records should use customer_id\nALTER TABLE workout_plans\n    ALTER COLUMN customer_id SET NOT NULL","-- For nutrition_plans: Make customer_id required for new records\nALTER TABLE nutrition_plans\n    ALTER COLUMN customer_id SET NOT NULL","-- Drop the foreign key constraint on lead_id (we'll keep the column but remove the constraint)\n-- This allows us to keep historical data but prevents new relationships\nALTER TABLE workout_plans\n    DROP CONSTRAINT IF EXISTS workout_plans_lead_id_fkey","ALTER TABLE nutrition_plans\n    DROP CONSTRAINT IF EXISTS nutrition_plans_lead_id_fkey","-- Add comments to mark lead_id as deprecated\nCOMMENT ON COLUMN workout_plans.lead_id IS 'DEPRECATED: Use customer_id instead. This column is kept for historical data only.'","COMMENT ON COLUMN nutrition_plans.lead_id IS 'DEPRECATED: Use customer_id instead. This column is kept for historical data only.'","-- =====================================================\n-- STEP F: Update RLS policies to use customer_id\n-- =====================================================\n\n-- Note: RLS policies will need to be updated in application logic\n-- The policies currently check user_id, which is still valid\n-- We add customer-based policies for admin access\n\n-- Policy: Admins can read all workout plans by customer\nDROP POLICY IF EXISTS \\"Admins can read workout plans by customer\\" ON workout_plans","CREATE POLICY \\"Admins can read workout plans by customer\\"\n    ON workout_plans FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Admins can read all nutrition plans by customer\nDROP POLICY IF EXISTS \\"Admins can read nutrition plans by customer\\" ON nutrition_plans","CREATE POLICY \\"Admins can read nutrition plans by customer\\"\n    ON nutrition_plans FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- STEP G: Add comments for documentation\n-- =====================================================\n\nCOMMENT ON COLUMN customers.daily_protocol IS 'JSONB: { \\"stepsGoal\\": number, \\"workoutGoal\\": number, \\"supplements\\": string[] } - Coaching protocol data'","COMMENT ON COLUMN customers.workout_history IS 'JSONB: Array of workout program objects with dates, splits, and descriptions - Historical coaching data'","COMMENT ON COLUMN customers.steps_history IS 'JSONB: Array of step tracking objects with week numbers, dates, and targets - Historical coaching data'","COMMENT ON COLUMN workout_plans.customer_id IS 'Reference to the customer this workout plan belongs to (coaching data)'","COMMENT ON COLUMN nutrition_plans.customer_id IS 'Reference to the customer this nutrition plan belongs to (coaching data)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	relocate_service_data_to_customers
20240102000015	{"-- =====================================================\n-- Performance Optimization: Shift Left Strategy\n-- Created: 2024-01-02\n-- Description: Move filtering, calculations, and aggregations to PostgreSQL\n--              Replace client-side JS logic with database functions\n-- Philosophy: Database does the heavy lifting, frontend stays light\n-- =====================================================\n\n-- =====================================================\n-- STEP 1: Create Optimized Indexes (Strategic, not over-indexing)\n-- =====================================================\n\n-- Indexes for filtering columns (most common filters)\nCREATE INDEX IF NOT EXISTS idx_leads_status_main ON public.leads(status_main) WHERE status_main IS NOT NULL","CREATE INDEX IF NOT EXISTS idx_leads_status_sub ON public.leads(status_sub) WHERE status_sub IS NOT NULL","CREATE INDEX IF NOT EXISTS idx_leads_source ON public.leads(source) WHERE source IS NOT NULL","CREATE INDEX IF NOT EXISTS idx_leads_fitness_goal ON public.leads(fitness_goal) WHERE fitness_goal IS NOT NULL","CREATE INDEX IF NOT EXISTS idx_leads_activity_level ON public.leads(activity_level) WHERE activity_level IS NOT NULL","CREATE INDEX IF NOT EXISTS idx_leads_preferred_time ON public.leads(preferred_time) WHERE preferred_time IS NOT NULL","-- Note: Removed idx_leads_created_at_date - DATE() is not IMMUTABLE\n-- Use existing idx_leads_created_at index for date filtering instead\n\n-- Composite index for common filter combinations\nCREATE INDEX IF NOT EXISTS idx_leads_status_source ON public.leads(status_main, source) WHERE status_main IS NOT NULL AND source IS NOT NULL","-- Index for customer_id (already exists, but ensure it's there)\nCREATE INDEX IF NOT EXISTS idx_leads_customer_id ON public.leads(customer_id)","-- Index for birth_date (for age calculations)\nCREATE INDEX IF NOT EXISTS idx_leads_birth_date ON public.leads(birth_date) WHERE birth_date IS NOT NULL","-- Note: Removed idx_leads_created_at_date index\n-- DATE() function is not IMMUTABLE, so it can't be used in index expressions\n-- The existing idx_leads_created_at index on created_at (DESC) is sufficient for date filtering\n\n-- =====================================================\n-- STEP 2: Create View for Leads with Customer Data (Pre-joined)\n-- =====================================================\n\nCREATE OR REPLACE VIEW public.v_leads_with_customer AS\nSELECT \n    l.id,\n    l.created_at,\n    l.updated_at,\n    l.assigned_to,\n    l.customer_id,\n    l.city,\n    l.birth_date,\n    l.gender,\n    l.status_main,\n    l.status_sub,\n    l.height,\n    l.weight,\n    l.bmi,\n    l.join_date,\n    l.subscription_data,\n    l.daily_protocol,\n    l.workout_history,\n    l.steps_history,\n    l.source,\n    l.fitness_goal,\n    l.activity_level,\n    l.preferred_time,\n    l.notes,\n    -- Customer data (joined)\n    c.full_name as customer_name,\n    c.phone as customer_phone,\n    c.email as customer_email,\n    -- Calculated fields (PostgreSQL does the math)\n    EXTRACT(YEAR FROM AGE(l.birth_date))::INTEGER as age,\n    TO_CHAR(l.created_at, 'YYYY-MM-DD') as created_date_formatted,\n    TO_CHAR(l.birth_date, 'YYYY-MM-DD') as birth_date_formatted,\n    -- Extract JSONB fields (PostgreSQL parses JSON)\n    (l.daily_protocol->>'stepsGoal')::INTEGER as daily_steps_goal,\n    (l.daily_protocol->>'workoutGoal')::INTEGER as weekly_workouts,\n    -- Extract supplements array from JSONB (handle both array and null)\n    CASE \n        WHEN l.daily_protocol->'supplements' IS NULL THEN ARRAY[]::TEXT[]\n        WHEN jsonb_typeof(l.daily_protocol->'supplements') = 'array' \n        THEN ARRAY(SELECT jsonb_array_elements_text(l.daily_protocol->'supplements'))\n        ELSE ARRAY[]::TEXT[]\n    END as daily_supplements,\n    -- Extract subscription data\n    (l.subscription_data->>'months')::INTEGER as subscription_months,\n    (l.subscription_data->>'initialPrice')::DECIMAL as subscription_initial_price,\n    (l.subscription_data->>'renewalPrice')::DECIMAL as subscription_renewal_price\nFROM public.leads l\nINNER JOIN public.customers c ON l.customer_id = c.id","-- Grant access to authenticated users\nGRANT SELECT ON public.v_leads_with_customer TO authenticated","-- =====================================================\n-- STEP 3: Create RPC Function for Filtered Leads (Complex Filtering)\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.get_filtered_leads(\n    p_search_query TEXT DEFAULT NULL,\n    p_created_date DATE DEFAULT NULL,\n    p_status_main TEXT DEFAULT NULL,\n    p_status_sub TEXT DEFAULT NULL,\n    p_age TEXT DEFAULT NULL,\n    p_height TEXT DEFAULT NULL,\n    p_weight TEXT DEFAULT NULL,\n    p_fitness_goal TEXT DEFAULT NULL,\n    p_activity_level TEXT DEFAULT NULL,\n    p_preferred_time TEXT DEFAULT NULL,\n    p_source TEXT DEFAULT NULL,\n    p_limit_count INTEGER DEFAULT 1000,\n    p_offset_count INTEGER DEFAULT 0\n)\nRETURNS TABLE (\n    id UUID,\n    created_at TIMESTAMP WITH TIME ZONE,\n    updated_at TIMESTAMP WITH TIME ZONE,\n    customer_id UUID,\n    customer_name TEXT,\n    customer_phone TEXT,\n    customer_email TEXT,\n    status_main TEXT,\n    status_sub TEXT,\n    source TEXT,\n    fitness_goal TEXT,\n    activity_level TEXT,\n    preferred_time TEXT,\n    notes TEXT,\n    age INTEGER,\n    birth_date DATE,\n    birth_date_formatted TEXT,\n    created_date_formatted TEXT,\n    height DECIMAL,\n    weight DECIMAL,\n    daily_steps_goal INTEGER,\n    weekly_workouts INTEGER,\n    daily_supplements TEXT[],\n    subscription_months INTEGER,\n    subscription_initial_price DECIMAL,\n    subscription_renewal_price DECIMAL\n) \nLANGUAGE plpgsql\nSECURITY DEFINER\nSTABLE\nAS $$\nBEGIN\n    RETURN QUERY\n    SELECT \n        v.id,\n        v.created_at,\n        v.updated_at,\n        v.customer_id,\n        v.customer_name,\n        v.customer_phone,\n        v.customer_email,\n        v.status_main,\n        v.status_sub,\n        v.source,\n        v.fitness_goal,\n        v.activity_level,\n        v.preferred_time,\n        v.notes,\n        v.age,\n        v.birth_date,\n        v.birth_date_formatted,\n        v.created_date_formatted,\n        v.height,\n        v.weight,\n        v.daily_steps_goal,\n        v.weekly_workouts,\n        v.daily_supplements,\n        v.subscription_months,\n        v.subscription_initial_price,\n        v.subscription_renewal_price\n    FROM public.v_leads_with_customer v\n    WHERE \n        -- Search query (PostgreSQL text search - fast with indexes)\n        (p_search_query IS NULL OR \n         v.customer_name ILIKE '%' || p_search_query || '%' OR\n         v.customer_email ILIKE '%' || p_search_query || '%' OR\n         v.customer_phone LIKE '%' || p_search_query || '%' OR\n         v.fitness_goal ILIKE '%' || p_search_query || '%' OR\n         v.notes ILIKE '%' || p_search_query || '%')\n        -- Date filter (PostgreSQL date comparison)\n        AND (p_created_date IS NULL OR DATE(v.created_at) = p_created_date)\n        -- Status filters (uses indexes)\n        AND (p_status_main IS NULL OR v.status_main = p_status_main)\n        AND (p_status_sub IS NULL OR v.status_sub = p_status_sub)\n        -- Age filter (calculated in PostgreSQL)\n        AND (p_age IS NULL OR v.age::TEXT = p_age)\n        -- Height filter\n        AND (p_height IS NULL OR v.height::TEXT = p_height)\n        -- Weight filter\n        AND (p_weight IS NULL OR v.weight::TEXT = p_weight)\n        -- Fitness goal filter (uses index)\n        AND (p_fitness_goal IS NULL OR v.fitness_goal = p_fitness_goal)\n        -- Activity level filter (uses index)\n        AND (p_activity_level IS NULL OR v.activity_level = p_activity_level)\n        -- Preferred time filter (uses index)\n        AND (p_preferred_time IS NULL OR v.preferred_time = p_preferred_time)\n        -- Source filter (uses index)\n        AND (p_source IS NULL OR v.source = p_source)\n    ORDER BY v.created_at DESC\n    LIMIT p_limit_count\n    OFFSET p_offset_count;\nEND;\n$$","-- Grant execute permission to authenticated users\nGRANT EXECUTE ON FUNCTION public.get_filtered_leads TO authenticated","-- =====================================================\n-- STEP 4: Create Helper Function for Age Calculation (Reusable)\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.calculate_age_from_birth_date(birth_date DATE)\nRETURNS INTEGER\nLANGUAGE plpgsql\nIMMUTABLE\nAS $$\nBEGIN\n    IF birth_date IS NULL THEN\n        RETURN 0;\n    END IF;\n    RETURN EXTRACT(YEAR FROM AGE(birth_date))::INTEGER;\nEND;\n$$","-- =====================================================\n-- STEP 5: Create Function to Get Unique Filter Values (For Dropdowns)\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.get_lead_filter_options()\nRETURNS JSONB\nLANGUAGE plpgsql\nSECURITY DEFINER\nSTABLE\nAS $$\nDECLARE\n    result JSONB;\nBEGIN\n    SELECT jsonb_build_object(\n        'statuses', ARRAY(SELECT DISTINCT status_main FROM public.leads WHERE status_main IS NOT NULL ORDER BY status_main)::TEXT[],\n        'sources', ARRAY(SELECT DISTINCT source FROM public.leads WHERE source IS NOT NULL ORDER BY source)::TEXT[],\n        'fitness_goals', ARRAY(SELECT DISTINCT fitness_goal FROM public.leads WHERE fitness_goal IS NOT NULL ORDER BY fitness_goal)::TEXT[],\n        'activity_levels', ARRAY(SELECT DISTINCT activity_level FROM public.leads WHERE activity_level IS NOT NULL ORDER BY activity_level)::TEXT[],\n        'preferred_times', ARRAY(SELECT DISTINCT preferred_time FROM public.leads WHERE preferred_time IS NOT NULL ORDER BY preferred_time)::TEXT[],\n        'ages', ARRAY(SELECT DISTINCT EXTRACT(YEAR FROM AGE(birth_date))::TEXT \n                      FROM public.leads \n                      WHERE birth_date IS NOT NULL \n                      ORDER BY EXTRACT(YEAR FROM AGE(birth_date)))::TEXT[],\n        'heights', ARRAY(SELECT DISTINCT height::TEXT \n                         FROM public.leads \n                         WHERE height IS NOT NULL \n                         ORDER BY height)::TEXT[],\n        'weights', ARRAY(SELECT DISTINCT weight::TEXT \n                         FROM public.leads \n                         WHERE weight IS NOT NULL \n                         ORDER BY weight)::TEXT[]\n    ) INTO result;\n    \n    RETURN result;\nEND;\n$$","-- Grant execute permission\nGRANT EXECUTE ON FUNCTION public.get_lead_filter_options TO authenticated","-- =====================================================\n-- STEP 6: Comments for Documentation\n-- =====================================================\n\nCOMMENT ON VIEW public.v_leads_with_customer IS 'Pre-joined view of leads with customer data and calculated fields. Use this for read operations to avoid client-side joins.'","COMMENT ON FUNCTION public.get_filtered_leads IS 'RPC function for complex lead filtering. All filtering happens in PostgreSQL. Returns pre-calculated fields (age, formatted dates, JSONB extracts).'","COMMENT ON FUNCTION public.calculate_age_from_birth_date IS 'Immutable function to calculate age from birth date. Can be used in queries and views.'","COMMENT ON FUNCTION public.get_lead_filter_options IS 'Returns distinct filter values for dropdowns. Calculated once in PostgreSQL instead of client-side.'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	optimize_leads_queries
20240102000016	{"-- =====================================================\n-- Add Profile Fields to Customers Table\n-- Created: 2024-01-02\n-- Description: Add fields for Rich Profile Hero view\n--              - total_spent: Calculated from leads subscription_data\n--              - membership_tier: Derived from total_spent\n--              - avatar_url: URL for customer avatar image\n-- =====================================================\n\n-- Add new columns to customers table\nALTER TABLE public.customers\n  ADD COLUMN IF NOT EXISTS avatar_url TEXT,\n  ADD COLUMN IF NOT EXISTS total_spent NUMERIC(10, 2) DEFAULT 0,\n  ADD COLUMN IF NOT EXISTS membership_tier TEXT DEFAULT 'New' CHECK (membership_tier IN ('New', 'Standard', 'Premium', 'VIP'))","-- Create index for membership_tier for faster filtering\nCREATE INDEX IF NOT EXISTS idx_customers_membership_tier ON public.customers(membership_tier)","-- Add comments for documentation\nCOMMENT ON COLUMN public.customers.avatar_url IS 'URL to customer avatar/profile image'","COMMENT ON COLUMN public.customers.total_spent IS 'Total amount spent across all leads (calculated field)'","COMMENT ON COLUMN public.customers.membership_tier IS 'Customer membership tier based on total_spent: New (<500), Standard (500-1999), Premium (2000-4999), VIP (5000+)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_profile_fields_to_customers
20240102000017	{"-- =====================================================\n-- Add Nutrition and Supplements History to Leads Table\n-- Created: 2024-01-02\n-- Description: Add nutrition_history and supplements_history JSONB columns\n--              to store historical nutrition plans and supplements plans\n-- =====================================================\n\n-- Add nutrition_history column to leads table\nALTER TABLE public.leads\n  ADD COLUMN IF NOT EXISTS nutrition_history JSONB DEFAULT '[]'::jsonb","-- Add supplements_history column to leads table\nALTER TABLE public.leads\n  ADD COLUMN IF NOT EXISTS supplements_history JSONB DEFAULT '[]'::jsonb","-- Create GIN indexes for efficient JSONB queries\nCREATE INDEX IF NOT EXISTS idx_leads_nutrition_history ON public.leads USING GIN (nutrition_history)","CREATE INDEX IF NOT EXISTS idx_leads_supplements_history ON public.leads USING GIN (supplements_history)","-- Add comments for documentation\nCOMMENT ON COLUMN public.leads.nutrition_history IS 'Array of historical nutrition plans for this lead'","COMMENT ON COLUMN public.leads.supplements_history IS 'Array of historical supplements plans for this lead'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_nutrition_supplements_history_to_leads
20240102000018	{"-- Migration: Add customer_notes table for unified customer notes system\n-- Created: 2024-01-02\n-- Description: Customer-centric notes that are unified across all leads belonging to the same customer\n\nCREATE TABLE IF NOT EXISTS customer_notes (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,\n  content TEXT NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id)\n)","-- Create indexes for performance\nCREATE INDEX IF NOT EXISTS idx_customer_notes_customer_id ON customer_notes(customer_id)","CREATE INDEX IF NOT EXISTS idx_customer_notes_created_at ON customer_notes(created_at DESC)","-- Enable RLS\nALTER TABLE customer_notes ENABLE ROW LEVEL SECURITY","-- RLS Policies: Allow authenticated users to manage notes\n-- Adjust these policies based on your specific requirements\n\nCREATE POLICY \\"Users can view customer notes\\" ON customer_notes\n  FOR SELECT\n  USING (auth.role() = 'authenticated')","CREATE POLICY \\"Users can insert customer notes\\" ON customer_notes\n  FOR INSERT\n  WITH CHECK (auth.role() = 'authenticated')","CREATE POLICY \\"Users can update customer notes\\" ON customer_notes\n  FOR UPDATE\n  USING (auth.role() = 'authenticated')","CREATE POLICY \\"Users can delete customer notes\\" ON customer_notes\n  FOR DELETE\n  USING (auth.role() = 'authenticated')","-- Function to automatically update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_customer_notes_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Trigger to automatically update updated_at\nCREATE TRIGGER customer_notes_updated_at\n  BEFORE UPDATE ON customer_notes\n  FOR EACH ROW\n  EXECUTE FUNCTION update_customer_notes_updated_at()"}	add_customer_notes
20240102000019	{"-- Migration: Add icon_name column to saved_views table\n-- This allows users to customize the icon for each saved view\n\n-- Add icon_name column (nullable, defaults to NULL for existing rows)\nALTER TABLE saved_views \nADD COLUMN IF NOT EXISTS icon_name TEXT","-- Add comment to explain the column\nCOMMENT ON COLUMN saved_views.icon_name IS 'Name of the Lucide icon component to use for this view (e.g., \\"Users\\", \\"Dumbbell\\", \\"Flame\\"). If NULL, uses default icon for the resource_key.'"}	add_icon_name_to_saved_views
20240102000020	{"-- Migration: Add user_interface_preferences table for storing custom interface icons\n-- This allows users to customize icons for main interface items (e.g., \\"ניהול לידים\\", \\"ניהול לקוחות\\")\n\nCREATE TABLE IF NOT EXISTS user_interface_preferences (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    interface_key TEXT NOT NULL, -- e.g., 'leads', 'customers', 'templates', etc.\n    icon_name TEXT NOT NULL, -- e.g., 'Users', 'Dumbbell', 'LayoutDashboard', etc.\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    \n    -- Ensure one preference per interface per user\n    CONSTRAINT unique_user_interface_preference \n        UNIQUE (user_id, interface_key)\n)","-- Index for faster queries\nCREATE INDEX IF NOT EXISTS idx_user_interface_preferences_user_id \n    ON user_interface_preferences(user_id)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_user_interface_preferences_updated_at\n    BEFORE UPDATE ON user_interface_preferences\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- Enable RLS\nALTER TABLE user_interface_preferences ENABLE ROW LEVEL SECURITY","-- Policy: Users can view their own preferences\nCREATE POLICY \\"Users can view their own interface preferences\\"\n    ON user_interface_preferences\n    FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own preferences\nCREATE POLICY \\"Users can insert their own interface preferences\\"\n    ON user_interface_preferences\n    FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own preferences\nCREATE POLICY \\"Users can update their own interface preferences\\"\n    ON user_interface_preferences\n    FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own preferences\nCREATE POLICY \\"Users can delete their own interface preferences\\"\n    ON user_interface_preferences\n    FOR DELETE\n    USING (auth.uid() = user_id)","-- Comments\nCOMMENT ON TABLE user_interface_preferences IS 'User preferences for customizing interface icons'","COMMENT ON COLUMN user_interface_preferences.interface_key IS 'The interface identifier (e.g., \\"leads\\", \\"customers\\", \\"templates\\")'","COMMENT ON COLUMN user_interface_preferences.icon_name IS 'The Lucide icon name (e.g., \\"Users\\", \\"Dumbbell\\", \\"LayoutDashboard\\")'"}	add_user_interface_preferences
20240102000021	{"-- Migration: Allow authenticated users to update leads\n-- This ensures that any authenticated user can update leads they can read\n-- Required for the inline editing functionality to work properly\n\n-- Note: We keep the existing admin policy which uses is_admin() function\n-- This new policy allows any authenticated user to update leads\n\n-- Create new policy that allows authenticated users to update leads\n-- Since we already have a SELECT policy allowing authenticated users to read leads,\n-- we should allow them to update leads as well for the CRM functionality\n-- The admin policy (created in 20240102000001) will still apply for admins\nCREATE POLICY \\"Authenticated users can update leads\\"\n    ON public.leads FOR UPDATE\n    USING (auth.role() = 'authenticated')\n    WITH CHECK (auth.role() = 'authenticated')","COMMENT ON POLICY \\"Authenticated users can update leads\\" ON public.leads IS \n    'Allows all authenticated users to update leads for CRM functionality'"}	allow_authenticated_users_update_leads
20240102000022	{"-- Migration: Add lead_id column to customer_notes table\n-- Created: 2024-01-02\n-- Description: Allow notes to be associated with specific leads/inquiries\n\nALTER TABLE customer_notes \nADD COLUMN IF NOT EXISTS lead_id UUID REFERENCES leads(id) ON DELETE SET NULL","-- Create index for performance\nCREATE INDEX IF NOT EXISTS idx_customer_notes_lead_id ON customer_notes(lead_id)","-- Add comment\nCOMMENT ON COLUMN customer_notes.lead_id IS 'Optional reference to a specific lead/inquiry. NULL means the note applies to all inquiries for the customer.'"}	add_lead_id_to_customer_notes
20240102000023	{"-- Migration: Add Client Portal Support\n-- Created: 2024-01-02\n-- Description: Enable client/trainee role, link customers to auth users, and create daily check-ins\n\n-- =====================================================\n-- 1. UPDATE profiles.role to include 'trainee'\n-- =====================================================\n\n-- Drop the existing CHECK constraint\nALTER TABLE profiles DROP CONSTRAINT IF EXISTS profiles_role_check","-- Add new CHECK constraint with 'trainee' role\nALTER TABLE profiles \nADD CONSTRAINT profiles_role_check \nCHECK (role IN ('admin', 'user', 'trainee'))","-- Update comment\nCOMMENT ON COLUMN profiles.role IS 'User role: admin (coach/admin), user (coach), trainee (client/trainee)'","-- =====================================================\n-- 2. ADD user_id to customers table\n-- =====================================================\n\n-- Add user_id column to customers (nullable, as existing customers may not have user accounts yet)\nALTER TABLE customers \nADD COLUMN IF NOT EXISTS user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL","-- Create index for faster lookups\nCREATE INDEX IF NOT EXISTS idx_customers_user_id ON customers(user_id)","-- Add unique constraint to ensure one user can only be linked to one customer\nCREATE UNIQUE INDEX IF NOT EXISTS idx_customers_user_id_unique ON customers(user_id) \nWHERE user_id IS NOT NULL","-- Add comment\nCOMMENT ON COLUMN customers.user_id IS 'Link to auth.users - allows clients to log in and access their portal'","-- =====================================================\n-- 3. CREATE daily_check_ins table\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS daily_check_ins (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,\n  lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n  check_in_date DATE NOT NULL DEFAULT CURRENT_DATE,\n  \n  -- Check-in statuses\n  workout_completed BOOLEAN DEFAULT false,\n  steps_goal_met BOOLEAN DEFAULT false,\n  steps_actual INTEGER, -- Actual steps taken (optional)\n  nutrition_goal_met BOOLEAN DEFAULT false,\n  supplements_taken JSONB DEFAULT '[]'::jsonb, -- Array of supplement names taken\n  \n  -- Additional notes\n  notes TEXT,\n  \n  -- Metadata\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n  \n  -- Ensure one check-in per customer per day\n  UNIQUE(customer_id, check_in_date)\n)","-- Create indexes for performance\nCREATE INDEX IF NOT EXISTS idx_daily_check_ins_customer_id ON daily_check_ins(customer_id)","CREATE INDEX IF NOT EXISTS idx_daily_check_ins_lead_id ON daily_check_ins(lead_id)","CREATE INDEX IF NOT EXISTS idx_daily_check_ins_date ON daily_check_ins(check_in_date DESC)","CREATE INDEX IF NOT EXISTS idx_daily_check_ins_customer_date ON daily_check_ins(customer_id, check_in_date DESC)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_daily_check_ins_updated_at\n  BEFORE UPDATE ON daily_check_ins\n  FOR EACH ROW\n  EXECUTE FUNCTION update_updated_at_column()","-- Add comments\nCOMMENT ON TABLE daily_check_ins IS 'Daily check-in records for client compliance tracking'","COMMENT ON COLUMN daily_check_ins.workout_completed IS 'Whether the client completed their workout for the day'","COMMENT ON COLUMN daily_check_ins.steps_goal_met IS 'Whether the client met their daily steps goal'","COMMENT ON COLUMN daily_check_ins.steps_actual IS 'Actual number of steps taken (optional, for detailed tracking)'","COMMENT ON COLUMN daily_check_ins.nutrition_goal_met IS 'Whether the client met their nutrition/macro goals'","COMMENT ON COLUMN daily_check_ins.supplements_taken IS 'JSONB array of supplement names that were taken'","-- =====================================================\n-- 4. ENABLE RLS ON daily_check_ins\n-- =====================================================\n\nALTER TABLE daily_check_ins ENABLE ROW LEVEL SECURITY","-- Policy: Trainees can view their own check-ins\nCREATE POLICY \\"Trainees can view own check-ins\\"\n  ON daily_check_ins FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = daily_check_ins.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- Policy: Trainees can insert their own check-ins\nCREATE POLICY \\"Trainees can insert own check-ins\\"\n  ON daily_check_ins FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = daily_check_ins.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- Policy: Trainees can update their own check-ins\nCREATE POLICY \\"Trainees can update own check-ins\\"\n  ON daily_check_ins FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = daily_check_ins.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = daily_check_ins.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- Policy: Coaches/admins can view all check-ins\nCREATE POLICY \\"Coaches can view all check-ins\\"\n  ON daily_check_ins FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE id = auth.uid() \n      AND role IN ('admin', 'user')\n    )\n  )","-- Policy: Coaches/admins can insert check-ins for any customer\nCREATE POLICY \\"Coaches can insert check-ins\\"\n  ON daily_check_ins FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE id = auth.uid() \n      AND role IN ('admin', 'user')\n    )\n  )","-- Policy: Coaches/admins can update check-ins for any customer\nCREATE POLICY \\"Coaches can update check-ins\\"\n  ON daily_check_ins FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE id = auth.uid() \n      AND role IN ('admin', 'user')\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE id = auth.uid() \n      AND role IN ('admin', 'user')\n    )\n  )","-- =====================================================\n-- 5. UPDATE RLS POLICIES FOR customers\n-- =====================================================\n\n-- Policy: Trainees can view their own customer record\nCREATE POLICY \\"Trainees can view own customer\\"\n  ON customers FOR SELECT\n  USING (user_id = auth.uid())","-- Policy: Trainees can update their own customer record (for profile editing)\nCREATE POLICY \\"Trainees can update own customer\\"\n  ON customers FOR UPDATE\n  USING (user_id = auth.uid())\n  WITH CHECK (user_id = auth.uid())","-- =====================================================\n-- 6. UPDATE RLS POLICIES FOR leads (for trainee access)\n-- =====================================================\n\n-- Policy: Trainees can view leads associated with their customer_id\nCREATE POLICY \\"Trainees can view own leads\\"\n  ON leads FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = leads.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- Policy: Trainees can update their own leads (for weight, height, etc.)\nCREATE POLICY \\"Trainees can update own leads\\"\n  ON leads FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = leads.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = leads.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_client_portal_support
20240102000024	{"-- Migration: Fix Trainee User Role\n-- Created: 2024-01-02\n-- Description: \n--   1. Update existing trainee user's role from 'user' to 'trainee' in the profiles table\n--   2. Create profile with correct role if user exists in auth.users but not in profiles\n--   3. Update handle_new_user function to automatically set role='trainee' for trainee@test.com\n\n-- =====================================================\n-- 1. UPDATE handle_new_user to auto-set trainee role\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.handle_new_user()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- Auto-set role to 'trainee' for trainee@test.com\n    INSERT INTO public.profiles (id, email, full_name, role)\n    VALUES (\n        NEW.id,\n        NEW.email,\n        COALESCE(NEW.raw_user_meta_data->>'full_name', ''),\n        CASE \n            WHEN NEW.email = 'trainee@test.com' THEN 'trainee'\n            ELSE COALESCE(NEW.raw_user_meta_data->>'role', 'user')\n        END\n    );\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- =====================================================\n-- 2. UPDATE/CREATE trainee@test.com role to 'trainee'\n-- =====================================================\n\nDO $$\nDECLARE\n  v_user_id UUID;\n  v_role TEXT;\n  v_updated_count INTEGER;\nBEGIN\n  -- Find the user in auth.users\n  SELECT id INTO v_user_id\n  FROM auth.users\n  WHERE email = 'trainee@test.com';\n  \n  IF v_user_id IS NULL THEN\n    RAISE NOTICE '⚠️ User trainee@test.com not found in auth.users - will be set to trainee when user is created';\n    RETURN;\n  END IF;\n  \n  -- Check if profile exists\n  SELECT role INTO v_role\n  FROM profiles\n  WHERE id = v_user_id;\n  \n  IF v_role IS NULL THEN\n    -- Profile doesn't exist, create it with 'trainee' role\n    INSERT INTO profiles (id, email, role, full_name)\n    VALUES (v_user_id, 'trainee@test.com', 'trainee', 'Test Trainee')\n    ON CONFLICT (id) DO UPDATE\n      SET role = 'trainee',\n          email = EXCLUDED.email;\n    \n    RAISE NOTICE '✅ Created profile for trainee@test.com with role: trainee';\n  ELSIF v_role != 'trainee' THEN\n    -- Profile exists but has wrong role, update it\n    UPDATE profiles \n    SET role = 'trainee' \n    WHERE id = v_user_id;\n    \n    GET DIAGNOSTICS v_updated_count = ROW_COUNT;\n    \n    IF v_updated_count > 0 THEN\n      RAISE NOTICE '✅ Updated trainee@test.com role from % to: trainee', v_role;\n    END IF;\n  ELSE\n    -- Profile already has correct role\n    RAISE NOTICE '✅ User trainee@test.com already has role: trainee';\n  END IF;\nEND $$"}	fix_trainee_user_role
20240102000025	{"-- Migration: Create Test Users (Manager & Client)\n-- Created: 2024-01-02\n-- Description: Creates two test users:\n--   1. Manager user (coach/admin) - sees full dashboard\n--   2. Client user (trainee) - sees only their client portal\n-- IMPORTANT: This must be the LAST migration to run\n\n-- =====================================================\n-- CREATE TEST USERS\n-- =====================================================\n\nDO $$\nDECLARE\n  v_manager_user_id UUID;\n  v_client_user_id UUID;\n  v_client_customer_id UUID;\n  v_client_lead_id UUID;\nBEGIN\n  -- =====================================================\n  -- 1. CREATE MANAGER USER (coach/admin)\n  -- =====================================================\n  \n  -- Check if manager user already exists\n  SELECT id INTO v_manager_user_id\n  FROM auth.users\n  WHERE email = 'manager@dietneta.com';\n  \n  -- Create auth user for manager (only if doesn't exist)\n  IF v_manager_user_id IS NULL THEN\n    INSERT INTO auth.users (\n      instance_id,\n      id,\n      aud,\n      role,\n      email,\n      encrypted_password,\n      email_confirmed_at,\n      recovery_sent_at,\n      last_sign_in_at,\n      raw_app_meta_data,\n      raw_user_meta_data,\n      created_at,\n      updated_at,\n      confirmation_token,\n      email_change,\n      email_change_token_new,\n      recovery_token\n    ) VALUES (\n      '00000000-0000-0000-0000-000000000000',\n      gen_random_uuid(),\n      'authenticated',\n      'authenticated',\n      'manager@dietneta.com',\n      crypt('Manager123!', gen_salt('bf')),\n      NOW(),\n      NOW(),\n      NOW(),\n      '{\\"provider\\": \\"email\\", \\"providers\\": [\\"email\\"]}',\n      '{\\"full_name\\": \\"מנהל מערכת\\", \\"role\\": \\"admin\\"}',\n      NOW(),\n      NOW(),\n      '',\n      '',\n      '',\n      ''\n    )\n    RETURNING id INTO v_manager_user_id;\n  END IF;\n  \n  -- Create profile for manager (if user exists)\n  IF v_manager_user_id IS NOT NULL THEN\n    INSERT INTO public.profiles (id, email, full_name, role)\n    VALUES (v_manager_user_id, 'manager@dietneta.com', 'מנהל מערכת', 'admin')\n    ON CONFLICT (id) DO UPDATE\n      SET role = 'admin',\n          email = 'manager@dietneta.com',\n          full_name = 'מנהל מערכת';\n    \n    RAISE NOTICE '✅ Manager user created/updated: manager@dietneta.com (ID: %)', v_manager_user_id;\n  ELSE\n    -- User already exists, get the ID\n    SELECT id INTO v_manager_user_id\n    FROM auth.users\n    WHERE email = 'manager@dietneta.com';\n    \n    -- Update profile to ensure correct role\n    UPDATE public.profiles\n    SET role = 'admin',\n        email = 'manager@dietneta.com',\n        full_name = 'מנהל מערכת'\n    WHERE id = v_manager_user_id;\n    \n    RAISE NOTICE '✅ Manager user already exists, profile updated: manager@dietneta.com (ID: %)', v_manager_user_id;\n  END IF;\n  \n  -- =====================================================\n  -- 2. CREATE CLIENT USER (trainee)\n  -- =====================================================\n  \n  -- Check if client user already exists\n  SELECT id INTO v_client_user_id\n  FROM auth.users\n  WHERE email = 'client@dietneta.com';\n  \n  -- Create auth user for client (only if doesn't exist)\n  IF v_client_user_id IS NULL THEN\n    INSERT INTO auth.users (\n      instance_id,\n      id,\n      aud,\n      role,\n      email,\n      encrypted_password,\n      email_confirmed_at,\n      recovery_sent_at,\n      last_sign_in_at,\n      raw_app_meta_data,\n      raw_user_meta_data,\n      created_at,\n      updated_at,\n      confirmation_token,\n      email_change,\n      email_change_token_new,\n      recovery_token\n    ) VALUES (\n      '00000000-0000-0000-0000-000000000000',\n      gen_random_uuid(),\n      'authenticated',\n      'authenticated',\n      'client@dietneta.com',\n      crypt('Client123!', gen_salt('bf')),\n      NOW(),\n      NOW(),\n      NOW(),\n      '{\\"provider\\": \\"email\\", \\"providers\\": [\\"email\\"]}',\n      '{\\"full_name\\": \\"לקוח בדיקה\\", \\"role\\": \\"trainee\\"}',\n      NOW(),\n      NOW(),\n      '',\n      '',\n      '',\n      ''\n    )\n    RETURNING id INTO v_client_user_id;\n  END IF;\n  \n  -- Create profile for client (if user exists)\n  IF v_client_user_id IS NOT NULL THEN\n    INSERT INTO public.profiles (id, email, full_name, role)\n    VALUES (v_client_user_id, 'client@dietneta.com', 'לקוח בדיקה', 'trainee')\n    ON CONFLICT (id) DO UPDATE\n      SET role = 'trainee',\n          email = 'client@dietneta.com',\n          full_name = 'לקוח בדיקה';\n    \n    RAISE NOTICE '✅ Client user created/updated: client@dietneta.com (ID: %)', v_client_user_id;\n  ELSE\n    -- User already exists, get the ID\n    SELECT id INTO v_client_user_id\n    FROM auth.users\n    WHERE email = 'client@dietneta.com';\n    \n    -- Update profile to ensure correct role\n    UPDATE public.profiles\n    SET role = 'trainee',\n        email = 'client@dietneta.com',\n        full_name = 'לקוח בדיקה'\n    WHERE id = v_client_user_id;\n    \n    RAISE NOTICE '✅ Client user already exists, profile updated: client@dietneta.com (ID: %)', v_client_user_id;\n  END IF;\n  \n  -- =====================================================\n  -- 3. CREATE CUSTOMER RECORD FOR CLIENT\n  -- =====================================================\n  \n  IF v_client_user_id IS NOT NULL THEN\n    -- Create customer record linked to client user\n    -- Use upsert approach since we can't rely on ON CONFLICT with partial unique index\n    INSERT INTO customers (full_name, phone, email, user_id)\n    VALUES (\n      'לקוח בדיקה',\n      '0501234567',\n      'client@dietneta.com',\n      v_client_user_id\n    )\n    ON CONFLICT (phone) DO UPDATE\n      SET user_id = EXCLUDED.user_id,\n          full_name = EXCLUDED.full_name,\n          email = EXCLUDED.email\n    RETURNING id INTO v_client_customer_id;\n    \n    -- If customer already existed with different user_id, update it\n    IF v_client_customer_id IS NULL THEN\n      UPDATE customers\n      SET user_id = v_client_user_id,\n          full_name = 'לקוח בדיקה',\n          email = 'client@dietneta.com'\n      WHERE phone = '0501234567'\n      RETURNING id INTO v_client_customer_id;\n    END IF;\n    \n    RAISE NOTICE '✅ Customer record created/updated for client (ID: %)', v_client_customer_id;\n    \n    -- =====================================================\n    -- 4. CREATE LEAD RECORD FOR CLIENT\n    -- =====================================================\n    \n    -- Create a lead record for the client (only if doesn't exist)\n    -- Note: After normalization, leads table no longer has full_name, phone, email columns\n    -- Those are in the customers table, linked via customer_id\n    INSERT INTO leads (\n      customer_id,\n      status_main,\n      fitness_goal,\n      height,\n      weight,\n      activity_level\n    )\n    SELECT \n      v_client_customer_id,\n      'בטיפול',\n      'ירידה במשקל',\n      175.0,\n      75.0,\n      'בינוני'\n    WHERE NOT EXISTS (\n      SELECT 1 FROM leads \n      WHERE customer_id = v_client_customer_id \n    )\n    RETURNING id INTO v_client_lead_id;\n    \n    RAISE NOTICE '✅ Lead record created/updated for client (ID: %)', v_client_lead_id;\n  END IF;\n  \n  RAISE NOTICE '';\n  RAISE NOTICE '========================================';\n  RAISE NOTICE '✅ TEST USERS CREATED SUCCESSFULLY';\n  RAISE NOTICE '========================================';\n  RAISE NOTICE '';\n  RAISE NOTICE '📧 MANAGER USER:';\n  RAISE NOTICE '   Email: manager@dietneta.com';\n  RAISE NOTICE '   Password: Manager123!';\n  RAISE NOTICE '   Role: admin (sees full dashboard)';\n  RAISE NOTICE '';\n  RAISE NOTICE '📧 CLIENT USER:';\n  RAISE NOTICE '   Email: client@dietneta.com';\n  RAISE NOTICE '   Password: Client123!';\n  RAISE NOTICE '   Role: trainee (sees only client portal)';\n  RAISE NOTICE '';\n  RAISE NOTICE '========================================';\n  \nEXCEPTION\n  WHEN OTHERS THEN\n    RAISE WARNING 'Error creating test users: %', SQLERRM;\n    -- Don't fail the migration if users already exist\nEND $$"}	create_test_users
20240102000026	{"-- Migration: Add Trainee Access to Workout and Nutrition Plans\n-- Created: 2024-01-02\n-- Description: Allow trainees to access their workout and nutrition plans via customer_id\n\n-- =====================================================\n-- 1. UPDATE RLS POLICIES FOR workout_plans (for trainee access)\n-- =====================================================\n\n-- Policy: Trainees can view workout plans associated with their customer_id\nCREATE POLICY \\"Trainees can view own workout plans\\"\n  ON workout_plans FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = workout_plans.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- =====================================================\n-- 2. UPDATE RLS POLICIES FOR nutrition_plans (for trainee access)\n-- =====================================================\n\n-- Policy: Trainees can view nutrition plans associated with their customer_id\nCREATE POLICY \\"Trainees can view own nutrition plans\\"\n  ON nutrition_plans FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM customers\n      WHERE customers.id = nutrition_plans.customer_id\n      AND customers.user_id = auth.uid()\n    )\n  )","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_trainee_access_to_plans
20240102000027	{"-- Migration: Secure User Invitations System\n-- Created: 2024-01-02\n-- Description: Implements secure invitation system for trainee user creation without passwords\n\n-- =====================================================\n-- 1. CREATE user_invitations TABLE\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS public.user_invitations (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    \n    -- User identification\n    email TEXT NOT NULL,\n    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,\n    customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    \n    -- Secure token (hashed at rest)\n    token_hash TEXT NOT NULL UNIQUE, -- SHA-256 hash of the invitation token\n    token_salt TEXT NOT NULL, -- Random salt for token hashing\n    \n    -- Invitation metadata\n    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'sent', 'accepted', 'expired', 'revoked')),\n    invited_by UUID REFERENCES auth.users(id) ON DELETE SET NULL, -- Admin/manager who created the invitation\n    invited_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    expires_at TIMESTAMP WITH TIME ZONE NOT NULL, -- Configurable expiration (default 7 days)\n    accepted_at TIMESTAMP WITH TIME ZONE,\n    \n    -- Audit fields\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    \n    -- Constraints\n    CONSTRAINT user_invitations_email_user_id_check CHECK (\n        (email IS NOT NULL) OR (user_id IS NOT NULL)\n    )\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_user_invitations_email ON public.user_invitations(email)","CREATE INDEX IF NOT EXISTS idx_user_invitations_user_id ON public.user_invitations(user_id)","CREATE INDEX IF NOT EXISTS idx_user_invitations_customer_id ON public.user_invitations(customer_id)","CREATE INDEX IF NOT EXISTS idx_user_invitations_token_hash ON public.user_invitations(token_hash)","CREATE INDEX IF NOT EXISTS idx_user_invitations_status ON public.user_invitations(status)","CREATE INDEX IF NOT EXISTS idx_user_invitations_expires_at ON public.user_invitations(expires_at)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_user_invitations_updated_at\n    BEFORE UPDATE ON public.user_invitations\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- 2. CREATE invitation_audit_log TABLE (for security audit)\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS public.invitation_audit_log (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    invitation_id UUID REFERENCES user_invitations(id) ON DELETE CASCADE,\n    action TEXT NOT NULL CHECK (action IN ('created', 'sent', 'resent', 'accepted', 'expired', 'revoked', 'viewed')),\n    performed_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n    ip_address INET,\n    user_agent TEXT,\n    metadata JSONB DEFAULT '{}'::jsonb,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL\n)","CREATE INDEX IF NOT EXISTS idx_invitation_audit_log_invitation_id ON public.invitation_audit_log(invitation_id)","CREATE INDEX IF NOT EXISTS idx_invitation_audit_log_performed_by ON public.invitation_audit_log(performed_by)","CREATE INDEX IF NOT EXISTS idx_invitation_audit_log_created_at ON public.invitation_audit_log(created_at DESC)","-- =====================================================\n-- 3. ENABLE RLS\n-- =====================================================\n\nALTER TABLE public.user_invitations ENABLE ROW LEVEL SECURITY","ALTER TABLE public.invitation_audit_log ENABLE ROW LEVEL SECURITY","-- =====================================================\n-- 4. RLS POLICIES FOR user_invitations\n-- =====================================================\n\n-- Policy: Admins/managers can view all invitations\nCREATE POLICY \\"Admins can view all invitations\\"\n    ON public.user_invitations FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Admins/managers can create invitations\nCREATE POLICY \\"Admins can create invitations\\"\n    ON public.user_invitations FOR INSERT\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Admins/managers can update invitations (for resend, revoke)\nCREATE POLICY \\"Admins can update invitations\\"\n    ON public.user_invitations FOR UPDATE\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Users can view their own invitation (by email match)\n-- Use profiles table instead of auth.users to avoid permission issues\nCREATE POLICY \\"Users can view own invitation\\"\n    ON public.user_invitations FOR SELECT\n    USING (\n        email = (SELECT email FROM profiles WHERE id = auth.uid())\n        OR user_id = auth.uid()\n    )","-- =====================================================\n-- 5. RLS POLICIES FOR invitation_audit_log\n-- =====================================================\n\n-- Policy: Admins can view all audit logs\nCREATE POLICY \\"Admins can view audit logs\\"\n    ON public.invitation_audit_log FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: System can insert audit logs (via service role or admin)\nCREATE POLICY \\"System can insert audit logs\\"\n    ON public.invitation_audit_log FOR INSERT\n    WITH CHECK (true)","-- Will be restricted by RLS on user_invitations\n\n-- =====================================================\n-- 6. HELPER FUNCTION: Generate secure invitation token\n-- =====================================================\n\n-- This function generates a cryptographically secure token\n-- The actual token is generated client-side and hashed before storage\nCREATE OR REPLACE FUNCTION public.generate_invitation_token()\nRETURNS TEXT AS $$\nDECLARE\n    token TEXT;\nBEGIN\n    -- Generate a secure random token (32 bytes = 64 hex characters)\n    -- This is just a placeholder - actual token generation happens in application code\n    -- using crypto.randomBytes or similar\n    token := encode(gen_random_bytes(32), 'hex');\n    RETURN token;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- =====================================================\n-- 7. HELPER FUNCTION: Hash token for storage\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.hash_invitation_token(token TEXT, salt TEXT)\nRETURNS TEXT AS $$\nBEGIN\n    -- Use SHA-256 for token hashing\n    -- In production, consider using bcrypt or argon2\n    RETURN encode(digest(salt || token, 'sha256'), 'hex');\nEND;\n$$ LANGUAGE plpgsql IMMUTABLE","-- =====================================================\n-- 8. HELPER FUNCTION: Verify invitation token\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.verify_invitation_token(\n    p_token_hash TEXT,\n    p_token TEXT,\n    p_salt TEXT\n)\nRETURNS BOOLEAN AS $$\nBEGIN\n    -- Verify token by hashing and comparing\n    RETURN p_token_hash = public.hash_invitation_token(p_token, p_salt);\nEND;\n$$ LANGUAGE plpgsql IMMUTABLE","-- =====================================================\n-- 9. HELPER FUNCTION: Check if invitation is valid\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION public.is_invitation_valid(p_invitation_id UUID)\nRETURNS BOOLEAN AS $$\nDECLARE\n    v_status TEXT;\n    v_expires_at TIMESTAMP WITH TIME ZONE;\nBEGIN\n    SELECT status, expires_at INTO v_status, v_expires_at\n    FROM public.user_invitations\n    WHERE id = p_invitation_id;\n    \n    IF NOT FOUND THEN\n        RETURN FALSE;\n    END IF;\n    \n    -- Check if expired or revoked\n    IF v_status IN ('expired', 'revoked', 'accepted') THEN\n        RETURN FALSE;\n    END IF;\n    \n    -- Check expiration\n    IF v_expires_at < NOW() THEN\n        -- Auto-update status to expired\n        UPDATE public.user_invitations\n        SET status = 'expired', updated_at = NOW()\n        WHERE id = p_invitation_id;\n        RETURN FALSE;\n    END IF;\n    \n    RETURN TRUE;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- =====================================================\n-- 10. COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE public.user_invitations IS 'Secure invitation system for trainee user creation without passwords'","COMMENT ON COLUMN public.user_invitations.token_hash IS 'SHA-256 hash of the invitation token (never store plaintext)'","COMMENT ON COLUMN public.user_invitations.token_salt IS 'Random salt used for token hashing'","COMMENT ON COLUMN public.user_invitations.status IS 'Invitation status: pending, sent, accepted, expired, revoked'","COMMENT ON COLUMN public.user_invitations.expires_at IS 'Token expiration timestamp (default 7 days from creation)'","COMMENT ON TABLE public.invitation_audit_log IS 'Audit log for all invitation-related actions for security compliance'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	secure_user_invitations
20240102000028	{"-- Migration: Fix RLS Policies for user_invitations\n-- Created: 2024-01-02\n-- Description: Fixes RLS policies that were trying to access auth.users directly\n\n-- Drop all existing policies to recreate them properly\nDROP POLICY IF EXISTS \\"Users can view own invitation\\" ON public.user_invitations","DROP POLICY IF EXISTS \\"Admins can view all invitations\\" ON public.user_invitations","DROP POLICY IF EXISTS \\"Admins can create invitations\\" ON public.user_invitations","DROP POLICY IF EXISTS \\"Admins can update invitations\\" ON public.user_invitations","-- Create a helper function to check if user is admin/manager\n-- This avoids repeated subqueries in policies\nCREATE OR REPLACE FUNCTION public.is_admin_or_manager()\nRETURNS BOOLEAN AS $$\nBEGIN\n    RETURN EXISTS (\n        SELECT 1 FROM profiles\n        WHERE id = auth.uid() \n        AND role IN ('admin', 'user')\n    );\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER STABLE","-- Policy: Admins/managers can view all invitations\nCREATE POLICY \\"Admins can view all invitations\\"\n    ON public.user_invitations FOR SELECT\n    USING (public.is_admin_or_manager())","-- Policy: Users can view their own invitation (by user_id or email from profile)\nCREATE POLICY \\"Users can view own invitation\\"\n    ON public.user_invitations FOR SELECT\n    USING (\n        user_id = auth.uid()\n        OR (\n            email = (SELECT email FROM profiles WHERE id = auth.uid())\n        )\n    )","-- Policy: Admins/managers can create invitations\nCREATE POLICY \\"Admins can create invitations\\"\n    ON public.user_invitations FOR INSERT\n    WITH CHECK (public.is_admin_or_manager())","-- Policy: Admins/managers can update invitations (for resend, revoke)\nCREATE POLICY \\"Admins can update invitations\\"\n    ON public.user_invitations FOR UPDATE\n    USING (public.is_admin_or_manager())\n    WITH CHECK (public.is_admin_or_manager())"}	fix_invitation_rls
20240102000029	{"-- Migration: Fix Manager User Password\n-- Created: 2024-01-02\n-- Description: Properly creates/resets manager user password using Supabase Auth\n\n-- This migration uses a function to properly set the password\n-- Note: Direct password updates in auth.users don't work with Supabase Auth\n-- This migration will be handled by a script instead\n\n-- For now, we'll just ensure the profile is correct\n-- The password should be reset using the admin API or script\n\nDO $$\nDECLARE\n  v_manager_user_id UUID;\nBEGIN\n  -- Find manager user\n  SELECT id INTO v_manager_user_id\n  FROM auth.users\n  WHERE email = 'manager@dietneta.com'\n  LIMIT 1;\n  \n  -- Ensure profile exists and is correct\n  IF v_manager_user_id IS NOT NULL THEN\n    INSERT INTO public.profiles (id, email, full_name, role)\n    VALUES (v_manager_user_id, 'manager@dietneta.com', 'מנהל מערכת', 'admin')\n    ON CONFLICT (id) DO UPDATE\n      SET role = 'admin',\n          email = 'manager@dietneta.com',\n          full_name = 'מנהל מערכת';\n    \n    RAISE NOTICE '✅ Manager profile updated: manager@dietneta.com (ID: %)', v_manager_user_id;\n    RAISE NOTICE '⚠️  Password reset required. Run: node scripts/reset_manager_password.js';\n  ELSE\n    RAISE NOTICE '⚠️  Manager user not found. Please create using Supabase Auth signUp or admin API.';\n  END IF;\nEND $$"}	fix_manager_user_password
20240102000030	{"-- Migration: Add WhatsApp Flow Templates Table\n-- Description: Stores message templates for WhatsApp automation flows\n-- Created: 2024-01-02\n\n-- Create whatsapp_flow_templates table\nCREATE TABLE IF NOT EXISTS public.whatsapp_flow_templates (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n  flow_key TEXT NOT NULL, -- e.g., 'customer_journey_start', 'intro_questionnaire'\n  template_content TEXT NOT NULL DEFAULT '', -- The message template with placeholders\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  \n  -- Ensure one template per flow per user\n  UNIQUE(user_id, flow_key)\n)","-- Add RLS policies\nALTER TABLE public.whatsapp_flow_templates ENABLE ROW LEVEL SECURITY","-- Policy: Users can view their own templates\nCREATE POLICY \\"Users can view own templates\\"\n  ON public.whatsapp_flow_templates\n  FOR SELECT\n  USING (auth.uid() = user_id)","-- Policy: Users can insert their own templates\nCREATE POLICY \\"Users can insert own templates\\"\n  ON public.whatsapp_flow_templates\n  FOR INSERT\n  WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own templates\nCREATE POLICY \\"Users can update own templates\\"\n  ON public.whatsapp_flow_templates\n  FOR UPDATE\n  USING (auth.uid() = user_id)\n  WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own templates\nCREATE POLICY \\"Users can delete own templates\\"\n  ON public.whatsapp_flow_templates\n  FOR DELETE\n  USING (auth.uid() = user_id)","-- Create index for faster lookups\nCREATE INDEX IF NOT EXISTS idx_whatsapp_flow_templates_user_flow \n  ON public.whatsapp_flow_templates(user_id, flow_key)","-- Create function to update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_whatsapp_flow_templates_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Create trigger to automatically update updated_at\nCREATE TRIGGER update_whatsapp_flow_templates_updated_at\n  BEFORE UPDATE ON public.whatsapp_flow_templates\n  FOR EACH ROW\n  EXECUTE FUNCTION update_whatsapp_flow_templates_updated_at()","-- Add comments\nCOMMENT ON TABLE public.whatsapp_flow_templates IS 'Stores WhatsApp message templates for automation flows'","COMMENT ON COLUMN public.whatsapp_flow_templates.flow_key IS 'Unique identifier for the flow (e.g., customer_journey_start, intro_questionnaire)'","COMMENT ON COLUMN public.whatsapp_flow_templates.template_content IS 'Message template with placeholders like {{name}}, {{phone}}, etc.'"}	add_whatsapp_flow_templates
20240102000031	{"-- Migration: Add buttons support to WhatsApp Flow Templates\n-- Description: Adds JSONB column to store interactive buttons for WhatsApp messages\n-- Created: 2024-01-02\n-- Migration number: 20240102000031 (must be last in sequence)\n\n-- Add buttons column to store interactive buttons array\nALTER TABLE public.whatsapp_flow_templates\nADD COLUMN IF NOT EXISTS buttons JSONB DEFAULT '[]'::jsonb","-- Add comment\nCOMMENT ON COLUMN public.whatsapp_flow_templates.buttons IS 'Array of interactive buttons: [{\\"id\\": \\"1\\", \\"text\\": \\"Button Text\\"}]'","-- Ensure any existing data complies with max 3 buttons rule before adding constraint\n-- This is safe because the column was just added, so there should be no existing data\n-- But we do this defensively in case the migration is run multiple times\nUPDATE public.whatsapp_flow_templates\nSET buttons = '[]'::jsonb\nWHERE buttons IS NULL \n   OR (jsonb_typeof(buttons) = 'array' AND jsonb_array_length(COALESCE(buttons, '[]'::jsonb)) > 3)","-- Add constraint to ensure buttons array has max 3 items (idempotent)\n-- Use DO block to safely handle constraint creation/dropping\nDO $$\nBEGIN\n    -- Drop constraint if it exists (in case of re-running migration)\n    IF EXISTS (\n        SELECT 1 FROM pg_constraint \n        WHERE conname = 'check_buttons_max_count' \n        AND conrelid = 'public.whatsapp_flow_templates'::regclass\n    ) THEN\n        ALTER TABLE public.whatsapp_flow_templates DROP CONSTRAINT check_buttons_max_count;\n    END IF;\n    \n    -- Add the constraint\n    ALTER TABLE public.whatsapp_flow_templates\n    ADD CONSTRAINT check_buttons_max_count \n    CHECK (jsonb_array_length(COALESCE(buttons, '[]'::jsonb)) <= 3);\nEXCEPTION\n    WHEN others THEN\n        -- If constraint creation fails, log but don't fail the migration\n        RAISE NOTICE 'Could not add check_buttons_max_count constraint: %', SQLERRM;\nEND $$"}	add_buttons_to_whatsapp_templates
20251228093611	{"-- Migration: Add Green API Settings Table\n-- Description: Stores Green API credentials in PostgreSQL instead of using Edge Functions\n-- Created: 2025-12-28\n-- Migration number: 20251228093611 (must be last in sequence)\n\n-- Create settings table for Green API credentials\nCREATE TABLE IF NOT EXISTS public.green_api_settings (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    id_instance TEXT NOT NULL,\n    api_token_instance TEXT NOT NULL,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n    updated_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Enable RLS\nALTER TABLE public.green_api_settings ENABLE ROW LEVEL SECURITY","-- Policy: Authenticated users can read Green API settings (needed to send messages)\nCREATE POLICY \\"Authenticated users can read Green API settings\\"\n    ON public.green_api_settings FOR SELECT\n    USING (auth.uid() IS NOT NULL)","-- Policy: Only admins can insert Green API settings\nCREATE POLICY \\"Admins can insert Green API settings\\"\n    ON public.green_api_settings FOR INSERT\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Only admins can update Green API settings\nCREATE POLICY \\"Admins can update Green API settings\\"\n    ON public.green_api_settings FOR UPDATE\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Only admins can delete Green API settings\nCREATE POLICY \\"Admins can delete Green API settings\\"\n    ON public.green_api_settings FOR DELETE\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Trigger to auto-update updated_at and updated_by\nCREATE TRIGGER update_green_api_settings_updated_at\n    BEFORE UPDATE ON public.green_api_settings\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- Function to set created_by and updated_by on insert\nCREATE OR REPLACE FUNCTION set_green_api_settings_user()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.created_by = COALESCE(NEW.created_by, auth.uid());\n    NEW.updated_by = auth.uid();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Trigger to set user fields\nCREATE TRIGGER set_green_api_settings_user_trigger\n    BEFORE INSERT OR UPDATE ON public.green_api_settings\n    FOR EACH ROW\n    EXECUTE FUNCTION set_green_api_settings_user()","-- Add comments\nCOMMENT ON TABLE public.green_api_settings IS 'Stores Green API credentials for WhatsApp messaging'","COMMENT ON COLUMN public.green_api_settings.id_instance IS 'Green API instance ID'","COMMENT ON COLUMN public.green_api_settings.api_token_instance IS 'Green API token instance'"}	add_green_api_settings
20251228120000	{"-- Migration: Expand daily_check_ins table with comprehensive metrics\n-- This adds 19 new fields for luxury daily check-in tracking\n\n-- Physical measurements (6 fields)\nALTER TABLE daily_check_ins\n  ADD COLUMN IF NOT EXISTS weight NUMERIC(5,2), -- Weight in kg\n  ADD COLUMN IF NOT EXISTS belly_circumference INTEGER, -- היקף בטן in cm\n  ADD COLUMN IF NOT EXISTS waist_circumference INTEGER, -- היקף מותן in cm\n  ADD COLUMN IF NOT EXISTS thigh_circumference INTEGER, -- היקף ירכיים in cm\n  ADD COLUMN IF NOT EXISTS arm_circumference INTEGER, -- היקף יד in cm\n  ADD COLUMN IF NOT EXISTS neck_circumference INTEGER, -- היקף צוואר in cm\n  -- Activity metrics (3 new fields, steps_actual already exists)\n  ADD COLUMN IF NOT EXISTS exercises_count INTEGER, -- כמה תרגילים עשית\n  ADD COLUMN IF NOT EXISTS cardio_amount INTEGER, -- כמה אירובי עשית (minutes)\n  ADD COLUMN IF NOT EXISTS intervals_count INTEGER, -- כמה אינטרוולים\n  -- Nutrition and Hydration (4 fields)\n  ADD COLUMN IF NOT EXISTS calories_daily INTEGER, -- קלוריות יומי\n  ADD COLUMN IF NOT EXISTS protein_daily INTEGER, -- חלבון יומי in grams\n  ADD COLUMN IF NOT EXISTS fiber_daily INTEGER, -- סיבים יומי in grams\n  ADD COLUMN IF NOT EXISTS water_amount NUMERIC(5,2), -- כמה מים שתית in liters\n  -- Well-being scales 1-10 (3 fields)\n  ADD COLUMN IF NOT EXISTS stress_level INTEGER, -- רמת הלחץ היומי\n  ADD COLUMN IF NOT EXISTS hunger_level INTEGER, -- רמת הרעב שלך\n  ADD COLUMN IF NOT EXISTS energy_level INTEGER, -- רמת האנרגיה שלך\n  -- Rest (1 field)\n  ADD COLUMN IF NOT EXISTS sleep_hours NUMERIC(4,2)","-- כמה שעות ישנת\n\n-- Add CHECK constraints for well-being scales (must be done separately after columns exist)\nDO $$\nBEGIN\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_constraint WHERE conname = 'daily_check_ins_stress_level_check'\n  ) THEN\n    ALTER TABLE daily_check_ins\n      ADD CONSTRAINT daily_check_ins_stress_level_check \n        CHECK (stress_level IS NULL OR (stress_level >= 1 AND stress_level <= 10));\n  END IF;\n\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_constraint WHERE conname = 'daily_check_ins_hunger_level_check'\n  ) THEN\n    ALTER TABLE daily_check_ins\n      ADD CONSTRAINT daily_check_ins_hunger_level_check \n        CHECK (hunger_level IS NULL OR (hunger_level >= 1 AND hunger_level <= 10));\n  END IF;\n\n  IF NOT EXISTS (\n    SELECT 1 FROM pg_constraint WHERE conname = 'daily_check_ins_energy_level_check'\n  ) THEN\n    ALTER TABLE daily_check_ins\n      ADD CONSTRAINT daily_check_ins_energy_level_check \n        CHECK (energy_level IS NULL OR (energy_level >= 1 AND energy_level <= 10));\n  END IF;\nEND $$","-- Add comments for documentation\nCOMMENT ON COLUMN daily_check_ins.weight IS 'Weight measurement in kg (משקל)'","COMMENT ON COLUMN daily_check_ins.belly_circumference IS 'Belly circumference in cm (היקף בטן)'","COMMENT ON COLUMN daily_check_ins.waist_circumference IS 'Waist circumference in cm (היקף מותן)'","COMMENT ON COLUMN daily_check_ins.thigh_circumference IS 'Thigh circumference in cm (היקף ירכיים)'","COMMENT ON COLUMN daily_check_ins.arm_circumference IS 'Arm circumference in cm (היקף יד)'","COMMENT ON COLUMN daily_check_ins.neck_circumference IS 'Neck circumference in cm (היקף צוואר)'","COMMENT ON COLUMN daily_check_ins.exercises_count IS 'Number of exercises completed (כמה תרגילים עשית)'","COMMENT ON COLUMN daily_check_ins.cardio_amount IS 'Cardio duration in minutes (כמה אירובי עשית)'","COMMENT ON COLUMN daily_check_ins.intervals_count IS 'Number of interval training sessions (כמה אינטרוולים)'","COMMENT ON COLUMN daily_check_ins.calories_daily IS 'Daily calorie intake (קלוריות יומי)'","COMMENT ON COLUMN daily_check_ins.protein_daily IS 'Daily protein intake in grams (חלבון יומי)'","COMMENT ON COLUMN daily_check_ins.fiber_daily IS 'Daily fiber intake in grams (סיבים יומי)'","COMMENT ON COLUMN daily_check_ins.water_amount IS 'Water consumed in liters (כמה מים שתית)'","COMMENT ON COLUMN daily_check_ins.stress_level IS 'Daily stress level 1-10 (רמת הלחץ היומי)'","COMMENT ON COLUMN daily_check_ins.hunger_level IS 'Hunger level 1-10 (רמת הרעב שלך)'","COMMENT ON COLUMN daily_check_ins.energy_level IS 'Energy level 1-10 (רמת האנרגיה שלך)'","COMMENT ON COLUMN daily_check_ins.sleep_hours IS 'Hours of sleep (כמה שעות ישנת)'"}	expand_daily_check_ins
20251229000000	{"-- =====================================================\n-- Budgets (Taktziv) Migration\n-- Created: 2024-12-29\n-- Description: Master budget templates that aggregate nutrition, workout, steps, and supplements\n-- =====================================================\n\n-- =====================================================\n-- TABLE: budgets (Budget Templates)\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS budgets (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name TEXT NOT NULL,\n    description TEXT,\n    \n    -- Nutrition Master (can link to nutrition_template or have custom values)\n    nutrition_template_id UUID REFERENCES nutrition_templates(id) ON DELETE SET NULL,\n    nutrition_targets JSONB DEFAULT '{}'::jsonb,\n    -- Structure: { calories: number, protein: number, carbs: number, fat: number, fiber_min: number, water_min: number }\n    \n    -- Steps Module\n    steps_goal INTEGER DEFAULT 0,\n    steps_instructions TEXT,\n    \n    -- Workout Link\n    workout_template_id UUID REFERENCES workout_templates(id) ON DELETE SET NULL,\n    \n    -- Supplements Module (JSONB array)\n    supplements JSONB DEFAULT '[]'::jsonb,\n    -- Structure: [{ name: string, dosage: string, timing: string }]\n    \n    -- Guidelines\n    eating_order TEXT, -- e.g., \\"Vegetables -> Protein -> Carbs\\"\n    eating_rules TEXT, -- e.g., \\"Don't eat carbs alone\\"\n    \n    -- Metadata\n    is_public BOOLEAN NOT NULL DEFAULT FALSE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_budgets_created_by ON budgets(created_by)","CREATE INDEX IF NOT EXISTS idx_budgets_is_public ON budgets(is_public)","CREATE INDEX IF NOT EXISTS idx_budgets_nutrition_template_id ON budgets(nutrition_template_id)","CREATE INDEX IF NOT EXISTS idx_budgets_workout_template_id ON budgets(workout_template_id)","CREATE INDEX IF NOT EXISTS idx_budgets_nutrition_targets ON budgets USING GIN (nutrition_targets)","CREATE INDEX IF NOT EXISTS idx_budgets_supplements ON budgets USING GIN (supplements)","CREATE INDEX IF NOT EXISTS idx_budgets_created_at ON budgets(created_at DESC)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_budgets_updated_at\n    BEFORE UPDATE ON budgets\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- TABLE: budget_assignments (Active Client Budgets)\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS budget_assignments (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    budget_id UUID NOT NULL REFERENCES budgets(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE CASCADE,\n    customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,\n    \n    -- Assignment metadata\n    assigned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    assigned_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    \n    -- Notes specific to this assignment\n    notes TEXT,\n    \n    -- Metadata\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_budget_assignments_budget_id ON budget_assignments(budget_id)","CREATE INDEX IF NOT EXISTS idx_budget_assignments_lead_id ON budget_assignments(lead_id)","CREATE INDEX IF NOT EXISTS idx_budget_assignments_customer_id ON budget_assignments(customer_id)","CREATE INDEX IF NOT EXISTS idx_budget_assignments_is_active ON budget_assignments(is_active)","CREATE INDEX IF NOT EXISTS idx_budget_assignments_assigned_at ON budget_assignments(assigned_at DESC)","-- Unique constraint: One active budget per lead/customer\nCREATE UNIQUE INDEX IF NOT EXISTS idx_budget_assignments_unique_active_lead \n    ON budget_assignments(lead_id) \n    WHERE is_active = TRUE AND lead_id IS NOT NULL","CREATE UNIQUE INDEX IF NOT EXISTS idx_budget_assignments_unique_active_customer \n    ON budget_assignments(customer_id) \n    WHERE is_active = TRUE AND customer_id IS NOT NULL","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_budget_assignments_updated_at\n    BEFORE UPDATE ON budget_assignments\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on budgets table\nALTER TABLE budgets ENABLE ROW LEVEL SECURITY","-- Policy: Users can view public budgets or their own budgets\nCREATE POLICY \\"Users can view public or own budgets\\"\n    ON budgets FOR SELECT\n    USING (\n        is_public = TRUE OR \n        created_by = auth.uid()\n    )","-- Policy: Users can insert their own budgets\nCREATE POLICY \\"Users can insert own budgets\\"\n    ON budgets FOR INSERT\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can update their own budgets\nCREATE POLICY \\"Users can update own budgets\\"\n    ON budgets FOR UPDATE\n    USING (auth.uid() = created_by)\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can delete their own budgets\nCREATE POLICY \\"Users can delete own budgets\\"\n    ON budgets FOR DELETE\n    USING (auth.uid() = created_by)","-- Policy: Admins have full access to budgets\nCREATE POLICY \\"Admins have full access to budgets\\"\n    ON budgets FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Enable RLS on budget_assignments table\nALTER TABLE budget_assignments ENABLE ROW LEVEL SECURITY","-- Policy: Users can view assignments for their own leads/customers or if they created the budget\nCREATE POLICY \\"Users can view relevant budget assignments\\"\n    ON budget_assignments FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM budgets\n            WHERE budgets.id = budget_assignments.budget_id\n            AND (budgets.created_by = auth.uid() OR budgets.is_public = TRUE)\n        )\n        OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Users can insert assignments if they own the budget\nCREATE POLICY \\"Users can insert budget assignments for own budgets\\"\n    ON budget_assignments FOR INSERT\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM budgets\n            WHERE budgets.id = budget_assignments.budget_id\n            AND budgets.created_by = auth.uid()\n        )\n        OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Users can update assignments if they own the budget\nCREATE POLICY \\"Users can update budget assignments for own budgets\\"\n    ON budget_assignments FOR UPDATE\n    USING (\n        EXISTS (\n            SELECT 1 FROM budgets\n            WHERE budgets.id = budget_assignments.budget_id\n            AND budgets.created_by = auth.uid()\n        )\n        OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM budgets\n            WHERE budgets.id = budget_assignments.budget_id\n            AND budgets.created_by = auth.uid()\n        )\n        OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- Policy: Users can delete assignments if they own the budget\nCREATE POLICY \\"Users can delete budget assignments for own budgets\\"\n    ON budget_assignments FOR DELETE\n    USING (\n        EXISTS (\n            SELECT 1 FROM budgets\n            WHERE budgets.id = budget_assignments.budget_id\n            AND budgets.created_by = auth.uid()\n        )\n        OR\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE budgets IS 'Master budget templates that aggregate nutrition, workout, steps, and supplements'","COMMENT ON COLUMN budgets.nutrition_targets IS 'JSONB containing macro targets: { calories: number, protein: number, carbs: number, fat: number, fiber_min: number, water_min: number }'","COMMENT ON COLUMN budgets.supplements IS 'JSONB array of supplements: [{ name: string, dosage: string, timing: string }]'","COMMENT ON TABLE budget_assignments IS 'Active budget assignments to leads/customers'","COMMENT ON COLUMN budget_assignments.is_active IS 'Only one active budget per lead/customer at a time'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_budgets
20251229000001	{"-- =====================================================\n-- Add 'budgets' to saved_views resource_key constraint\n-- Created: 2025-12-29\n-- Description: Allow saved views for budgets (Taktziv)\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'budgets'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates', 'budgets'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_budgets_to_saved_views
20251230000000	{"-- Migration: Add check-in field configurations table\n-- Allows admins to customize which fields and sections are visible in client check-in forms\n\n-- Create check_in_field_configurations table\nCREATE TABLE IF NOT EXISTS check_in_field_configurations (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,\n  -- If customer_id is NULL, this is a global/default configuration\n  configuration JSONB NOT NULL DEFAULT '{}'::jsonb,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id),\n  \n  -- Ensure only one configuration per customer (or one global)\n  CONSTRAINT check_in_field_configurations_customer_unique UNIQUE (customer_id)\n)","-- Add index for faster lookups\nCREATE INDEX IF NOT EXISTS idx_check_in_field_configurations_customer_id \n  ON check_in_field_configurations(customer_id)","-- Add index for global configurations\nCREATE INDEX IF NOT EXISTS idx_check_in_field_configurations_global \n  ON check_in_field_configurations((customer_id IS NULL))","-- Enable RLS\nALTER TABLE check_in_field_configurations ENABLE ROW LEVEL SECURITY","-- RLS Policies\n-- Admins can read/write all configurations\nCREATE POLICY \\"Admins can manage all check-in field configurations\\"\n  ON check_in_field_configurations\n  FOR ALL\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'manager')\n    )\n  )","-- Clients can read their own configuration\nCREATE POLICY \\"Clients can read their check-in field configuration\\"\n  ON check_in_field_configurations\n  FOR SELECT\n  USING (\n    customer_id IN (\n      SELECT id FROM customers\n      WHERE user_id = auth.uid()\n    )\n    OR customer_id IS NULL -- Also allow reading global/default config\n  )","-- Function to update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_check_in_field_configurations_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Trigger to automatically update updated_at\nCREATE TRIGGER update_check_in_field_configurations_updated_at\n  BEFORE UPDATE ON check_in_field_configurations\n  FOR EACH ROW\n  EXECUTE FUNCTION update_check_in_field_configurations_updated_at()","-- Add comments\nCOMMENT ON TABLE check_in_field_configurations IS 'Stores configuration for check-in field visibility and labels per customer or globally'","COMMENT ON COLUMN check_in_field_configurations.customer_id IS 'Customer ID for customer-specific config, NULL for global/default config'","COMMENT ON COLUMN check_in_field_configurations.configuration IS 'JSONB object containing field visibility, labels, and section visibility settings'","-- Example configuration structure:\n-- {\n--   \\"sections\\": {\n--     \\"body\\": { \\"visible\\": true, \\"label\\": \\"מדדי גוף\\" },\n--     \\"activity\\": { \\"visible\\": true, \\"label\\": \\"פעילות\\" },\n--     \\"nutrition\\": { \\"visible\\": true, \\"label\\": \\"תזונה\\" },\n--     \\"wellness\\": { \\"visible\\": true, \\"label\\": \\"בריאות\\" }\n--   },\n--   \\"fields\\": {\n--     \\"weight\\": { \\"visible\\": true, \\"label\\": \\"משקל\\", \\"section\\": \\"body\\" },\n--     \\"bellyCircumference\\": { \\"visible\\": true, \\"label\\": \\"היקף בטן\\", \\"section\\": \\"body\\" },\n--     \\"waistCircumference\\": { \\"visible\\": true, \\"label\\": \\"היקף מותן\\", \\"section\\": \\"body\\" },\n--     \\"thighCircumference\\": { \\"visible\\": true, \\"label\\": \\"היקף ירכיים\\", \\"section\\": \\"body\\" },\n--     \\"armCircumference\\": { \\"visible\\": true, \\"label\\": \\"היקף יד\\", \\"section\\": \\"body\\" },\n--     \\"neckCircumference\\": { \\"visible\\": true, \\"label\\": \\"היקף צוואר\\", \\"section\\": \\"body\\" },\n--     \\"stepsActual\\": { \\"visible\\": true, \\"label\\": \\"מס' צעדים יומי\\", \\"section\\": \\"activity\\" },\n--     \\"exercisesCount\\": { \\"visible\\": true, \\"label\\": \\"כמה תרגילים עשית\\", \\"section\\": \\"activity\\" },\n--     \\"cardioAmount\\": { \\"visible\\": true, \\"label\\": \\"כמה אירובי עשית\\", \\"section\\": \\"activity\\" },\n--     \\"intervalsCount\\": { \\"visible\\": true, \\"label\\": \\"כמה אינטרוולים\\", \\"section\\": \\"activity\\" },\n--     \\"caloriesDaily\\": { \\"visible\\": true, \\"label\\": \\"קלוריות יומי\\", \\"section\\": \\"nutrition\\" },\n--     \\"proteinDaily\\": { \\"visible\\": true, \\"label\\": \\"חלבון יומי\\", \\"section\\": \\"nutrition\\" },\n--     \\"fiberDaily\\": { \\"visible\\": true, \\"label\\": \\"סיבים יומי\\", \\"section\\": \\"nutrition\\" },\n--     \\"waterAmount\\": { \\"visible\\": true, \\"label\\": \\"כמה מים שתית\\", \\"section\\": \\"nutrition\\" },\n--     \\"stressLevel\\": { \\"visible\\": true, \\"label\\": \\"רמת הלחץ היומי\\", \\"section\\": \\"wellness\\" },\n--     \\"hungerLevel\\": { \\"visible\\": true, \\"label\\": \\"רמת הרעב שלך\\", \\"section\\": \\"wellness\\" },\n--     \\"energyLevel\\": { \\"visible\\": true, \\"label\\": \\"רמת האנרגיה שלך\\", \\"section\\": \\"wellness\\" },\n--     \\"sleepHours\\": { \\"visible\\": true, \\"label\\": \\"כמה שעות ישנת\\", \\"section\\": \\"wellness\\" }\n--   }\n-- }"}	add_check_in_field_configurations
20251231000000	{"-- =====================================================\n-- Add Budget Links to Plans Migration\n-- Created: 2024-12-31\n-- Description: Links workout_plans, nutrition_plans, and supplement_plans to budgets\n-- =====================================================\n\n-- =====================================================\n-- Add budget_id to workout_plans\n-- =====================================================\n\nALTER TABLE workout_plans \nADD COLUMN IF NOT EXISTS budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL","CREATE INDEX IF NOT EXISTS idx_workout_plans_budget_id ON workout_plans(budget_id)","-- =====================================================\n-- Add budget_id to nutrition_plans\n-- =====================================================\n\nALTER TABLE nutrition_plans \nADD COLUMN IF NOT EXISTS budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_budget_id ON nutrition_plans(budget_id)","-- =====================================================\n-- Create supplement_plans table\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS supplement_plans (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    customer_id UUID REFERENCES customers(id) ON DELETE SET NULL,\n    budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL,\n    template_id UUID, -- For future use if supplement templates are created\n    \n    -- Standard fields\n    start_date DATE NOT NULL,\n    end_date DATE,\n    description TEXT,\n    \n    -- Supplements (JSONB array)\n    supplements JSONB DEFAULT '[]'::jsonb,\n    -- Structure: [{ name: string, dosage: string, timing: string }]\n    \n    -- Metadata\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_supplement_plans_user_id ON supplement_plans(user_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_lead_id ON supplement_plans(lead_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_customer_id ON supplement_plans(customer_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_budget_id ON supplement_plans(budget_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_start_date ON supplement_plans(start_date DESC)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_created_at ON supplement_plans(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_supplements ON supplement_plans USING GIN (supplements)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_supplement_plans_updated_at\n    BEFORE UPDATE ON supplement_plans\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES for supplement_plans\n-- =====================================================\n\n-- Enable RLS on supplement_plans table\nALTER TABLE supplement_plans ENABLE ROW LEVEL SECURITY","-- Policy: Users can read their own supplement plans\nCREATE POLICY \\"Users can read own supplement plans\\"\n    ON supplement_plans FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own supplement plans\nCREATE POLICY \\"Users can insert own supplement plans\\"\n    ON supplement_plans FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own supplement plans\nCREATE POLICY \\"Users can update own supplement plans\\"\n    ON supplement_plans FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own supplement plans\nCREATE POLICY \\"Users can delete own supplement plans\\"\n    ON supplement_plans FOR DELETE\n    USING (auth.uid() = user_id)","-- Policy: Admins have full access to supplement plans\nCREATE POLICY \\"Admins have full access to supplement plans\\"\n    ON supplement_plans FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON COLUMN workout_plans.budget_id IS 'Reference to the budget this workout plan was created from'","COMMENT ON COLUMN nutrition_plans.budget_id IS 'Reference to the budget this nutrition plan was created from'","COMMENT ON TABLE supplement_plans IS 'Supplement plans linked to leads/customers and budgets'","COMMENT ON COLUMN supplement_plans.budget_id IS 'Reference to the budget this supplement plan was created from'","COMMENT ON COLUMN supplement_plans.supplements IS 'JSONB array of supplements: [{ name: string, dosage: string, timing: string }]'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_budget_links_to_plans
20260101000000	{"-- =====================================================\n-- Fix Budget Links to Plans and Create Supplement Plans\n-- Created: 2026-01-01\n-- Description: Ensures budget_id columns exist in workout_plans and nutrition_plans,\n--              and creates supplement_plans table if it doesn't exist\n-- =====================================================\n\n-- =====================================================\n-- Add budget_id to workout_plans (if not exists)\n-- =====================================================\n\nDO $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.columns \n        WHERE table_name = 'workout_plans' \n        AND column_name = 'budget_id'\n    ) THEN\n        ALTER TABLE workout_plans \n        ADD COLUMN budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL;\n        \n        CREATE INDEX IF NOT EXISTS idx_workout_plans_budget_id ON workout_plans(budget_id);\n        \n        COMMENT ON COLUMN workout_plans.budget_id IS 'Reference to the budget this workout plan was created from';\n    END IF;\nEND $$","-- =====================================================\n-- Add budget_id to nutrition_plans (if not exists)\n-- =====================================================\n\nDO $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.columns \n        WHERE table_name = 'nutrition_plans' \n        AND column_name = 'budget_id'\n    ) THEN\n        ALTER TABLE nutrition_plans \n        ADD COLUMN budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL;\n        \n        CREATE INDEX IF NOT EXISTS idx_nutrition_plans_budget_id ON nutrition_plans(budget_id);\n        \n        COMMENT ON COLUMN nutrition_plans.budget_id IS 'Reference to the budget this nutrition plan was created from';\n    END IF;\nEND $$","-- =====================================================\n-- Create supplement_plans table (if not exists)\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS supplement_plans (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    customer_id UUID REFERENCES customers(id) ON DELETE SET NULL,\n    budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL,\n    template_id UUID, -- For future use if supplement templates are created\n    \n    -- Standard fields\n    start_date DATE NOT NULL,\n    end_date DATE,\n    description TEXT,\n    \n    -- Supplements (JSONB array)\n    supplements JSONB DEFAULT '[]'::jsonb,\n    -- Structure: [{ name: string, dosage: string, timing: string }]\n    \n    -- Metadata\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_supplement_plans_user_id ON supplement_plans(user_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_lead_id ON supplement_plans(lead_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_customer_id ON supplement_plans(customer_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_budget_id ON supplement_plans(budget_id)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_start_date ON supplement_plans(start_date DESC)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_created_at ON supplement_plans(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_supplement_plans_supplements ON supplement_plans USING GIN (supplements)","-- Trigger to auto-update updated_at (only if it doesn't exist)\nDO $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM pg_trigger \n        WHERE tgname = 'update_supplement_plans_updated_at'\n    ) THEN\n        CREATE TRIGGER update_supplement_plans_updated_at\n            BEFORE UPDATE ON supplement_plans\n            FOR EACH ROW\n            EXECUTE FUNCTION update_updated_at_column();\n    END IF;\nEND $$","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES for supplement_plans\n-- =====================================================\n\n-- Enable RLS on supplement_plans table\nALTER TABLE supplement_plans ENABLE ROW LEVEL SECURITY","-- Drop existing policies if they exist (to avoid conflicts)\nDROP POLICY IF EXISTS \\"Users can read own supplement plans\\" ON supplement_plans","DROP POLICY IF EXISTS \\"Users can insert own supplement plans\\" ON supplement_plans","DROP POLICY IF EXISTS \\"Users can update own supplement plans\\" ON supplement_plans","DROP POLICY IF EXISTS \\"Users can delete own supplement plans\\" ON supplement_plans","DROP POLICY IF EXISTS \\"Admins have full access to supplement plans\\" ON supplement_plans","-- Policy: Users can read their own supplement plans\nCREATE POLICY \\"Users can read own supplement plans\\"\n    ON supplement_plans FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own supplement plans\nCREATE POLICY \\"Users can insert own supplement plans\\"\n    ON supplement_plans FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own supplement plans\nCREATE POLICY \\"Users can update own supplement plans\\"\n    ON supplement_plans FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own supplement plans\nCREATE POLICY \\"Users can delete own supplement plans\\"\n    ON supplement_plans FOR DELETE\n    USING (auth.uid() = user_id)","-- Policy: Admins have full access to supplement plans\nCREATE POLICY \\"Admins have full access to supplement plans\\"\n    ON supplement_plans FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE supplement_plans IS 'Supplement plans linked to leads/customers and budgets'","COMMENT ON COLUMN supplement_plans.budget_id IS 'Reference to the budget this supplement plan was created from'","COMMENT ON COLUMN supplement_plans.supplements IS 'JSONB array of supplements: [{ name: string, dosage: string, timing: string }]'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_budget_links_and_supplement_plans
20260103000000	{"-- =====================================================\n-- Weekly Reviews Migration\n-- Created: 2026-01-03\n-- Description: Weekly strategy review module for trainer-client communication\n-- =====================================================\n\n-- =====================================================\n-- TABLE: weekly_reviews\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS weekly_reviews (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    \n    -- Links\n    lead_id UUID REFERENCES leads(id) ON DELETE CASCADE,\n    customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,\n    \n    -- Week identification\n    week_start_date DATE NOT NULL, -- First day of the week (typically Sunday or Monday)\n    week_end_date DATE NOT NULL,   -- Last day of the week\n    \n    -- Current Goals (from active budget/protocol at time of review)\n    target_calories INTEGER,\n    target_protein INTEGER, -- grams\n    target_carbs INTEGER,  -- grams\n    target_fat INTEGER,     -- grams\n    target_fiber INTEGER,   -- grams\n    target_steps INTEGER,\n    \n    -- Actual Averages (calculated from daily_check_ins for the week)\n    actual_calories_avg NUMERIC(10,2),\n    actual_protein_avg NUMERIC(10,2),\n    actual_carbs_avg NUMERIC(10,2),\n    actual_fat_avg NUMERIC(10,2),\n    actual_fiber_avg NUMERIC(10,2),\n    actual_calories_weekly_avg NUMERIC(10,2), -- Weekly average of daily calories\n    \n    -- Body Metrics\n    weekly_avg_weight NUMERIC(5,2), -- Average weight for the week\n    waist_measurement INTEGER,        -- Latest waist measurement from body metrics (cm)\n    \n    -- Trainer Inputs\n    trainer_summary TEXT,             -- סיכום ומסקנות (Summary & Insights)\n    action_plan TEXT,                 -- דגשים לשבוע הקרוב (Focus for next week)\n    \n    -- Protocol Updates (for next week)\n    updated_steps_goal INTEGER,       -- Updated step goal for following week\n    updated_calories_target INTEGER, -- Updated calorie target for following week\n    \n    -- Metadata\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n    \n    -- Ensure one review per lead/customer per week\n    UNIQUE(lead_id, week_start_date),\n    UNIQUE(customer_id, week_start_date)\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_weekly_reviews_lead_id ON weekly_reviews(lead_id)","CREATE INDEX IF NOT EXISTS idx_weekly_reviews_customer_id ON weekly_reviews(customer_id)","CREATE INDEX IF NOT EXISTS idx_weekly_reviews_week_start ON weekly_reviews(week_start_date DESC)","CREATE INDEX IF NOT EXISTS idx_weekly_reviews_created_at ON weekly_reviews(created_at DESC)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_weekly_reviews_updated_at\n    BEFORE UPDATE ON weekly_reviews\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\nALTER TABLE weekly_reviews ENABLE ROW LEVEL SECURITY","-- Policy: Trainees can view their own weekly reviews\nCREATE POLICY \\"Trainees can view own weekly reviews\\"\n    ON weekly_reviews FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM customers\n            WHERE customers.id = weekly_reviews.customer_id\n            AND customers.user_id = auth.uid()\n        )\n    )","-- Policy: Coaches/admins can view all weekly reviews\nCREATE POLICY \\"Coaches can view all weekly reviews\\"\n    ON weekly_reviews FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Coaches/admins can insert weekly reviews\nCREATE POLICY \\"Coaches can insert weekly reviews\\"\n    ON weekly_reviews FOR INSERT\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Coaches/admins can update weekly reviews\nCREATE POLICY \\"Coaches can update weekly reviews\\"\n    ON weekly_reviews FOR UPDATE\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- Policy: Coaches/admins can delete weekly reviews\nCREATE POLICY \\"Coaches can delete weekly reviews\\"\n    ON weekly_reviews FOR DELETE\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() \n            AND role IN ('admin', 'user')\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE weekly_reviews IS 'Weekly strategy reviews linking trainer insights with client check-in data'","COMMENT ON COLUMN weekly_reviews.week_start_date IS 'First day of the week being reviewed'","COMMENT ON COLUMN weekly_reviews.week_end_date IS 'Last day of the week being reviewed'","COMMENT ON COLUMN weekly_reviews.target_calories IS 'Target calories from active budget/protocol at time of review'","COMMENT ON COLUMN weekly_reviews.actual_calories_avg IS 'Average daily calories from check-ins during the week'","COMMENT ON COLUMN weekly_reviews.weekly_avg_weight IS 'Average weight for the week from daily check-ins'","COMMENT ON COLUMN weekly_reviews.waist_measurement IS 'Latest waist measurement from body metrics section'","COMMENT ON COLUMN weekly_reviews.trainer_summary IS 'Trainer summary and insights (סיכום ומסקנות)'","COMMENT ON COLUMN weekly_reviews.action_plan IS 'Action plan for next week (דגשים לשבוע הקרוב)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_weekly_reviews
20260104000000	{"-- Migration: Create Meetings Table\n-- Description: Stores meeting data from Fillout form submissions\n-- Created: 2026-01-04\n\n-- Create meetings table\nCREATE TABLE IF NOT EXISTS public.meetings (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  lead_id UUID REFERENCES public.leads(id) ON DELETE SET NULL,\n  customer_id UUID REFERENCES public.customers(id) ON DELETE SET NULL,\n  fillout_submission_id TEXT, -- ID from Fillout submission\n  meeting_data JSONB NOT NULL DEFAULT '{}'::jsonb, -- Flexible JSONB to store all form data\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Add indexes\nCREATE INDEX IF NOT EXISTS idx_meetings_lead_id ON public.meetings(lead_id)","CREATE INDEX IF NOT EXISTS idx_meetings_customer_id ON public.meetings(customer_id)","CREATE INDEX IF NOT EXISTS idx_meetings_created_at ON public.meetings(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_meetings_fillout_submission_id ON public.meetings(fillout_submission_id)","-- Add RLS policies\nALTER TABLE public.meetings ENABLE ROW LEVEL SECURITY","-- Policy: Managers can view all meetings\nCREATE POLICY \\"Managers can view all meetings\\"\n  ON public.meetings\n  FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Policy: Managers can insert meetings\nCREATE POLICY \\"Managers can insert meetings\\"\n  ON public.meetings\n  FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Policy: Managers can update meetings\nCREATE POLICY \\"Managers can update meetings\\"\n  ON public.meetings\n  FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Policy: Managers can delete meetings\nCREATE POLICY \\"Managers can delete meetings\\"\n  ON public.meetings\n  FOR DELETE\n  USING (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Create function to update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_meetings_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Create trigger to automatically update updated_at\nCREATE TRIGGER update_meetings_updated_at\n  BEFORE UPDATE ON public.meetings\n  FOR EACH ROW\n  EXECUTE FUNCTION update_meetings_updated_at()","-- Add comments\nCOMMENT ON TABLE public.meetings IS 'Stores meeting data from Fillout form submissions'","COMMENT ON COLUMN public.meetings.lead_id IS 'Link to the lead that the meeting is associated with'","COMMENT ON COLUMN public.meetings.customer_id IS 'Link to the customer that the meeting is associated with'","COMMENT ON COLUMN public.meetings.fillout_submission_id IS 'Unique identifier from Fillout submission'","COMMENT ON COLUMN public.meetings.meeting_data IS 'Flexible JSONB containing all meeting data from Fillout form'"}	create_meetings
20260104000001	{"-- =====================================================\n-- Add 'meetings' to saved_views resource_key constraint\n-- Created: 2026-01-04\n-- Description: Allow saved views for meetings (Pegishot)\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'meetings'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates', 'budgets', 'meetings'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_meetings_to_saved_views
20260104000002	{"-- =====================================================\n-- Fix Meetings RLS Policies\n-- Created: 2026-01-04\n-- Description: Update RLS policies to use 'admin' and 'user' roles instead of 'manager'\n-- =====================================================\n\n-- Drop existing policies\nDROP POLICY IF EXISTS \\"Managers can view all meetings\\" ON public.meetings","DROP POLICY IF EXISTS \\"Managers can insert meetings\\" ON public.meetings","DROP POLICY IF EXISTS \\"Managers can update meetings\\" ON public.meetings","DROP POLICY IF EXISTS \\"Managers can delete meetings\\" ON public.meetings","-- Policy: Admins and users (managers) can view all meetings\nCREATE POLICY \\"Admins and users can view all meetings\\"\n  ON public.meetings\n  FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user')\n    )\n  )","-- Policy: Admins and users can insert meetings\nCREATE POLICY \\"Admins and users can insert meetings\\"\n  ON public.meetings\n  FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user')\n    )\n  )","-- Policy: Admins and users can update meetings\nCREATE POLICY \\"Admins and users can update meetings\\"\n  ON public.meetings\n  FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user')\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user')\n    )\n  )","-- Policy: Admins and users can delete meetings\nCREATE POLICY \\"Admins and users can delete meetings\\"\n  ON public.meetings\n  FOR DELETE\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user')\n    )\n  )","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_meetings_rls_policies
20260104000003	{"-- Migration: Backfill Meeting Data from Fillout\n-- Description: This migration provides a function to re-sync meeting_data from Fillout API\n--              for existing meetings that only have metadata. Run this manually via Supabase SQL editor\n--              or create an Edge Function to trigger it.\n-- Created: 2026-01-04\n\n-- Note: This migration doesn't automatically backfill data.\n-- To backfill existing meetings, you need to:\n-- 1. Call the sync-fillout-meetings Edge Function which will update existing meetings\n-- 2. Or manually update meetings via the Supabase dashboard\n-- 3. Or create a one-time script to fetch from Fillout API and update meeting_data\n\n-- The sync-fillout-meetings function has been updated to properly extract all question data\n-- including the Schedule field. When you run the sync, it will update existing meetings\n-- with the full meeting_data including all form fields.\n\n-- This migration file serves as documentation that the extraction logic has been improved.\n-- No database schema changes are needed as meeting_data is already JSONB and can store any structure.\n\nCOMMENT ON COLUMN public.meetings.meeting_data IS 'Flexible JSONB containing all meeting data from Fillout form, including Schedule field for actual meeting date/time'"}	backfill_meeting_data_from_fillout
20260104000004	{"-- =====================================================\n-- Add 'check_in_settings' to saved_views resource_key constraint\n-- Created: 2026-01-04\n-- Description: Allow saved views for check-in settings\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'check_in_settings'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates', 'budgets', 'meetings', 'check_in_settings'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_check_in_settings_to_saved_views
20260104000005	{"-- =====================================================\n-- Add attachment_url column to customer_notes table\n-- Created: 2026-01-04\n-- Description: Allow notes to have file attachments stored in Supabase Storage\n-- =====================================================\n\n-- Add attachment_url column to store the file path in Supabase Storage\nALTER TABLE customer_notes \n  ADD COLUMN IF NOT EXISTS attachment_url TEXT","-- Create index for faster queries on notes with attachments\nCREATE INDEX IF NOT EXISTS idx_customer_notes_attachment_url \n  ON customer_notes(attachment_url) \n  WHERE attachment_url IS NOT NULL","-- Add comment for documentation\nCOMMENT ON COLUMN customer_notes.attachment_url IS 'URL/path to file attachment in Supabase Storage (client-assets bucket)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_attachment_url_to_customer_notes
20260104000006	{"-- =====================================================\n-- Create client-assets storage bucket with RLS policies\n-- Created: 2026-01-04\n-- Description: Storage bucket for progress photos and note attachments\n-- Path structure: [client_id]/progress/[file_name] and [client_id]/notes/[file_name]\n-- \n-- NOTE: Storage buckets must be created via Supabase Dashboard or CLI.\n-- This migration only sets up RLS policies for the 'client-assets' bucket.\n-- \n-- To create the bucket:\n-- 1. Via Supabase Dashboard: Go to Storage > Create Bucket > Name: \\"client-assets\\" > Public: false\n-- 2. Via CLI: Use Supabase Management API or create manually in dashboard\n-- \n-- The bucket should have:\n-- - Name: client-assets\n-- - Public: false (private, uses signed URLs)\n-- - File size limit: 10MB\n-- - Allowed MIME types: image/*, application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document\n-- \n-- IMPORTANT: Storage must be enabled in supabase/config.toml ([storage] enabled = true)\n-- and the bucket must be created before these policies will work.\n-- \n-- For local development:\n-- 1. Enable storage in supabase/config.toml: [storage] enabled = true\n-- 2. Restart Supabase: npx supabase stop && npx supabase start\n-- 3. Create the bucket via Supabase Studio (http://localhost:54323) > Storage > Create Bucket\n-- \n-- If storage is not enabled locally, this migration will fail. That's expected.\n-- The migration will work correctly in production/remote Supabase where storage is enabled.\n-- =====================================================\n\n-- Only create policies if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- RLS Policy: Allow trainees to upload files to their own client_id folder\n    DROP POLICY IF EXISTS \\"Trainees can upload to own client folder\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Trainees can upload to own client folder\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = ''client-assets'' AND\n      (\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''progress''\n        OR\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''notes''\n      )\n    )';\n\n    -- RLS Policy: Allow trainees to view files in their own client_id folder\n    DROP POLICY IF EXISTS \\"Trainees can view own client files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Trainees can view own client files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      (\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''progress''\n        OR\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''notes''\n      )\n    )';\n\n    -- RLS Policy: Allow trainees to delete files from their own client_id folder\n    DROP POLICY IF EXISTS \\"Trainees can delete own client files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Trainees can delete own client files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      (\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''progress''\n        OR\n        EXISTS (\n          SELECT 1 FROM customers\n          WHERE customers.id::text = (storage.foldername(name))[1]\n          AND customers.user_id = auth.uid()\n        ) AND\n        (storage.foldername(name))[2] = ''notes''\n      )\n    )';\n\n    -- RLS Policy: Allow managers/admins to upload files for any client\n    DROP POLICY IF EXISTS \\"Managers can upload client files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can upload client files\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (\n        (storage.foldername(name))[2] = ''progress'' OR\n        (storage.foldername(name))[2] = ''notes''\n      )\n    )';\n\n    -- RLS Policy: Allow managers/admins to view all client files\n    DROP POLICY IF EXISTS \\"Managers can view all client files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can view all client files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      )\n    )';\n\n    -- RLS Policy: Allow managers/admins to delete all client files\n    DROP POLICY IF EXISTS \\"Managers can delete all client files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can delete all client files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      )\n    )';\n\n    RAISE NOTICE 'Storage RLS policies created successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy creation. Enable storage in config.toml and restart Supabase to create policies.';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_client_assets_storage_bucket
20260104000007	{"-- =====================================================\n-- Create Steps Plans Table Migration\n-- Created: 2026-01-04\n-- Description: Create steps_plans table similar to supplement_plans\n-- =====================================================\n\n-- =====================================================\n-- Create steps_plans table\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS steps_plans (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n    customer_id UUID REFERENCES customers(id) ON DELETE SET NULL,\n    budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL,\n    template_id UUID, -- For future use if steps templates are created\n    \n    -- Standard fields\n    start_date DATE NOT NULL,\n    end_date DATE,\n    description TEXT,\n    \n    -- Steps data\n    steps_goal INTEGER NOT NULL DEFAULT 0,\n    steps_instructions TEXT,\n    \n    -- Metadata\n    is_active BOOLEAN NOT NULL DEFAULT TRUE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_steps_plans_user_id ON steps_plans(user_id)","CREATE INDEX IF NOT EXISTS idx_steps_plans_lead_id ON steps_plans(lead_id)","CREATE INDEX IF NOT EXISTS idx_steps_plans_customer_id ON steps_plans(customer_id)","CREATE INDEX IF NOT EXISTS idx_steps_plans_budget_id ON steps_plans(budget_id)","CREATE INDEX IF NOT EXISTS idx_steps_plans_start_date ON steps_plans(start_date DESC)","CREATE INDEX IF NOT EXISTS idx_steps_plans_created_at ON steps_plans(created_at DESC)","-- Trigger to auto-update updated_at\n-- Ensure the function exists first\nCREATE OR REPLACE FUNCTION public.update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","CREATE TRIGGER update_steps_plans_updated_at\n    BEFORE UPDATE ON steps_plans\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES for steps_plans\n-- =====================================================\n\n-- Enable RLS on steps_plans table\nALTER TABLE steps_plans ENABLE ROW LEVEL SECURITY","-- Policy: Users can read their own steps plans\nCREATE POLICY \\"Users can read own steps plans\\"\n    ON steps_plans FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own steps plans\nCREATE POLICY \\"Users can insert own steps plans\\"\n    ON steps_plans FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own steps plans\nCREATE POLICY \\"Users can update own steps plans\\"\n    ON steps_plans FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own steps plans\nCREATE POLICY \\"Users can delete own steps plans\\"\n    ON steps_plans FOR DELETE\n    USING (auth.uid() = user_id)","-- Policy: Admins have full access to steps plans\nCREATE POLICY \\"Admins have full access to steps plans\\"\n    ON steps_plans FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE steps_plans IS 'Steps plans linked to leads/customers and budgets'","COMMENT ON COLUMN steps_plans.budget_id IS 'Reference to the budget this steps plan was created from'","COMMENT ON COLUMN steps_plans.steps_goal IS 'Daily steps goal for this plan'","COMMENT ON COLUMN steps_plans.steps_instructions IS 'Instructions and guidelines for daily steps'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_steps_plans
20260104000008	{"-- =====================================================\n-- Prevent Duplicate Plans Per Budget Migration\n-- Created: 2026-01-04\n-- Description: Prevents duplicate plans (workout, nutrition, steps, supplement) \n--              for the same budget + customer/lead combination\n-- =====================================================\n\n-- =====================================================\n-- STEP 1: Clean up existing duplicates\n-- Keep only the most recent plan per budget_id + customer_id/lead_id combination\n-- =====================================================\n\n-- Clean up duplicate workout_plans (only if budget_id column exists)\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'workout_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE '\n    WITH ranked_plans AS (\n      SELECT \n        id,\n        ROW_NUMBER() OVER (\n          PARTITION BY budget_id, COALESCE(customer_id::text, ''''), COALESCE(lead_id::text, '''')\n          ORDER BY created_at DESC\n        ) as rn\n      FROM workout_plans\n      WHERE budget_id IS NOT NULL\n    )\n    DELETE FROM workout_plans\n    WHERE id IN (\n      SELECT id FROM ranked_plans WHERE rn > 1\n    )';\n  END IF;\nEND $$","-- Clean up duplicate nutrition_plans (only if budget_id column exists)\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'nutrition_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE '\n    WITH ranked_plans AS (\n      SELECT \n        id,\n        ROW_NUMBER() OVER (\n          PARTITION BY budget_id, COALESCE(customer_id::text, ''''), COALESCE(lead_id::text, '''')\n          ORDER BY created_at DESC\n        ) as rn\n      FROM nutrition_plans\n      WHERE budget_id IS NOT NULL\n    )\n    DELETE FROM nutrition_plans\n    WHERE id IN (\n      SELECT id FROM ranked_plans WHERE rn > 1\n    )';\n  END IF;\nEND $$","-- Clean up duplicate steps_plans\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'steps_plans') THEN\n    EXECUTE '\n    WITH ranked_plans AS (\n      SELECT \n        id,\n        ROW_NUMBER() OVER (\n          PARTITION BY budget_id, COALESCE(customer_id::text, ''''), COALESCE(lead_id::text, '''')\n          ORDER BY created_at DESC\n        ) as rn\n      FROM steps_plans\n      WHERE budget_id IS NOT NULL\n    )\n    DELETE FROM steps_plans\n    WHERE id IN (\n      SELECT id FROM ranked_plans WHERE rn > 1\n    )';\n  END IF;\nEND $$","-- Clean up duplicate supplement_plans (only if budget_id column exists)\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'supplement_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE '\n    WITH ranked_plans AS (\n      SELECT \n        id,\n        ROW_NUMBER() OVER (\n          PARTITION BY budget_id, COALESCE(customer_id::text, ''''), COALESCE(lead_id::text, '''')\n          ORDER BY created_at DESC\n        ) as rn\n      FROM supplement_plans\n      WHERE budget_id IS NOT NULL\n    )\n    DELETE FROM supplement_plans\n    WHERE id IN (\n      SELECT id FROM ranked_plans WHERE rn > 1\n    )';\n  END IF;\nEND $$","-- =====================================================\n-- STEP 2: Create unique partial indexes to prevent future duplicates\n-- These indexes ensure only one plan per budget + customer/lead combination\n-- =====================================================\n\n-- Unique index for workout_plans (when budget_id is set)\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'workout_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_workout_plans_unique_budget_customer\n    ON workout_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_workout_plans_unique_budget_lead\n    ON workout_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- Unique index for nutrition_plans (when budget_id is set)\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'nutrition_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_nutrition_plans_unique_budget_customer\n    ON nutrition_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_nutrition_plans_unique_budget_lead\n    ON nutrition_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- Unique index for steps_plans (when budget_id is set)\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'steps_plans') THEN\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_steps_plans_unique_budget_customer\n    ON steps_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_steps_plans_unique_budget_lead\n    ON steps_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- Unique index for supplement_plans (when budget_id is set)\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'supplement_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_supplement_plans_unique_budget_customer\n    ON supplement_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_supplement_plans_unique_budget_lead\n    ON supplement_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- =====================================================\n-- COMMENTS (only if indexes exist)\n-- =====================================================\n\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_workout_plans_unique_budget_customer') THEN\n    EXECUTE 'COMMENT ON INDEX idx_workout_plans_unique_budget_customer IS ''Ensures only one workout plan per budget + customer combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_workout_plans_unique_budget_lead') THEN\n    EXECUTE 'COMMENT ON INDEX idx_workout_plans_unique_budget_lead IS ''Ensures only one workout plan per budget + lead combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_nutrition_plans_unique_budget_customer') THEN\n    EXECUTE 'COMMENT ON INDEX idx_nutrition_plans_unique_budget_customer IS ''Ensures only one nutrition plan per budget + customer combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_nutrition_plans_unique_budget_lead') THEN\n    EXECUTE 'COMMENT ON INDEX idx_nutrition_plans_unique_budget_lead IS ''Ensures only one nutrition plan per budget + lead combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_supplement_plans_unique_budget_customer') THEN\n    EXECUTE 'COMMENT ON INDEX idx_supplement_plans_unique_budget_customer IS ''Ensures only one supplement plan per budget + customer combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_supplement_plans_unique_budget_lead') THEN\n    EXECUTE 'COMMENT ON INDEX idx_supplement_plans_unique_budget_lead IS ''Ensures only one supplement plan per budget + lead combination''';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	prevent_duplicate_plans_per_budget
20260104000009	{"-- =====================================================\n-- Create Payments Table\n-- Created: 2026-01-04\n-- Description: Secure payments table for tracking customer/lead payments\n--              NO sensitive data (card numbers, CVV, passwords) stored\n--              Links to both customers and leads\n-- =====================================================\n\n-- Create payments table\nCREATE TABLE IF NOT EXISTS public.payments (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    customer_id UUID NOT NULL REFERENCES public.customers(id) ON DELETE CASCADE,\n    lead_id UUID REFERENCES public.leads(id) ON DELETE SET NULL,\n    product_name TEXT NOT NULL,\n    amount NUMERIC(10, 2) NOT NULL CHECK (amount >= 0),\n    currency TEXT NOT NULL DEFAULT 'ILS',\n    status TEXT NOT NULL CHECK (status IN ('שולם', 'ממתין', 'הוחזר', 'נכשל')),\n    stripe_payment_id TEXT,\n    transaction_id TEXT,\n    receipt_url TEXT,\n    notes TEXT,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Create indexes for efficient queries\nCREATE INDEX IF NOT EXISTS idx_payments_customer_id ON public.payments(customer_id)","CREATE INDEX IF NOT EXISTS idx_payments_lead_id ON public.payments(lead_id)","CREATE INDEX IF NOT EXISTS idx_payments_created_at ON public.payments(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_payments_status ON public.payments(status)","CREATE INDEX IF NOT EXISTS idx_payments_stripe_payment_id ON public.payments(stripe_payment_id) WHERE stripe_payment_id IS NOT NULL","-- Create trigger for auto-updating updated_at\nCREATE TRIGGER update_payments_updated_at\n    BEFORE UPDATE ON public.payments\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- Enable RLS on payments table\nALTER TABLE public.payments ENABLE ROW LEVEL SECURITY","-- RLS Policies for payments\n-- Authenticated users can read payments for customers/leads they have access to\nDROP POLICY IF EXISTS \\"Authenticated users can read payments\\" ON public.payments","CREATE POLICY \\"Authenticated users can read payments\\"\n    ON public.payments FOR SELECT\n    USING (\n        auth.role() = 'authenticated' AND (\n            -- Users can see payments for customers they have access to\n            EXISTS (\n                SELECT 1 FROM public.customers\n                WHERE customers.id = payments.customer_id\n            )\n            OR\n            -- Admins can see all payments\n            EXISTS (\n                SELECT 1 FROM public.profiles\n                WHERE profiles.id = auth.uid() AND profiles.role = 'admin'\n            )\n        )\n    )","-- Authenticated users can insert payments\nDROP POLICY IF EXISTS \\"Authenticated users can insert payments\\" ON public.payments","CREATE POLICY \\"Authenticated users can insert payments\\"\n    ON public.payments FOR INSERT\n    WITH CHECK (auth.role() = 'authenticated')","-- Authenticated users can update payments\nDROP POLICY IF EXISTS \\"Authenticated users can update payments\\" ON public.payments","CREATE POLICY \\"Authenticated users can update payments\\"\n    ON public.payments FOR UPDATE\n    USING (auth.role() = 'authenticated')\n    WITH CHECK (auth.role() = 'authenticated')","-- Admins have full access to payments\nDROP POLICY IF EXISTS \\"Admins have full access to payments\\" ON public.payments","CREATE POLICY \\"Admins have full access to payments\\"\n    ON public.payments FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid() AND profiles.role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid() AND profiles.role = 'admin'\n        )\n    )","-- Add comment to table\nCOMMENT ON TABLE public.payments IS 'Customer/lead payment records. NO sensitive payment data (card numbers, CVV, passwords) stored.'","COMMENT ON COLUMN public.payments.stripe_payment_id IS 'Stripe payment intent ID - external reference only'","COMMENT ON COLUMN public.payments.transaction_id IS 'Transaction ID for tracking purposes'","COMMENT ON COLUMN public.payments.receipt_url IS 'URL to receipt document (stored in secure storage)'","COMMENT ON COLUMN public.payments.status IS 'Payment status in Hebrew: שולם (paid), ממתין (pending), הוחזר (refunded), נכשל (failed)'"}	create_payments
20260111161628	{"-- Migration: Add Media Support to WhatsApp Flow Templates\n-- Description: Adds media column to store image, video, or GIF URLs\n-- Created: 2026-01-11\n\n-- Add media column to whatsapp_flow_templates table\n-- Media is stored as JSONB with structure: { type: 'image'|'video'|'gif', url: string }\nALTER TABLE public.whatsapp_flow_templates\nADD COLUMN IF NOT EXISTS media JSONB DEFAULT NULL","-- Add comment\nCOMMENT ON COLUMN public.whatsapp_flow_templates.media IS 'Media attachment for template (image, video, or GIF) stored as JSONB: { type: \\"image\\"|\\"video\\"|\\"gif\\", url: string }'","-- Add index for faster queries if needed\nCREATE INDEX IF NOT EXISTS idx_whatsapp_flow_templates_media \nON public.whatsapp_flow_templates USING gin(media)"}	add_media_to_whatsapp_templates
20260111162708	{"-- =====================================================\n-- Ensure client-assets storage bucket exists with templates folder policies\n-- Created: 2026-01-11\n-- Description: Ensures the client-assets bucket exists and has RLS policies for templates folder\n-- This migration must be the LAST one in the list for migration up to work correctly\n-- =====================================================\n\n-- Ensure storage bucket exists (idempotent)\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'buckets'\n  ) THEN\n    -- Insert bucket if it doesn't exist (idempotent)\n    INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)\n    VALUES (\n      'client-assets',\n      'client-assets',\n      false, -- private bucket (uses signed URLs)\n      52428800, -- 50MB file size limit (in bytes) - matches config.toml\n      ARRAY[\n        'image/jpeg',\n        'image/jpg', \n        'image/png',\n        'image/gif',\n        'image/webp',\n        'video/mp4',\n        'video/mpeg',\n        'video/quicktime',\n        'application/pdf',\n        'application/msword',\n        'application/vnd.openxmlformats-officedocument.wordprocessingml.document'\n      ]::text[]\n    )\n    ON CONFLICT (id) DO UPDATE SET\n      file_size_limit = EXCLUDED.file_size_limit,\n      allowed_mime_types = EXCLUDED.allowed_mime_types;\n    \n    RAISE NOTICE 'Storage bucket \\"client-assets\\" ensured successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping bucket creation. Enable storage in config.toml and restart Supabase.';\n  END IF;\nEND $$","-- Add RLS policies for templates folder if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- RLS Policy: Allow authenticated users (managers/admins) to upload template files\n    -- Path structure: templates/{user_id}/{flow_key}/{filename}\n    DROP POLICY IF EXISTS \\"Managers can upload template files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can upload template files\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''templates''\n    )';\n\n    -- RLS Policy: Allow authenticated users (managers/admins) to view template files\n    DROP POLICY IF EXISTS \\"Managers can view template files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can view template files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''templates''\n    )';\n\n    -- RLS Policy: Allow authenticated users (managers/admins) to delete template files\n    DROP POLICY IF EXISTS \\"Managers can delete template files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can delete template files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''templates''\n    )';\n\n    RAISE NOTICE 'Storage RLS policies for templates folder created successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy creation. Enable storage in config.toml and restart Supabase to create policies.';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	ensure_client_assets_storage_bucket
20260112000000	{"-- =====================================================\n-- Add Storage Policies for Workout Exercises Media\n-- Created: 2026-01-12\n-- Description: Adds RLS policies to allow managers/admins to upload and manage\n--              images and videos for workout exercises in the client-assets bucket\n-- Path structure: workout-exercises/[exercise_id]/[images|videos]/[file_name]\n-- =====================================================\n\n-- Only create policies if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- RLS Policy: Allow managers/admins to upload workout exercise media\n    DROP POLICY IF EXISTS \\"Managers can upload workout exercise media\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can upload workout exercise media\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''workout-exercises''\n    )';\n\n    -- RLS Policy: Allow managers/admins to view workout exercise media\n    DROP POLICY IF EXISTS \\"Managers can view workout exercise media\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can view workout exercise media\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      (\n        EXISTS (\n          SELECT 1 FROM profiles\n          WHERE profiles.id = auth.uid()\n          AND profiles.role IN (''admin'', ''user'')\n        ) AND\n        (storage.foldername(name))[1] = ''workout-exercises''\n      )\n    )';\n\n    -- RLS Policy: Allow managers/admins to delete workout exercise media\n    DROP POLICY IF EXISTS \\"Managers can delete workout exercise media\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can delete workout exercise media\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''workout-exercises''\n    )';\n\n    RAISE NOTICE 'Workout exercises storage RLS policies created successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy creation. Enable storage in config.toml and restart Supabase to create policies.';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_workout_exercises_storage_policies
20260113000000	{"-- =====================================================\n-- Subscription Types (Sugei Menuyim) Migration\n-- Created: 2026-01-13\n-- Description: Master subscription type templates for leads\n-- =====================================================\n\n-- =====================================================\n-- TABLE: subscription_types\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS subscription_types (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name TEXT NOT NULL,\n    duration INTEGER NOT NULL, -- Duration in months\n    price NUMERIC(10, 2) NOT NULL, -- Price in NIS\n    \n    -- Metadata\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_subscription_types_created_by ON subscription_types(created_by)","CREATE INDEX IF NOT EXISTS idx_subscription_types_created_at ON subscription_types(created_at DESC)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_subscription_types_updated_at\n    BEFORE UPDATE ON subscription_types\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on subscription_types table\nALTER TABLE subscription_types ENABLE ROW LEVEL SECURITY","-- Policy: Users can view all subscription types\nCREATE POLICY \\"Users can view subscription types\\"\n    ON subscription_types FOR SELECT\n    USING (true)","-- Policy: Users can insert their own subscription types\nCREATE POLICY \\"Users can insert own subscription types\\"\n    ON subscription_types FOR INSERT\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can update their own subscription types\nCREATE POLICY \\"Users can update own subscription types\\"\n    ON subscription_types FOR UPDATE\n    USING (auth.uid() = created_by)\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can delete their own subscription types\nCREATE POLICY \\"Users can delete own subscription types\\"\n    ON subscription_types FOR DELETE\n    USING (auth.uid() = created_by)","-- Policy: Admins have full access to subscription types\nCREATE POLICY \\"Admins have full access to subscription types\\"\n    ON subscription_types FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE subscription_types IS 'Master subscription type templates that can be used to populate lead subscription data'","COMMENT ON COLUMN subscription_types.duration IS 'Duration in months (e.g., 3, 6, 12)'","COMMENT ON COLUMN subscription_types.price IS 'Price in NIS (e.g., 299.99)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_subscription_types
20260114000000	{"-- =====================================================\n-- Blood Tests (Bedikot Dam) Migration\n-- Created: 2026-01-14\n-- Description: Blood test PDF uploads for leads\n-- =====================================================\n\n-- =====================================================\n-- TABLE: blood_tests\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS blood_tests (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    lead_id UUID NOT NULL REFERENCES leads(id) ON DELETE CASCADE,\n    file_url TEXT NOT NULL, -- Storage path in client-assets bucket\n    file_name TEXT NOT NULL, -- Original file name\n    upload_date TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    \n    -- Metadata\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    uploaded_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_blood_tests_lead_id ON blood_tests(lead_id)","CREATE INDEX IF NOT EXISTS idx_blood_tests_upload_date ON blood_tests(upload_date DESC)","CREATE INDEX IF NOT EXISTS idx_blood_tests_uploaded_by ON blood_tests(uploaded_by)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_blood_tests_updated_at\n    BEFORE UPDATE ON blood_tests\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on blood_tests table\nALTER TABLE blood_tests ENABLE ROW LEVEL SECURITY","-- Policy: Users can view blood tests for leads they have access to\nCREATE POLICY \\"Users can view blood tests for accessible leads\\"\n    ON blood_tests FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM leads\n            WHERE leads.id = blood_tests.lead_id\n            AND (\n                leads.assigned_to = auth.uid()\n                OR EXISTS (\n                    SELECT 1 FROM profiles\n                    WHERE profiles.id = auth.uid()\n                    AND profiles.role IN ('admin', 'user')\n                )\n                OR EXISTS (\n                    SELECT 1 FROM customers\n                    JOIN leads ON leads.customer_id = customers.id\n                    WHERE leads.id = blood_tests.lead_id\n                    AND customers.id IN (\n                        SELECT customer_id FROM profiles\n                        WHERE profiles.id = auth.uid()\n                        AND profiles.role = 'trainee'\n                    )\n                )\n            )\n        )\n    )","-- Policy: Trainees can insert blood tests for their own customer's leads\nCREATE POLICY \\"Trainees can insert blood tests for their customer\\"\n    ON blood_tests FOR INSERT\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM leads\n            JOIN customers ON customers.id = leads.customer_id\n            WHERE leads.id = blood_tests.lead_id\n            AND customers.id IN (\n                SELECT customer_id FROM profiles\n                WHERE profiles.id = auth.uid()\n                AND profiles.role = 'trainee'\n            )\n        )\n        AND auth.uid() = uploaded_by\n    )","-- Policy: Managers/admins can insert blood tests for any lead\nCREATE POLICY \\"Managers can insert blood tests\\"\n    ON blood_tests FOR INSERT\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE profiles.id = auth.uid()\n            AND profiles.role IN ('admin', 'user')\n        )\n        AND (\n            auth.uid() = uploaded_by\n            OR uploaded_by IS NULL\n        )\n    )","-- Policy: Trainees can delete their own blood tests\nCREATE POLICY \\"Trainees can delete their own blood tests\\"\n    ON blood_tests FOR DELETE\n    USING (\n        EXISTS (\n            SELECT 1 FROM leads\n            JOIN customers ON customers.id = leads.customer_id\n            WHERE leads.id = blood_tests.lead_id\n            AND customers.id IN (\n                SELECT customer_id FROM profiles\n                WHERE profiles.id = auth.uid()\n                AND profiles.role = 'trainee'\n            )\n        )\n        AND uploaded_by = auth.uid()\n    )","-- Policy: Managers/admins can delete any blood test\nCREATE POLICY \\"Managers can delete blood tests\\"\n    ON blood_tests FOR DELETE\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE profiles.id = auth.uid()\n            AND profiles.role IN ('admin', 'user')\n        )\n    )","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE blood_tests IS 'Blood test PDF files uploaded by clients or managers'","COMMENT ON COLUMN blood_tests.lead_id IS 'Reference to the lead (client)'","COMMENT ON COLUMN blood_tests.file_url IS 'Storage path in client-assets bucket (e.g., customer_id/blood-tests/filename.pdf)'","COMMENT ON COLUMN blood_tests.file_name IS 'Original file name for display'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_blood_tests
20260114000001	{"-- =====================================================\n-- Add Storage Policies for Blood Tests\n-- Created: 2026-01-14\n-- Description: Add RLS policies for blood-tests folder in client-assets bucket\n-- =====================================================\n\n-- Only create policies if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- RLS Policy: Allow trainees to upload blood test PDFs to their own client_id folder\n    DROP POLICY IF EXISTS \\"Trainees can upload blood tests to own client folder\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Trainees can upload blood tests to own client folder\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM customers\n        WHERE customers.id::text = (storage.foldername(name))[1]\n        AND customers.user_id = auth.uid()\n      ) AND\n      (storage.foldername(name))[2] = ''blood-tests''\n    )';\n\n    -- RLS Policy: Allow trainees to view blood test PDFs in their own client_id folder\n    DROP POLICY IF EXISTS \\"Trainees can view own blood tests\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Trainees can view own blood tests\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM customers\n        WHERE customers.id::text = (storage.foldername(name))[1]\n        AND customers.user_id = auth.uid()\n      ) AND\n      (storage.foldername(name))[2] = ''blood-tests''\n    )';\n\n    -- RLS Policy: Allow trainees to delete blood test PDFs from their own client_id folder\n    DROP POLICY IF EXISTS \\"Trainees can delete own blood tests\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Trainees can delete own blood tests\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM customers\n        WHERE customers.id::text = (storage.foldername(name))[1]\n        AND customers.user_id = auth.uid()\n      ) AND\n      (storage.foldername(name))[2] = ''blood-tests''\n    )';\n\n    -- RLS Policy: Allow managers/admins to upload blood test PDFs for any client\n    DROP POLICY IF EXISTS \\"Managers can upload blood tests\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can upload blood tests\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[2] = ''blood-tests''\n    )';\n\n    -- RLS Policy: Allow managers/admins to view all blood test PDFs\n    DROP POLICY IF EXISTS \\"Managers can view all blood tests\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can view all blood tests\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[2] = ''blood-tests''\n    )';\n\n    -- RLS Policy: Allow managers/admins to delete all blood test PDFs\n    DROP POLICY IF EXISTS \\"Managers can delete all blood tests\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can delete all blood tests\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[2] = ''blood-tests''\n    )';\n\n    RAISE NOTICE 'Blood tests storage RLS policies created successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy creation. Enable storage in config.toml and restart Supabase to create policies.';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_blood_tests_storage_policies
20260115000000	{"-- Add active flag to profiles for trainee activation control\nALTER TABLE public.profiles\n  ADD COLUMN IF NOT EXISTS is_active BOOLEAN NOT NULL DEFAULT true","COMMENT ON COLUMN public.profiles.is_active IS 'Whether the user account is active (trainee access gating)'"}	add_profiles_is_active
20260125000002	{"-- =====================================================\n-- Add collection_id to payments table\n-- Created: 2026-01-25\n-- Description: Link payments to collections (optional)\n--              Payments can exist without a collection\n-- =====================================================\n\n-- Add collection_id column to payments table (nullable - payments can exist without a collection)\nALTER TABLE public.payments \nADD COLUMN IF NOT EXISTS collection_id UUID REFERENCES public.collections(id) ON DELETE SET NULL","-- Create index for efficient queries\nCREATE INDEX IF NOT EXISTS idx_payments_collection_id ON public.payments(collection_id)","-- Add comment\nCOMMENT ON COLUMN public.payments.collection_id IS 'Optional link to a collection (גבייה). Payments can exist without a collection.'"}	add_collection_id_to_payments
20260115000001	{"-- =====================================================\n-- Create Internal Knowledge Base Table\n-- Created: 2026-01-15\n-- Description: Internal knowledge base for storing video links and resources\n--              For internal usage by staff/managers (NOT customer-related)\n-- =====================================================\n\n-- Create internal_knowledge_base table\nCREATE TABLE IF NOT EXISTS public.internal_knowledge_base (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    title TEXT NOT NULL,\n    description TEXT,\n    video_url TEXT NOT NULL, -- Video link (URL only, no storage)\n    tags TEXT[] DEFAULT '{}', -- Array of tags for categorization\n    duration INTEGER, -- Duration in seconds (optional)\n    additional_info JSONB DEFAULT '{}'::jsonb, -- Flexible additional metadata\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Create indexes for efficient queries\nCREATE INDEX IF NOT EXISTS idx_internal_kb_created_at ON public.internal_knowledge_base(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_internal_kb_tags ON public.internal_knowledge_base USING GIN (tags)","CREATE INDEX IF NOT EXISTS idx_internal_kb_title ON public.internal_knowledge_base(title)","CREATE INDEX IF NOT EXISTS idx_internal_kb_created_by ON public.internal_knowledge_base(created_by)","-- Create trigger for auto-updating updated_at\nCREATE TRIGGER update_internal_kb_updated_at\n    BEFORE UPDATE ON public.internal_knowledge_base\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- Enable RLS on internal_knowledge_base table\nALTER TABLE public.internal_knowledge_base ENABLE ROW LEVEL SECURITY","-- RLS Policies for internal_knowledge_base\n-- Authenticated users (staff/managers) can read all entries\nDROP POLICY IF EXISTS \\"Authenticated users can read knowledge base\\" ON public.internal_knowledge_base","CREATE POLICY \\"Authenticated users can read knowledge base\\"\n    ON public.internal_knowledge_base FOR SELECT\n    USING (auth.role() = 'authenticated')","-- Authenticated users can insert entries\nDROP POLICY IF EXISTS \\"Authenticated users can insert knowledge base\\" ON public.internal_knowledge_base","CREATE POLICY \\"Authenticated users can insert knowledge base\\"\n    ON public.internal_knowledge_base FOR INSERT\n    WITH CHECK (auth.role() = 'authenticated')","-- Authenticated users can update entries\nDROP POLICY IF EXISTS \\"Authenticated users can update knowledge base\\" ON public.internal_knowledge_base","CREATE POLICY \\"Authenticated users can update knowledge base\\"\n    ON public.internal_knowledge_base FOR UPDATE\n    USING (auth.role() = 'authenticated')\n    WITH CHECK (auth.role() = 'authenticated')","-- Authenticated users can delete entries\nDROP POLICY IF EXISTS \\"Authenticated users can delete knowledge base\\" ON public.internal_knowledge_base","CREATE POLICY \\"Authenticated users can delete knowledge base\\"\n    ON public.internal_knowledge_base FOR DELETE\n    USING (auth.role() = 'authenticated')","-- Add comment to table\nCOMMENT ON TABLE public.internal_knowledge_base IS 'Internal knowledge base for storing video links and resources for staff/managers (NOT customer-related)'","COMMENT ON COLUMN public.internal_knowledge_base.video_url IS 'Video link URL (external link, no storage)'","COMMENT ON COLUMN public.internal_knowledge_base.tags IS 'Array of tags for categorization and filtering'","COMMENT ON COLUMN public.internal_knowledge_base.duration IS 'Duration in seconds (optional)'","COMMENT ON COLUMN public.internal_knowledge_base.additional_info IS 'Flexible JSONB field for additional metadata'"}	create_internal_knowledge_base
20260115000002	{"-- =====================================================\n-- Make video_url optional in internal_knowledge_base\n-- Created: 2026-01-15\n-- Description: Allow video_url to be NULL\n-- =====================================================\n\nALTER TABLE public.internal_knowledge_base \n  ALTER COLUMN video_url DROP NOT NULL"}	make_video_url_optional
20260120000000	{"-- Add customer_id to profiles for trainee/customer linkage\nALTER TABLE public.profiles\n    ADD COLUMN IF NOT EXISTS customer_id UUID REFERENCES public.customers(id) ON DELETE SET NULL","CREATE INDEX IF NOT EXISTS idx_profiles_customer_id ON public.profiles(customer_id)","COMMENT ON COLUMN public.profiles.customer_id IS 'Linked customer for trainee users'","-- Backfill existing links from customers.user_id\nUPDATE public.profiles p\nSET customer_id = c.id\nFROM public.customers c\nWHERE c.user_id = p.id\n  AND p.customer_id IS NULL"}	add_profiles_customer_id
20260120000001	{"-- =====================================================\n-- Add age column alongside birth_date\n-- Created: 2026-01-16\n-- Description: Adds age column to leads table while keeping birth_date\n--              Age can be manually entered, independent of birth_date\n-- =====================================================\n\nSET search_path TO public","-- Step 1: Add age column to leads table (keep birth_date)\nALTER TABLE public.leads \nADD COLUMN IF NOT EXISTS age INTEGER","-- Step 2: Create index for age column\nCREATE INDEX IF NOT EXISTS idx_leads_age ON public.leads(age) WHERE age IS NOT NULL","-- Step 3: Drop and recreate the view to include both birth_date and age\nDROP VIEW IF EXISTS public.v_leads_with_customer CASCADE","CREATE VIEW public.v_leads_with_customer AS\nSELECT \n    l.id,\n    l.created_at,\n    l.updated_at,\n    l.assigned_to,\n    l.customer_id,\n    l.city,\n    l.birth_date,\n    l.age,\n    l.gender,\n    l.status_main,\n    l.status_sub,\n    l.height,\n    l.weight,\n    l.bmi,\n    l.join_date,\n    l.subscription_data,\n    l.daily_protocol,\n    l.workout_history,\n    l.steps_history,\n    l.source,\n    l.fitness_goal,\n    l.activity_level,\n    l.preferred_time,\n    l.notes,\n    -- Customer data (joined)\n    c.full_name as customer_name,\n    c.phone as customer_phone,\n    c.email as customer_email,\n    -- Calculated fields (PostgreSQL does the math)\n    TO_CHAR(l.created_at, 'YYYY-MM-DD') as created_date_formatted,\n    TO_CHAR(l.birth_date, 'YYYY-MM-DD') as birth_date_formatted,\n    -- Extract JSONB fields (PostgreSQL parses JSON)\n    (l.daily_protocol->>'stepsGoal')::INTEGER as daily_steps_goal,\n    (l.daily_protocol->>'workoutGoal')::INTEGER as weekly_workouts,\n    -- Extract supplements array from JSONB (handle both array and null)\n    CASE \n        WHEN l.daily_protocol->'supplements' IS NULL THEN ARRAY[]::TEXT[]\n        WHEN jsonb_typeof(l.daily_protocol->'supplements') = 'array' \n        THEN ARRAY(SELECT jsonb_array_elements_text(l.daily_protocol->'supplements'))\n        ELSE ARRAY[]::TEXT[]\n    END as daily_supplements,\n    (l.subscription_data->>'months')::INTEGER as subscription_months,\n    (l.subscription_data->>'initialPrice')::DECIMAL as subscription_initial_price,\n    (l.subscription_data->>'renewalPrice')::DECIMAL as subscription_renewal_price\nFROM public.leads l\nLEFT JOIN public.customers c ON l.customer_id = c.id","-- Step 7: Update get_filtered_leads function to use age instead of birth_date\nCREATE OR REPLACE FUNCTION public.get_filtered_leads(\n    p_limit_count INTEGER DEFAULT 100,\n    p_offset_count INTEGER DEFAULT 0,\n    p_search_query TEXT DEFAULT NULL,\n    p_status_main TEXT DEFAULT NULL,\n    p_status_sub TEXT DEFAULT NULL,\n    p_source TEXT DEFAULT NULL,\n    p_fitness_goal TEXT DEFAULT NULL,\n    p_activity_level TEXT DEFAULT NULL,\n    p_preferred_time TEXT DEFAULT NULL,\n    p_age TEXT DEFAULT NULL,\n    p_height TEXT DEFAULT NULL,\n    p_weight TEXT DEFAULT NULL,\n    p_date TEXT DEFAULT NULL\n)\nRETURNS TABLE (\n    id UUID,\n    created_at TIMESTAMP WITH TIME ZONE,\n    updated_at TIMESTAMP WITH TIME ZONE,\n    assigned_to UUID,\n    customer_id UUID,\n    city TEXT,\n    birth_date DATE,\n    age INTEGER,\n    gender TEXT,\n    status_main TEXT,\n    status_sub TEXT,\n    height DECIMAL,\n    weight DECIMAL,\n    bmi DECIMAL,\n    join_date TIMESTAMP WITH TIME ZONE,\n    subscription_data JSONB,\n    daily_protocol JSONB,\n    workout_history JSONB,\n    steps_history JSONB,\n    source TEXT,\n    fitness_goal TEXT,\n    activity_level TEXT,\n    preferred_time TEXT,\n    notes TEXT,\n    customer_name TEXT,\n    customer_phone TEXT,\n    customer_email TEXT,\n    created_date_formatted TEXT,\n    birth_date_formatted TEXT,\n    daily_steps_goal INTEGER,\n    weekly_workouts INTEGER,\n    daily_supplements TEXT[],\n    subscription_months INTEGER,\n    subscription_initial_price DECIMAL,\n    subscription_renewal_price DECIMAL\n)\nLANGUAGE plpgsql\nSECURITY DEFINER\nSTABLE\nAS $$\nBEGIN\n    RETURN QUERY\n    SELECT \n        v.id,\n        v.created_at,\n        v.updated_at,\n        v.assigned_to,\n        v.customer_id,\n        v.city,\n        v.birth_date,\n        v.age,\n        v.gender,\n        v.status_main,\n        v.status_sub,\n        v.height,\n        v.weight,\n        v.bmi,\n        v.join_date,\n        v.subscription_data,\n        v.daily_protocol,\n        v.workout_history,\n        v.steps_history,\n        v.source,\n        v.fitness_goal,\n        v.activity_level,\n        v.preferred_time,\n        v.notes,\n        v.customer_name,\n        v.customer_phone,\n        v.customer_email,\n        v.created_date_formatted,\n        v.birth_date_formatted,\n        v.daily_steps_goal,\n        v.weekly_workouts,\n        v.daily_supplements,\n        v.subscription_months,\n        v.subscription_initial_price,\n        v.subscription_renewal_price\n    FROM public.v_leads_with_customer v\n    WHERE \n        -- Search query (name, phone, email)\n        (p_search_query IS NULL OR \n         v.customer_name ILIKE '%' || p_search_query || '%' OR\n         v.customer_phone ILIKE '%' || p_search_query || '%' OR\n         v.customer_email ILIKE '%' || p_search_query || '%')\n        -- Status filter\n        AND (p_status_main IS NULL OR v.status_main = p_status_main)\n        AND (p_status_sub IS NULL OR v.status_sub = p_status_sub)\n        -- Source filter\n        AND (p_source IS NULL OR v.source = p_source)\n        -- Fitness goal filter\n        AND (p_fitness_goal IS NULL OR v.fitness_goal = p_fitness_goal)\n        -- Activity level filter\n        AND (p_activity_level IS NULL OR v.activity_level = p_activity_level)\n        -- Preferred time filter\n        AND (p_preferred_time IS NULL OR v.preferred_time = p_preferred_time)\n        -- Age filter (now using age column directly)\n        AND (p_age IS NULL OR v.age::TEXT = p_age)\n        -- Height filter\n        AND (p_height IS NULL OR v.height::TEXT = p_height)\n        -- Weight filter\n        AND (p_weight IS NULL OR v.weight::TEXT = p_weight)\n        -- Date filter (created_at date)\n        AND (p_date IS NULL OR v.created_date_formatted = p_date)\n    ORDER BY v.created_at DESC\n    LIMIT p_limit_count\n    OFFSET p_offset_count;\nEND;\n$$","-- Step 8: Update get_lead_filter_options function to use age column\nCREATE OR REPLACE FUNCTION public.get_lead_filter_options()\nRETURNS JSONB\nLANGUAGE plpgsql\nSECURITY DEFINER\nSTABLE\nAS $$\nDECLARE\n    result JSONB;\nBEGIN\n    SELECT jsonb_build_object(\n        'statuses', ARRAY(SELECT DISTINCT status_main FROM public.leads WHERE status_main IS NOT NULL ORDER BY status_main)::TEXT[],\n        'sources', ARRAY(SELECT DISTINCT source FROM public.leads WHERE source IS NOT NULL ORDER BY source)::TEXT[],\n        'fitness_goals', ARRAY(SELECT DISTINCT fitness_goal FROM public.leads WHERE fitness_goal IS NOT NULL ORDER BY fitness_goal)::TEXT[],\n        'activity_levels', ARRAY(SELECT DISTINCT activity_level FROM public.leads WHERE activity_level IS NOT NULL ORDER BY activity_level)::TEXT[],\n        'preferred_times', ARRAY(SELECT DISTINCT preferred_time FROM public.leads WHERE preferred_time IS NOT NULL ORDER BY preferred_time)::TEXT[],\n        'ages', ARRAY(SELECT DISTINCT age::TEXT \n                      FROM public.leads \n                      WHERE age IS NOT NULL \n                      ORDER BY age)::TEXT[],\n        'heights', ARRAY(SELECT DISTINCT height::TEXT \n                         FROM public.leads \n                         WHERE height IS NOT NULL \n                         ORDER BY height)::TEXT[],\n        'weights', ARRAY(SELECT DISTINCT weight::TEXT \n                         FROM public.leads \n                         WHERE weight IS NOT NULL \n                         ORDER BY weight)::TEXT[]\n    ) INTO result;\n    \n    RETURN result;\nEND;\n$$","-- Step 9: Update comments\nCOMMENT ON COLUMN public.leads.age IS 'Age in years. Can be manually entered, independent of birth_date.'","COMMENT ON COLUMN public.leads.birth_date IS 'Birth date. Can be entered manually, independent of age.'","COMMENT ON VIEW public.v_leads_with_customer IS 'Pre-joined view of leads with customer data and calculated fields. Includes both birth_date and age columns.'","COMMENT ON FUNCTION public.get_filtered_leads(INTEGER, INTEGER, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT) IS 'RPC function for complex lead filtering. All filtering happens in PostgreSQL. Includes both birth_date and age columns.'","COMMENT ON FUNCTION public.get_lead_filter_options() IS 'Returns distinct filter values for dropdowns. Uses age column directly.'"}	replace_birth_date_with_age
20260120000002	{"-- =====================================================\n-- Add period boolean field to leads table\n-- Created: 2026-01-20\n-- Description: Adds period field to personal information section\n--              This is a boolean field to track menstrual period status\n-- =====================================================\n\nSET search_path TO public","-- Add period column to leads table\nALTER TABLE public.leads \nADD COLUMN IF NOT EXISTS period BOOLEAN DEFAULT NULL","-- Create index for period column\nCREATE INDEX IF NOT EXISTS idx_leads_period ON public.leads(period) WHERE period IS NOT NULL","-- Update the view to include period field\nDROP VIEW IF EXISTS public.v_leads_with_customer CASCADE","CREATE VIEW public.v_leads_with_customer AS\nSELECT \n    l.id,\n    l.created_at,\n    l.updated_at,\n    l.assigned_to,\n    l.customer_id,\n    l.city,\n    l.birth_date,\n    l.age,\n    l.gender,\n    l.period,\n    l.status_main,\n    l.status_sub,\n    l.height,\n    l.weight,\n    l.bmi,\n    l.join_date,\n    l.subscription_data,\n    l.daily_protocol,\n    l.workout_history,\n    l.steps_history,\n    l.source,\n    l.fitness_goal,\n    l.activity_level,\n    l.preferred_time,\n    l.notes,\n    -- Customer data (joined)\n    c.full_name as customer_name,\n    c.phone as customer_phone,\n    c.email as customer_email,\n    -- Calculated fields (PostgreSQL does the math)\n    TO_CHAR(l.created_at, 'YYYY-MM-DD') as created_date_formatted,\n    TO_CHAR(l.birth_date, 'YYYY-MM-DD') as birth_date_formatted,\n    -- Extract JSONB fields (PostgreSQL parses JSON)\n    (l.daily_protocol->>'stepsGoal')::INTEGER as daily_steps_goal,\n    (l.daily_protocol->>'workoutGoal')::INTEGER as weekly_workouts,\n    -- Extract supplements array from JSONB (handle both array and null)\n    CASE \n        WHEN l.daily_protocol->'supplements' IS NULL THEN ARRAY[]::TEXT[]\n        WHEN jsonb_typeof(l.daily_protocol->'supplements') = 'array' \n        THEN ARRAY(SELECT jsonb_array_elements_text(l.daily_protocol->'supplements'))\n        ELSE ARRAY[]::TEXT[]\n    END as daily_supplements,\n    (l.subscription_data->>'months')::INTEGER as subscription_months,\n    (l.subscription_data->>'initialPrice')::DECIMAL as subscription_initial_price,\n    (l.subscription_data->>'renewalPrice')::DECIMAL as subscription_renewal_price\nFROM public.leads l\nLEFT JOIN public.customers c ON l.customer_id = c.id","-- Grant permissions on the view\nGRANT SELECT ON public.v_leads_with_customer TO authenticated","GRANT SELECT ON public.v_leads_with_customer TO anon"}	add_period_field
20260120000003	{"-- =====================================================\n-- Add currency field to subscription_types table\n-- Created: 2026-01-20\n-- Description: Adds currency column to subscription types\n--              Supports ILS, USD, EUR currencies\n--              Defaults to 'ILS' for backward compatibility\n-- =====================================================\n\nSET search_path TO public","-- Add currency column to subscription_types table\nALTER TABLE public.subscription_types \nADD COLUMN IF NOT EXISTS currency TEXT DEFAULT 'ILS' NOT NULL CHECK (currency IN ('ILS', 'USD', 'EUR'))","-- Create index for currency column\nCREATE INDEX IF NOT EXISTS idx_subscription_types_currency ON public.subscription_types(currency)","-- Update comment for price column\nCOMMENT ON COLUMN public.subscription_types.price IS 'Price amount (value varies based on currency)'","COMMENT ON COLUMN public.subscription_types.currency IS 'Currency code: ILS (Israeli Shekel), USD (US Dollar), or EUR (Euro)'"}	add_currency_to_subscription_types
20260120000004	{"-- Create notifications table for real-time activity tracking\n-- This table stores notifications for admin users when trainees perform actions\n\nCREATE TABLE IF NOT EXISTS notifications (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n  customer_id UUID REFERENCES customers(id) ON DELETE CASCADE,\n  lead_id UUID REFERENCES leads(id) ON DELETE SET NULL,\n  type TEXT NOT NULL, -- e.g., 'weight_updated', 'meal_logged', 'check_in_completed', etc.\n  title TEXT NOT NULL, -- e.g., \\"עדכון משקל\\"\n  message TEXT NOT NULL, -- e.g., \\"יוסי כהן עדכן את המשקל ל-75 ק״ג\\"\n  action_url TEXT, -- URL to navigate when clicking notification (e.g., \\"/customers/{customer_id}\\")\n  is_read BOOLEAN DEFAULT FALSE,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  read_at TIMESTAMPTZ,\n  \n  -- Metadata for additional context\n  metadata JSONB DEFAULT '{}'::jsonb\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_notifications_user_id ON notifications(user_id)","CREATE INDEX IF NOT EXISTS idx_notifications_user_read ON notifications(user_id, is_read)","CREATE INDEX IF NOT EXISTS idx_notifications_created_at ON notifications(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_notifications_customer_id ON notifications(customer_id)","CREATE INDEX IF NOT EXISTS idx_notifications_lead_id ON notifications(lead_id)","-- RLS Policies\nALTER TABLE notifications ENABLE ROW LEVEL SECURITY","-- Policy: Users can only see their own notifications\nCREATE POLICY \\"Users can view their own notifications\\"\n  ON notifications\n  FOR SELECT\n  USING (auth.uid() = user_id)","-- Policy: System can create notifications for any user\n-- (This will be used by Edge Functions or service role)\nCREATE POLICY \\"Service role can create notifications\\"\n  ON notifications\n  FOR INSERT\n  WITH CHECK (true)","-- Policy: Users can update their own notifications (mark as read)\nCREATE POLICY \\"Users can update their own notifications\\"\n  ON notifications\n  FOR UPDATE\n  USING (auth.uid() = user_id)\n  WITH CHECK (auth.uid() = user_id)","-- Function to mark notification as read\nCREATE OR REPLACE FUNCTION mark_notification_read(notification_id UUID)\nRETURNS void\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nBEGIN\n  UPDATE notifications\n  SET is_read = TRUE,\n      read_at = NOW()\n  WHERE id = notification_id\n    AND user_id = auth.uid();\nEND;\n$$","-- Function to mark all notifications as read for a user\nCREATE OR REPLACE FUNCTION mark_all_notifications_read()\nRETURNS void\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nBEGIN\n  UPDATE notifications\n  SET is_read = TRUE,\n      read_at = NOW()\n  WHERE user_id = auth.uid()\n    AND is_read = FALSE;\nEND;\n$$","-- Function to get unread notification count\nCREATE OR REPLACE FUNCTION get_unread_notification_count()\nRETURNS INTEGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nAS $$\nDECLARE\n  count INTEGER;\nBEGIN\n  SELECT COUNT(*)::INTEGER\n  INTO count\n  FROM notifications\n  WHERE user_id = auth.uid()\n    AND is_read = FALSE;\n  \n  RETURN COALESCE(count, 0);\nEND;\n$$","-- Grant execute permissions\nGRANT EXECUTE ON FUNCTION mark_notification_read(UUID) TO authenticated","GRANT EXECUTE ON FUNCTION mark_all_notifications_read() TO authenticated","GRANT EXECUTE ON FUNCTION get_unread_notification_count() TO authenticated","-- Comments\nCOMMENT ON TABLE notifications IS 'Stores real-time notifications for admin users about trainee activities'","COMMENT ON COLUMN notifications.type IS 'Type of notification: weight_updated, meal_logged, check_in_completed, etc.'","COMMENT ON COLUMN notifications.action_url IS 'URL to navigate when clicking the notification'","COMMENT ON COLUMN notifications.metadata IS 'Additional context data in JSON format'"}	create_notifications
20260120000005	{"-- =====================================================\n-- Fix templates folder storage RLS policies\n-- Created: 2026-01-20\n-- Description: Updates RLS policies for templates folder to use more reliable path matching\n--              Replaces storage.foldername(name)[1] with starts_with() for better reliability\n-- This migration must be the LAST one in the list for migration up to work correctly\n-- =====================================================\n\n-- Only update policies if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- Drop existing policies\n    DROP POLICY IF EXISTS \\"Managers can upload template files\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can view template files\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can delete template files\\" ON storage.objects;\n\n    -- RLS Policy: Allow authenticated users (managers/admins) to upload template files\n    -- Path structure: templates/{user_id}/{flow_key}/{filename}\n    -- Using starts_with() for more reliable path matching\n    CREATE POLICY \\"Managers can upload template files\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = 'client-assets' AND\n      name LIKE 'templates/%' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- RLS Policy: Allow authenticated users (managers/admins) to view template files\n    CREATE POLICY \\"Managers can view template files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      name LIKE 'templates/%' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- RLS Policy: Allow authenticated users (managers/admins) to delete template files\n    CREATE POLICY \\"Managers can delete template files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      name LIKE 'templates/%' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    RAISE NOTICE 'Storage RLS policies for templates folder updated successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy update. Enable storage in config.toml and restart Supabase.';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_templates_storage_rls
20260120000006	{"-- =====================================================\n-- Add Manual Override Fields to Nutrition Templates\n-- Created: 2026-01-20\n-- Description: Adds manual override state tracking and new fields (steps, workouts, supplements)\n--              to allow professional users to set values manually without auto-calculation\n-- This migration must be the LAST one in the list for migration up to work correctly\n-- =====================================================\n\n-- Add manual override tracking and new fields to nutrition_templates\nALTER TABLE nutrition_templates\n  ADD COLUMN IF NOT EXISTS manual_override JSONB DEFAULT '{}'::jsonb,\n  -- Structure: { calories: boolean, protein: boolean, carbs: boolean, fat: boolean, fiber: boolean }\n  -- Tracks which fields have been manually overridden\n  ADD COLUMN IF NOT EXISTS manual_fields JSONB DEFAULT '{}'::jsonb","-- Structure: { steps: number | null, workouts: text | null, supplements: text | null }\n  -- Stores manual fields: steps, workouts, supplements\n\n-- Add comment\nCOMMENT ON COLUMN nutrition_templates.manual_override IS 'JSONB tracking which macro/calorie fields have been manually overridden: { calories: boolean, protein: boolean, carbs: boolean, fat: boolean, fiber: boolean }'","COMMENT ON COLUMN nutrition_templates.manual_fields IS 'JSONB storing manual fields: { steps: number | null, workouts: text | null, supplements: text | null }'","-- Create GIN index for manual_override JSONB column (enables fast queries on JSONB data)\nCREATE INDEX IF NOT EXISTS idx_nutrition_templates_manual_override ON nutrition_templates USING GIN (manual_override)","CREATE INDEX IF NOT EXISTS idx_nutrition_templates_manual_fields ON nutrition_templates USING GIN (manual_fields)","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_manual_override_fields_to_nutrition_templates
20260121000000	{"-- =====================================================\n-- Ensure Storage Bucket is Private\n-- Created: 2026-01-21\n-- Description: Ensures the client-assets bucket is private (public = false)\n--              This migration ensures all files require signed URLs for access\n--              Only admin/worker roles can view all files, regular users can only view their own\n-- This migration must be the LAST one in the list for migration up to work correctly\n-- =====================================================\n\n-- Ensure storage bucket is private (idempotent)\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'buckets'\n  ) THEN\n    -- Update bucket to ensure it's private (public = false)\n    -- This ensures all files require signed URLs for access\n    UPDATE storage.buckets\n    SET public = false\n    WHERE id = 'client-assets' AND public = true;\n    \n    -- If bucket doesn't exist, create it as private\n    INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)\n    VALUES (\n      'client-assets',\n      'client-assets',\n      false, -- private bucket (uses signed URLs)\n      52428800, -- 50MB file size limit (in bytes) - matches config.toml\n      ARRAY[\n        'image/jpeg',\n        'image/jpg', \n        'image/png',\n        'image/gif',\n        'image/webp',\n        'video/mp4',\n        'video/mpeg',\n        'video/quicktime',\n        'application/pdf',\n        'application/msword',\n        'application/vnd.openxmlformats-officedocument.wordprocessingml.document'\n      ]::text[]\n    )\n    ON CONFLICT (id) DO UPDATE SET\n      public = false, -- Always ensure private\n      file_size_limit = EXCLUDED.file_size_limit,\n      allowed_mime_types = EXCLUDED.allowed_mime_types;\n    \n    RAISE NOTICE 'Storage bucket \\"client-assets\\" is now private (requires signed URLs)';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping bucket update. Enable storage in config.toml and restart Supabase.';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	ensure_storage_bucket_is_private
20260121000001	{"-- =====================================================\n-- Fix workout-exercises folder storage RLS policies\n-- Created: 2026-01-21\n-- Description: Updates RLS policies for workout-exercises folder to use more reliable path matching\n--              Replaces storage.foldername(name)[1] with LIKE pattern for better reliability\n--              Path structure: workout-exercises/{exercise_id}/images/{filename} or workout-exercises/{exercise_id}/videos/{filename}\n-- This migration must be the LAST one in the list for migration up to work correctly\n-- =====================================================\n\n-- Only update policies if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- Drop existing policies\n    DROP POLICY IF EXISTS \\"Managers can upload workout exercise media\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can view workout exercise media\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can delete workout exercise media\\" ON storage.objects;\n\n    -- RLS Policy: Allow authenticated users (managers/admins) to upload workout exercise media\n    -- Path structure: workout-exercises/{exercise_id}/images/{filename} or workout-exercises/{exercise_id}/videos/{filename}\n    -- Using LIKE pattern for more reliable path matching\n    CREATE POLICY \\"Managers can upload workout exercise media\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = 'client-assets' AND\n      name LIKE 'workout-exercises/%' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- RLS Policy: Allow authenticated users (managers/admins) to view workout exercise media\n    CREATE POLICY \\"Managers can view workout exercise media\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      name LIKE 'workout-exercises/%' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- RLS Policy: Allow authenticated users (managers/admins) to delete workout exercise media\n    CREATE POLICY \\"Managers can delete workout exercise media\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      name LIKE 'workout-exercises/%' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    RAISE NOTICE 'Storage RLS policies for workout-exercises folder updated successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy update. Enable storage in config.toml and restart Supabase.';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_workout_exercises_storage_rls
20260121000002	{"-- =====================================================\n-- Add Duration Unit to Subscription Types\n-- Created: 2026-01-21\n-- Description: Allow subscription types to specify duration in days, weeks, or months\n-- =====================================================\n\n-- Add duration_unit column with default 'months' for backward compatibility\nALTER TABLE subscription_types\nADD COLUMN IF NOT EXISTS duration_unit TEXT NOT NULL DEFAULT 'months'\nCHECK (duration_unit IN ('days', 'weeks', 'months'))","-- Update comment on duration column\nCOMMENT ON COLUMN subscription_types.duration IS 'Duration value (interpreted based on duration_unit)'","COMMENT ON COLUMN subscription_types.duration_unit IS 'Unit for duration: days, weeks, or months'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_duration_unit_to_subscription_types
20260121000003	{"-- =====================================================\n-- Add 'payments' to saved_views resource_key constraint\n-- Created: 2026-01-21\n-- Description: Allow saved views for payments (Tashlumim)\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'payments'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates', 'budgets', 'meetings', 'check_in_settings', 'payments'))","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_payments_to_saved_views
20260121000004	{"-- =====================================================\n-- Migration: Create Fillout Submissions Table\n-- Created: 2026-01-21\n-- Description: Stores all Fillout form submissions with submission type for easy categorization\n-- =====================================================\n\n-- Create fillout_submissions table\nCREATE TABLE IF NOT EXISTS public.fillout_submissions (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  fillout_submission_id TEXT NOT NULL UNIQUE, -- Unique identifier from Fillout\n  fillout_form_id TEXT NOT NULL, -- Form ID from Fillout\n  submission_type TEXT, -- Type of submission (e.g., 'meeting', 'questionnaire', etc.)\n  submission_data JSONB NOT NULL DEFAULT '{}'::jsonb, -- Flexible JSONB to store all form data\n  lead_id UUID REFERENCES public.leads(id) ON DELETE SET NULL,\n  customer_id UUID REFERENCES public.customers(id) ON DELETE SET NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Add indexes\nCREATE INDEX IF NOT EXISTS idx_fillout_submissions_fillout_submission_id ON public.fillout_submissions(fillout_submission_id)","CREATE INDEX IF NOT EXISTS idx_fillout_submissions_fillout_form_id ON public.fillout_submissions(fillout_form_id)","CREATE INDEX IF NOT EXISTS idx_fillout_submissions_submission_type ON public.fillout_submissions(submission_type)","CREATE INDEX IF NOT EXISTS idx_fillout_submissions_lead_id ON public.fillout_submissions(lead_id)","CREATE INDEX IF NOT EXISTS idx_fillout_submissions_customer_id ON public.fillout_submissions(customer_id)","CREATE INDEX IF NOT EXISTS idx_fillout_submissions_created_at ON public.fillout_submissions(created_at DESC)","-- Add RLS policies\nALTER TABLE public.fillout_submissions ENABLE ROW LEVEL SECURITY","-- Policy: Managers can view all submissions\nCREATE POLICY \\"Managers can view all fillout submissions\\"\n  ON public.fillout_submissions\n  FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Policy: Managers can insert submissions\nCREATE POLICY \\"Managers can insert fillout submissions\\"\n  ON public.fillout_submissions\n  FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Policy: Managers can update submissions\nCREATE POLICY \\"Managers can update fillout submissions\\"\n  ON public.fillout_submissions\n  FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Policy: Managers can delete submissions\nCREATE POLICY \\"Managers can delete fillout submissions\\"\n  ON public.fillout_submissions\n  FOR DELETE\n  USING (\n    EXISTS (\n      SELECT 1 FROM auth.users\n      WHERE auth.users.id = auth.uid()\n      AND auth.users.raw_user_meta_data->>'role' = 'manager'\n    )\n  )","-- Policy: Allow service role (edge functions) to insert/update submissions\nCREATE POLICY \\"Service role can manage fillout submissions\\"\n  ON public.fillout_submissions\n  FOR ALL\n  USING (auth.role() = 'service_role')\n  WITH CHECK (auth.role() = 'service_role')","-- Create function to update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_fillout_submissions_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Create trigger to automatically update updated_at\nCREATE TRIGGER update_fillout_submissions_updated_at\n  BEFORE UPDATE ON public.fillout_submissions\n  FOR EACH ROW\n  EXECUTE FUNCTION update_fillout_submissions_updated_at()","-- Add comments\nCOMMENT ON TABLE public.fillout_submissions IS 'Stores all Fillout form submissions with type for easy categorization'","COMMENT ON COLUMN public.fillout_submissions.fillout_submission_id IS 'Unique identifier from Fillout submission'","COMMENT ON COLUMN public.fillout_submissions.fillout_form_id IS 'Form ID from Fillout'","COMMENT ON COLUMN public.fillout_submissions.submission_type IS 'Type of submission (e.g., meeting, questionnaire) - extracted from form submission'","COMMENT ON COLUMN public.fillout_submissions.submission_data IS 'Flexible JSONB containing all form submission data'","COMMENT ON COLUMN public.fillout_submissions.lead_id IS 'Link to the lead that the submission is associated with'","COMMENT ON COLUMN public.fillout_submissions.customer_id IS 'Link to the customer that the submission is associated with'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_fillout_submissions
20260121000005	{"-- =====================================================\n-- Migration: Add Pagination, Sorting, and Group By to Leads\n-- Created: 2026-01-21\n-- Description: Adds server-side pagination, sorting, and grouping support to get_filtered_leads RPC function\n--              Also adds separate get_filtered_leads_count function for total count\n-- =====================================================\n\n-- Step 1: Update get_filtered_leads function to support sorting and grouping\nCREATE OR REPLACE FUNCTION public.get_filtered_leads(\n    p_limit_count INTEGER DEFAULT 100,\n    p_offset_count INTEGER DEFAULT 0,\n    p_search_query TEXT DEFAULT NULL,\n    p_status_main TEXT DEFAULT NULL,\n    p_status_sub TEXT DEFAULT NULL,\n    p_source TEXT DEFAULT NULL,\n    p_fitness_goal TEXT DEFAULT NULL,\n    p_activity_level TEXT DEFAULT NULL,\n    p_preferred_time TEXT DEFAULT NULL,\n    p_age TEXT DEFAULT NULL,\n    p_height TEXT DEFAULT NULL,\n    p_weight TEXT DEFAULT NULL,\n    p_date TEXT DEFAULT NULL,\n    -- New parameters for sorting\n    p_sort_by TEXT DEFAULT 'created_at',\n    p_sort_order TEXT DEFAULT 'DESC',\n    -- New parameters for grouping (level 1 and level 2)\n    p_group_by_level1 TEXT DEFAULT NULL,\n    p_group_by_level2 TEXT DEFAULT NULL\n)\nRETURNS TABLE (\n    id UUID,\n    created_at TIMESTAMP WITH TIME ZONE,\n    updated_at TIMESTAMP WITH TIME ZONE,\n    assigned_to UUID,\n    customer_id UUID,\n    city TEXT,\n    birth_date DATE,\n    age INTEGER,\n    gender TEXT,\n    status_main TEXT,\n    status_sub TEXT,\n    height DECIMAL,\n    weight DECIMAL,\n    bmi DECIMAL,\n    join_date TIMESTAMP WITH TIME ZONE,\n    subscription_data JSONB,\n    daily_protocol JSONB,\n    workout_history JSONB,\n    steps_history JSONB,\n    source TEXT,\n    fitness_goal TEXT,\n    activity_level TEXT,\n    preferred_time TEXT,\n    notes TEXT,\n    customer_name TEXT,\n    customer_phone TEXT,\n    customer_email TEXT,\n    created_date_formatted TEXT,\n    birth_date_formatted TEXT,\n    daily_steps_goal INTEGER,\n    weekly_workouts INTEGER,\n    daily_supplements TEXT[],\n    subscription_months INTEGER,\n    subscription_initial_price DECIMAL,\n    subscription_renewal_price DECIMAL\n)\nLANGUAGE plpgsql\nSECURITY DEFINER\nSTABLE\nAS $$\nDECLARE\n    v_sort_direction TEXT;\n    v_order_by_clause TEXT;\nBEGIN\n    -- Validate sort_order (must be ASC or DESC)\n    v_sort_direction := UPPER(COALESCE(NULLIF(p_sort_order, ''), 'DESC'));\n    IF v_sort_direction NOT IN ('ASC', 'DESC') THEN\n        v_sort_direction := 'DESC';\n    END IF;\n\n    -- Build ORDER BY clause - start with grouping columns, then sorting column\n    v_order_by_clause := '';\n    \n    -- Add grouping columns to ORDER BY (for grouping in frontend, ensures groups are sorted together)\n    IF p_group_by_level1 IS NOT NULL THEN\n        v_order_by_clause := v_order_by_clause || CASE \n            WHEN p_group_by_level1 = 'status' OR p_group_by_level1 = 'status_main' THEN 'v.status_main ASC, '\n            WHEN p_group_by_level1 = 'source' THEN 'v.source ASC, '\n            WHEN p_group_by_level1 = 'fitnessGoal' OR p_group_by_level1 = 'fitness_goal' THEN 'v.fitness_goal ASC, '\n            WHEN p_group_by_level1 = 'activityLevel' OR p_group_by_level1 = 'activity_level' THEN 'v.activity_level ASC, '\n            WHEN p_group_by_level1 = 'preferredTime' OR p_group_by_level1 = 'preferred_time' THEN 'v.preferred_time ASC, '\n            WHEN p_group_by_level1 = 'name' OR p_group_by_level1 = 'customer_name' THEN 'v.customer_name ASC, '\n            WHEN p_group_by_level1 = 'age' THEN 'v.age ASC, '\n            WHEN p_group_by_level1 = 'height' THEN 'v.height ASC, '\n            WHEN p_group_by_level1 = 'weight' THEN 'v.weight ASC, '\n            ELSE ''\n        END;\n    END IF;\n    \n    IF p_group_by_level2 IS NOT NULL THEN\n        v_order_by_clause := v_order_by_clause || CASE \n            WHEN p_group_by_level2 = 'status' OR p_group_by_level2 = 'status_main' THEN 'v.status_main ASC, '\n            WHEN p_group_by_level2 = 'source' THEN 'v.source ASC, '\n            WHEN p_group_by_level2 = 'fitnessGoal' OR p_group_by_level2 = 'fitness_goal' THEN 'v.fitness_goal ASC, '\n            WHEN p_group_by_level2 = 'activityLevel' OR p_group_by_level2 = 'activity_level' THEN 'v.activity_level ASC, '\n            WHEN p_group_by_level2 = 'preferredTime' OR p_group_by_level2 = 'preferred_time' THEN 'v.preferred_time ASC, '\n            WHEN p_group_by_level2 = 'name' OR p_group_by_level2 = 'customer_name' THEN 'v.customer_name ASC, '\n            WHEN p_group_by_level2 = 'age' THEN 'v.age ASC, '\n            WHEN p_group_by_level2 = 'height' THEN 'v.height ASC, '\n            WHEN p_group_by_level2 = 'weight' THEN 'v.weight ASC, '\n            ELSE ''\n        END;\n    END IF;\n    \n    -- Add main sorting column\n    v_order_by_clause := v_order_by_clause || CASE \n        WHEN p_sort_by = 'createdDate' OR p_sort_by = 'created_date' OR p_sort_by = 'created_at' THEN 'v.created_at ' || v_sort_direction\n        WHEN p_sort_by = 'name' OR p_sort_by = 'customer_name' THEN 'v.customer_name ' || v_sort_direction\n        WHEN p_sort_by = 'status' OR p_sort_by = 'status_main' THEN 'v.status_main ' || v_sort_direction\n        WHEN p_sort_by = 'phone' OR p_sort_by = 'customer_phone' THEN 'v.customer_phone ' || v_sort_direction\n        WHEN p_sort_by = 'email' OR p_sort_by = 'customer_email' THEN 'v.customer_email ' || v_sort_direction\n        WHEN p_sort_by = 'source' THEN 'v.source ' || v_sort_direction\n        WHEN p_sort_by = 'age' THEN 'v.age ' || v_sort_direction\n        WHEN p_sort_by = 'height' THEN 'v.height ' || v_sort_direction\n        WHEN p_sort_by = 'weight' THEN 'v.weight ' || v_sort_direction\n        WHEN p_sort_by = 'fitnessGoal' OR p_sort_by = 'fitness_goal' THEN 'v.fitness_goal ' || v_sort_direction\n        WHEN p_sort_by = 'activityLevel' OR p_sort_by = 'activity_level' THEN 'v.activity_level ' || v_sort_direction\n        WHEN p_sort_by = 'preferredTime' OR p_sort_by = 'preferred_time' THEN 'v.preferred_time ' || v_sort_direction\n        WHEN p_sort_by = 'notes' THEN 'v.notes ' || v_sort_direction\n        ELSE 'v.created_at ' || v_sort_direction -- Default fallback\n    END;\n\n    -- Execute query with dynamic ORDER BY using EXECUTE (safe with validated inputs)\n    RETURN QUERY\n    EXECUTE format('\n        SELECT \n            v.id,\n            v.created_at,\n            v.updated_at,\n            v.assigned_to,\n            v.customer_id,\n            v.city,\n            v.birth_date,\n            v.age,\n            v.gender,\n            v.status_main,\n            v.status_sub,\n            v.height,\n            v.weight,\n            v.bmi,\n            v.join_date,\n            v.subscription_data,\n            v.daily_protocol,\n            v.workout_history,\n            v.steps_history,\n            v.source,\n            v.fitness_goal,\n            v.activity_level,\n            v.preferred_time,\n            v.notes,\n            v.customer_name,\n            v.customer_phone,\n            v.customer_email,\n            v.created_date_formatted,\n            v.birth_date_formatted,\n            v.daily_steps_goal,\n            v.weekly_workouts,\n            v.daily_supplements,\n            v.subscription_months,\n            v.subscription_initial_price,\n            v.subscription_renewal_price\n        FROM public.v_leads_with_customer v\n        WHERE \n            -- Search query (name, phone, email)\n            ($1 IS NULL OR \n             v.customer_name ILIKE ''%%'' || $1 || ''%%'' OR\n             v.customer_phone ILIKE ''%%'' || $1 || ''%%'' OR\n             v.customer_email ILIKE ''%%'' || $1 || ''%%'')\n            -- Status filter\n            AND ($2 IS NULL OR v.status_main = $2)\n            AND ($3 IS NULL OR v.status_sub = $3)\n            -- Source filter\n            AND ($4 IS NULL OR v.source = $4)\n            -- Fitness goal filter\n            AND ($5 IS NULL OR v.fitness_goal = $5)\n            -- Activity level filter\n            AND ($6 IS NULL OR v.activity_level = $6)\n            -- Preferred time filter\n            AND ($7 IS NULL OR v.preferred_time = $7)\n            -- Age filter\n            AND ($8 IS NULL OR v.age::TEXT = $8)\n            -- Height filter\n            AND ($9 IS NULL OR v.height::TEXT = $9)\n            -- Weight filter\n            AND ($10 IS NULL OR v.weight::TEXT = $10)\n            -- Date filter (created_at date)\n            AND ($11 IS NULL OR v.created_date_formatted = $11)\n        ORDER BY %s\n        LIMIT $12\n        OFFSET $13\n    ', v_order_by_clause)\n    USING \n        p_search_query,\n        p_status_main,\n        p_status_sub,\n        p_source,\n        p_fitness_goal,\n        p_activity_level,\n        p_preferred_time,\n        p_age,\n        p_height,\n        p_weight,\n        p_date,\n        p_limit_count,\n        p_offset_count;\nEND;\n$$","-- Step 2: Create separate count function for total leads matching filters\nCREATE OR REPLACE FUNCTION public.get_filtered_leads_count(\n    p_search_query TEXT DEFAULT NULL,\n    p_status_main TEXT DEFAULT NULL,\n    p_status_sub TEXT DEFAULT NULL,\n    p_source TEXT DEFAULT NULL,\n    p_fitness_goal TEXT DEFAULT NULL,\n    p_activity_level TEXT DEFAULT NULL,\n    p_preferred_time TEXT DEFAULT NULL,\n    p_age TEXT DEFAULT NULL,\n    p_height TEXT DEFAULT NULL,\n    p_weight TEXT DEFAULT NULL,\n    p_date TEXT DEFAULT NULL\n)\nRETURNS INTEGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSTABLE\nAS $$\nDECLARE\n    v_count INTEGER;\nBEGIN\n    SELECT COUNT(*)::INTEGER INTO v_count\n    FROM public.v_leads_with_customer v\n    WHERE \n        -- Search query (name, phone, email)\n        (p_search_query IS NULL OR \n         v.customer_name ILIKE '%' || p_search_query || '%' OR\n         v.customer_phone ILIKE '%' || p_search_query || '%' OR\n         v.customer_email ILIKE '%' || p_search_query || '%')\n        -- Status filter\n        AND (p_status_main IS NULL OR v.status_main = p_status_main)\n        AND (p_status_sub IS NULL OR v.status_sub = p_status_sub)\n        -- Source filter\n        AND (p_source IS NULL OR v.source = p_source)\n        -- Fitness goal filter\n        AND (p_fitness_goal IS NULL OR v.fitness_goal = p_fitness_goal)\n        -- Activity level filter\n        AND (p_activity_level IS NULL OR v.activity_level = p_activity_level)\n        -- Preferred time filter\n        AND (p_preferred_time IS NULL OR v.preferred_time = p_preferred_time)\n        -- Age filter\n        AND (p_age IS NULL OR v.age::TEXT = p_age)\n        -- Height filter\n        AND (p_height IS NULL OR v.height::TEXT = p_height)\n        -- Weight filter\n        AND (p_weight IS NULL OR v.weight::TEXT = p_weight)\n        -- Date filter (created_at date)\n        AND (p_date IS NULL OR v.created_date_formatted = p_date);\n\n    RETURN COALESCE(v_count, 0);\nEND;\n$$","-- Step 3: Grant execute permissions\nGRANT EXECUTE ON FUNCTION public.get_filtered_leads(INTEGER, INTEGER, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT) TO authenticated","GRANT EXECUTE ON FUNCTION public.get_filtered_leads_count(TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT) TO authenticated","-- Step 4: Update comments\nCOMMENT ON FUNCTION public.get_filtered_leads(INTEGER, INTEGER, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT) IS 'RPC function for complex lead filtering with server-side pagination, sorting, and grouping support. All filtering happens in PostgreSQL.'","COMMENT ON FUNCTION public.get_filtered_leads_count(TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT) IS 'Returns total count of leads matching the filter criteria. Used for pagination to calculate total pages.'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_pagination_sorting_groupby_to_leads
20260121000006	{"-- =====================================================\n-- Add Activity Entries and Ensure Manual Fields to Nutrition Templates\n-- Created: 2026-01-21\n-- Description: Adds activity_entries column for METs calculation data\n--              Also ensures manual_override and manual_fields columns exist (in case previous migration wasn't run)\n-- This migration must be the LAST one in the list for migration up to work correctly\n-- =====================================================\n\n-- Ensure manual_override column exists (in case previous migration wasn't run)\n-- Structure: { calories: boolean, protein: boolean, carbs: boolean, fat: boolean, fiber: boolean }\n-- Tracks which fields have been manually overridden\nALTER TABLE nutrition_templates\n  ADD COLUMN IF NOT EXISTS manual_override JSONB DEFAULT '{}'::jsonb","-- Ensure manual_fields column exists (in case previous migration wasn't run)\n-- Structure: { steps: number | null, workouts: text | null, supplements: text | null }\n-- Stores manual fields: steps, workouts, supplements\nALTER TABLE nutrition_templates\n  ADD COLUMN IF NOT EXISTS manual_fields JSONB DEFAULT '{}'::jsonb","-- Add activity_entries column for storing METs activity data\n-- Structure: Array of { id: string, activityType: string, mets: number, minutesPerWeek: number }\nALTER TABLE nutrition_templates\n  ADD COLUMN IF NOT EXISTS activity_entries JSONB DEFAULT '[]'::jsonb","-- Add comments\nCOMMENT ON COLUMN nutrition_templates.manual_override IS 'JSONB tracking which macro/calorie fields have been manually overridden: { calories: boolean, protein: boolean, carbs: boolean, fat: boolean, fiber: boolean }'","COMMENT ON COLUMN nutrition_templates.manual_fields IS 'JSONB storing manual fields: { steps: number | null, workouts: text | null, supplements: text | null }'","COMMENT ON COLUMN nutrition_templates.activity_entries IS 'JSONB array storing activity entries for METs calculation: [{ id: string, activityType: string, mets: number, minutesPerWeek: number }]'","-- Create GIN indexes for JSONB columns (enables fast queries on JSONB data)\nCREATE INDEX IF NOT EXISTS idx_nutrition_templates_manual_override ON nutrition_templates USING GIN (manual_override)","CREATE INDEX IF NOT EXISTS idx_nutrition_templates_manual_fields ON nutrition_templates USING GIN (manual_fields)","CREATE INDEX IF NOT EXISTS idx_nutrition_templates_activity_entries ON nutrition_templates USING GIN (activity_entries)","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_activity_entries_to_nutrition_templates
20260121000007	{"-- =====================================================\n-- Fix Nutrition Templates Columns\n-- Created: 2026-01-21\n-- Description: Ensures all required columns exist in nutrition_templates table\n--              This is a comprehensive fix for any missing columns\n-- This migration must be the LAST one in the list for migration up to work correctly\n-- =====================================================\n\n-- Ensure manual_override column exists\n-- Structure: { calories: boolean, protein: boolean, carbs: boolean, fat: boolean, fiber: boolean }\nDO $$ \nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.columns \n        WHERE table_schema = 'public' \n        AND table_name = 'nutrition_templates' \n        AND column_name = 'manual_override'\n    ) THEN\n        ALTER TABLE nutrition_templates\n        ADD COLUMN manual_override JSONB DEFAULT '{}'::jsonb;\n        \n        COMMENT ON COLUMN nutrition_templates.manual_override IS 'JSONB tracking which macro/calorie fields have been manually overridden: { calories: boolean, protein: boolean, carbs: boolean, fat: boolean, fiber: boolean }';\n    END IF;\nEND $$","-- Ensure manual_fields column exists\n-- Structure: { steps: number | null, workouts: text | null, supplements: text | null }\nDO $$ \nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.columns \n        WHERE table_schema = 'public' \n        AND table_name = 'nutrition_templates' \n        AND column_name = 'manual_fields'\n    ) THEN\n        ALTER TABLE nutrition_templates\n        ADD COLUMN manual_fields JSONB DEFAULT '{}'::jsonb;\n        \n        COMMENT ON COLUMN nutrition_templates.manual_fields IS 'JSONB storing manual fields: { steps: number | null, workouts: text | null, supplements: text | null }';\n    END IF;\nEND $$","-- Ensure activity_entries column exists\n-- Structure: Array of { id: string, activityType: string, mets: number, minutesPerWeek: number }\nDO $$ \nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.columns \n        WHERE table_schema = 'public' \n        AND table_name = 'nutrition_templates' \n        AND column_name = 'activity_entries'\n    ) THEN\n        ALTER TABLE nutrition_templates\n        ADD COLUMN activity_entries JSONB DEFAULT '[]'::jsonb;\n        \n        COMMENT ON COLUMN nutrition_templates.activity_entries IS 'JSONB array storing activity entries for METs calculation: [{ id: string, activityType: string, mets: number, minutesPerWeek: number }]';\n    END IF;\nEND $$","-- Create GIN indexes for JSONB columns (if they don't exist)\nCREATE INDEX IF NOT EXISTS idx_nutrition_templates_manual_override ON nutrition_templates USING GIN (manual_override)","CREATE INDEX IF NOT EXISTS idx_nutrition_templates_manual_fields ON nutrition_templates USING GIN (manual_fields)","CREATE INDEX IF NOT EXISTS idx_nutrition_templates_activity_entries ON nutrition_templates USING GIN (activity_entries)","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_nutrition_templates_columns
20260121000008	{"-- =====================================================\n-- Fix Fillout Submissions RLS Policies\n-- Created: 2026-01-21\n-- Description: Fixes RLS policies to avoid \\"permission denied for table users\\" error\n--              Uses auth.jwt() instead of querying auth.users directly\n-- This migration must be the LAST one in the list for migration up to work correctly\n-- =====================================================\n\n-- Drop existing policies\nDROP POLICY IF EXISTS \\"Managers can view all fillout submissions\\" ON public.fillout_submissions","DROP POLICY IF EXISTS \\"Managers can insert fillout submissions\\" ON public.fillout_submissions","DROP POLICY IF EXISTS \\"Managers can update fillout submissions\\" ON public.fillout_submissions","DROP POLICY IF EXISTS \\"Managers can delete fillout submissions\\" ON public.fillout_submissions","-- Policy: Managers can view all submissions\n-- Uses profiles table to check role (same pattern as other tables)\nCREATE POLICY \\"Managers can view all fillout submissions\\"\n  ON public.fillout_submissions\n  FOR SELECT\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user', 'manager')\n    )\n    OR auth.role() = 'service_role'\n  )","-- Policy: Managers can insert submissions\nCREATE POLICY \\"Managers can insert fillout submissions\\"\n  ON public.fillout_submissions\n  FOR INSERT\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user', 'manager')\n    )\n    OR auth.role() = 'service_role'\n  )","-- Policy: Managers can update submissions\nCREATE POLICY \\"Managers can update fillout submissions\\"\n  ON public.fillout_submissions\n  FOR UPDATE\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user', 'manager')\n    )\n    OR auth.role() = 'service_role'\n  )\n  WITH CHECK (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user', 'manager')\n    )\n    OR auth.role() = 'service_role'\n  )","-- Policy: Managers can delete submissions\nCREATE POLICY \\"Managers can delete fillout submissions\\"\n  ON public.fillout_submissions\n  FOR DELETE\n  USING (\n    EXISTS (\n      SELECT 1 FROM profiles\n      WHERE profiles.id = auth.uid()\n      AND profiles.role IN ('admin', 'user', 'manager')\n    )\n    OR auth.role() = 'service_role'\n  )","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_fillout_submissions_rls
20260121000009	{"-- =====================================================\n-- Add is_active to nutrition_plans\n-- Created: 2026-01-21\n-- Description: Add is_active and deleted_at columns to nutrition_plans for consistency with workout_plans\n--              This allows tracking active vs inactive nutrition plans\n-- This migration must be the LAST one in the list for migration up to work correctly\n-- =====================================================\n\n-- Add is_active and deleted_at columns\nALTER TABLE nutrition_plans\n  ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true NOT NULL,\n  ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMP WITH TIME ZONE","-- Create index for active plans\nCREATE INDEX IF NOT EXISTS idx_nutrition_plans_is_active ON nutrition_plans(is_active) WHERE is_active = true","CREATE INDEX IF NOT EXISTS idx_nutrition_plans_deleted_at ON nutrition_plans(deleted_at) WHERE deleted_at IS NOT NULL","-- Update existing plans to be active\nUPDATE nutrition_plans SET is_active = true WHERE is_active IS NULL","-- Add comments\nCOMMENT ON COLUMN nutrition_plans.is_active IS 'Whether this nutrition plan is currently active'","COMMENT ON COLUMN nutrition_plans.deleted_at IS 'Timestamp when this nutrition plan was deleted (soft delete)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_is_active_to_nutrition_plans
20260121000010	{"-- =====================================================\n-- Set Default Weekly Review WhatsApp Template\n-- Created: 2026-01-21\n-- Description: Sets default template for weekly_review automation\n--              This template matches the format used when sending weekly goals\n-- This migration must be the LAST one in the list for migration up to work correctly\n-- =====================================================\n\n-- Create a function to set default weekly_review template for a user\nCREATE OR REPLACE FUNCTION set_default_weekly_review_template(p_user_id UUID)\nRETURNS void AS $$\nBEGIN\n  -- Insert or update the weekly_review template for the user\n  INSERT INTO public.whatsapp_flow_templates (user_id, flow_key, template_content, buttons, media)\n  VALUES (\n    p_user_id,\n    'weekly_review',\n    '📊 סיכום שבועי - שבוע {{week_start}} - {{week_end}}\n\n🎯 יעדים:\nקלוריות: {{target_calories}} קק\\"ל\nחלבון: {{target_protein}} גרם\nסיבים: {{target_fiber}} גרם\nצעדים: {{target_steps}}\n\n📈 בפועל (ממוצע):\nקלוריות: {{actual_calories}} קק\\"ל\nמשקל ממוצע: {{actual_weight}} ק\\"ג',\n    '[]'::jsonb,\n    NULL\n  )\n  ON CONFLICT (user_id, flow_key)\n  DO UPDATE SET\n    template_content = EXCLUDED.template_content,\n    updated_at = NOW()\n  WHERE whatsapp_flow_templates.template_content = '' OR whatsapp_flow_templates.template_content IS NULL;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Set default template for all existing users (coaches/managers)\n-- This will only set templates for users who don't already have a weekly_review template\nDO $$\nDECLARE\n  user_record RECORD;\nBEGIN\n  FOR user_record IN \n    SELECT id FROM auth.users\n    WHERE id NOT IN (\n      SELECT DISTINCT user_id \n      FROM public.whatsapp_flow_templates \n      WHERE flow_key = 'weekly_review' \n      AND template_content IS NOT NULL \n      AND template_content != ''\n    )\n  LOOP\n    PERFORM set_default_weekly_review_template(user_record.id);\n  END LOOP;\nEND $$","-- Add comment\nCOMMENT ON FUNCTION set_default_weekly_review_template(UUID) IS 'Sets default weekly_review WhatsApp template for a user. Only updates if template is empty or null.'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	set_default_weekly_review_template
20260121000011	{"-- =====================================================\n-- Fix Duplicate Plans Per Budget Migration\n-- Created: 2026-01-21\n-- Description: Removes duplicate plans per budget and ensures only one plan per budget_id\n--              This fixes the issue where the same plan appears twice when both customer_id and lead_id are set\n-- =====================================================\n\n-- =====================================================\n-- STEP 1: Clean up existing duplicates\n-- Keep only the most recent plan per budget_id + customer_id/lead_id combination\n-- =====================================================\n\n-- Clean up duplicate workout_plans - keep only one per budget_id per customer/lead\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'workout_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE '\n    WITH ranked_plans AS (\n      SELECT \n        id,\n        ROW_NUMBER() OVER (\n          PARTITION BY budget_id, COALESCE(customer_id::text, ''''), COALESCE(lead_id::text, '''')\n          ORDER BY COALESCE(start_date, created_at) DESC, created_at DESC\n        ) as rn\n      FROM workout_plans\n      WHERE budget_id IS NOT NULL\n    )\n    DELETE FROM workout_plans\n    WHERE id IN (\n      SELECT id FROM ranked_plans WHERE rn > 1\n    )';\n  END IF;\nEND $$","-- Clean up duplicate nutrition_plans - keep only one per budget_id per customer/lead\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'nutrition_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE '\n    WITH ranked_plans AS (\n      SELECT \n        id,\n        ROW_NUMBER() OVER (\n          PARTITION BY budget_id, COALESCE(customer_id::text, ''''), COALESCE(lead_id::text, '''')\n          ORDER BY COALESCE(start_date, created_at) DESC, created_at DESC\n        ) as rn\n      FROM nutrition_plans\n      WHERE budget_id IS NOT NULL\n    )\n    DELETE FROM nutrition_plans\n    WHERE id IN (\n      SELECT id FROM ranked_plans WHERE rn > 1\n    )';\n  END IF;\nEND $$","-- Clean up duplicate steps_plans - keep only one per budget_id per customer/lead\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'steps_plans') THEN\n    EXECUTE '\n    WITH ranked_plans AS (\n      SELECT \n        id,\n        ROW_NUMBER() OVER (\n          PARTITION BY budget_id, COALESCE(customer_id::text, ''''), COALESCE(lead_id::text, '''')\n          ORDER BY COALESCE(start_date, created_at) DESC, created_at DESC\n        ) as rn\n      FROM steps_plans\n      WHERE budget_id IS NOT NULL\n    )\n    DELETE FROM steps_plans\n    WHERE id IN (\n      SELECT id FROM ranked_plans WHERE rn > 1\n    )';\n  END IF;\nEND $$","-- Clean up duplicate supplement_plans - keep only one per budget_id per customer/lead\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'supplement_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE '\n    WITH ranked_plans AS (\n      SELECT \n        id,\n        ROW_NUMBER() OVER (\n          PARTITION BY budget_id, COALESCE(customer_id::text, ''''), COALESCE(lead_id::text, '''')\n          ORDER BY COALESCE(start_date, created_at) DESC, created_at DESC\n        ) as rn\n      FROM supplement_plans\n      WHERE budget_id IS NOT NULL\n    )\n    DELETE FROM supplement_plans\n    WHERE id IN (\n      SELECT id FROM ranked_plans WHERE rn > 1\n    )';\n  END IF;\nEND $$","-- =====================================================\n-- STEP 2: Add unique constraint to prevent future duplicates\n-- One plan per budget_id per customer_id/lead_id combination\n-- Using a single expression index that handles both customer_id and lead_id\n-- =====================================================\n\n-- Drop existing indexes if they exist and create new unique constraint for workout_plans\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'workout_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    -- Drop old indexes if they exist\n    EXECUTE 'DROP INDEX IF EXISTS idx_workout_plans_unique_budget_customer';\n    EXECUTE 'DROP INDEX IF EXISTS idx_workout_plans_unique_budget_lead';\n    EXECUTE 'DROP INDEX IF EXISTS idx_workout_plans_unique_budget';\n    \n    -- Create unique constraint using expression: one plan per budget_id + (customer_id or lead_id)\n    -- This handles cases where plan has customer_id only, lead_id only, or both\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_workout_plans_unique_budget_customer\n    ON workout_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_workout_plans_unique_budget_lead\n    ON workout_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- Drop existing indexes if they exist and create new unique constraint for nutrition_plans\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'nutrition_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    -- Drop old indexes if they exist\n    EXECUTE 'DROP INDEX IF EXISTS idx_nutrition_plans_unique_budget_customer';\n    EXECUTE 'DROP INDEX IF EXISTS idx_nutrition_plans_unique_budget_lead';\n    EXECUTE 'DROP INDEX IF EXISTS idx_nutrition_plans_unique_budget';\n    \n    -- Create new unique constraint: one plan per budget_id + customer_id\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_nutrition_plans_unique_budget_customer\n    ON nutrition_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    -- Create new unique constraint: one plan per budget_id + lead_id\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_nutrition_plans_unique_budget_lead\n    ON nutrition_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- Drop existing indexes if they exist and create new unique constraint for steps_plans\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'steps_plans') THEN\n    -- Drop old indexes if they exist\n    EXECUTE 'DROP INDEX IF EXISTS idx_steps_plans_unique_budget_customer';\n    EXECUTE 'DROP INDEX IF EXISTS idx_steps_plans_unique_budget_lead';\n    EXECUTE 'DROP INDEX IF EXISTS idx_steps_plans_unique_budget';\n    \n    -- Create new unique constraint: one plan per budget_id + customer_id\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_steps_plans_unique_budget_customer\n    ON steps_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    -- Create new unique constraint: one plan per budget_id + lead_id\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_steps_plans_unique_budget_lead\n    ON steps_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- Drop existing indexes if they exist and create new unique constraint for supplement_plans\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'supplement_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    -- Drop old indexes if they exist\n    EXECUTE 'DROP INDEX IF EXISTS idx_supplement_plans_unique_budget_customer';\n    EXECUTE 'DROP INDEX IF EXISTS idx_supplement_plans_unique_budget_lead';\n    EXECUTE 'DROP INDEX IF EXISTS idx_supplement_plans_unique_budget';\n    \n    -- Create new unique constraint: one plan per budget_id + customer_id\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_supplement_plans_unique_budget_customer\n    ON supplement_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    -- Create new unique constraint: one plan per budget_id + lead_id\n    EXECUTE 'CREATE UNIQUE INDEX IF NOT EXISTS idx_supplement_plans_unique_budget_lead\n    ON supplement_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_workout_plans_unique_budget_customer') THEN\n    EXECUTE 'COMMENT ON INDEX idx_workout_plans_unique_budget_customer IS ''Ensures only one workout plan per budget_id + customer_id combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_workout_plans_unique_budget_lead') THEN\n    EXECUTE 'COMMENT ON INDEX idx_workout_plans_unique_budget_lead IS ''Ensures only one workout plan per budget_id + lead_id combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_nutrition_plans_unique_budget_customer') THEN\n    EXECUTE 'COMMENT ON INDEX idx_nutrition_plans_unique_budget_customer IS ''Ensures only one nutrition plan per budget_id + customer_id combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_nutrition_plans_unique_budget_lead') THEN\n    EXECUTE 'COMMENT ON INDEX idx_nutrition_plans_unique_budget_lead IS ''Ensures only one nutrition plan per budget_id + lead_id combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_steps_plans_unique_budget_customer') THEN\n    EXECUTE 'COMMENT ON INDEX idx_steps_plans_unique_budget_customer IS ''Ensures only one steps plan per budget_id + customer_id combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_steps_plans_unique_budget_lead') THEN\n    EXECUTE 'COMMENT ON INDEX idx_steps_plans_unique_budget_lead IS ''Ensures only one steps plan per budget_id + lead_id combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_supplement_plans_unique_budget_customer') THEN\n    EXECUTE 'COMMENT ON INDEX idx_supplement_plans_unique_budget_customer IS ''Ensures only one supplement plan per budget_id + customer_id combination''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_supplement_plans_unique_budget_lead') THEN\n    EXECUTE 'COMMENT ON INDEX idx_supplement_plans_unique_budget_lead IS ''Ensures only one supplement plan per budget_id + lead_id combination''';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_duplicate_plans_per_budget
20260121000012	{"-- =====================================================\n-- Remove Strict Budget Constraints Migration\n-- Created: 2026-01-21\n-- Description: Removes overly strict unique constraints that prevent plan creation\n--              The application already handles deduplication via delete-before-insert logic\n-- =====================================================\n\n-- =====================================================\n-- STEP 1: Drop all unique constraints on budget_id\n-- These constraints are preventing legitimate plan creation\n-- =====================================================\n\n-- Drop unique constraints for workout_plans\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'workout_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE 'DROP INDEX IF EXISTS idx_workout_plans_unique_budget_customer';\n    EXECUTE 'DROP INDEX IF EXISTS idx_workout_plans_unique_budget_lead';\n    EXECUTE 'DROP INDEX IF EXISTS idx_workout_plans_unique_budget';\n  END IF;\nEND $$","-- Drop unique constraints for nutrition_plans\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'nutrition_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE 'DROP INDEX IF EXISTS idx_nutrition_plans_unique_budget_customer';\n    EXECUTE 'DROP INDEX IF EXISTS idx_nutrition_plans_unique_budget_lead';\n    EXECUTE 'DROP INDEX IF EXISTS idx_nutrition_plans_unique_budget';\n  END IF;\nEND $$","-- Drop unique constraints for steps_plans\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'steps_plans') THEN\n    EXECUTE 'DROP INDEX IF EXISTS idx_steps_plans_unique_budget_customer';\n    EXECUTE 'DROP INDEX IF EXISTS idx_steps_plans_unique_budget_lead';\n    EXECUTE 'DROP INDEX IF EXISTS idx_steps_plans_unique_budget';\n  END IF;\nEND $$","-- Drop unique constraints for supplement_plans\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'supplement_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE 'DROP INDEX IF EXISTS idx_supplement_plans_unique_budget_customer';\n    EXECUTE 'DROP INDEX IF EXISTS idx_supplement_plans_unique_budget_lead';\n    EXECUTE 'DROP INDEX IF EXISTS idx_supplement_plans_unique_budget';\n  END IF;\nEND $$","-- =====================================================\n-- STEP 2: Create non-unique indexes for performance\n-- These help with queries but don't prevent inserts\n-- =====================================================\n\n-- Create non-unique indexes for workout_plans\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'workout_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_workout_plans_budget_id_perf\n    ON workout_plans (budget_id)\n    WHERE budget_id IS NOT NULL';\n    \n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_workout_plans_budget_customer_perf\n    ON workout_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_workout_plans_budget_lead_perf\n    ON workout_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- Create non-unique indexes for nutrition_plans\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'nutrition_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_nutrition_plans_budget_id_perf\n    ON nutrition_plans (budget_id)\n    WHERE budget_id IS NOT NULL';\n    \n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_nutrition_plans_budget_customer_perf\n    ON nutrition_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_nutrition_plans_budget_lead_perf\n    ON nutrition_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- Create non-unique indexes for steps_plans\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'steps_plans') THEN\n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_steps_plans_budget_id_perf\n    ON steps_plans (budget_id)\n    WHERE budget_id IS NOT NULL';\n    \n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_steps_plans_budget_customer_perf\n    ON steps_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_steps_plans_budget_lead_perf\n    ON steps_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- Create non-unique indexes for supplement_plans\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_name = 'supplement_plans' \n    AND column_name = 'budget_id'\n  ) THEN\n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_supplement_plans_budget_id_perf\n    ON supplement_plans (budget_id)\n    WHERE budget_id IS NOT NULL';\n    \n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_supplement_plans_budget_customer_perf\n    ON supplement_plans (budget_id, customer_id)\n    WHERE budget_id IS NOT NULL AND customer_id IS NOT NULL';\n    \n    EXECUTE 'CREATE INDEX IF NOT EXISTS idx_supplement_plans_budget_lead_perf\n    ON supplement_plans (budget_id, lead_id)\n    WHERE budget_id IS NOT NULL AND lead_id IS NOT NULL';\n  END IF;\nEND $$","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nDO $$\nBEGIN\n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_workout_plans_budget_id_perf') THEN\n    EXECUTE 'COMMENT ON INDEX idx_workout_plans_budget_id_perf IS ''Performance index for querying workout plans by budget_id''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_nutrition_plans_budget_id_perf') THEN\n    EXECUTE 'COMMENT ON INDEX idx_nutrition_plans_budget_id_perf IS ''Performance index for querying nutrition plans by budget_id''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_steps_plans_budget_id_perf') THEN\n    EXECUTE 'COMMENT ON INDEX idx_steps_plans_budget_id_perf IS ''Performance index for querying steps plans by budget_id''';\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM pg_indexes WHERE indexname = 'idx_supplement_plans_budget_id_perf') THEN\n    EXECUTE 'COMMENT ON INDEX idx_supplement_plans_budget_id_perf IS ''Performance index for querying supplement plans by budget_id''';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- Note: Deduplication is now handled entirely by application logic\n-- in budgetPlanSync.ts which deletes existing plans before inserting new ones\n-- ====================================================="}	remove_strict_budget_constraints
20260121000013	{"-- =====================================================\n-- Fix client-assets folder storage RLS policies (blood-tests, progress, notes)\n-- Created: 2026-01-21\n-- Description: Updates RLS policies for various folders in client-assets bucket to use more reliable path matching\n--              Replaces storage.foldername(name) with LIKE pattern\n--              Path structure: {customer_id}/{folder}/{filename}\n-- =====================================================\n\n-- Only update policies if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- Drop existing blood-tests policies\n    DROP POLICY IF EXISTS \\"Trainees can upload blood tests to own client folder\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Trainees can view own blood tests\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Trainees can delete own blood tests\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can upload blood tests\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can view all blood tests\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can delete all blood tests\\" ON storage.objects;\n\n    -- Drop existing progress/notes policies\n    DROP POLICY IF EXISTS \\"Trainees can upload to own client folder\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Trainees can view own client files\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Trainees can delete own client files\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can upload client files\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can view all client files\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can delete all client files\\" ON storage.objects;\n\n    -- =====================================================\n    -- 1. TRAINEE POLICIES (for own folder)\n    -- =====================================================\n\n    -- RLS Policy: Allow trainees to upload files to their own client_id folder (progress, notes, blood-tests)\n    CREATE POLICY \\"Trainees can upload to own client folder\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = 'client-assets' AND\n      (\n        name LIKE '%/progress/%' OR\n        name LIKE '%/notes/%' OR\n        name LIKE '%/blood-tests/%'\n      ) AND\n      EXISTS (\n        SELECT 1 FROM customers\n        WHERE customers.id::text = split_part(name, '/', 1)\n        AND customers.user_id = auth.uid()\n      )\n    );\n\n    -- RLS Policy: Allow trainees to view files in their own client_id folder\n    CREATE POLICY \\"Trainees can view own client files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      (\n        name LIKE '%/progress/%' OR\n        name LIKE '%/notes/%' OR\n        name LIKE '%/blood-tests/%'\n      ) AND\n      EXISTS (\n        SELECT 1 FROM customers\n        WHERE customers.id::text = split_part(name, '/', 1)\n        AND customers.user_id = auth.uid()\n      )\n    );\n\n    -- RLS Policy: Allow trainees to delete files from their own client_id folder\n    CREATE POLICY \\"Trainees can delete own client files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      (\n        name LIKE '%/progress/%' OR\n        name LIKE '%/notes/%' OR\n        name LIKE '%/blood-tests/%'\n      ) AND\n      EXISTS (\n        SELECT 1 FROM customers\n        WHERE customers.id::text = split_part(name, '/', 1)\n        AND customers.user_id = auth.uid()\n      )\n    );\n\n    -- =====================================================\n    -- 2. MANAGER POLICIES (for all client folders)\n    -- =====================================================\n\n    -- RLS Policy: Allow managers/admins to upload client files\n    CREATE POLICY \\"Managers can upload client files\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = 'client-assets' AND\n      (\n        name LIKE '%/progress/%' OR\n        name LIKE '%/notes/%' OR\n        name LIKE '%/blood-tests/%'\n      ) AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- RLS Policy: Allow managers/admins to view all client files\n    CREATE POLICY \\"Managers can view all client files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- RLS Policy: Allow managers/admins to delete all client files\n    CREATE POLICY \\"Managers can delete all client files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    RAISE NOTICE 'Storage RLS policies for client folders updated successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy update.';\n  END IF;\nEND $$"}	fix_blood_tests_storage_rls
20260121000014	{"-- =====================================================\n-- Fix workout-exercises storage RLS policies path matching\n-- Created: 2026-01-21\n-- Description: Updates RLS policies for workout-exercises folder to use LIKE pattern\n--              instead of storage.foldername() for more reliable path matching\n--              Path structure: workout-exercises/{exercise_id}/images/{filename} or workout-exercises/{exercise_id}/videos/{filename}\n-- =====================================================\n\n-- Only update policies if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- Drop existing policies\n    DROP POLICY IF EXISTS \\"Managers can upload workout exercise media\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can view workout exercise media\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can delete workout exercise media\\" ON storage.objects;\n\n    -- RLS Policy: Allow managers/admins to upload workout exercise media\n    -- Using LIKE pattern for more reliable path matching\n    CREATE POLICY \\"Managers can upload workout exercise media\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = 'client-assets' AND\n      name LIKE 'workout-exercises/%' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- RLS Policy: Allow managers/admins to view workout exercise media\n    CREATE POLICY \\"Managers can view workout exercise media\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      name LIKE 'workout-exercises/%' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- RLS Policy: Allow managers/admins to delete workout exercise media\n    CREATE POLICY \\"Managers can delete workout exercise media\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      name LIKE 'workout-exercises/%' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    RAISE NOTICE 'Storage RLS policies for workout-exercises folder updated successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy update. Enable storage in config.toml and restart Supabase.';\n  END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_workout_exercises_storage_rls_path
20260122000000	{"-- =====================================================\n-- Add target_weight and target_waist to weekly_reviews\n-- Created: 2026-01-22\n-- Description: Add editable target columns for weight and waist measurements\n-- =====================================================\n\n-- Add target_weight column (NUMERIC to match weekly_avg_weight)\nALTER TABLE weekly_reviews\nADD COLUMN IF NOT EXISTS target_weight NUMERIC(5,2)","-- Add target_waist column (INTEGER to match waist_measurement)\nALTER TABLE weekly_reviews\nADD COLUMN IF NOT EXISTS target_waist INTEGER","-- Add comments for documentation\nCOMMENT ON COLUMN weekly_reviews.target_weight IS 'Target weight for the week (kg)'","COMMENT ON COLUMN weekly_reviews.target_waist IS 'Target waist circumference for the week (cm)'"}	add_target_weight_waist_to_weekly_reviews
20260123000000	{"-- =====================================================\n-- Create External Knowledge Base Table\n-- Created: 2026-01-23\n-- Description: External knowledge base for storing articles that clients can view\n--              Managers can create articles with titles, content, images, videos, and status (draft/published)\n--              Only published articles are visible to clients in their portal\n-- =====================================================\n\n-- Create external_knowledge_base table\nCREATE TABLE IF NOT EXISTS public.external_knowledge_base (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    title TEXT NOT NULL,\n    content TEXT NOT NULL, -- Rich text content/article body\n    images TEXT[] DEFAULT '{}', -- Array of image URLs (storage paths or external URLs)\n    videos TEXT[] DEFAULT '{}', -- Array of video URLs (storage paths or external URLs)\n    status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'published')),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Create indexes for efficient queries\nCREATE INDEX IF NOT EXISTS idx_external_kb_status ON public.external_knowledge_base(status)","CREATE INDEX IF NOT EXISTS idx_external_kb_created_at ON public.external_knowledge_base(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_external_kb_title ON public.external_knowledge_base(title)","CREATE INDEX IF NOT EXISTS idx_external_kb_created_by ON public.external_knowledge_base(created_by)","-- Index for filtering published articles (most common query for clients)\nCREATE INDEX IF NOT EXISTS idx_external_kb_status_published ON public.external_knowledge_base(status, created_at DESC) \n    WHERE status = 'published'","-- Create trigger for auto-updating updated_at\nCREATE TRIGGER update_external_kb_updated_at\n    BEFORE UPDATE ON public.external_knowledge_base\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- Enable RLS on external_knowledge_base table\nALTER TABLE public.external_knowledge_base ENABLE ROW LEVEL SECURITY","-- RLS Policies for external_knowledge_base\n\n-- Managers (authenticated users) can read all entries (both draft and published)\nDROP POLICY IF EXISTS \\"Managers can read all knowledge base articles\\" ON public.external_knowledge_base","CREATE POLICY \\"Managers can read all knowledge base articles\\"\n    ON public.external_knowledge_base FOR SELECT\n    USING (\n        auth.role() = 'authenticated' AND\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid()\n            AND profiles.role IN ('manager', 'admin')\n        )\n    )","-- Clients (authenticated users with customer role) can only read published articles\nDROP POLICY IF EXISTS \\"Clients can read published articles\\" ON public.external_knowledge_base","CREATE POLICY \\"Clients can read published articles\\"\n    ON public.external_knowledge_base FOR SELECT\n    USING (\n        auth.role() = 'authenticated' AND\n        status = 'published' AND\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid()\n        )\n    )","-- Only managers can insert articles\nDROP POLICY IF EXISTS \\"Managers can insert knowledge base articles\\" ON public.external_knowledge_base","CREATE POLICY \\"Managers can insert knowledge base articles\\"\n    ON public.external_knowledge_base FOR INSERT\n    WITH CHECK (\n        auth.role() = 'authenticated' AND\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid()\n            AND profiles.role IN ('manager', 'admin')\n        )\n    )","-- Only managers can update articles\nDROP POLICY IF EXISTS \\"Managers can update knowledge base articles\\" ON public.external_knowledge_base","CREATE POLICY \\"Managers can update knowledge base articles\\"\n    ON public.external_knowledge_base FOR UPDATE\n    USING (\n        auth.role() = 'authenticated' AND\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid()\n            AND profiles.role IN ('manager', 'admin')\n        )\n    )\n    WITH CHECK (\n        auth.role() = 'authenticated' AND\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid()\n            AND profiles.role IN ('manager', 'admin')\n        )\n    )","-- Only managers can delete articles\nDROP POLICY IF EXISTS \\"Managers can delete knowledge base articles\\" ON public.external_knowledge_base","CREATE POLICY \\"Managers can delete knowledge base articles\\"\n    ON public.external_knowledge_base FOR DELETE\n    USING (\n        auth.role() = 'authenticated' AND\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid()\n            AND profiles.role IN ('manager', 'admin')\n        )\n    )","-- Add comments to table\nCOMMENT ON TABLE public.external_knowledge_base IS 'External knowledge base for storing articles that clients can view. Only published articles are visible to clients.'","COMMENT ON COLUMN public.external_knowledge_base.content IS 'Rich text content/article body'","COMMENT ON COLUMN public.external_knowledge_base.images IS 'Array of image URLs (storage paths or external URLs)'","COMMENT ON COLUMN public.external_knowledge_base.videos IS 'Array of video URLs (storage paths or external URLs)'","COMMENT ON COLUMN public.external_knowledge_base.status IS 'Status of the article: draft (only visible to managers) or published (visible to all clients)'"}	create_external_knowledge_base
20260123000001	{"-- =====================================================\n-- Add Storage Policies for Knowledge Base\n-- Created: 2026-01-23\n-- Description: RLS policies for knowledge-base folder in client-assets bucket\n--              Managers can upload/view/delete, clients can view published articles' media\n-- =====================================================\n\n-- Add RLS policies for knowledge-base folder if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- RLS Policy: Allow managers/admins to upload knowledge base files (images/videos)\n    DROP POLICY IF EXISTS \\"Managers can upload knowledge base files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can upload knowledge base files\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''knowledge-base''\n    )';\n\n    -- RLS Policy: Allow managers/admins to view all knowledge base files\n    DROP POLICY IF EXISTS \\"Managers can view knowledge base files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can view knowledge base files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''knowledge-base''\n    )';\n\n    -- RLS Policy: Allow managers/admins to delete knowledge base files\n    DROP POLICY IF EXISTS \\"Managers can delete knowledge base files\\" ON storage.objects;\n    EXECUTE '\n    CREATE POLICY \\"Managers can delete knowledge base files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = ''client-assets'' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN (''admin'', ''user'')\n      ) AND\n      (storage.foldername(name))[1] = ''knowledge-base''\n    )';\n\n    -- Note: Clients access knowledge base files via signed URLs stored in the database\n    -- Signed URLs are generated with 1-year expiration and don't require direct storage access\n    -- Therefore, no separate policy is needed for clients to view files\n\n    RAISE NOTICE 'Storage RLS policies for knowledge-base folder created successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy creation. Enable storage in config.toml and restart Supabase to create policies.';\n  END IF;\nEND $$"}	add_knowledge_base_storage_policies
20260123000002	{"-- =====================================================\n-- Add Cover Image and Update Content Structure for Inline Media\n-- Created: 2026-01-23\n-- Description: Add cover_image field and update content to support inline images/videos\n--              Content will be stored as JSONB with blocks structure for flexible media placement\n-- =====================================================\n\n-- Add cover_image field\nALTER TABLE public.external_knowledge_base \nADD COLUMN IF NOT EXISTS cover_image TEXT","-- Change content to JSONB to support structured content with inline media\n-- Content structure: { \\"blocks\\": [{ \\"type\\": \\"text|image|video\\", \\"content\\": \\"...\\", \\"url\\": \\"...\\" }] }\n-- For backward compatibility, we'll migrate existing TEXT content to JSONB format\nALTER TABLE public.external_knowledge_base \nALTER COLUMN content TYPE JSONB USING \n  CASE \n    WHEN content::text LIKE '{%' THEN content::jsonb\n    ELSE jsonb_build_object(\n      'blocks', \n      jsonb_build_array(\n        jsonb_build_object('type', 'text', 'content', content)\n      )\n    )\n  END","-- Add index for cover_image queries\nCREATE INDEX IF NOT EXISTS idx_external_kb_cover_image ON public.external_knowledge_base(cover_image) \nWHERE cover_image IS NOT NULL","-- Update comments\nCOMMENT ON COLUMN public.external_knowledge_base.cover_image IS 'Cover image URL for the article card display'","COMMENT ON COLUMN public.external_knowledge_base.content IS 'JSONB structured content with blocks. Format: { \\"blocks\\": [{ \\"type\\": \\"text|image|video\\", \\"content\\": \\"...\\", \\"url\\": \\"...\\" }] }'","COMMENT ON COLUMN public.external_knowledge_base.images IS 'DEPRECATED: Legacy array of image URLs. Use inline media in content blocks instead.'","COMMENT ON COLUMN public.external_knowledge_base.videos IS 'DEPRECATED: Legacy array of video URLs. Use inline media in content blocks instead.'"}	add_cover_image_and_inline_media
20260123000003	{"-- Migration: Add display_order columns for drag-and-drop ordering\n-- This allows users to customize the order of interfaces and pages/views\n\n-- Add display_order to user_interface_preferences (for interfaces)\nALTER TABLE user_interface_preferences \nADD COLUMN IF NOT EXISTS display_order INTEGER","-- Create index for efficient ordering queries\nCREATE INDEX IF NOT EXISTS idx_user_interface_preferences_display_order \n    ON user_interface_preferences(user_id, display_order)","-- Add display_order to saved_views (for pages/views)\nALTER TABLE saved_views \nADD COLUMN IF NOT EXISTS display_order INTEGER","-- Create index for efficient ordering queries\nCREATE INDEX IF NOT EXISTS idx_saved_views_display_order \n    ON saved_views(resource_key, created_by, display_order)","-- Initialize display_order for existing interfaces based on current interface_key order\n-- This sets a default order for existing preferences\nDO $$\nDECLARE\n    interface_order RECORD;\n    order_num INTEGER := 1;\nBEGIN\n    FOR interface_order IN \n        SELECT DISTINCT user_id, interface_key\n        FROM user_interface_preferences\n        ORDER BY user_id, interface_key\n    LOOP\n        UPDATE user_interface_preferences\n        SET display_order = order_num\n        WHERE user_id = interface_order.user_id \n          AND interface_key = interface_order.interface_key\n          AND display_order IS NULL;\n        order_num := order_num + 1;\n    END LOOP;\nEND $$","-- Initialize display_order for existing saved_views\n-- Default views always get order 0, then others by creation date\nDO $$\nDECLARE\n    view_order RECORD;\n    order_num INTEGER;\nBEGIN\n    FOR view_order IN \n        SELECT id, resource_key, created_by, is_default, created_at\n        FROM saved_views\n        ORDER BY resource_key, created_by, is_default DESC, created_at\n    LOOP\n        IF view_order.is_default THEN\n            order_num := 0;\n        ELSE\n            -- Get max order for this resource/user, or start from 1\n            SELECT COALESCE(MAX(display_order), 0) + 1\n            INTO order_num\n            FROM saved_views\n            WHERE resource_key = view_order.resource_key\n              AND created_by = view_order.created_by\n              AND id != view_order.id;\n        END IF;\n        \n        UPDATE saved_views\n        SET display_order = order_num\n        WHERE id = view_order.id\n          AND display_order IS NULL;\n    END LOOP;\nEND $$","-- Comments\nCOMMENT ON COLUMN user_interface_preferences.display_order IS 'Display order for the interface (lower numbers appear first)'","COMMENT ON COLUMN saved_views.display_order IS 'Display order for the page/view (0 for default view, higher numbers appear later)'"}	add_display_order_to_interfaces_and_pages
20260124000000	{"-- =====================================================\n-- Migration: Add Filter Support Views\n-- Created: 2026-01-24\n-- Description: Add server-side helper views for table filters\n-- =====================================================\n\n-- Customers with lead counts (total_leads)\nDROP VIEW IF EXISTS public.customers_with_lead_counts","CREATE VIEW public.customers_with_lead_counts AS\nSELECT\n  c.*,\n  COALESCE(l.lead_count, 0) AS total_leads\nFROM public.customers c\nLEFT JOIN (\n  SELECT customer_id, COUNT(*)::INT AS lead_count\n  FROM public.leads\n  WHERE customer_id IS NOT NULL\n  GROUP BY customer_id\n) l ON l.customer_id = c.id","GRANT SELECT ON public.customers_with_lead_counts TO authenticated","GRANT SELECT ON public.customers_with_lead_counts TO anon","COMMENT ON VIEW public.customers_with_lead_counts IS 'Customers with total lead counts for filtering and sorting.'","-- Workout templates with has_leads flag\nDROP VIEW IF EXISTS public.workout_templates_with_leads","CREATE VIEW public.workout_templates_with_leads AS\nSELECT\n  t.*,\n  EXISTS (\n    SELECT 1\n    FROM public.workout_plans wp\n    WHERE wp.template_id = t.id\n      AND wp.lead_id IS NOT NULL\n  ) AS has_leads\nFROM public.workout_templates t","GRANT SELECT ON public.workout_templates_with_leads TO authenticated","GRANT SELECT ON public.workout_templates_with_leads TO anon","COMMENT ON VIEW public.workout_templates_with_leads IS 'Workout templates with has_leads flag for filtering.'","-- Nutrition templates with numeric ranges\nDROP VIEW IF EXISTS public.nutrition_templates_with_ranges","CREATE VIEW public.nutrition_templates_with_ranges AS\nSELECT\n  t.*,\n  (t.targets->>'calories')::NUMERIC AS calories_value,\n  (t.targets->>'protein')::NUMERIC AS protein_value\nFROM public.nutrition_templates t","GRANT SELECT ON public.nutrition_templates_with_ranges TO authenticated","GRANT SELECT ON public.nutrition_templates_with_ranges TO anon","COMMENT ON VIEW public.nutrition_templates_with_ranges IS 'Nutrition templates with numeric calories/protein values for filtering.'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_filter_views
20260124000001	{"-- Migration: Create interface_folders table for organizing pages into folders\n-- This allows users to create folders under interfaces and organize pages into them\n\n-- =====================================================\n-- TABLE: interface_folders\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS interface_folders (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name TEXT NOT NULL,\n    interface_key TEXT NOT NULL, -- e.g., 'leads', 'customers', 'templates', etc.\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    display_order INTEGER,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    \n    -- Ensure unique folder names per interface per user\n    CONSTRAINT unique_folder_name_per_interface_user \n        UNIQUE (interface_key, user_id, name)\n)","-- Indexes for faster queries\nCREATE INDEX IF NOT EXISTS idx_interface_folders_interface_key ON interface_folders(interface_key)","CREATE INDEX IF NOT EXISTS idx_interface_folders_user_id ON interface_folders(user_id)","CREATE INDEX IF NOT EXISTS idx_interface_folders_interface_user ON interface_folders(interface_key, user_id)","CREATE INDEX IF NOT EXISTS idx_interface_folders_display_order ON interface_folders(interface_key, user_id, display_order)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_interface_folders_updated_at\n    BEFORE UPDATE ON interface_folders\n    FOR EACH ROW\n    EXECUTE FUNCTION update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS)\n-- =====================================================\n\n-- Enable RLS\nALTER TABLE interface_folders ENABLE ROW LEVEL SECURITY","-- Policy: Users can view their own folders\nCREATE POLICY \\"Users can view their own folders\\"\n    ON interface_folders\n    FOR SELECT\n    USING (auth.uid() = user_id)","-- Policy: Users can insert their own folders\nCREATE POLICY \\"Users can insert their own folders\\"\n    ON interface_folders\n    FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can update their own folders\nCREATE POLICY \\"Users can update their own folders\\"\n    ON interface_folders\n    FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Policy: Users can delete their own folders\nCREATE POLICY \\"Users can delete their own folders\\"\n    ON interface_folders\n    FOR DELETE\n    USING (auth.uid() = user_id)","-- =====================================================\n-- Add folder_id to saved_views\n-- =====================================================\n\n-- Add folder_id column to saved_views (nullable - pages can be in a folder or not)\nALTER TABLE saved_views \nADD COLUMN IF NOT EXISTS folder_id UUID REFERENCES interface_folders(id) ON DELETE SET NULL","-- Create index for faster queries\nCREATE INDEX IF NOT EXISTS idx_saved_views_folder_id ON saved_views(folder_id)","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE interface_folders IS 'User-defined folders for organizing pages under interfaces'","COMMENT ON COLUMN interface_folders.name IS 'Name of the folder'","COMMENT ON COLUMN interface_folders.interface_key IS 'The interface this folder belongs to (e.g., \\"leads\\", \\"customers\\")'","COMMENT ON COLUMN interface_folders.display_order IS 'Display order for the folder (lower numbers appear first)'","COMMENT ON COLUMN saved_views.folder_id IS 'Optional folder this page belongs to. NULL means the page is directly under the interface.'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_interface_folders
20260125000001	{"-- =====================================================\n-- Create Collections (גבייה) Table\n-- Created: 2026-01-25\n-- Description: Collections table for tracking payment collections\n--              Links to leads and can have multiple payments\n-- =====================================================\n\n-- Create collections table\nCREATE TABLE IF NOT EXISTS public.collections (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    lead_id UUID NOT NULL REFERENCES public.leads(id) ON DELETE CASCADE,\n    customer_id UUID REFERENCES public.customers(id) ON DELETE SET NULL,\n    total_amount NUMERIC(10, 2) NOT NULL CHECK (total_amount >= 0),\n    due_date DATE,\n    status TEXT NOT NULL CHECK (status IN ('ממתין', 'חלקי', 'הושלם', 'בוטל')) DEFAULT 'ממתין',\n    description TEXT,\n    notes TEXT,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Create indexes for efficient queries\nCREATE INDEX IF NOT EXISTS idx_collections_lead_id ON public.collections(lead_id)","CREATE INDEX IF NOT EXISTS idx_collections_customer_id ON public.collections(customer_id)","CREATE INDEX IF NOT EXISTS idx_collections_created_at ON public.collections(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_collections_status ON public.collections(status)","CREATE INDEX IF NOT EXISTS idx_collections_due_date ON public.collections(due_date)","-- Create trigger for auto-updating updated_at\nCREATE TRIGGER update_collections_updated_at\n    BEFORE UPDATE ON public.collections\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- Enable RLS on collections table\nALTER TABLE public.collections ENABLE ROW LEVEL SECURITY","-- RLS Policies for collections\n-- Authenticated users can read collections for leads they have access to\nDROP POLICY IF EXISTS \\"Authenticated users can read collections\\" ON public.collections","CREATE POLICY \\"Authenticated users can read collections\\"\n    ON public.collections FOR SELECT\n    USING (\n        auth.role() = 'authenticated' AND (\n            -- Users can see collections for leads they have access to\n            EXISTS (\n                SELECT 1 FROM public.leads\n                WHERE leads.id = collections.lead_id\n            )\n            OR\n            -- Admins can see all collections\n            EXISTS (\n                SELECT 1 FROM public.profiles\n                WHERE profiles.id = auth.uid() AND profiles.role = 'admin'\n            )\n        )\n    )","-- Authenticated users can insert collections\nDROP POLICY IF EXISTS \\"Authenticated users can insert collections\\" ON public.collections","CREATE POLICY \\"Authenticated users can insert collections\\"\n    ON public.collections FOR INSERT\n    WITH CHECK (auth.role() = 'authenticated')","-- Authenticated users can update collections\nDROP POLICY IF EXISTS \\"Authenticated users can update collections\\" ON public.collections","CREATE POLICY \\"Authenticated users can update collections\\"\n    ON public.collections FOR UPDATE\n    USING (auth.role() = 'authenticated')\n    WITH CHECK (auth.role() = 'authenticated')","-- Authenticated users can delete collections\nDROP POLICY IF EXISTS \\"Authenticated users can delete collections\\" ON public.collections","CREATE POLICY \\"Authenticated users can delete collections\\"\n    ON public.collections FOR DELETE\n    USING (auth.role() = 'authenticated')","-- Admins have full access to collections\nDROP POLICY IF EXISTS \\"Admins have full access to collections\\" ON public.collections","CREATE POLICY \\"Admins have full access to collections\\"\n    ON public.collections FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid() AND profiles.role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM public.profiles\n            WHERE profiles.id = auth.uid() AND profiles.role = 'admin'\n        )\n    )","-- Add comment to table\nCOMMENT ON TABLE public.collections IS 'Payment collections (גבייה) - groups of payments for a lead'","COMMENT ON COLUMN public.collections.lead_id IS 'Lead this collection belongs to (required)'","COMMENT ON COLUMN public.collections.customer_id IS 'Customer this collection belongs to (derived from lead, optional for direct reference)'","COMMENT ON COLUMN public.collections.total_amount IS 'Total amount expected for this collection'","COMMENT ON COLUMN public.collections.due_date IS 'Due date for the collection'","COMMENT ON COLUMN public.collections.status IS 'Collection status: ממתין (pending), חלקי (partial), הושלם (completed), בוטל (cancelled)'","COMMENT ON COLUMN public.collections.description IS 'Description of the collection'","COMMENT ON COLUMN public.collections.notes IS 'Additional notes about the collection'"}	create_collections
20260125000003	{"-- =====================================================\n-- Add collections to saved_views\n-- Created: 2026-01-25\n-- Description: Enable saved views for collections interface\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'collections'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates', 'budgets', 'meetings', 'check_in_settings', 'payments', 'collections'))","-- Insert collections into saved_views resource types if not exists\n-- This allows users to create custom views/filters for collections\nINSERT INTO public.saved_views (resource_key, view_name, filter_config, created_by, is_default, display_order)\nSELECT \n    'collections' as resource_key,\n    'כל הגבייות' as view_name,\n    '{}'::jsonb as filter_config,\n    u.id as created_by,\n    true as is_default,\n    1 as display_order\nFROM auth.users u\nWHERE NOT EXISTS (\n    SELECT 1 FROM public.saved_views sv\n    WHERE sv.resource_key = 'collections' \n    AND sv.created_by = u.id \n    AND sv.is_default = true\n)"}	add_collections_to_saved_views
20260126000000	{"-- =====================================================\n-- Auto-fill customer_id from lead_id in payments\n-- Created: 2026-01-26\n-- Description: Automatically populate customer_id from lead_id when lead_id is provided\n--              This ensures payments are properly linked to both lead and customer\n-- =====================================================\n\n-- Create function to auto-fill customer_id from lead_id\nCREATE OR REPLACE FUNCTION public.auto_fill_payment_customer_id()\nRETURNS TRIGGER AS $$\nBEGIN\n    -- If customer_id is not provided but lead_id is, get customer_id from lead\n    IF NEW.customer_id IS NULL AND NEW.lead_id IS NOT NULL THEN\n        SELECT customer_id INTO NEW.customer_id\n        FROM public.leads\n        WHERE id = NEW.lead_id;\n    END IF;\n    \n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Create trigger to call the function before insert\nDROP TRIGGER IF EXISTS trigger_auto_fill_payment_customer_id ON public.payments","CREATE TRIGGER trigger_auto_fill_payment_customer_id\n    BEFORE INSERT ON public.payments\n    FOR EACH ROW\n    EXECUTE FUNCTION public.auto_fill_payment_customer_id()","-- Also handle updates in case lead_id is changed\nDROP TRIGGER IF EXISTS trigger_auto_fill_payment_customer_id_update ON public.payments","CREATE TRIGGER trigger_auto_fill_payment_customer_id_update\n    BEFORE UPDATE ON public.payments\n    FOR EACH ROW\n    WHEN (OLD.lead_id IS DISTINCT FROM NEW.lead_id OR NEW.customer_id IS NULL)\n    EXECUTE FUNCTION public.auto_fill_payment_customer_id()","-- Add comment\nCOMMENT ON FUNCTION public.auto_fill_payment_customer_id() IS 'Automatically populates customer_id from lead_id when inserting or updating payments'"}	auto_fill_customer_id_from_lead
20260130000000	{"-- =====================================================\n-- Add subscription_types and whatsapp_automations to saved_views\n-- Created: 2026-01-30\n-- Description: Enable saved views for subscription types and WhatsApp automations interfaces\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'subscription_types' and 'whatsapp_automations'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'nutrition_templates', 'budgets', 'meetings', 'check_in_settings', 'payments', 'collections', 'subscription_types', 'whatsapp_automations'))","-- Insert subscription_types default view for all users\nINSERT INTO public.saved_views (resource_key, view_name, filter_config, created_by, is_default, display_order)\nSELECT \n    'subscription_types' as resource_key,\n    'כל סוגי המנויים' as view_name,\n    '{}'::jsonb as filter_config,\n    u.id as created_by,\n    true as is_default,\n    1 as display_order\nFROM auth.users u\nWHERE NOT EXISTS (\n    SELECT 1 FROM public.saved_views sv\n    WHERE sv.resource_key = 'subscription_types' \n    AND sv.created_by = u.id \n    AND sv.is_default = true\n)","-- Insert whatsapp_automations default view for all users\nINSERT INTO public.saved_views (resource_key, view_name, filter_config, created_by, is_default, display_order)\nSELECT \n    'whatsapp_automations' as resource_key,\n    'כל האוטומציות' as view_name,\n    '{}'::jsonb as filter_config,\n    u.id as created_by,\n    true as is_default,\n    1 as display_order\nFROM auth.users u\nWHERE NOT EXISTS (\n    SELECT 1 FROM public.saved_views sv\n    WHERE sv.resource_key = 'whatsapp_automations' \n    AND sv.created_by = u.id \n    AND sv.is_default = true\n)","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_subscription_types_and_whatsapp_automations_to_saved_views
20260127000000	{"-- =====================================================\n-- Create prospero_proposals table\n-- Created: 2026-01-27\n-- Description: Stores Prospero proposals created via Make.com webhook\n--              Status can be \\"Sent\\" (when created) or \\"Signed\\" (when signed)\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS public.prospero_proposals (\n    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    \n    -- Foreign keys\n    lead_id UUID NOT NULL REFERENCES public.leads(id) ON DELETE CASCADE,\n    customer_id UUID REFERENCES public.customers(id) ON DELETE SET NULL,\n    \n    -- Proposal data\n    proposal_link TEXT NOT NULL,\n    prospero_proposal_id TEXT, -- ID from Prospero if provided\n    status TEXT NOT NULL DEFAULT 'Sent' CHECK (status IN ('Sent', 'Signed')),\n    \n    -- Additional metadata\n    metadata JSONB DEFAULT '{}'::jsonb\n)","-- Create indexes\nCREATE INDEX IF NOT EXISTS idx_prospero_proposals_lead_id ON public.prospero_proposals(lead_id)","CREATE INDEX IF NOT EXISTS idx_prospero_proposals_customer_id ON public.prospero_proposals(customer_id)","CREATE INDEX IF NOT EXISTS idx_prospero_proposals_status ON public.prospero_proposals(status)","CREATE INDEX IF NOT EXISTS idx_prospero_proposals_created_at ON public.prospero_proposals(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_prospero_proposals_prospero_id ON public.prospero_proposals(prospero_proposal_id)","-- Create trigger for auto-updating updated_at\nCREATE TRIGGER update_prospero_proposals_updated_at\n    BEFORE UPDATE ON public.prospero_proposals\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- Enable RLS\nALTER TABLE public.prospero_proposals ENABLE ROW LEVEL SECURITY","-- RLS Policies\n-- Allow authenticated users to view proposals\nCREATE POLICY \\"Authenticated users can view proposals\\"\n    ON public.prospero_proposals\n    FOR SELECT\n    TO authenticated\n    USING (true)","-- Allow authenticated users to insert proposals\nCREATE POLICY \\"Authenticated users can insert proposals\\"\n    ON public.prospero_proposals\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (true)","-- Allow authenticated users to update proposals\nCREATE POLICY \\"Authenticated users can update proposals\\"\n    ON public.prospero_proposals\n    FOR UPDATE\n    TO authenticated\n    USING (true)\n    WITH CHECK (true)","-- Add comments\nCOMMENT ON TABLE public.prospero_proposals IS 'Stores Prospero proposals created via Make.com webhook integration'","COMMENT ON COLUMN public.prospero_proposals.status IS 'Proposal status: \\"Sent\\" when created, \\"Signed\\" when signed by customer'","COMMENT ON COLUMN public.prospero_proposals.prospero_proposal_id IS 'Optional Prospero proposal ID if provided by the system'","COMMENT ON COLUMN public.prospero_proposals.metadata IS 'Additional metadata stored as JSON'"}	create_prospero_proposals
20260128000000	{"-- =====================================================\n-- Add Status Field to Subscription Types\n-- Created: 2026-01-28\n-- Description: Adds status column to subscription_types table\n--              Allows tracking subscription type status (Active/Inactive)\n--              Defaults to 'פעיל' (Active) for backward compatibility\n-- =====================================================\n\nSET search_path TO public","-- Add status column to subscription_types table\nALTER TABLE public.subscription_types \nADD COLUMN IF NOT EXISTS status TEXT DEFAULT 'פעיל' NOT NULL","-- Create index for status column for filtering\nCREATE INDEX IF NOT EXISTS idx_subscription_types_status ON public.subscription_types(status) WHERE status IS NOT NULL","-- Add comment for status column\nCOMMENT ON COLUMN public.subscription_types.status IS 'Subscription type status: פעיל (Active) or לא פעיל (Inactive)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_status_to_subscription_types
20260129000000	{"-- =====================================================\n-- Create proposals table\n-- Created: 2026-01-29\n-- Description: Stores proposals for leads and customers\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS public.proposals (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    \n    -- Foreign keys\n    lead_id UUID REFERENCES public.leads(id) ON DELETE CASCADE,\n    customer_id UUID REFERENCES public.customers(id) ON DELETE SET NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n    \n    -- Proposal data\n    title TEXT NOT NULL,\n    description TEXT,\n    proposal_link TEXT,\n    external_proposal_id TEXT,\n    status TEXT NOT NULL DEFAULT 'Draft' CHECK (status IN ('Draft', 'Sent', 'Viewed', 'Signed', 'Rejected', 'Expired')),\n    \n    -- Financial data\n    amount NUMERIC(12, 2),\n    currency TEXT DEFAULT 'ILS',\n    \n    -- Timestamps\n    sent_at TIMESTAMP WITH TIME ZONE,\n    viewed_at TIMESTAMP WITH TIME ZONE,\n    signed_at TIMESTAMP WITH TIME ZONE,\n    expires_at TIMESTAMP WITH TIME ZONE,\n    \n    -- Additional metadata\n    metadata JSONB DEFAULT '{}'::jsonb\n)","-- Create indexes\nCREATE INDEX IF NOT EXISTS idx_proposals_lead_id ON public.proposals(lead_id)","CREATE INDEX IF NOT EXISTS idx_proposals_customer_id ON public.proposals(customer_id)","CREATE INDEX IF NOT EXISTS idx_proposals_created_by ON public.proposals(created_by)","CREATE INDEX IF NOT EXISTS idx_proposals_status ON public.proposals(status)","CREATE INDEX IF NOT EXISTS idx_proposals_created_at ON public.proposals(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_proposals_external_id ON public.proposals(external_proposal_id)","CREATE INDEX IF NOT EXISTS idx_proposals_expires_at ON public.proposals(expires_at) WHERE expires_at IS NOT NULL","-- Create trigger for auto-updating updated_at\nDROP TRIGGER IF EXISTS update_proposals_updated_at ON public.proposals","CREATE TRIGGER update_proposals_updated_at\n    BEFORE UPDATE ON public.proposals\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- Enable RLS\nALTER TABLE public.proposals ENABLE ROW LEVEL SECURITY","-- RLS Policies\n-- Drop existing policies if they exist\nDROP POLICY IF EXISTS \\"Authenticated users can view proposals\\" ON public.proposals","DROP POLICY IF EXISTS \\"Authenticated users can insert proposals\\" ON public.proposals","DROP POLICY IF EXISTS \\"Authenticated users can update proposals\\" ON public.proposals","DROP POLICY IF EXISTS \\"Authenticated users can delete proposals\\" ON public.proposals","-- Allow authenticated users to view proposals\nCREATE POLICY \\"Authenticated users can view proposals\\"\n    ON public.proposals\n    FOR SELECT\n    TO authenticated\n    USING (true)","-- Allow authenticated users to insert proposals\nCREATE POLICY \\"Authenticated users can insert proposals\\"\n    ON public.proposals\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (true)","-- Allow authenticated users to update proposals\nCREATE POLICY \\"Authenticated users can update proposals\\"\n    ON public.proposals\n    FOR UPDATE\n    TO authenticated\n    USING (true)\n    WITH CHECK (true)","-- Allow authenticated users to delete proposals\nCREATE POLICY \\"Authenticated users can delete proposals\\"\n    ON public.proposals\n    FOR DELETE\n    TO authenticated\n    USING (true)","-- Add comments\nCOMMENT ON TABLE public.proposals IS 'Stores proposals for leads and customers'","COMMENT ON COLUMN public.proposals.status IS 'Proposal status: Draft, Sent, Viewed, Signed, Rejected, or Expired'","COMMENT ON COLUMN public.proposals.external_proposal_id IS 'External proposal ID from third-party systems'","COMMENT ON COLUMN public.proposals.metadata IS 'Additional metadata stored as JSON'"}	create_proposals
20260130000001	{"-- Migration: Add numeric_value column to user_interface_preferences\n-- This allows storing numeric preferences like sidebar width alongside icon preferences\n\n-- Make icon_name nullable to support numeric-only preferences\nALTER TABLE user_interface_preferences\nALTER COLUMN icon_name DROP NOT NULL","-- Add numeric_value column\nALTER TABLE user_interface_preferences\nADD COLUMN IF NOT EXISTS numeric_value INTEGER","-- Add comment\nCOMMENT ON COLUMN user_interface_preferences.numeric_value IS 'Numeric preference value (e.g., sidebar width in pixels)'","-- Update the unique constraint to allow same interface_key with different value types\n-- Note: The existing constraint on (user_id, interface_key) still applies\n-- This means one preference per interface per user, but now it can be either icon_name or numeric_value"}	add_numeric_value_to_user_interface_preferences
20260131000000	{"-- =====================================================\n-- Create Exercises Table\n-- Created: 2026-01-31\n-- Description: Stores exercise library with name, repetitions, weight, image, and video link\n-- =====================================================\n\n-- =====================================================\n-- TABLE: exercises\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS public.exercises (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name TEXT NOT NULL,\n    repetitions INTEGER, -- Default repetitions/reps\n    weight DECIMAL(5, 2), -- Default weight in kg\n    image TEXT, -- URL or path to image\n    video_link TEXT, -- URL to video (YouTube, Vimeo, etc.)\n    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_exercises_name ON public.exercises(name)","CREATE INDEX IF NOT EXISTS idx_exercises_created_at ON public.exercises(created_at DESC)","CREATE INDEX IF NOT EXISTS idx_exercises_created_by ON public.exercises(created_by)","-- Trigger to auto-update updated_at\nCREATE TRIGGER update_exercises_updated_at\n    BEFORE UPDATE ON public.exercises\n    FOR EACH ROW\n    EXECUTE FUNCTION public.update_updated_at_column()","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on exercises table\nALTER TABLE public.exercises ENABLE ROW LEVEL SECURITY","-- Policy: Authenticated users can view all exercises\nCREATE POLICY \\"Authenticated users can view exercises\\"\n    ON public.exercises FOR SELECT\n    USING (auth.role() = 'authenticated')","-- Policy: Authenticated users can insert exercises\nCREATE POLICY \\"Authenticated users can insert exercises\\"\n    ON public.exercises FOR INSERT\n    WITH CHECK (auth.role() = 'authenticated')","-- Policy: Authenticated users can update exercises\nCREATE POLICY \\"Authenticated users can update exercises\\"\n    ON public.exercises FOR UPDATE\n    USING (auth.role() = 'authenticated')\n    WITH CHECK (auth.role() = 'authenticated')","-- Policy: Authenticated users can delete exercises\nCREATE POLICY \\"Authenticated users can delete exercises\\"\n    ON public.exercises FOR DELETE\n    USING (auth.role() = 'authenticated')","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE public.exercises IS 'Exercise library that can be selected and used in workout templates'","COMMENT ON COLUMN public.exercises.name IS 'Exercise name'","COMMENT ON COLUMN public.exercises.repetitions IS 'Default number of repetitions/reps'","COMMENT ON COLUMN public.exercises.weight IS 'Default weight in kg'","COMMENT ON COLUMN public.exercises.image IS 'URL or path to exercise image'","COMMENT ON COLUMN public.exercises.video_link IS 'URL to exercise video (YouTube, Vimeo, etc.)'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_exercises
20260131000001	{"-- =====================================================\n-- Add exercises to saved_views\n-- Created: 2026-01-31\n-- Description: Enable saved views for exercises interface\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'exercises'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'exercises', 'nutrition_templates', 'budgets', 'meetings', 'check_in_settings', 'payments', 'collections', 'subscription_types', 'whatsapp_automations'))","-- Insert exercises default view for all users\nINSERT INTO public.saved_views (resource_key, view_name, filter_config, created_by, is_default, display_order)\nSELECT \n    'exercises' as resource_key,\n    'כל התרגילים' as view_name,\n    '{}'::jsonb as filter_config,\n    u.id as created_by,\n    true as is_default,\n    1 as display_order\nFROM auth.users u\nWHERE NOT EXISTS (\n    SELECT 1 FROM public.saved_views sv\n    WHERE sv.resource_key = 'exercises' \n    AND sv.created_by = u.id \n    AND sv.is_default = true\n)","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_exercises_to_saved_views
20260131000002	{"-- =====================================================\n-- Fix Exercise and Workout Storage RLS Policies\n-- Created: 2026-01-22\n-- Description: Ensures managers can upload to both workout-exercises and exercises folders\n-- =====================================================\n\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- Drop existing specific policies to consolidate\n    DROP POLICY IF EXISTS \\"Managers can upload workout exercise media\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can view workout exercise media\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can delete workout exercise media\\" ON storage.objects;\n    \n    DROP POLICY IF EXISTS \\"Managers can upload exercise media\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can view exercise media\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can delete exercise media\\" ON storage.objects;\n\n    -- Drop the new policies if they exist (in case migration is re-run)\n    DROP POLICY IF EXISTS \\"Managers can upload exercise assets\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Authenticated users can view exercise assets\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can delete exercise assets\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can update exercise assets\\" ON storage.objects;\n\n    -- 1. INSERT: Allow managers/admins to upload\n    CREATE POLICY \\"Managers can upload exercise assets\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = 'client-assets' AND\n      (name LIKE 'workout-exercises/%' OR name LIKE 'exercises/%') AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- 2. SELECT: Allow all authenticated users to view (so trainees can see exercise images in their plans)\n    CREATE POLICY \\"Authenticated users can view exercise assets\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      (name LIKE 'workout-exercises/%' OR name LIKE 'exercises/%')\n    );\n\n    -- 3. DELETE: Allow managers/admins to delete\n    CREATE POLICY \\"Managers can delete exercise assets\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      (name LIKE 'workout-exercises/%' OR name LIKE 'exercises/%') AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- 4. UPDATE: Allow managers/admins to update (for upserts)\n    CREATE POLICY \\"Managers can update exercise assets\\"\n    ON storage.objects\n    FOR UPDATE\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      (name LIKE 'workout-exercises/%' OR name LIKE 'exercises/%') AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    RAISE NOTICE 'Exercise storage RLS policies fixed successfully';\n  END IF;\nEND $$"}	fix_exercise_storage_rls
20260201000000	{"-- Create a view for collections with aggregated payment totals\n-- This enables server-side sorting/pagination on paid/remaining amounts.\n\nCREATE OR REPLACE VIEW public.collections_with_payments AS\nSELECT\n  c.*,\n  lead_customer.full_name AS lead_name,\n  customer.full_name AS customer_name,\n  COALESCE(SUM(CASE WHEN p.status = 'שולם' THEN p.amount ELSE 0 END), 0) AS paid_amount,\n  GREATEST(\n    COALESCE(c.total_amount, 0) - COALESCE(SUM(CASE WHEN p.status = 'שולם' THEN p.amount ELSE 0 END), 0),\n    0\n  ) AS remaining_amount\nFROM public.collections c\nLEFT JOIN public.leads l ON l.id = c.lead_id\nLEFT JOIN public.customers lead_customer ON lead_customer.id = l.customer_id\nLEFT JOIN public.customers customer ON customer.id = c.customer_id\nLEFT JOIN public.payments p ON p.collection_id = c.id\nGROUP BY c.id, lead_customer.full_name, customer.full_name","ALTER VIEW public.collections_with_payments SET (security_invoker = true)"}	create_collections_with_payments_view
20260202000000	{"-- =====================================================\n-- Update Leads View and Functions for Expanded Relations (Ultimate God Mode - FIXED)\n-- Created: 2026-02-02\n-- Description: Adds relations to EVERYTHING linked to leads\n-- =====================================================\n\n-- 1. Drop dependencies (Robustly drop all function signatures)\nDO $$\nDECLARE\n    r RECORD;\nBEGIN\n    -- Drop get_filtered_leads functions\n    FOR r IN SELECT oid::regprocedure AS func_signature\n             FROM pg_proc\n             WHERE proname = 'get_filtered_leads'\n             AND pronamespace = 'public'::regnamespace\n    LOOP\n        EXECUTE 'DROP FUNCTION IF EXISTS ' || r.func_signature || ' CASCADE';\n    END LOOP;\n\n    -- Drop get_filtered_leads_count functions\n    FOR r IN SELECT oid::regprocedure AS func_signature\n             FROM pg_proc\n             WHERE proname = 'get_filtered_leads_count'\n             AND pronamespace = 'public'::regnamespace\n    LOOP\n        EXECUTE 'DROP FUNCTION IF EXISTS ' || r.func_signature || ' CASCADE';\n    END LOOP;\nEND $$","DROP VIEW IF EXISTS public.v_leads_with_customer CASCADE","-- 2. Recreate View with ALL Aggregates and JSON Data\nCREATE OR REPLACE VIEW \\"public\\".\\"v_leads_with_customer\\" AS\nSELECT \n    l.id,\n    l.created_at,\n    l.updated_at,\n    l.assigned_to,\n    l.customer_id,\n    l.city,\n    l.birth_date,\n    l.age,\n    l.gender,\n    l.period,\n    l.status_main,\n    l.status_sub,\n    l.height,\n    l.weight,\n    l.bmi,\n    l.join_date,\n    l.subscription_data,\n    l.daily_protocol,\n    l.workout_history,\n    l.steps_history,\n    l.source,\n    l.fitness_goal,\n    l.activity_level,\n    l.preferred_time,\n    l.notes,\n    -- Customer data (One-to-One)\n    c.full_name as customer_name,\n    c.phone as customer_phone,\n    c.email as customer_email,\n    -- Calculated fields\n    TO_CHAR(l.created_at, 'YYYY-MM-DD') as created_date_formatted,\n    TO_CHAR(l.birth_date, 'YYYY-MM-DD') as birth_date_formatted,\n    -- JSONB fields extracted for convenience\n    (l.daily_protocol->>'stepsGoal')::INTEGER as daily_steps_goal,\n    (l.daily_protocol->>'workoutGoal')::INTEGER as weekly_workouts_goal,\n    (l.daily_protocol->>'supplements')::JSONB as daily_supplements,\n    (l.subscription_data->>'months')::INTEGER as subscription_months,\n    (l.subscription_data->>'initialPrice')::DECIMAL as subscription_initial_price,\n    (l.subscription_data->>'renewalPrice')::DECIMAL as subscription_renewal_price,\n    (l.subscription_data->>'name')::TEXT as subscription_name,\n    \n    -- Active Budget (One-to-One via assignment)\n    b.name as active_budget_name,\n    b.id as active_budget_id,\n    to_jsonb(b.*) as active_budget_json,\n    \n    -- Payments (One-to-Many)\n    COALESCE(p_agg.total_paid, 0) as total_paid,\n    p_agg.last_payment_date,\n    COALESCE(p_agg.payments_json, '[]'::jsonb) as payments_json,\n    \n    -- Collections (One-to-Many)\n    COALESCE(col_agg.total_expected, 0) as total_expected,\n    (COALESCE(col_agg.total_expected, 0) - COALESCE(p_agg.total_paid, 0)) as debt_amount,\n    COALESCE(col_agg.collections_json, '[]'::jsonb) as collections_json,\n    \n    -- Workout Plans (One-to-Many)\n    COALESCE(wp_agg.plan_count, 0) as workout_plans_count,\n    wp_agg.latest_plan_date as latest_workout_plan_date,\n    COALESCE(wp_agg.plans_json, '[]'::jsonb) as workout_plans_json,\n    \n    -- Nutrition Plans (One-to-Many)\n    COALESCE(np_agg.plan_count, 0) as nutrition_plans_count,\n    np_agg.latest_plan_date as latest_nutrition_plan_date,\n    COALESCE(np_agg.plans_json, '[]'::jsonb) as nutrition_plans_json,\n\n    -- Supplement Plans (One-to-Many)\n    COALESCE(sup_agg.plan_count, 0) as supplement_plans_count,\n    sup_agg.latest_plan_date as latest_supplement_plan_date,\n    COALESCE(sup_agg.plans_json, '[]'::jsonb) as supplement_plans_json,\n\n    -- Steps Plans (One-to-Many)\n    COALESCE(step_agg.plan_count, 0) as steps_plans_count,\n    step_agg.latest_plan_date as latest_steps_plan_date,\n    COALESCE(step_agg.plans_json, '[]'::jsonb) as steps_plans_json,\n\n    -- Meetings (One-to-Many)\n    COALESCE(meet_agg.meeting_count, 0) as meetings_count,\n    meet_agg.latest_meeting_date,\n    meet_agg.next_meeting_date,\n    COALESCE(meet_agg.meetings_json, '[]'::jsonb) as meetings_json,\n\n    -- Blood Tests (One-to-Many)\n    COALESCE(blood_agg.test_count, 0) as blood_tests_count,\n    blood_agg.latest_test_date,\n    COALESCE(blood_agg.tests_json, '[]'::jsonb) as blood_tests_json\n\nFROM public.leads l\nLEFT JOIN public.customers c ON l.customer_id = c.id\nLEFT JOIN public.budget_assignments ba ON l.id = ba.lead_id AND ba.is_active = true\nLEFT JOIN public.budgets b ON ba.budget_id = b.id\n\n-- Payments Aggregation\nLEFT JOIN (\n    SELECT lead_id, SUM(amount) as total_paid, MAX(created_at) as last_payment_date,\n           jsonb_agg(to_jsonb(p.*) ORDER BY created_at DESC) as payments_json\n    FROM public.payments p GROUP BY lead_id\n) p_agg ON l.id = p_agg.lead_id\n\n-- Collections Aggregation\nLEFT JOIN (\n    SELECT lead_id, SUM(total_amount) as total_expected,\n           jsonb_agg(to_jsonb(cl.*) ORDER BY due_date ASC) as collections_json\n    FROM public.collections cl GROUP BY lead_id\n) col_agg ON l.id = col_agg.lead_id\n\n-- Workout Plans\nLEFT JOIN (\n    SELECT lead_id, COUNT(*) as plan_count, MAX(start_date) as latest_plan_date,\n           jsonb_agg(to_jsonb(wp.*) ORDER BY start_date DESC) as plans_json\n    FROM public.workout_plans wp GROUP BY lead_id\n) wp_agg ON l.id = wp_agg.lead_id\n\n-- Nutrition Plans\nLEFT JOIN (\n    SELECT lead_id, COUNT(*) as plan_count, MAX(start_date) as latest_plan_date,\n           jsonb_agg(to_jsonb(np.*) ORDER BY start_date DESC) as plans_json\n    FROM public.nutrition_plans np GROUP BY lead_id\n) np_agg ON l.id = np_agg.lead_id\n\n-- Supplement Plans\nLEFT JOIN (\n    SELECT lead_id, COUNT(*) as plan_count, MAX(start_date) as latest_plan_date,\n           jsonb_agg(to_jsonb(sp.*) ORDER BY start_date DESC) as plans_json\n    FROM public.supplement_plans sp GROUP BY lead_id\n) sup_agg ON l.id = sup_agg.lead_id\n\n-- Steps Plans\nLEFT JOIN (\n    SELECT lead_id, COUNT(*) as plan_count, MAX(start_date) as latest_plan_date,\n           jsonb_agg(to_jsonb(stp.*) ORDER BY start_date DESC) as plans_json\n    FROM public.steps_plans stp GROUP BY lead_id\n) step_agg ON l.id = step_agg.lead_id\n\n-- Meetings\nLEFT JOIN (\n    SELECT lead_id, COUNT(*) as meeting_count, \n           MAX(created_at) FILTER (WHERE created_at < now()) as latest_meeting_date,\n           MIN(created_at) FILTER (WHERE created_at >= now()) as next_meeting_date,\n           jsonb_agg(to_jsonb(m.*) ORDER BY created_at DESC) as meetings_json\n    FROM public.meetings m GROUP BY lead_id\n) meet_agg ON l.id = meet_agg.lead_id\n\n-- Blood Tests\nLEFT JOIN (\n    SELECT lead_id, COUNT(*) as test_count, MAX(created_at) as latest_test_date,\n           jsonb_agg(to_jsonb(bt.*) ORDER BY created_at DESC) as tests_json\n    FROM public.blood_tests bt GROUP BY lead_id\n) blood_agg ON l.id = blood_agg.lead_id","-- Grant permissions\nGRANT SELECT ON public.v_leads_with_customer TO authenticated","GRANT SELECT ON public.v_leads_with_customer TO anon","GRANT SELECT ON public.v_leads_with_customer TO service_role","-- 3. Recreate get_filtered_leads with ALL columns\nCREATE OR REPLACE FUNCTION public.get_filtered_leads(\n    p_limit_count INTEGER DEFAULT 100,\n    p_offset_count INTEGER DEFAULT 0,\n    p_search_query TEXT DEFAULT NULL,\n    p_status_main TEXT DEFAULT NULL,\n    p_status_sub TEXT DEFAULT NULL,\n    p_source TEXT DEFAULT NULL,\n    p_fitness_goal TEXT DEFAULT NULL,\n    p_activity_level TEXT DEFAULT NULL,\n    p_preferred_time TEXT DEFAULT NULL,\n    p_age TEXT DEFAULT NULL,\n    p_height TEXT DEFAULT NULL,\n    p_weight TEXT DEFAULT NULL,\n    p_date TEXT DEFAULT NULL,\n    p_sort_by TEXT DEFAULT 'created_at',\n    p_sort_order TEXT DEFAULT 'DESC',\n    p_group_by_level1 TEXT DEFAULT NULL,\n    p_group_by_level2 TEXT DEFAULT NULL\n)\nRETURNS TABLE (\n    id UUID,\n    created_at TIMESTAMP WITH TIME ZONE,\n    updated_at TIMESTAMP WITH TIME ZONE,\n    assigned_to UUID,\n    customer_id UUID,\n    city TEXT,\n    birth_date DATE,\n    age INTEGER,\n    gender TEXT,\n    status_main TEXT,\n    status_sub TEXT,\n    height DECIMAL,\n    weight DECIMAL,\n    bmi DECIMAL,\n    join_date TIMESTAMP WITH TIME ZONE,\n    subscription_data JSONB,\n    daily_protocol JSONB,\n    workout_history JSONB,\n    steps_history JSONB,\n    source TEXT,\n    fitness_goal TEXT,\n    activity_level TEXT,\n    preferred_time TEXT,\n    notes TEXT,\n    customer_name TEXT,\n    customer_phone TEXT,\n    customer_email TEXT,\n    created_date_formatted TEXT,\n    birth_date_formatted TEXT,\n    daily_steps_goal INTEGER,\n    weekly_workouts_goal INTEGER,\n    daily_supplements JSONB,\n    subscription_months INTEGER,\n    subscription_initial_price DECIMAL,\n    subscription_renewal_price DECIMAL,\n    subscription_name TEXT,\n    \n    active_budget_name TEXT,\n    active_budget_id UUID,\n    active_budget_json JSONB,\n    \n    total_paid DECIMAL,\n    last_payment_date TIMESTAMP WITH TIME ZONE,\n    payments_json JSONB,\n    \n    total_expected DECIMAL,\n    debt_amount DECIMAL,\n    collections_json JSONB,\n    \n    workout_plans_count BIGINT,\n    latest_workout_plan_date DATE,\n    workout_plans_json JSONB,\n    \n    nutrition_plans_count BIGINT,\n    latest_nutrition_plan_date DATE,\n    nutrition_plans_json JSONB,\n\n    supplement_plans_count BIGINT,\n    latest_supplement_plan_date DATE,\n    supplement_plans_json JSONB,\n\n    steps_plans_count BIGINT,\n    latest_steps_plan_date DATE,\n    steps_plans_json JSONB,\n\n    meetings_count BIGINT,\n    latest_meeting_date TIMESTAMP WITH TIME ZONE,\n    next_meeting_date TIMESTAMP WITH TIME ZONE,\n    meetings_json JSONB,\n\n    blood_tests_count BIGINT,\n    latest_test_date TIMESTAMP WITH TIME ZONE,\n    blood_tests_json JSONB\n)\nLANGUAGE plpgsql\nSECURITY DEFINER\nSTABLE\nAS $$\nDECLARE\n    v_sort_direction TEXT;\n    v_order_by_clause TEXT;\nBEGIN\n    v_sort_direction := UPPER(COALESCE(NULLIF(p_sort_order, ''), 'DESC'));\n    IF v_sort_direction NOT IN ('ASC', 'DESC') THEN v_sort_direction := 'DESC'; END IF;\n\n    v_order_by_clause := '';\n    \n    IF p_group_by_level1 IS NOT NULL THEN\n        v_order_by_clause := v_order_by_clause || CASE \n            WHEN p_group_by_level1 IN ('status', 'status_main') THEN 'v.status_main ASC, '\n            WHEN p_group_by_level1 = 'source' THEN 'v.source ASC, '\n            WHEN p_group_by_level1 IN ('name', 'customer_name') THEN 'v.customer_name ASC, '\n            WHEN p_group_by_level1 = 'active_budget_name' THEN 'v.active_budget_name ASC, '\n            ELSE ''\n        END;\n    END IF;\n    \n    IF p_group_by_level2 IS NOT NULL THEN\n        v_order_by_clause := v_order_by_clause || CASE \n            WHEN p_group_by_level2 IN ('status', 'status_main') THEN 'v.status_main ASC, '\n            WHEN p_group_by_level2 = 'source' THEN 'v.source ASC, '\n            WHEN p_group_by_level2 IN ('name', 'customer_name') THEN 'v.customer_name ASC, '\n            ELSE ''\n        END;\n    END IF;\n    \n    v_order_by_clause := v_order_by_clause || CASE \n        WHEN p_sort_by IN ('createdDate', 'created_date', 'created_at') THEN 'v.created_at ' || v_sort_direction\n        WHEN p_sort_by IN ('name', 'customer_name') THEN 'v.customer_name ' || v_sort_direction\n        WHEN p_sort_by IN ('status', 'status_main') THEN 'v.status_main ' || v_sort_direction\n        WHEN p_sort_by = 'debt_amount' THEN 'v.debt_amount ' || v_sort_direction\n        ELSE 'v.created_at ' || v_sort_direction\n    END;\n\n    RETURN QUERY\n    EXECUTE format('\n        SELECT \n            v.*\n        FROM public.v_leads_with_customer v\n        WHERE \n            ($1 IS NULL OR \n             v.customer_name ILIKE ''%%'' || $1 || ''%%'' OR\n             v.customer_phone ILIKE ''%%'' || $1 || ''%%'' OR\n             v.customer_email ILIKE ''%%'' || $1 || ''%%'')\n            AND ($2 IS NULL OR v.status_main = $2)\n            AND ($3 IS NULL OR v.status_sub = $3)\n            AND ($4 IS NULL OR v.source = $4)\n            AND ($5 IS NULL OR v.fitness_goal = $5)\n            AND ($6 IS NULL OR v.activity_level = $6)\n            AND ($7 IS NULL OR v.preferred_time = $7)\n            AND ($8 IS NULL OR v.age::TEXT = $8)\n            AND ($9 IS NULL OR v.height::TEXT = $9)\n            AND ($10 IS NULL OR v.weight::TEXT = $10)\n            AND ($11 IS NULL OR v.created_date_formatted = $11)\n        ORDER BY %s\n        LIMIT $12\n        OFFSET $13\n    ', v_order_by_clause)\n    USING \n        p_search_query, p_status_main, p_status_sub, p_source, p_fitness_goal, p_activity_level, \n        p_preferred_time, p_age, p_height, p_weight, p_date, p_limit_count, p_offset_count;\nEND;\n$$","-- 4. Recreate get_filtered_leads_count\nCREATE OR REPLACE FUNCTION public.get_filtered_leads_count(\n    p_search_query TEXT DEFAULT NULL,\n    p_status_main TEXT DEFAULT NULL,\n    p_status_sub TEXT DEFAULT NULL,\n    p_source TEXT DEFAULT NULL,\n    p_fitness_goal TEXT DEFAULT NULL,\n    p_activity_level TEXT DEFAULT NULL,\n    p_preferred_time TEXT DEFAULT NULL,\n    p_age TEXT DEFAULT NULL,\n    p_height TEXT DEFAULT NULL,\n    p_weight TEXT DEFAULT NULL,\n    p_date TEXT DEFAULT NULL\n)\nRETURNS INTEGER\nLANGUAGE plpgsql\nSECURITY DEFINER\nSTABLE\nAS $$\nDECLARE\n    v_count INTEGER;\nBEGIN\n    SELECT COUNT(*)::INTEGER INTO v_count\n    FROM public.v_leads_with_customer v\n    WHERE \n        (p_search_query IS NULL OR \n         v.customer_name ILIKE '%' || p_search_query || '%' OR\n         v.customer_phone ILIKE '%' || p_search_query || '%' OR\n         v.customer_email ILIKE '%' || p_search_query || '%')\n        AND (p_status_main IS NULL OR v.status_main = p_status_main)\n        AND (p_status_sub IS NULL OR v.status_sub = p_status_sub)\n        AND (p_source IS NULL OR v.source = p_source)\n        AND (p_fitness_goal IS NULL OR v.fitness_goal = p_fitness_goal)\n        AND (p_activity_level IS NULL OR v.activity_level = p_activity_level)\n        AND (p_preferred_time IS NULL OR v.preferred_time = p_preferred_time)\n        AND (p_age IS NULL OR v.age::TEXT = p_age)\n        AND (p_height IS NULL OR v.height::TEXT = p_height)\n        AND (p_weight IS NULL OR v.weight::TEXT = p_weight)\n        AND (p_date IS NULL OR v.created_date_formatted = p_date);\n\n    RETURN COALESCE(v_count, 0);\nEND;\n$$","GRANT EXECUTE ON FUNCTION public.get_filtered_leads TO authenticated","GRANT EXECUTE ON FUNCTION public.get_filtered_leads_count TO authenticated"}	update_leads_view
20260204000000	{"-- Add avatar_url to profiles table\nALTER TABLE public.profiles\nADD COLUMN IF NOT EXISTS avatar_url TEXT","COMMENT ON COLUMN public.profiles.avatar_url IS 'URL of the user''s profile picture'","-- Create avatars storage bucket if it doesn't exist\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'buckets'\n  ) THEN\n    -- Insert bucket if it doesn't exist\n    INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)\n    VALUES (\n      'avatars',\n      'avatars',\n      true, -- Public bucket so avatars can be easily viewed\n      5242880, -- 5MB limit\n      ARRAY['image/jpeg', 'image/png', 'image/gif', 'image/webp']::text[]\n    )\n    ON CONFLICT (id) DO UPDATE SET\n      public = EXCLUDED.public,\n      file_size_limit = EXCLUDED.file_size_limit,\n      allowed_mime_types = EXCLUDED.allowed_mime_types;\n  END IF;\nEND $$","-- RLS Policies for avatars bucket\n\n-- Policy: Anyone can view avatars\nDROP POLICY IF EXISTS \\"Anyone can view avatars\\" ON storage.objects","CREATE POLICY \\"Anyone can view avatars\\"\nON storage.objects FOR SELECT\nUSING ( bucket_id = 'avatars' )","-- Policy: Authenticated users can upload their own avatar\n-- We'll use the file path convention: {user_id}/{filename}\nDROP POLICY IF EXISTS \\"Users can upload their own avatar\\" ON storage.objects","CREATE POLICY \\"Users can upload their own avatar\\"\nON storage.objects FOR INSERT\nTO authenticated\nWITH CHECK (\n  bucket_id = 'avatars' AND\n  (storage.foldername(name))[1] = auth.uid()::text\n)","-- Policy: Users can update their own avatar\nDROP POLICY IF EXISTS \\"Users can update their own avatar\\" ON storage.objects","CREATE POLICY \\"Users can update their own avatar\\"\nON storage.objects FOR UPDATE\nTO authenticated\nUSING (\n  bucket_id = 'avatars' AND\n  (storage.foldername(name))[1] = auth.uid()::text\n)\nWITH CHECK (\n  bucket_id = 'avatars' AND\n  (storage.foldername(name))[1] = auth.uid()::text\n)","-- Policy: Users can delete their own avatar\nDROP POLICY IF EXISTS \\"Users can delete their own avatar\\" ON storage.objects","CREATE POLICY \\"Users can delete their own avatar\\"\nON storage.objects FOR DELETE\nTO authenticated\nUSING (\n  bucket_id = 'avatars' AND\n  (storage.foldername(name))[1] = auth.uid()::text\n)"}	add_avatar_url
20260205000005	{"-- =====================================================\n-- Update Budget History Trigger\n-- Created: 2026-02-05\n-- Description: Update trigger to include all budget fields including supplement_template_id\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION log_budget_changes()\nRETURNS TRIGGER AS $$\nDECLARE\n    changes_json JSONB;\n    user_id UUID;\nBEGIN\n    user_id := auth.uid();\n    \n    IF (TG_OP = 'UPDATE') THEN\n        -- Only log if there are actual changes to relevant fields\n        -- We ignore updated_at\n        IF (OLD.name IS DISTINCT FROM NEW.name OR\n            OLD.description IS DISTINCT FROM NEW.description OR\n            OLD.nutrition_template_id IS DISTINCT FROM NEW.nutrition_template_id OR\n            OLD.nutrition_targets IS DISTINCT FROM NEW.nutrition_targets OR\n            OLD.steps_goal IS DISTINCT FROM NEW.steps_goal OR\n            OLD.steps_instructions IS DISTINCT FROM NEW.steps_instructions OR\n            OLD.workout_template_id IS DISTINCT FROM NEW.workout_template_id OR\n            OLD.supplement_template_id IS DISTINCT FROM NEW.supplement_template_id OR\n            OLD.supplements IS DISTINCT FROM NEW.supplements OR\n            OLD.eating_order IS DISTINCT FROM NEW.eating_order OR\n            OLD.eating_rules IS DISTINCT FROM NEW.eating_rules OR\n            OLD.is_public IS DISTINCT FROM NEW.is_public) THEN\n            \n            changes_json := jsonb_build_object(\n                'old', to_jsonb(OLD),\n                'new', to_jsonb(NEW)\n            );\n            \n            INSERT INTO budget_history (budget_id, changed_at, changed_by, change_type, changes, snapshot)\n            VALUES (NEW.id, NOW(), user_id, 'update', changes_json, to_jsonb(NEW));\n        END IF;\n        \n        RETURN NEW;\n    ELSIF (TG_OP = 'INSERT') THEN\n        INSERT INTO budget_history (budget_id, changed_at, changed_by, change_type, changes, snapshot)\n        VALUES (NEW.id, NOW(), user_id, 'create', '{}'::jsonb, to_jsonb(NEW));\n        RETURN NEW;\n    END IF;\n    RETURN NULL;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER"}	update_budget_history_trigger
20260205000000	{"-- Create function to check expiring subscriptions and notify admins\nCREATE OR REPLACE FUNCTION check_expiring_subscriptions() RETURNS void AS $$\nDECLARE\n  lead_record RECORD;\n  admin_user RECORD;\n  days_until_expiration INT;\n  notification_type TEXT := 'subscription_expiring';\n  existing_count INT;\n  message_text TEXT;\nBEGIN\n  -- Loop through active leads with expiration date\n  -- Check for expiration date in subscription_data JSONB\n  FOR lead_record IN\n    SELECT \n      l.id, \n      l.customer_id,\n      c.full_name as customer_name,\n      (l.subscription_data->>'expirationDate')::DATE as expiration_date\n    FROM leads l\n    LEFT JOIN customers c ON l.customer_id = c.id\n    WHERE \n      l.subscription_data->>'expirationDate' IS NOT NULL \n      AND (l.subscription_data->>'status')::TEXT = 'פעיל'\n  LOOP\n    -- Calculate days until expiration\n    days_until_expiration := lead_record.expiration_date - CURRENT_DATE;\n    \n    -- Check if subscription is expiring in 7, 3, or 0 days\n    -- Also checking negative values if we missed the exact day (e.g. -1 for yesterday)\n    -- But let's stick to exact days for now to avoid spam, or checking range.\n    -- Better: check if expiration is exactly 7, 3, or 0 days from now.\n    IF days_until_expiration IN (7, 3, 0) THEN\n      \n      -- Prepare message\n      IF days_until_expiration = 0 THEN\n        message_text := 'המנוי של ' || COALESCE(lead_record.customer_name, 'לקוח') || ' מסתיים היום (' || TO_CHAR(lead_record.expiration_date, 'DD/MM/YYYY') || ')';\n      ELSE\n        message_text := 'המנוי של ' || COALESCE(lead_record.customer_name, 'לקוח') || ' יסתיים בעוד ' || days_until_expiration || ' ימים (' || TO_CHAR(lead_record.expiration_date, 'DD/MM/YYYY') || ')';\n      END IF;\n\n      -- For each admin user\n      FOR admin_user IN SELECT id FROM profiles WHERE role = 'admin' LOOP\n        \n        -- Check for existing notification today to avoid duplicates\n        -- Checking last 20 hours to handle potential timezone shifts or slightly early runs\n        SELECT COUNT(*) INTO existing_count\n        FROM notifications\n        WHERE \n          user_id = admin_user.id\n          AND lead_id = lead_record.id \n          AND type = notification_type \n          AND created_at > NOW() - INTERVAL '20 hours'\n          AND message = message_text;\n          \n        IF existing_count = 0 THEN\n          INSERT INTO notifications (\n            user_id,\n            customer_id,\n            lead_id,\n            type,\n            title,\n            message,\n            action_url\n          ) VALUES (\n            admin_user.id,\n            lead_record.customer_id,\n            lead_record.id,\n            notification_type,\n            'תזכורת סיום מנוי',\n            message_text,\n            '/dashboard/leads/' || lead_record.id\n          );\n        END IF;\n        \n      END LOOP;\n      \n    END IF;\n  END LOOP;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Grant execute permission to authenticated users (so they can trigger it on login)\nGRANT EXECUTE ON FUNCTION check_expiring_subscriptions() TO authenticated"}	check_subscription_expiration
20260205000001	{"-- =====================================================\n-- Update client-assets folder storage RLS policies to include 'avatar' folder\n-- Created: 2026-02-05\n-- Description: Updates RLS policies to allow uploads to 'avatar' folder\n--              Path structure: {customer_id}/{folder}/{filename}\n--              Folders: progress, notes, blood-tests, avatar\n-- =====================================================\n\n-- Only update policies if storage.objects table exists\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT FROM information_schema.tables \n    WHERE table_schema = 'storage' \n    AND table_name = 'objects'\n  ) THEN\n    -- Drop existing policies\n    DROP POLICY IF EXISTS \\"Trainees can upload to own client folder\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Trainees can view own client files\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Trainees can delete own client files\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can upload client files\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can view all client files\\" ON storage.objects;\n    DROP POLICY IF EXISTS \\"Managers can delete all client files\\" ON storage.objects;\n\n    -- =====================================================\n    -- 1. TRAINEE POLICIES (for own folder)\n    -- =====================================================\n\n    -- RLS Policy: Allow trainees to upload files to their own client_id folder\n    CREATE POLICY \\"Trainees can upload to own client folder\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = 'client-assets' AND\n      (\n        name LIKE '%/progress/%' OR\n        name LIKE '%/notes/%' OR\n        name LIKE '%/blood-tests/%' OR\n        name LIKE '%/avatar/%'\n      ) AND\n      EXISTS (\n        SELECT 1 FROM customers\n        WHERE customers.id::text = split_part(name, '/', 1)\n        AND customers.user_id = auth.uid()\n      )\n    );\n\n    -- RLS Policy: Allow trainees to view files in their own client_id folder\n    CREATE POLICY \\"Trainees can view own client files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      (\n        name LIKE '%/progress/%' OR\n        name LIKE '%/notes/%' OR\n        name LIKE '%/blood-tests/%' OR\n        name LIKE '%/avatar/%'\n      ) AND\n      EXISTS (\n        SELECT 1 FROM customers\n        WHERE customers.id::text = split_part(name, '/', 1)\n        AND customers.user_id = auth.uid()\n      )\n    );\n\n    -- RLS Policy: Allow trainees to delete files from their own client_id folder\n    CREATE POLICY \\"Trainees can delete own client files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      (\n        name LIKE '%/progress/%' OR\n        name LIKE '%/notes/%' OR\n        name LIKE '%/blood-tests/%' OR\n        name LIKE '%/avatar/%'\n      ) AND\n      EXISTS (\n        SELECT 1 FROM customers\n        WHERE customers.id::text = split_part(name, '/', 1)\n        AND customers.user_id = auth.uid()\n      )\n    );\n\n    -- =====================================================\n    -- 2. MANAGER POLICIES (for all client folders)\n    -- =====================================================\n\n    -- RLS Policy: Allow managers/admins to upload client files\n    CREATE POLICY \\"Managers can upload client files\\"\n    ON storage.objects\n    FOR INSERT\n    TO authenticated\n    WITH CHECK (\n      bucket_id = 'client-assets' AND\n      (\n        name LIKE '%/progress/%' OR\n        name LIKE '%/notes/%' OR\n        name LIKE '%/blood-tests/%' OR\n        name LIKE '%/avatar/%'\n      ) AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- RLS Policy: Allow managers/admins to view all client files\n    CREATE POLICY \\"Managers can view all client files\\"\n    ON storage.objects\n    FOR SELECT\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    -- RLS Policy: Allow managers/admins to delete all client files\n    CREATE POLICY \\"Managers can delete all client files\\"\n    ON storage.objects\n    FOR DELETE\n    TO authenticated\n    USING (\n      bucket_id = 'client-assets' AND\n      EXISTS (\n        SELECT 1 FROM profiles\n        WHERE profiles.id = auth.uid()\n        AND profiles.role IN ('admin', 'user')\n      )\n    );\n\n    RAISE NOTICE 'Storage RLS policies for avatar uploads updated successfully';\n  ELSE\n    RAISE NOTICE 'Storage schema not available. Skipping RLS policy update.';\n  END IF;\nEND $$"}	add_avatar_storage_policies
20260205000002	{"-- =====================================================\n-- Budget History Migration\n-- Created: 2026-02-05\n-- Description: Track changes to budgets for audit history\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS budget_history (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    budget_id UUID NOT NULL REFERENCES budgets(id) ON DELETE CASCADE,\n    changed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    changed_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,\n    change_type TEXT NOT NULL, -- 'create', 'update'\n    changes JSONB NOT NULL DEFAULT '{}'::jsonb, -- Store old and new values\n    snapshot JSONB -- Full snapshot of the budget after change\n)","-- Indexes\nCREATE INDEX IF NOT EXISTS idx_budget_history_budget_id ON budget_history(budget_id)","CREATE INDEX IF NOT EXISTS idx_budget_history_changed_at ON budget_history(changed_at DESC)","-- Enable RLS\nALTER TABLE budget_history ENABLE ROW LEVEL SECURITY","-- Policies\n\n-- Admins/Staff can view all history\nCREATE POLICY \\"Staff can view all budget history\\"\n    ON budget_history FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role IN ('admin', 'manager', 'coach')\n        )\n    )","-- Users can view history of budgets they created\nCREATE POLICY \\"Users can view history of own budgets\\"\n    ON budget_history FOR SELECT\n    USING (\n        EXISTS (\n            SELECT 1 FROM budgets\n            WHERE budgets.id = budget_history.budget_id\n            AND budgets.created_by = auth.uid()\n        )\n    )","-- Trigger Function\nCREATE OR REPLACE FUNCTION log_budget_changes()\nRETURNS TRIGGER AS $$\nDECLARE\n    changes_json JSONB;\n    user_id UUID;\nBEGIN\n    user_id := auth.uid();\n    \n    IF (TG_OP = 'UPDATE') THEN\n        -- Only log if there are actual changes to relevant fields\n        -- We ignore updated_at\n        IF (OLD.name IS DISTINCT FROM NEW.name OR\n            OLD.description IS DISTINCT FROM NEW.description OR\n            OLD.nutrition_template_id IS DISTINCT FROM NEW.nutrition_template_id OR\n            OLD.nutrition_targets IS DISTINCT FROM NEW.nutrition_targets OR\n            OLD.steps_goal IS DISTINCT FROM NEW.steps_goal OR\n            OLD.steps_instructions IS DISTINCT FROM NEW.steps_instructions OR\n            OLD.workout_template_id IS DISTINCT FROM NEW.workout_template_id OR\n            OLD.supplements IS DISTINCT FROM NEW.supplements OR\n            OLD.eating_order IS DISTINCT FROM NEW.eating_order OR\n            OLD.eating_rules IS DISTINCT FROM NEW.eating_rules OR\n            OLD.is_public IS DISTINCT FROM NEW.is_public) THEN\n            \n            changes_json := jsonb_build_object(\n                'old', to_jsonb(OLD),\n                'new', to_jsonb(NEW)\n            );\n            \n            INSERT INTO budget_history (budget_id, changed_at, changed_by, change_type, changes, snapshot)\n            VALUES (NEW.id, NOW(), user_id, 'update', changes_json, to_jsonb(NEW));\n        END IF;\n        \n        RETURN NEW;\n    ELSIF (TG_OP = 'INSERT') THEN\n        INSERT INTO budget_history (budget_id, changed_at, changed_by, change_type, changes, snapshot)\n        VALUES (NEW.id, NOW(), user_id, 'create', '{}'::jsonb, to_jsonb(NEW));\n        RETURN NEW;\n    END IF;\n    RETURN NULL;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Trigger\nDROP TRIGGER IF EXISTS log_budget_changes_trigger ON budgets","CREATE TRIGGER log_budget_changes_trigger\n    AFTER INSERT OR UPDATE ON budgets\n    FOR EACH ROW\n    EXECUTE FUNCTION log_budget_changes()"}	create_budget_history
20260205000003	{"-- Update function to check expiring subscriptions (both current and future) and notify admins\nCREATE OR REPLACE FUNCTION check_expiring_subscriptions() RETURNS void AS $$\nDECLARE\n  lead_record RECORD;\n  admin_user RECORD;\n  days_until_expiration INT;\n  notification_type TEXT := 'subscription_ending';\n  existing_count INT;\n  message_text TEXT;\n  \n  -- Variables for future subscription\n  future_expiration_date DATE;\n  future_days_until_expiration INT;\nBEGIN\n  -- Loop through active leads with expiration date (current OR future)\n  FOR lead_record IN\n    SELECT \n      l.id, \n      l.customer_id,\n      c.full_name as customer_name,\n      (l.subscription_data->>'expirationDate')::DATE as current_expiration_date,\n      (l.subscription_data->'future_subscription'->>'expirationDate')::DATE as future_expiration_date,\n      (l.subscription_data->>'status')::TEXT as current_status,\n      (l.subscription_data->'future_subscription'->>'status')::TEXT as future_status\n    FROM leads l\n    LEFT JOIN customers c ON l.customer_id = c.id\n    WHERE \n      (l.subscription_data->>'expirationDate' IS NOT NULL AND (l.subscription_data->>'status')::TEXT = 'פעיל')\n      OR \n      (l.subscription_data->'future_subscription'->>'expirationDate' IS NOT NULL AND (l.subscription_data->'future_subscription'->>'status')::TEXT IN ('פעיל', 'ממתין'))\n  LOOP\n    \n    -- 1. Check Current Subscription\n    IF lead_record.current_expiration_date IS NOT NULL AND lead_record.current_status = 'פעיל' THEN\n        days_until_expiration := lead_record.current_expiration_date - CURRENT_DATE;\n        \n        IF days_until_expiration IN (7, 3, 0) THEN\n          IF days_until_expiration = 0 THEN\n            message_text := 'המנוי של ' || COALESCE(lead_record.customer_name, 'לקוח') || ' מסתיים היום (' || TO_CHAR(lead_record.current_expiration_date, 'DD/MM/YYYY') || ')';\n          ELSE\n            message_text := 'המנוי של ' || COALESCE(lead_record.customer_name, 'לקוח') || ' יסתיים בעוד ' || days_until_expiration || ' ימים (' || TO_CHAR(lead_record.current_expiration_date, 'DD/MM/YYYY') || ')';\n          END IF;\n\n          -- Send notification\n          FOR admin_user IN SELECT id FROM profiles WHERE role = 'admin' LOOP\n            SELECT COUNT(*) INTO existing_count\n            FROM notifications\n            WHERE \n              user_id = admin_user.id\n              AND lead_id = lead_record.id \n              AND type = notification_type \n              AND created_at > NOW() - INTERVAL '20 hours'\n              AND message = message_text;\n              \n            IF existing_count = 0 THEN\n              INSERT INTO notifications (\n                user_id, customer_id, lead_id, type, title, message, action_url\n              ) VALUES (\n                admin_user.id, lead_record.customer_id, lead_record.id, notification_type, 'תזכורת סיום מנוי', message_text, '/dashboard/leads/' || lead_record.id\n              );\n            END IF;\n          END LOOP;\n        END IF;\n    END IF;\n\n    -- 2. Check Future Subscription\n    IF lead_record.future_expiration_date IS NOT NULL AND lead_record.future_status IN ('פעיל', 'ממתין') THEN\n        future_days_until_expiration := lead_record.future_expiration_date - CURRENT_DATE;\n        \n        IF future_days_until_expiration IN (7, 3, 0) THEN\n          IF future_days_until_expiration = 0 THEN\n            message_text := 'המנוי העתידי של ' || COALESCE(lead_record.customer_name, 'לקוח') || ' מסתיים היום (' || TO_CHAR(lead_record.future_expiration_date, 'DD/MM/YYYY') || ')';\n          ELSE\n            message_text := 'המנוי העתידי של ' || COALESCE(lead_record.customer_name, 'לקוח') || ' יסתיים בעוד ' || future_days_until_expiration || ' ימים (' || TO_CHAR(lead_record.future_expiration_date, 'DD/MM/YYYY') || ')';\n          END IF;\n\n          -- Send notification\n          FOR admin_user IN SELECT id FROM profiles WHERE role = 'admin' LOOP\n            SELECT COUNT(*) INTO existing_count\n            FROM notifications\n            WHERE \n              user_id = admin_user.id\n              AND lead_id = lead_record.id \n              AND type = notification_type \n              AND created_at > NOW() - INTERVAL '20 hours'\n              AND message = message_text;\n              \n            IF existing_count = 0 THEN\n              INSERT INTO notifications (\n                user_id, customer_id, lead_id, type, title, message, action_url\n              ) VALUES (\n                admin_user.id, lead_record.customer_id, lead_record.id, notification_type, 'תזכורת סיום מנוי עתידי', message_text, '/dashboard/leads/' || lead_record.id\n              );\n            END IF;\n          END LOOP;\n        END IF;\n    END IF;\n\n  END LOOP;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Grant execute permission to authenticated users\nGRANT EXECUTE ON FUNCTION check_expiring_subscriptions() TO authenticated"}	update_check_subscription_expiration
20260205000004	{"-- =====================================================\n-- Create Supplement Templates\n-- Created: 2026-02-05\n-- Description: Reusable supplement templates that can be imported by users\n-- =====================================================\n\n-- =====================================================\n-- TABLE: supplement_templates\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS supplement_templates (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name TEXT NOT NULL,\n    description TEXT,\n    supplements JSONB DEFAULT '[]'::jsonb, -- Array of supplements: [{ name: string, dosage: string, timing: string, link1: string, link2: string }]\n    is_public BOOLEAN NOT NULL DEFAULT FALSE,\n    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL\n)","-- Indexes for performance\nCREATE INDEX IF NOT EXISTS idx_supplement_templates_created_by ON supplement_templates(created_by)","CREATE INDEX IF NOT EXISTS idx_supplement_templates_is_public ON supplement_templates(is_public)","CREATE INDEX IF NOT EXISTS idx_supplement_templates_supplements ON supplement_templates USING GIN (supplements)","CREATE INDEX IF NOT EXISTS idx_supplement_templates_created_at ON supplement_templates(created_at DESC)","-- Trigger to auto-update updated_at\nDO $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM pg_trigger \n        WHERE tgname = 'update_supplement_templates_updated_at'\n    ) THEN\n        CREATE TRIGGER update_supplement_templates_updated_at\n            BEFORE UPDATE ON supplement_templates\n            FOR EACH ROW\n            EXECUTE FUNCTION update_updated_at_column();\n    END IF;\nEND $$","-- =====================================================\n-- ROW LEVEL SECURITY (RLS) POLICIES\n-- =====================================================\n\n-- Enable RLS on supplement_templates table\nALTER TABLE supplement_templates ENABLE ROW LEVEL SECURITY","-- Drop existing policies if they exist (to avoid conflicts)\nDROP POLICY IF EXISTS \\"Users can view public or own supplement templates\\" ON supplement_templates","DROP POLICY IF EXISTS \\"Users can insert own supplement templates\\" ON supplement_templates","DROP POLICY IF EXISTS \\"Users can update own supplement templates\\" ON supplement_templates","DROP POLICY IF EXISTS \\"Users can delete own supplement templates\\" ON supplement_templates","DROP POLICY IF EXISTS \\"Admins have full access to supplement templates\\" ON supplement_templates","-- Policy: Users can view public templates or their own templates\nCREATE POLICY \\"Users can view public or own supplement templates\\"\n    ON supplement_templates FOR SELECT\n    USING (\n        is_public = TRUE OR \n        created_by = auth.uid()\n    )","-- Policy: Users can insert their own templates\nCREATE POLICY \\"Users can insert own supplement templates\\"\n    ON supplement_templates FOR INSERT\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can update their own templates\nCREATE POLICY \\"Users can update own supplement templates\\"\n    ON supplement_templates FOR UPDATE\n    USING (auth.uid() = created_by)\n    WITH CHECK (auth.uid() = created_by)","-- Policy: Users can delete their own templates\nCREATE POLICY \\"Users can delete own supplement templates\\"\n    ON supplement_templates FOR DELETE\n    USING (auth.uid() = created_by)","-- Policy: Admins have full access to templates\nCREATE POLICY \\"Admins have full access to supplement templates\\"\n    ON supplement_templates FOR ALL\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )\n    WITH CHECK (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role = 'admin'\n        )\n    )","-- =====================================================\n-- Add supplement_template_id to budgets\n-- =====================================================\n\nDO $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM information_schema.columns \n        WHERE table_name = 'budgets' \n        AND column_name = 'supplement_template_id'\n    ) THEN\n        ALTER TABLE budgets \n        ADD COLUMN supplement_template_id UUID REFERENCES supplement_templates(id) ON DELETE SET NULL;\n        \n        CREATE INDEX IF NOT EXISTS idx_budgets_supplement_template_id ON budgets(supplement_template_id);\n    END IF;\nEND $$","-- =====================================================\n-- COMMENTS\n-- =====================================================\n\nCOMMENT ON TABLE supplement_templates IS 'Reusable supplement templates that can be imported by users to create supplement plans'","COMMENT ON COLUMN supplement_templates.name IS 'Template name'","COMMENT ON COLUMN supplement_templates.description IS 'Template description'","COMMENT ON COLUMN supplement_templates.supplements IS 'JSONB array of supplements: [{ name: string, dosage: string, timing: string, link1: string, link2: string }]'","COMMENT ON COLUMN supplement_templates.is_public IS 'Whether the template is publicly visible to all users'","COMMENT ON COLUMN budgets.supplement_template_id IS 'Reference to the supplement template used in this budget'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	create_supplement_templates
20260205000006	{"-- =====================================================\n-- Add supplement_templates to saved_views\n-- Created: 2026-02-05\n-- Description: Enable saved views for supplement templates interface\n-- =====================================================\n\n-- Drop the existing constraint\nALTER TABLE saved_views DROP CONSTRAINT IF EXISTS saved_views_resource_key_check","-- Add new constraint that includes 'supplement_templates'\nALTER TABLE saved_views \n  ADD CONSTRAINT saved_views_resource_key_check \n  CHECK (resource_key IN ('leads', 'workouts', 'customers', 'templates', 'exercises', 'nutrition_templates', 'budgets', 'meetings', 'check_in_settings', 'payments', 'collections', 'subscription_types', 'whatsapp_automations', 'supplement_templates'))","-- Insert supplement_templates default view for all users\nINSERT INTO public.saved_views (resource_key, view_name, filter_config, created_by, is_default, display_order)\nSELECT \n    'supplement_templates' as resource_key,\n    'כל התבניות' as view_name,\n    '{}'::jsonb as filter_config,\n    u.id as created_by,\n    true as is_default,\n    1 as display_order\nFROM auth.users u\nWHERE NOT EXISTS (\n    SELECT 1 FROM public.saved_views sv\n    WHERE sv.resource_key = 'supplement_templates' \n    AND sv.created_by = u.id \n    AND sv.is_default = true\n)","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_supplement_templates_to_saved_views
20260206000001	{"-- =====================================================\n-- Fix Budget Update RLS\n-- Created: 2026-02-06\n-- Description: Allow staff to update budgets to ensure history logging works\n-- =====================================================\n\n-- Allow managers and coaches to update budgets\n-- This is necessary for the budget history trigger to fire when they make changes\n\nDO $$\nBEGIN\n    -- Check if the policy already exists to avoid errors\n    IF NOT EXISTS (\n        SELECT 1 FROM pg_policies \n        WHERE tablename = 'budgets' \n        AND policyname = 'Staff can update budgets'\n    ) THEN\n        CREATE POLICY \\"Staff can update budgets\\"\n            ON budgets FOR UPDATE\n            USING (\n                EXISTS (\n                    SELECT 1 FROM profiles\n                    WHERE id = auth.uid() AND role IN ('admin', 'manager', 'coach')\n                )\n            )\n            WITH CHECK (\n                EXISTS (\n                    SELECT 1 FROM profiles\n                    WHERE id = auth.uid() AND role IN ('admin', 'manager', 'coach')\n                )\n            );\n    END IF;\nEND\n$$"}	fix_budget_update_rls
20260206000002	{"-- Fix budget_history foreign key to reference profiles instead of auth.users\n-- This allows PostgREST to join the tables\n\nALTER TABLE budget_history\n  DROP CONSTRAINT IF EXISTS budget_history_changed_by_fkey","ALTER TABLE budget_history\n  ADD CONSTRAINT budget_history_changed_by_fkey\n  FOREIGN KEY (changed_by)\n  REFERENCES public.profiles(id)\n  ON DELETE SET NULL"}	fix_budget_history_fk
20260206000003	{"-- =====================================================\n-- Ensure Budget History Trigger Covers All Fields\n-- Created: 2026-02-06\n-- Description: Re-apply trigger to guarantee all fields including supplement_template_id are logged\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION log_budget_changes()\nRETURNS TRIGGER AS $$\nDECLARE\n    changes_json JSONB;\n    user_id UUID;\nBEGIN\n    user_id := auth.uid();\n    \n    IF (TG_OP = 'UPDATE') THEN\n        -- Only log if there are actual changes to relevant fields\n        -- We ignore updated_at, created_at, created_by, id\n        IF (OLD.name IS DISTINCT FROM NEW.name OR\n            OLD.description IS DISTINCT FROM NEW.description OR\n            OLD.nutrition_template_id IS DISTINCT FROM NEW.nutrition_template_id OR\n            OLD.nutrition_targets IS DISTINCT FROM NEW.nutrition_targets OR\n            OLD.steps_goal IS DISTINCT FROM NEW.steps_goal OR\n            OLD.steps_instructions IS DISTINCT FROM NEW.steps_instructions OR\n            OLD.workout_template_id IS DISTINCT FROM NEW.workout_template_id OR\n            OLD.supplement_template_id IS DISTINCT FROM NEW.supplement_template_id OR\n            OLD.supplements IS DISTINCT FROM NEW.supplements OR\n            OLD.eating_order IS DISTINCT FROM NEW.eating_order OR\n            OLD.eating_rules IS DISTINCT FROM NEW.eating_rules OR\n            OLD.is_public IS DISTINCT FROM NEW.is_public) THEN\n            \n            changes_json := jsonb_build_object(\n                'old', to_jsonb(OLD),\n                'new', to_jsonb(NEW)\n            );\n            \n            INSERT INTO budget_history (budget_id, changed_at, changed_by, change_type, changes, snapshot)\n            VALUES (NEW.id, NOW(), user_id, 'update', changes_json, to_jsonb(NEW));\n        END IF;\n        \n        RETURN NEW;\n    ELSIF (TG_OP = 'INSERT') THEN\n        INSERT INTO budget_history (budget_id, changed_at, changed_by, change_type, changes, snapshot)\n        VALUES (NEW.id, NOW(), user_id, 'create', '{}'::jsonb, to_jsonb(NEW));\n        RETURN NEW;\n    END IF;\n    RETURN NULL;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Ensure trigger exists\nDROP TRIGGER IF EXISTS log_budget_changes_trigger ON budgets","CREATE TRIGGER log_budget_changes_trigger\n    AFTER INSERT OR UPDATE ON budgets\n    FOR EACH ROW\n    EXECUTE FUNCTION log_budget_changes()"}	ensure_budget_history_trigger
20260206000005	{"-- =====================================================\n-- Fix Plans Name and History Migration\n-- Created: 2026-02-06\n-- Description: \n-- 1. Add name column to nutrition_plans and workout_plans\n-- 2. Add lead_id to budget_history\n-- 3. Create triggers to log plan changes to budget_history\n-- =====================================================\n\n-- 1. Add name column to plans\nALTER TABLE nutrition_plans ADD COLUMN IF NOT EXISTS name TEXT","ALTER TABLE workout_plans ADD COLUMN IF NOT EXISTS name TEXT","-- 2. Add lead_id to budget_history\nALTER TABLE budget_history ADD COLUMN IF NOT EXISTS lead_id UUID REFERENCES leads(id) ON DELETE SET NULL","CREATE INDEX IF NOT EXISTS idx_budget_history_lead_id ON budget_history(lead_id)","-- 3. Create logging functions for plans\n\n-- Function to log nutrition plan changes\nCREATE OR REPLACE FUNCTION log_nutrition_plan_changes()\nRETURNS TRIGGER AS $$\nDECLARE\n    changes_json JSONB;\n    user_id UUID;\n    lead_id_val UUID;\n    budget_id_val UUID;\nBEGIN\n    user_id := auth.uid();\n    lead_id_val := COALESCE(NEW.lead_id, OLD.lead_id);\n    budget_id_val := COALESCE(NEW.budget_id, OLD.budget_id);\n    \n    -- Only log if linked to a budget\n    IF budget_id_val IS NULL THEN\n        RETURN NULL;\n    END IF;\n\n    IF (TG_OP = 'UPDATE') THEN\n        -- Check if relevant fields changed\n        IF (OLD.targets IS DISTINCT FROM NEW.targets OR\n            OLD.start_date IS DISTINCT FROM NEW.start_date OR\n            OLD.description IS DISTINCT FROM NEW.description OR\n            OLD.name IS DISTINCT FROM NEW.name OR\n            OLD.is_active IS DISTINCT FROM NEW.is_active) THEN\n            \n            changes_json := jsonb_build_object(\n                'old', to_jsonb(OLD),\n                'new', to_jsonb(NEW),\n                'entity', 'nutrition_plan'\n            );\n            \n            INSERT INTO budget_history (budget_id, lead_id, changed_at, changed_by, change_type, changes, snapshot)\n            VALUES (budget_id_val, lead_id_val, NOW(), user_id, 'nutrition_update', changes_json, to_jsonb(NEW));\n        END IF;\n        \n        RETURN NEW;\n    ELSIF (TG_OP = 'INSERT') THEN\n        changes_json := jsonb_build_object(\n            'entity', 'nutrition_plan'\n        );\n        INSERT INTO budget_history (budget_id, lead_id, changed_at, changed_by, change_type, changes, snapshot)\n        VALUES (budget_id_val, lead_id_val, NOW(), user_id, 'nutrition_create', changes_json, to_jsonb(NEW));\n        RETURN NEW;\n    END IF;\n    RETURN NULL;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Function to log workout plan changes\nCREATE OR REPLACE FUNCTION log_workout_plan_changes()\nRETURNS TRIGGER AS $$\nDECLARE\n    changes_json JSONB;\n    user_id UUID;\n    lead_id_val UUID;\n    budget_id_val UUID;\nBEGIN\n    user_id := auth.uid();\n    lead_id_val := COALESCE(NEW.lead_id, OLD.lead_id);\n    budget_id_val := COALESCE(NEW.budget_id, OLD.budget_id);\n    \n    -- Only log if linked to a budget\n    IF budget_id_val IS NULL THEN\n        RETURN NULL;\n    END IF;\n\n    IF (TG_OP = 'UPDATE') THEN\n        -- Check if relevant fields changed\n        IF (OLD.start_date IS DISTINCT FROM NEW.start_date OR\n            OLD.description IS DISTINCT FROM NEW.description OR\n            OLD.name IS DISTINCT FROM NEW.name OR\n            OLD.strength IS DISTINCT FROM NEW.strength OR\n            OLD.cardio IS DISTINCT FROM NEW.cardio OR\n            OLD.intervals IS DISTINCT FROM NEW.intervals OR\n            OLD.custom_attributes IS DISTINCT FROM NEW.custom_attributes OR\n            OLD.is_active IS DISTINCT FROM NEW.is_active) THEN\n            \n            changes_json := jsonb_build_object(\n                'old', to_jsonb(OLD),\n                'new', to_jsonb(NEW),\n                'entity', 'workout_plan'\n            );\n            \n            INSERT INTO budget_history (budget_id, lead_id, changed_at, changed_by, change_type, changes, snapshot)\n            VALUES (budget_id_val, lead_id_val, NOW(), user_id, 'workout_update', changes_json, to_jsonb(NEW));\n        END IF;\n        \n        RETURN NEW;\n    ELSIF (TG_OP = 'INSERT') THEN\n        changes_json := jsonb_build_object(\n            'entity', 'workout_plan'\n        );\n        INSERT INTO budget_history (budget_id, lead_id, changed_at, changed_by, change_type, changes, snapshot)\n        VALUES (budget_id_val, lead_id_val, NOW(), user_id, 'workout_create', changes_json, to_jsonb(NEW));\n        RETURN NEW;\n    END IF;\n    RETURN NULL;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Create triggers\nDROP TRIGGER IF EXISTS log_nutrition_plan_changes_trigger ON nutrition_plans","CREATE TRIGGER log_nutrition_plan_changes_trigger\n    AFTER INSERT OR UPDATE ON nutrition_plans\n    FOR EACH ROW\n    EXECUTE FUNCTION log_nutrition_plan_changes()","DROP TRIGGER IF EXISTS log_workout_plan_changes_trigger ON workout_plans","CREATE TRIGGER log_workout_plan_changes_trigger\n    AFTER INSERT OR UPDATE ON workout_plans\n    FOR EACH ROW\n    EXECUTE FUNCTION log_workout_plan_changes()"}	fix_plans_name_and_history
20260207000000	{"-- =====================================================\n-- Add Second Period to Subscription Types\n-- Created: 2026-02-07\n-- Description: Adds support for bundle subscription types with 2 periods\n--              Stores second period data as JSONB for flexibility\n-- =====================================================\n\nSET search_path TO public","-- Add second_period column to subscription_types table\nALTER TABLE subscription_types \nADD COLUMN IF NOT EXISTS second_period JSONB DEFAULT NULL","-- Add comment for second_period column\nCOMMENT ON COLUMN subscription_types.second_period IS 'Second period data for bundle subscriptions. Contains: duration, duration_unit, price, currency'","-- Create index for second_period queries (if needed for filtering)\nCREATE INDEX IF NOT EXISTS idx_subscription_types_has_second_period \nON subscription_types((second_period IS NOT NULL)) \nWHERE second_period IS NOT NULL","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_second_period_to_subscription_types
20260208000000	{"-- =====================================================\n-- Add Cardio and Interval Training to Budgets\n-- Created: 2026-02-08\n-- Description: Add JSONB columns for cardio_training and interval_training to budgets table\n-- =====================================================\n\n-- Add cardio_training column\nALTER TABLE budgets \nADD COLUMN IF NOT EXISTS cardio_training JSONB DEFAULT NULL","-- Add interval_training column\nALTER TABLE budgets \nADD COLUMN IF NOT EXISTS interval_training JSONB DEFAULT NULL","-- Add GIN indexes for JSONB columns for better query performance\nCREATE INDEX IF NOT EXISTS idx_budgets_cardio_training ON budgets USING GIN (cardio_training)","CREATE INDEX IF NOT EXISTS idx_budgets_interval_training ON budgets USING GIN (interval_training)","-- Add comments\nCOMMENT ON COLUMN budgets.cardio_training IS 'JSONB array of cardio training workouts: [{ id?: string, name: string, type: string, duration_minutes: number, workouts_per_week: number, notes: string }]'","COMMENT ON COLUMN budgets.interval_training IS 'JSONB array of interval training workouts: [{ id?: string, name: string, type: string, duration_minutes: number, workouts_per_week: number, notes: string }]'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	add_cardio_interval_training_to_budgets
20260209000000	{"-- =====================================================\n-- Saved Action Plans Migration\n-- Created: 2026-02-09\n-- Description: Store snapshots of action plans (budgets) for viewing historical versions\n-- =====================================================\n\nCREATE TABLE IF NOT EXISTS saved_action_plans (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,\n    budget_id UUID REFERENCES budgets(id) ON DELETE SET NULL,\n    \n    -- Snapshot data - stores complete copy of the action plan at time of save\n    name TEXT NOT NULL,\n    description TEXT,\n    saved_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,\n    \n    -- Full snapshot of all budget data\n    snapshot JSONB NOT NULL DEFAULT '{}'::jsonb,\n    -- Structure includes:\n    -- - nutrition_template_id, nutrition_targets\n    -- - workout_template_id, workout_template (full data)\n    -- - supplements\n    -- - cardio_training\n    -- - interval_training\n    -- - steps_goal, steps_instructions\n    -- - eating_order, eating_rules\n    -- - nutrition_template (full data if linked)\n    \n    -- Optional metadata\n    notes TEXT -- User notes about this saved version\n)","-- Indexes\nCREATE INDEX IF NOT EXISTS idx_saved_action_plans_user_id ON saved_action_plans(user_id)","CREATE INDEX IF NOT EXISTS idx_saved_action_plans_budget_id ON saved_action_plans(budget_id)","CREATE INDEX IF NOT EXISTS idx_saved_action_plans_saved_at ON saved_action_plans(saved_at DESC)","-- Enable RLS\nALTER TABLE saved_action_plans ENABLE ROW LEVEL SECURITY","-- Policies\n\n-- Users can view their own saved action plans\nCREATE POLICY \\"Users can view own saved action plans\\"\n    ON saved_action_plans FOR SELECT\n    USING (auth.uid() = user_id)","-- Users can insert their own saved action plans\nCREATE POLICY \\"Users can insert own saved action plans\\"\n    ON saved_action_plans FOR INSERT\n    WITH CHECK (auth.uid() = user_id)","-- Users can update their own saved action plans\nCREATE POLICY \\"Users can update own saved action plans\\"\n    ON saved_action_plans FOR UPDATE\n    USING (auth.uid() = user_id)\n    WITH CHECK (auth.uid() = user_id)","-- Users can delete their own saved action plans\nCREATE POLICY \\"Users can delete own saved action plans\\"\n    ON saved_action_plans FOR DELETE\n    USING (auth.uid() = user_id)","-- Admins have full access\nCREATE POLICY \\"Admins have full access to saved action plans\\"\n    ON saved_action_plans\n    USING (\n        EXISTS (\n            SELECT 1 FROM profiles\n            WHERE id = auth.uid() AND role IN ('admin', 'user')\n        )\n    )","-- Comments\nCOMMENT ON TABLE saved_action_plans IS 'Saved snapshots of action plans (budgets) for historical viewing'","COMMENT ON COLUMN saved_action_plans.snapshot IS 'Complete snapshot of budget data including all templates and related data'","COMMENT ON COLUMN saved_action_plans.budget_id IS 'Reference to the original budget (may be null if budget was deleted)'"}	create_saved_action_plans
20260210000000	{"-- =====================================================\n-- Add lead_id to saved_action_plans Migration\n-- Created: 2026-02-10\n-- Description: Add lead_id column to saved_action_plans to scope saved plans per lead\n-- =====================================================\n\n-- Add lead_id column to saved_action_plans\nALTER TABLE saved_action_plans \n  ADD COLUMN IF NOT EXISTS lead_id UUID REFERENCES leads(id) ON DELETE CASCADE","-- Create index for lead_id\nCREATE INDEX IF NOT EXISTS idx_saved_action_plans_lead_id ON saved_action_plans(lead_id)","-- Update RLS policies to allow filtering by lead_id\n-- The existing policies already check user_id, so we keep them\n-- Users can still view their own saved action plans, but now filtered by lead_id when provided\n\n-- Comments\nCOMMENT ON COLUMN saved_action_plans.lead_id IS 'Reference to the lead this action plan belongs to. Each lead has its own saved action plans.'"}	add_lead_id_to_saved_action_plans
20260211000000	{"-- =====================================================\n-- Update Budgets View Name Migration\n-- Created: 2026-02-11\n-- Description: Update saved view names from \\"כל התקציבים\\" to \\"כל תכניות הפעולה\\" for budgets resource\n-- =====================================================\n\n-- Update all saved views for budgets resource that have the old name\nUPDATE saved_views\nSET view_name = 'כל תכניות הפעולה'\nWHERE resource_key = 'budgets'\n  AND view_name = 'כל התקציבים'","-- Comments\nCOMMENT ON TABLE saved_views IS 'User-defined saved views/filters for different resources. Updated budget view names from \\"כל התקציבים\\" to \\"כל תכניות הפעולה\\".'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	update_budgets_view_name
20260212000000	{"-- Migration: Add Automation Info to WhatsApp Flow Templates\n-- Description: Adds name and status fields to store ALL automation information and text in the database\n-- Created: 2026-02-12\n-- This migration ensures ALL automation data and text is stored in DB:\n--   - flow_key (unique identifier)\n--   - name (Hebrew description/label)\n--   - status (configuration status)\n--   - template_content (full message text with HTML formatting)\n--   - buttons (JSONB with all button text, actions, and action configs including reply messages, URLs, etc.)\n--   - media (JSONB with media type and URL)\n\n-- Add name column to store the Hebrew description/label of the automation\n-- This is the editable name shown in the automation list (e.g., \\"תחילת מסע לקוח ותיאום פגישה\\")\nALTER TABLE public.whatsapp_flow_templates\nADD COLUMN IF NOT EXISTS name TEXT","-- Add status column to track automation configuration status (e.g., 'מוגדר', 'לא מוגדר')\nALTER TABLE public.whatsapp_flow_templates\nADD COLUMN IF NOT EXISTS status TEXT DEFAULT 'לא מוגדר'","-- Add description column for additional descriptive text about the automation\nALTER TABLE public.whatsapp_flow_templates\nADD COLUMN IF NOT EXISTS description TEXT","-- Ensure template_content column can store rich text (HTML) - it's already TEXT, but add comment\n-- This stores ALL the message text including HTML formatting, placeholders, and any text content\nCOMMENT ON COLUMN public.whatsapp_flow_templates.template_content IS 'Full message template text with HTML formatting from rich text editor. Contains ALL text content including placeholders like {{name}}, {{phone}}, {{email}}, {{password}}, {{login_url}}, {{city}}, {{gender}}, {{payment_link}}, {{status}}, {{lead_id}}, etc. This is the complete message that will be sent.'","-- Ensure buttons JSONB column stores ALL button text and configurations\n-- Buttons structure: [{\\"id\\": \\"string\\", \\"text\\": \\"button text\\", \\"action\\": \\"reply|flow|url|none\\", \\"actionConfig\\": {\\"replyMessage\\": \\"...\\", \\"url\\": \\"...\\", \\"flowKey\\": \\"...\\"}}]\n-- This stores ALL button-related text: button labels, reply messages, URLs, flow keys, etc.\nCOMMENT ON COLUMN public.whatsapp_flow_templates.buttons IS 'Array of interactive buttons storing ALL button text: [{\\"id\\": \\"string\\", \\"text\\": \\"button label text (up to 25 chars)\\", \\"action\\": \\"reply|flow|url|none\\", \\"actionConfig\\": {\\"replyMessage\\": \\"auto reply message text\\", \\"url\\": \\"https://...\\", \\"flowKey\\": \\"...\\"}}]. Stores ALL button-related text including button labels, reply messages, URLs, flow keys, and any other button configuration text.'","-- Add comments for all text fields to document that ALL text is stored\nCOMMENT ON COLUMN public.whatsapp_flow_templates.name IS 'Hebrew name/description of the automation (e.g., \\"תחילת מסע לקוח ותיאום פגישה\\"). This is the editable label shown in the automation list. Stores the display name of the automation.'","COMMENT ON COLUMN public.whatsapp_flow_templates.description IS 'Optional additional descriptive text about the automation. Can contain any explanatory text about what the automation does.'","COMMENT ON COLUMN public.whatsapp_flow_templates.status IS 'Status of automation configuration (e.g., \\"מוגדר\\" for configured, \\"לא מוגדר\\" for not configured, \\"מושעה\\" for suspended).'","COMMENT ON COLUMN public.whatsapp_flow_templates.flow_key IS 'Unique identifier for the automation flow (e.g., customer_journey_start, intro_questionnaire, budget, payment_request, trainee_user_credentials, weekly_review).'","COMMENT ON COLUMN public.whatsapp_flow_templates.media IS 'Media attachment information stored as JSONB: {\\"type\\": \\"image|video|gif\\", \\"url\\": \\"...\\"}. Stores media-related text/URLs if applicable.'","-- Summary comment on the table to document that ALL automation text is stored\nCOMMENT ON TABLE public.whatsapp_flow_templates IS 'Stores ALL automation information and ALL text content: flow_key (identifier), name (display name), description (optional description), status (configuration status), template_content (full message text with HTML), buttons (all button text and configs), media (media URLs). Every piece of text in the automation is persisted in this table.'","-- Create index for faster lookups by status\nCREATE INDEX IF NOT EXISTS idx_whatsapp_flow_templates_status \nON public.whatsapp_flow_templates(user_id, status)","-- Create index for faster lookups by name\nCREATE INDEX IF NOT EXISTS idx_whatsapp_flow_templates_name \nON public.whatsapp_flow_templates(user_id, name)","-- Update existing templates to set status based on whether they have content\n-- If template_content is not empty, set status to 'מוגדר', otherwise 'לא מוגדר'\nUPDATE public.whatsapp_flow_templates\nSET status = CASE \n  WHEN template_content IS NOT NULL AND TRIM(template_content) != '' THEN 'מוגדר'\n  ELSE 'לא מוגדר'\nEND\nWHERE status IS NULL OR status = 'לא מוגדר'","-- Set default names for known flow keys if they don't have names yet\n-- This seeds the database with default automation names\nUPDATE public.whatsapp_flow_templates\nSET name = CASE flow_key\n  WHEN 'customer_journey_start' THEN 'תחילת מסע לקוח ותיאום פגישה'\n  WHEN 'intro_questionnaire' THEN 'אוטומטי שליחת שאלון הכרות לאחר קביעת שיחה'\n  WHEN 'budget' THEN 'שליחת תכנית פעולה'\n  WHEN 'payment_request' THEN 'בקשת תשלום'\n  WHEN 'trainee_user_credentials' THEN 'שליחת פרטי משתמש'\n  WHEN 'weekly_review' THEN 'סיכום שבועי ויעדים'\n  ELSE name\nEND\nWHERE name IS NULL OR name = ''","-- Add constraint to ensure status is one of the valid values\nDO $$\nBEGIN\n    -- Drop constraint if it exists (in case of re-running migration)\n    IF EXISTS (\n        SELECT 1 FROM pg_constraint \n        WHERE conname = 'check_whatsapp_template_status' \n        AND conrelid = 'public.whatsapp_flow_templates'::regclass\n    ) THEN\n        ALTER TABLE public.whatsapp_flow_templates DROP CONSTRAINT check_whatsapp_template_status;\n    END IF;\n    \n    -- Add the constraint\n    ALTER TABLE public.whatsapp_flow_templates\n    ADD CONSTRAINT check_whatsapp_template_status \n    CHECK (status IN ('מוגדר', 'לא מוגדר', 'מושעה'));\nEXCEPTION\n    WHEN others THEN\n        -- If constraint creation fails, log but don't fail the migration\n        RAISE NOTICE 'Could not add check_whatsapp_template_status constraint: %', SQLERRM;\nEND $$","-- Create a function to automatically update status when template_content changes\nCREATE OR REPLACE FUNCTION update_whatsapp_template_status()\nRETURNS TRIGGER AS $$\nBEGIN\n  -- Update status based on template_content\n  IF NEW.template_content IS NOT NULL AND TRIM(NEW.template_content) != '' THEN\n    NEW.status = 'מוגדר';\n  ELSE\n    NEW.status = 'לא מוגדר';\n  END IF;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Create trigger to automatically update status when template_content is updated\nDROP TRIGGER IF EXISTS trigger_update_whatsapp_template_status ON public.whatsapp_flow_templates","CREATE TRIGGER trigger_update_whatsapp_template_status\n  BEFORE INSERT OR UPDATE OF template_content ON public.whatsapp_flow_templates\n  FOR EACH ROW\n  EXECUTE FUNCTION update_whatsapp_template_status()","-- Add updated_at trigger if it doesn't exist (for consistency)\n-- This ensures updated_at is always updated when any field changes\nCREATE OR REPLACE FUNCTION update_whatsapp_flow_templates_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql","-- Ensure the trigger exists\nDROP TRIGGER IF EXISTS update_whatsapp_flow_templates_updated_at ON public.whatsapp_flow_templates","CREATE TRIGGER update_whatsapp_flow_templates_updated_at\n  BEFORE UPDATE ON public.whatsapp_flow_templates\n  FOR EACH ROW\n  EXECUTE FUNCTION update_whatsapp_flow_templates_updated_at()"}	add_automation_info_to_whatsapp_templates
20260213000000	{"-- Migration: Fix Numeric Field Overflow in daily_check_ins\n-- Created: 2026-02-13\n-- Description: Changes INTEGER fields to BIGINT and increases NUMERIC precision\n--              to prevent overflow errors when entering large numbers\n\nSET search_path TO public","-- Change INTEGER fields to BIGINT to support larger values\n-- This prevents overflow for fields like steps (can be 50,000+), \n-- circumference values, calories, protein, etc.\n\n-- Update steps_actual if it exists (it was created in the original table as INTEGER)\nDO $$\nBEGIN\n  IF EXISTS (\n    SELECT 1 FROM information_schema.columns \n    WHERE table_schema = 'public'\n    AND table_name = 'daily_check_ins' \n    AND column_name = 'steps_actual'\n    AND data_type = 'integer'\n  ) THEN\n    ALTER TABLE daily_check_ins\n      ALTER COLUMN steps_actual TYPE BIGINT;\n  END IF;\nEND $$","-- Update all INTEGER fields that were added in expand_daily_check_ins migration\n-- Use DO block to safely alter columns only if they exist\nDO $$\nBEGIN\n  -- Change INTEGER fields to BIGINT\n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'belly_circumference' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN belly_circumference TYPE BIGINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'waist_circumference' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN waist_circumference TYPE BIGINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'thigh_circumference' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN thigh_circumference TYPE BIGINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'arm_circumference' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN arm_circumference TYPE BIGINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'neck_circumference' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN neck_circumference TYPE BIGINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'exercises_count' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN exercises_count TYPE BIGINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'cardio_amount' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN cardio_amount TYPE BIGINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'intervals_count' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN intervals_count TYPE BIGINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'calories_daily' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN calories_daily TYPE BIGINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'protein_daily' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN protein_daily TYPE BIGINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'fiber_daily' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN fiber_daily TYPE BIGINT;\n  END IF;\n  \n  -- Increase NUMERIC precision for weight (allow up to 9999.99 kg for edge cases)\n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'weight') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN weight TYPE NUMERIC(10,2);\n  END IF;\n  \n  -- Increase NUMERIC precision for water_amount (allow up to 9999.99 liters)\n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'water_amount') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN water_amount TYPE NUMERIC(10,2);\n  END IF;\n  \n  -- Increase NUMERIC precision for sleep_hours (allow up to 999.99 hours for edge cases)\n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'sleep_hours') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN sleep_hours TYPE NUMERIC(6,2);\n  END IF;\n  \n  -- Keep stress_level, hunger_level, and energy_level as SMALLINT for efficiency\n  -- (range -32,768 to 32,767, more than enough for 1-10)\n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'stress_level' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN stress_level TYPE SMALLINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'hunger_level' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN hunger_level TYPE SMALLINT;\n  END IF;\n  \n  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema = 'public' AND table_name = 'daily_check_ins' AND column_name = 'energy_level' AND data_type = 'integer') THEN\n    ALTER TABLE daily_check_ins ALTER COLUMN energy_level TYPE SMALLINT;\n  END IF;\nEND $$","-- Update comments to reflect the changes\nCOMMENT ON COLUMN daily_check_ins.weight IS 'Weight measurement in kg (משקל). Supports up to 9999.99 kg'","COMMENT ON COLUMN daily_check_ins.belly_circumference IS 'Belly circumference in cm (היקף בטן). Supports large values'","COMMENT ON COLUMN daily_check_ins.waist_circumference IS 'Waist circumference in cm (היקף מותן). Supports large values'","COMMENT ON COLUMN daily_check_ins.thigh_circumference IS 'Thigh circumference in cm (היקף ירכיים). Supports large values'","COMMENT ON COLUMN daily_check_ins.arm_circumference IS 'Arm circumference in cm (היקף יד). Supports large values'","COMMENT ON COLUMN daily_check_ins.neck_circumference IS 'Neck circumference in cm (היקף צוואר). Supports large values'","COMMENT ON COLUMN daily_check_ins.exercises_count IS 'Number of exercises completed (כמה תרגילים עשית). Supports large values'","COMMENT ON COLUMN daily_check_ins.cardio_amount IS 'Cardio duration in minutes (כמה אירובי עשית). Supports large values'","COMMENT ON COLUMN daily_check_ins.intervals_count IS 'Number of interval training sessions (כמה אינטרוולים). Supports large values'","COMMENT ON COLUMN daily_check_ins.calories_daily IS 'Daily calorie intake (קלוריות יומי). Supports large values'","COMMENT ON COLUMN daily_check_ins.protein_daily IS 'Daily protein intake in grams (חלבון יומי). Supports large values'","COMMENT ON COLUMN daily_check_ins.fiber_daily IS 'Daily fiber intake in grams (סיבים יומי). Supports large values'","COMMENT ON COLUMN daily_check_ins.water_amount IS 'Water consumed in liters (כמה מים שתית). Supports up to 9999.99 liters'","COMMENT ON COLUMN daily_check_ins.sleep_hours IS 'Hours of sleep (כמה שעות ישנת). Supports up to 999.99 hours'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_daily_check_ins_numeric_overflow
20260214000000	{"-- Migration: Update Budget Automation Message\n-- Description: Updates the budget WhatsApp automation message to the new simplified format\n-- Created: 2026-02-14\n-- This migration must be the LAST one in the list for migration up to work correctly\n\n-- Update all existing budget automation templates to use the new message format\n-- Old format: \\"שלום אנדרי שצוקין, התקציב שלך מוכן! 📋 שם התקציב: {{budget_name}} לצפייה בתקציב המלא: {{budget_link}} בברכה, צוות DietNeta\\"\n-- New format: \\"שלום אנדרי שצוקין, התקציב שלך מוכן בפורטל! 📋 בברכה, צוות DietNeta\\"\n-- This updates all budget templates that contain the old format with budget_name and budget_link placeholders\nUPDATE public.whatsapp_flow_templates\nSET \n  template_content = 'שלום אנדרי שצוקין, התקציב שלך מוכן בפורטל! 📋 בברכה, צוות DietNeta',\n  updated_at = NOW()\nWHERE \n  flow_key = 'budget'\n  AND (\n    template_content LIKE '%{{budget_name}}%'\n    OR template_content LIKE '%{{budget_link}}%'\n    OR template_content LIKE '%שם התקציב:%'\n    OR template_content LIKE '%לצפייה בתקציב המלא:%'\n  )","-- Add comment\nCOMMENT ON COLUMN public.whatsapp_flow_templates.template_content IS 'Full message template text with HTML formatting from rich text editor. Contains ALL text content including placeholders like {{name}}, {{phone}}, {{email}}, {{password}}, {{login_url}}, {{city}}, {{gender}}, {{payment_link}}, {{status}}, {{lead_id}}, etc. This is the complete message that will be sent.'","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	update_budget_automation_message
20260215000000	{"-- =====================================================\n-- Fix Budget History to Log All Fields\n-- Created: 2026-02-15\n-- Description: \n-- 1. Update log_budget_changes() to include ALL budget fields including cardio_training and interval_training\n-- 2. Ensure lead_id is properly set when logging budget changes\n-- 3. Make sure every field change in the action plan is logged\n-- =====================================================\n\nCREATE OR REPLACE FUNCTION log_budget_changes()\nRETURNS TRIGGER AS $$\nDECLARE\n    changes_json JSONB;\n    user_id UUID;\n    lead_id_val UUID;\nBEGIN\n    user_id := auth.uid();\n    \n    -- Get lead_id from the most recent active budget assignment\n    -- This ensures we track which lead's action plan was changed\n    SELECT lead_id INTO lead_id_val\n    FROM budget_assignments\n    WHERE budget_id = NEW.id\n      AND is_active = TRUE\n    ORDER BY assigned_at DESC\n    LIMIT 1;\n    \n    IF (TG_OP = 'UPDATE') THEN\n        -- Check ALL fields that can be changed in an action plan\n        -- We ignore: updated_at, created_at, created_by, id\n        IF (OLD.name IS DISTINCT FROM NEW.name OR\n            OLD.description IS DISTINCT FROM NEW.description OR\n            OLD.nutrition_template_id IS DISTINCT FROM NEW.nutrition_template_id OR\n            OLD.nutrition_targets IS DISTINCT FROM NEW.nutrition_targets OR\n            OLD.steps_goal IS DISTINCT FROM NEW.steps_goal OR\n            OLD.steps_instructions IS DISTINCT FROM NEW.steps_instructions OR\n            OLD.workout_template_id IS DISTINCT FROM NEW.workout_template_id OR\n            OLD.supplement_template_id IS DISTINCT FROM NEW.supplement_template_id OR\n            OLD.supplements IS DISTINCT FROM NEW.supplements OR\n            OLD.eating_order IS DISTINCT FROM NEW.eating_order OR\n            OLD.eating_rules IS DISTINCT FROM NEW.eating_rules OR\n            OLD.cardio_training IS DISTINCT FROM NEW.cardio_training OR\n            OLD.interval_training IS DISTINCT FROM NEW.interval_training OR\n            OLD.is_public IS DISTINCT FROM NEW.is_public) THEN\n            \n            changes_json := jsonb_build_object(\n                'old', to_jsonb(OLD),\n                'new', to_jsonb(NEW)\n            );\n            \n            INSERT INTO budget_history (budget_id, lead_id, changed_at, changed_by, change_type, changes, snapshot)\n            VALUES (NEW.id, lead_id_val, NOW(), user_id, 'update', changes_json, to_jsonb(NEW));\n        END IF;\n        \n        RETURN NEW;\n    ELSIF (TG_OP = 'INSERT') THEN\n        -- For new budgets, try to get lead_id if it exists\n        -- (though typically new budgets won't have assignments yet)\n        INSERT INTO budget_history (budget_id, lead_id, changed_at, changed_by, change_type, changes, snapshot)\n        VALUES (NEW.id, lead_id_val, NOW(), user_id, 'create', '{}'::jsonb, to_jsonb(NEW));\n        RETURN NEW;\n    END IF;\n    RETURN NULL;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Ensure trigger exists and is active\nDROP TRIGGER IF EXISTS log_budget_changes_trigger ON budgets","CREATE TRIGGER log_budget_changes_trigger\n    AFTER INSERT OR UPDATE ON budgets\n    FOR EACH ROW\n    EXECUTE FUNCTION log_budget_changes()","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_budget_history_log_all_fields
20260227000000	{"-- =====================================================\n-- Fix Budget History Logging - Ensure All Fields Are Logged\n-- Created: 2026-02-27\n-- Description: \n-- 1. Recreate log_budget_changes() function to ensure ALL budget fields are tracked\n-- 2. Ensure trigger is properly set up and firing\n-- 3. Make sure lead_id is captured correctly\n-- 4. Log ALL changes including: name, description, nutrition, workouts, steps, supplements, cardio, intervals, eating rules\n-- =====================================================\n\n-- Drop and recreate the function to ensure it's up to date\nDROP FUNCTION IF EXISTS log_budget_changes() CASCADE","CREATE OR REPLACE FUNCTION log_budget_changes()\nRETURNS TRIGGER AS $$\nDECLARE\n    changes_json JSONB;\n    user_id UUID;\n    lead_id_val UUID;\nBEGIN\n    -- Get current user ID\n    user_id := auth.uid();\n    \n    -- Get lead_id from the most recent active budget assignment\n    -- This ensures we track which lead's action plan was changed\n    SELECT lead_id INTO lead_id_val\n    FROM budget_assignments\n    WHERE budget_id = NEW.id\n      AND is_active = TRUE\n    ORDER BY assigned_at DESC\n    LIMIT 1;\n    \n    IF (TG_OP = 'UPDATE') THEN\n        -- Check ALL fields that can be changed in an action plan\n        -- We ignore: updated_at, created_at, created_by, id\n        -- We check EVERY field that can be modified in the action plan\n        IF (OLD.name IS DISTINCT FROM NEW.name OR\n            OLD.description IS DISTINCT FROM NEW.description OR\n            OLD.nutrition_template_id IS DISTINCT FROM NEW.nutrition_template_id OR\n            OLD.nutrition_targets IS DISTINCT FROM NEW.nutrition_targets OR\n            OLD.steps_goal IS DISTINCT FROM NEW.steps_goal OR\n            OLD.steps_instructions IS DISTINCT FROM NEW.steps_instructions OR\n            OLD.workout_template_id IS DISTINCT FROM NEW.workout_template_id OR\n            OLD.supplement_template_id IS DISTINCT FROM NEW.supplement_template_id OR\n            OLD.supplements IS DISTINCT FROM NEW.supplements OR\n            OLD.eating_order IS DISTINCT FROM NEW.eating_order OR\n            OLD.eating_rules IS DISTINCT FROM NEW.eating_rules OR\n            OLD.cardio_training IS DISTINCT FROM NEW.cardio_training OR\n            OLD.interval_training IS DISTINCT FROM NEW.interval_training OR\n            OLD.is_public IS DISTINCT FROM NEW.is_public) THEN\n            \n            -- Build changes object with old and new values\n            changes_json := jsonb_build_object(\n                'old', to_jsonb(OLD),\n                'new', to_jsonb(NEW)\n            );\n            \n            -- Insert into budget_history\n            INSERT INTO budget_history (budget_id, lead_id, changed_at, changed_by, change_type, changes, snapshot)\n            VALUES (NEW.id, lead_id_val, NOW(), user_id, 'update', changes_json, to_jsonb(NEW));\n        END IF;\n        \n        RETURN NEW;\n    ELSIF (TG_OP = 'INSERT') THEN\n        -- For new budgets, try to get lead_id if it exists\n        -- (though typically new budgets won't have assignments yet)\n        INSERT INTO budget_history (budget_id, lead_id, changed_at, changed_by, change_type, changes, snapshot)\n        VALUES (NEW.id, lead_id_val, NOW(), user_id, 'create', '{}'::jsonb, to_jsonb(NEW));\n        RETURN NEW;\n    END IF;\n    \n    RETURN NULL;\nEND;\n$$ LANGUAGE plpgsql SECURITY DEFINER","-- Drop existing trigger if it exists\nDROP TRIGGER IF EXISTS log_budget_changes_trigger ON budgets","-- Create the trigger\nCREATE TRIGGER log_budget_changes_trigger\n    AFTER INSERT OR UPDATE ON budgets\n    FOR EACH ROW\n    EXECUTE FUNCTION log_budget_changes()","-- Grant necessary permissions\nGRANT EXECUTE ON FUNCTION log_budget_changes() TO authenticated","GRANT EXECUTE ON FUNCTION log_budget_changes() TO service_role","-- Ensure RLS allows the trigger function to insert\n-- The function uses SECURITY DEFINER, but we need to make sure it can insert\n-- Drop existing INSERT policy if it exists and create a new one\nDROP POLICY IF EXISTS \\"Allow trigger to insert budget history\\" ON budget_history","CREATE POLICY \\"Allow trigger to insert budget history\\"\n    ON budget_history FOR INSERT\n    WITH CHECK (true)","-- Allow all inserts (the function will handle security)\n\n-- Also ensure the function owner can insert\nALTER FUNCTION log_budget_changes() OWNER TO postgres","-- =====================================================\n-- Verify trigger exists\n-- =====================================================\nDO $$\nBEGIN\n    IF NOT EXISTS (\n        SELECT 1 FROM pg_trigger \n        WHERE tgname = 'log_budget_changes_trigger' \n        AND tgrelid = 'budgets'::regclass\n    ) THEN\n        RAISE EXCEPTION 'Trigger log_budget_changes_trigger was not created successfully';\n    END IF;\nEND $$","-- =====================================================\n-- Migration Complete\n-- ====================================================="}	fix_budget_history_logging_all_fields
\.


--
-- Name: refresh_tokens_id_seq; Type: SEQUENCE SET; Schema: auth; Owner: supabase_auth_admin
--

SELECT pg_catalog.setval('"auth"."refresh_tokens_id_seq"', 170, true);


--
-- PostgreSQL database dump complete
--

-- \unrestrict X2iLRBMBTzpTHJl5m8vWiv2uo2kCYrZGg87bvBbcUo0mjfuaKddS1Wr0NrEWDIj

RESET ALL;
